using Neosinerji.BABOnlineTP.Business;
using Neosinerji.BABOnlineTP.Business.Common;
using Neosinerji.BABOnlineTP.Business.Komisyon;
using Neosinerji.BABOnlineTP.Business.Muhasebe_CariHesap;
using Neosinerji.BABOnlineTP.Business.PoliceTransfer;
using Neosinerji.BABOnlineTP.Business.TaliPolice;
using Neosinerji.BABOnlineTP.Database;
using Neosinerji.BABOnlineTP.Database.Models;
using Neosinerji.BABOnlineTP.Web.Areas.Manage.Models;
using Neosinerji.BABOnlineTP.Web.Areas.Police.Models;
using Neosinerji.BABOnlineTP.Web.Areas.Rapor.Controllers;
using Neosinerji.BABOnlineTP.Web.Areas.Rapor.Models;
using Neosinerji.BABOnlineTP.Web.Areas.Teklif.Models;
using Neosinerji.BABOnlineTP.Web.Content.Lang;
using Neosinerji.BABOnlineTP.Web.Tools;
using Neosinerji.BABOnlineTP.Web.Tools.Helpers;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Linq.Expressions;
using System.Net;
using System.Web.Mvc;
using nsbusiness = Neosinerji.BABOnlineTP.Business;

namespace Neosinerji.BABOnlineTP.Web.Areas.Police.Controllers
{
    [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = 0, SekmeKodu = 0)]
    public class PoliceController : Controller
    {
        IAktifKullaniciService _AktifKullaniciService;
        ITUMService _TUMService;
        IUrunService _UrunService;
        IKullaniciService _KullaniciService;
        ITeklifService _TeklifService;
        ILogService _Log;
        IRaporService _RaporService;
        IBransService _BransService;
        ITaliPoliceService _TaliPoliceService;
        IMuhasebe_CariHesapService _Muhasebe_CariHesapService;
        ITUMContext _TumContext;
        ITVMService _TVMService;
        IPoliceService _PoliceService;
        ISigortaSirketleriService _SigortaSirketleriService;
        IKomisyonService _KomisyonService;
        IYetkiService _YetkiService;
        ICommonService _CommonService;
        IMusteriDokumanStorage _Storage;
        IMusteriService _MusteriService;

        public PoliceController(IAktifKullaniciService aktifKullaniciService,
                                ITUMService tumService,
                                IUrunService urunService,
                                IKullaniciService kullaniciService,
                                ITeklifService teklifService,
                                 IMuhasebe_CariHesapService muhasebe_CariHesapService,
                                IBransService bransService,
                                ITaliPoliceService taliPoliceService,
                                IPoliceService policeService,
                                IYetkiService yetki,
                                ITUMContext tumContext, ISigortaSirketleriService SigortaSirketleriService, ITVMService TVMService, IKomisyonService komisyonService,
            ICommonService commonService, IMusteriDokumanStorage storage, IMusteriService musteriService)
        {
            _AktifKullaniciService = aktifKullaniciService;
            _TUMService = tumService;
            _UrunService = urunService;
            _KullaniciService = kullaniciService;
            _TeklifService = teklifService;
            _Log = DependencyResolver.Current.GetService<ILogService>();
            _RaporService = DependencyResolver.Current.GetService<IRaporService>();
            _BransService = bransService;
            _Muhasebe_CariHesapService = muhasebe_CariHesapService;
            _TaliPoliceService = taliPoliceService;
            _PoliceService = policeService;
            _TumContext = tumContext;
            _SigortaSirketleriService = SigortaSirketleriService;
            _TVMService = TVMService;
            _KomisyonService = komisyonService;
            _YetkiService = yetki;
            _CommonService = commonService;
            _Storage = storage;
            _MusteriService = musteriService;
        }


        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceAra, SekmeKodu = 0)]
        public ActionResult Liste()
        {

            PoliceAramaModel model = new PoliceAramaModel();

            model.BaslangicTarihi = TurkeyDateTime.Now.AddDays(-2);
            model.BitisTarihi = TurkeyDateTime.Now;


            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TVMUnvani = _AktifKullaniciService.TVMUnvani;

            model.Durumlar = new SelectList(TeklifListeleri.TeklifDurumTipleri(), "Value", "Text", "1");
            model.TUMler = new SelectList(_TUMService.GetListTUMDetay(), "Kodu", "Unvani", "").ListWithOptionLabel();
            model.Urunler = new SelectList(_AktifKullaniciService.UrunYetkileri, "UrunKodu", "Aciklama", "").ListWithOptionLabel();
            model.Kullanicilar = new SelectList(_KullaniciService.GetListKullanicilarTeklifAra(), "KullaniciKodu", "AdiSoyadi", "").ListWithOptionLabel();

            return View(model);
        }

        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceAra, SekmeKodu = 0)]
        public ActionResult ListePager()
        {
            if (Request["sEcho"] != null)
            {
                TeklifListe arama = new TeklifListe(Request, new Expression<Func<TeklifAramaTableModel, object>>[]
                                                                    {
                                                                        t => t.TeklifNo,
                                                                        t => t.TUMPoliceNo,
                                                                        t => t.TUMUnvani,
                                                                        t => t.PoliceBitisTarihi,
                                                                        t => t.KaydiEKleyenTVMKodu,
                                                                        t => t.KaydedenTVMUnvani,
                                                                        t => t.TanzimTarihi,
                                                                        t => t.TVMKullaniciAdSoyad,
                                                                        t => t.UrunAdi,
                                                                        t => t.MusteriAdSoyad,
                                                                        t => t.OzelAlan,
                                                                        t => t.TVMKullaniciKodu,
                                                                        t => t.AdiSoyadi,
                                                                        t => t.SigortaliKimlikNo,


                                                                    });

                arama.TVMKodu = arama.TryParseParamInt("TVMKodu");
                arama.TUMKodu = arama.TryParseParamInt("TUMKodu");
                arama.UrunKodu = arama.TryParseParamInt("UrunKodu");
                arama.HazirlayanKodu = arama.TryParseParamInt("HazirlayanKodu");

                arama.TeklifNo = arama.TryParseParamString("TeklifNo");
                arama.BaslangisTarihi = arama.TryParseParamDate("BaslangicTarihi");
                arama.BitisTarihi = arama.TryParseParamDate("BitisTarihi");
                arama.PoliceNo = arama.TryParseParamString("PoliceNo");
                arama.MusteriKodu = arama.TryParseParamInt("MusteriKodu");

                arama.AddFormatter(f => f.TeklifNo, f => String.Format("<a href='{0}{1}'>{2}</a> {3}", TeklifSayfaAdresleri.DetayAdres(f.UrunKodu),
                                                       f.AnaTeklifId, f.TeklifNo, f.AnaTeklifPDF == null ? "" :
                                                       "<a href=" + f.AnaTeklifPDF + " title='" + babonline.ProposalPDF + "' target='_blank' class='pull-right'>" +
                                                       "<img src='/content/img/pdf_icon.png' /></a>"));

                arama.AddFormatter(f => f.TUMPoliceNo, f => String.Format("<a href='{0}{1}'>{2}</a> {3}", TeklifSayfaAdresleri.PoliceAdres(f.UrunKodu),
                                                       f.TeklifId, f.TUMPoliceNo, f.PdfURL == null ? "" : (f.İngilizcePdfURL == null ?
                                                       "<a href=" + f.PdfURL + " title='" + babonline.Turkish + " PDF' target='_blank' class='pull-right'>" +
                                                       "<img src='/content/img/tr.png' /></a>"

                                                       :

                                                       "<a href=" + f.PdfURL + " title='Türkçe PDF' target='_blank' class='pull-right'>" +
                                                       "<img src='/content/img/tr.png' /></a>" +
                                                       "<a href=" + f.İngilizcePdfURL + " title='" + babonline.English + " PDF' target='_blank' class='pull-right'>" +
                                                       "<img src='/content/img/us.png' /></a>")));

                arama.AddFormatter(f => f.PoliceBitisTarihi, f => String.Format("{0}", f.PoliceBitisTarihi.ToString("dd.MM.yyyy")));
                arama.AddFormatter(f => f.TanzimTarihi, f => String.Format("{0}", f.KayitTarihi.ToString()));
                arama.AddFormatter(f => f.MusteriAdSoyad, f => String.Format("<a href='/Musteri/Musteri/Detay/{0}'>{1}</a>", f.MusteriKodu, f.MusteriAdSoyad));
                arama.AddFormatter(s => s.OzelAlan, s => String.Format("{0}", RaporController.GetOzelAlan(s.TeklifId)));
                arama.AddFormatter(s => s.TVMKullaniciKodu, s => String.Format("{0} {1}", s.TVMKullaniciKodu, s.TVMKullaniciAdSoyad));
                arama.AddFormatter(f => f.KaydiEKleyenTVMKodu, f => String.Format("{0}", f.KaydiEKleyenTVMKodu));


                int totalRowCount = 0;
                List<TeklifAramaTableModel> list = _TeklifService.PagedList(arama, out totalRowCount, false);
                DataTableList result = arama.Prepare(list, totalRowCount);
                return Json(result, JsonRequestBehavior.AllowGet);
            }
            return View();
        }

        #region PoliceAra/TahsilatGirişi

        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceAraOffLine, SekmeKodu = 0)]
        public ActionResult PoliceAraOffline()
        {
            PoliceOffLineModel model = new PoliceOffLineModel();
            model.listPolOffline = new List<PoliceAraRaporOffLineModel>();
            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TvmUnvani = _AktifKullaniciService.TVMUnvani;
            //durum 0 şahıs 1 firma
            model.Durumlar = new SelectList(DurumListesiAktifPasif.FirmamiSahismi(), "Value", "Text", "0");
            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            int KontrolTVMKod = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
            if (tvmTaliVar || KontrolTVMKod == -9999)
            {
                ViewBag.AnaTVM = true;
            }
            else
            {
                ViewBag.AnaTVM = false;
            }
            List<SelectListItem> listYillar = new List<SelectListItem>();
            for (int yil = TurkeyDateTime.Today.Year + 2; yil >= 1990; yil--)
            {
                listYillar.AddRange(new SelectListItem[] {
                    new SelectListItem() { Value = yil.ToString(), Text = yil.ToString() },
                });

            }
            model.Donem = TurkeyDateTime.Now.Year.ToString() + "-" + (TurkeyDateTime.Now.Year - 1).ToString();
            model.Donemler = new SelectList(_CommonService.DonemAralikListesi(), "Value", "Text", model.Donem).ToList();

            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.AnaTVM = false;
            }
            return View(model);
        }


        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceAraOffLine, SekmeKodu = 0)]
        public ActionResult PoliceAraOffline(PoliceOffLineModel model)
        {
            model.listPolOffline = new List<PoliceAraRaporOffLineModel>();
            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TvmUnvani = _AktifKullaniciService.TVMUnvani;
            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            int KontrolTVMKod = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;

            model.Durumlar = new SelectList(DurumListesiAktifPasif.FirmamiSahismi(), "Value", "Text", "0");
            model.Donemler = new SelectList(_CommonService.DonemAralikListesi(), "Value", "Text", model.Donem).ToList();
            PoliceAraRaporOffLineModel sonucModel;

            if (tvmTaliVar || KontrolTVMKod == -9999)
            {
                ViewBag.AnaTVM = true;
            }
            else
            {
                ViewBag.AnaTVM = false;
            }
            #region polno
            if (model.PoliceNo != null)
            {
                model.PoliceNo = model.PoliceNo.Trim();
                PoliceGenel police = new PoliceGenel();
                PoliceService.PoliceOffLineServiceModel policeler = _PoliceService.PoliceOffLinePolNo(ViewBag.AnaTVM, model.PoliceNo, _AktifKullaniciService.TVMKodu, model.Donem);
                for (int i = 0; i < policeler.OfflineGenel.Count(); i++)
                {
                    sonucModel = new PoliceAraRaporOffLineModel();
                    police = policeler.OfflineGenel[i];
                    sonucModel.PoliceId = police.PoliceId;
                    if (police.TaliAcenteKodu != null)
                    {
                        sonucModel.TaliAcenteKodu = police.TaliAcenteKodu.Value.ToString();
                        var taliTvmUnvan = _TvmService.GetDetay(police.TaliAcenteKodu.Value);
                        sonucModel.TaliAcenteAdi = taliTvmUnvan != null ? taliTvmUnvan.Unvani : null;
                    }
                    if (police.UretimTaliAcenteKodu != null)
                    {
                        sonucModel.DisKaynakKodu = police.UretimTaliAcenteKodu.Value.ToString();
                        var disKaynakUnvan = _TvmService.GetDetay(police.UretimTaliAcenteKodu.Value);
                        sonucModel.DisKaynakAdi = disKaynakUnvan != null ? disKaynakUnvan.Unvani : null;
                    }
                    if (police.PoliceSigortali != null)
                    {
                        sonucModel.SigortaliUnvani = police.PoliceSigortali.AdiUnvan + " " + police.PoliceSigortali.SoyadiUnvan;
                    }


                    sonucModel.YenilemeNo = police.YenilemeNo.HasValue ? police.YenilemeNo.Value.ToString() : null;
                    sonucModel.BransAdi = police.BransAdi;
                    sonucModel.UrunAdi = police.TUMUrunAdi;
                    sonucModel.UrunKodu = police.TUMUrunKodu;
                    sonucModel.VerilenKomisyon = police.TaliKomisyon;
                    sonucModel.BaslangicTarihi = police.BaslangicTarihi;

                    //  if (police.PoliceSigortali.KimlikNo != null)
                    // {
                    //    sonucModel.TcknVkn = police.PoliceSigortali.KimlikNo;
                    // }
                    // else
                    // {
                    //   
                    // }

                    // if (police.PoliceSigortali.VergiKimlikNo != null)
                    // {
                    //    sonucModel.TcknVkn = police.PoliceSigortali.VergiKimlikNo;
                    // }


                    string tcK = police.PoliceSigortali.KimlikNo;
                    if (!String.IsNullOrEmpty(tcK))
                    {
                        police.PoliceSigortali.KimlikNo = tcK;
                        sonucModel.TcknVkn = police.PoliceSigortali.KimlikNo;
                    }

                    string vkn = police.PoliceSigortali.VergiKimlikNo;
                    if (!String.IsNullOrEmpty(vkn))
                    {
                        police.PoliceSigortali.VergiKimlikNo = vkn;
                        sonucModel.TcknVkn = police.PoliceSigortali.VergiKimlikNo;
                    }

                    //string tcKSEttiren = police.PoliceSigortaEttiren.KimlikNo;
                    //if (!String.IsNullOrEmpty(tcKSEttiren))
                    //{
                    //    police.PoliceSigortaEttiren.KimlikNo = tcKSEttiren;
                    //    sonucModel.TcknVkn = police.PoliceSigortaEttiren.KimlikNo;
                    //}


                    //string vknSEttiren = police.PoliceSigortaEttiren.VergiKimlikNo;
                    //if (!String.IsNullOrEmpty(vknSEttiren))
                    //{
                    //    police.PoliceSigortaEttiren.VergiKimlikNo = vknSEttiren;
                    //    sonucModel.TcknVkn = police.PoliceSigortaEttiren.VergiKimlikNo;
                    //}





                    if (police.PoliceSigortali.PoliceGenel.OnaylayanKullaniciKodu == null)
                    {
                        sonucModel.OnaylayanUnvan = "";
                    }

                    else
                    {
                        sonucModel.OnaylayanUnvan = police.TVMKullanicilar.Adi + " " + police.TVMKullanicilar.Soyadi;
                    }

                    if (!String.IsNullOrEmpty(police.BitisTarihi.ToString()))
                    {
                        sonucModel.BitisTarihi = police.BitisTarihi.Value.Date;
                    }
                    if (police.TanzimTarihi.Value.Date != null)
                    {
                        sonucModel.TanzimTarihi = police.TanzimTarihi.Value.Date;
                    }
                    sonucModel.BrütPrim = police.PoliceSigortali.PoliceGenel.BrutPrim != null ? police.PoliceSigortali.PoliceGenel.BrutPrim : 0;
                    sonucModel.EkNo = police.EkNo.HasValue ? police.EkNo.Value.ToString() : null;
                    sonucModel.Komisyon = police.Komisyon;
                    sonucModel.NetPrim = police.NetPrim;
                    sonucModel.DovizliBrütPrim = police.DovizliBrutPrim;
                    sonucModel.DovizliKomisyon = police.DovizliKomisyon;
                    sonucModel.DovizliNetPrim = police.DovizliNetPrim;
                    sonucModel.OdemeSekli = police.OdemeSekli.HasValue ? police.OdemeSekli.Value.ToString() : null;
                    sonucModel.SigortaSirketi = police.SigortaSirketleri.SirketAdi;
                    sonucModel.PoliceNo = police.PoliceNumarasi;
                    sonucModel.TaksitSayisi = policeler.OfflineGenel.Find(s => s.PoliceId == police.PoliceId).PoliceOdemePlanis.Count();
                    sonucModel.Yeni_is = Convert.ToInt32(police.Yeni_is != null ? police.Yeni_is : 0);

                    if (policeler.OfflineGenel.Find(s => s.PoliceId == police.PoliceId).PoliceOdemePlanis.Count > 0)
                    {
                        sonucModel.OdemeTipi = policeler.OfflineGenel.Find(s => s.PoliceId == police.PoliceId).PoliceOdemePlanis.FirstOrDefault().OdemeTipi.ToString();
                    }

                    if (sonucModel.OdemeSekli == "1")
                    {
                        sonucModel.OdemeTipi = "Peşin";
                    }
                    else
                    {
                        sonucModel.OdemeTipi = "Taksit";
                    }

                    var odemeTipleri = police.PoliceOdemePlanis.FirstOrDefault();
                    if (odemeTipleri != null)
                    {
                        sonucModel.OdemeTipim = odemeTipleri.OdemeTipi.ToString();
                    }

                    string odemetipi = sonucModel.OdemeTipim;
                    this.OdemeTipiText(ref odemetipi);
                    sonucModel.OdemeTipim = odemetipi;

                    if (police.PoliceArac != null)
                    {
                        sonucModel.PlakaKodu = police.PoliceArac.PlakaKodu;
                        sonucModel.PlakaNo = police.PoliceArac.PlakaNo;
                    }
                    sonucModel.MuhasebeyeAktarildiMi = police.MuhasebeyeAktarildiMi;
                    sonucModel.ManuelPoliceMi = police.Durum;


                    if (police.BransKodu == BransKodlari.Kasko || police.BransKodu == BransKodlari.Trafik)

                    {
                        sonucModel.IlIlce = "";
                    }
                    else
                    {
                        sonucModel.IlIlce = police.PoliceSigortali.IlAdi + "/" + police.PoliceSigortali.IlceAdi;
                    }

                    model.listPolOffline.Add(sonucModel);
                }
            }




            #endregion

            #region tcvkno
            if (model.TcknVkn != null)
            {
                model.TcknVkn = model.TcknVkn.Trim();
                PoliceService.PoliceOffLineServiceModel policetcvkn = _PoliceService.PoliceOffLineTcVkn(ViewBag.AnaTVM, model.TcknVkn, _AktifKullaniciService.TVMKodu, model.Donem);
                PoliceSigortali polSigortali = null;
                for (int i = 0; i < policetcvkn.OfflineSigortali.Count(); i++)
                {
                    polSigortali = policetcvkn.OfflineSigortali[i];
                    sonucModel = new PoliceAraRaporOffLineModel();
                    sonucModel.PoliceId = polSigortali.PoliceId;

                    sonucModel.SigortaliUnvani = polSigortali.PoliceGenel.PoliceSigortali.AdiUnvan + " " + polSigortali.PoliceGenel.PoliceSigortali.SoyadiUnvan;
                    sonucModel.YenilemeNo = polSigortali.PoliceGenel.YenilemeNo.HasValue ? polSigortali.PoliceGenel.YenilemeNo.Value.ToString() : null;
                    sonucModel.BransAdi = polSigortali.PoliceGenel.BransAdi;
                    sonucModel.UrunAdi = polSigortali.PoliceGenel.TUMUrunAdi;



                    string tcK = polSigortali.KimlikNo;
                    if (!String.IsNullOrEmpty(tcK))
                    {
                        polSigortali.KimlikNo = tcK;
                        sonucModel.TcknVkn = polSigortali.KimlikNo;
                    }

                    string vkn = polSigortali.VergiKimlikNo;
                    if (!String.IsNullOrEmpty(vkn))
                    {
                        polSigortali.VergiKimlikNo = vkn;
                        sonucModel.TcknVkn = polSigortali.VergiKimlikNo;
                    }

                    //string tcKSEttiren = polSigortali.PoliceGenel.PoliceSigortaEttiren.KimlikNo;
                    //if (!String.IsNullOrEmpty(tcKSEttiren))
                    //{
                    //    polSigortali.PoliceGenel.PoliceSigortaEttiren.KimlikNo = tcKSEttiren;
                    //    sonucModel.TcknVkn = polSigortali.PoliceGenel.PoliceSigortaEttiren.KimlikNo;
                    //}


                    //string vknSEttiren = polSigortali.PoliceGenel.PoliceSigortaEttiren.VergiKimlikNo;
                    //if (!String.IsNullOrEmpty(vknSEttiren))
                    //{
                    //    polSigortali.PoliceGenel.PoliceSigortaEttiren.VergiKimlikNo = vknSEttiren;
                    //    sonucModel.TcknVkn = polSigortali.PoliceGenel.PoliceSigortaEttiren.VergiKimlikNo;
                    //}



                    if (polSigortali.PoliceGenel.PoliceSigortali.PoliceGenel.OnaylayanKullaniciKodu == null)
                    {
                        sonucModel.OnaylayanUnvan = "";
                    }

                    else
                    {
                        sonucModel.OnaylayanUnvan = polSigortali.PoliceGenel.TVMKullanicilar.Adi + " " + polSigortali.PoliceGenel.TVMKullanicilar.Soyadi;
                    }
                    sonucModel.ManuelPoliceMi = polSigortali.PoliceGenel.Durum;

                    if (polSigortali.PoliceGenel.TaliAcenteKodu != null)
                    {
                        sonucModel.TaliAcenteKodu = polSigortali.PoliceGenel.TaliAcenteKodu.Value.ToString();
                        var taliTvmUnvan = _TvmService.GetDetay(polSigortali.PoliceGenel.TaliAcenteKodu.Value);
                        sonucModel.TaliAcenteAdi = taliTvmUnvan != null ? taliTvmUnvan.Unvani : null;
                    }
                    if (polSigortali.PoliceGenel.UretimTaliAcenteKodu != null)
                    {
                        sonucModel.DisKaynakKodu = polSigortali.PoliceGenel.UretimTaliAcenteKodu.Value.ToString();
                        var disKaynakUnvan = _TvmService.GetDetay(polSigortali.PoliceGenel.UretimTaliAcenteKodu.Value);
                        sonucModel.DisKaynakAdi = disKaynakUnvan != null ? disKaynakUnvan.Unvani : null;
                    }
                    sonucModel.VerilenKomisyon = polSigortali.PoliceGenel.TaliKomisyon;
                    sonucModel.BaslangicTarihi = polSigortali.PoliceGenel.BaslangicTarihi;
                    if (polSigortali.PoliceGenel.BitisTarihi != null)
                    {
                        sonucModel.BitisTarihi = polSigortali.PoliceGenel.BitisTarihi.Value.Date;
                    }
                    if (polSigortali.PoliceGenel.TanzimTarihi.Value.Date != null)
                    {
                        sonucModel.TanzimTarihi = polSigortali.PoliceGenel.TanzimTarihi.Value.Date;
                    }
                    sonucModel.BrütPrim = polSigortali.PoliceGenel.BrutPrim != null ? polSigortali.PoliceGenel.BrutPrim : 0;
                    sonucModel.EkNo = polSigortali.PoliceGenel.EkNo.HasValue ? polSigortali.PoliceGenel.EkNo.Value.ToString() : null;
                    sonucModel.Komisyon = polSigortali.PoliceGenel.Komisyon;
                    sonucModel.NetPrim = polSigortali.PoliceGenel.NetPrim;
                    sonucModel.DovizliBrütPrim = polSigortali.PoliceGenel.DovizliBrutPrim;
                    sonucModel.DovizliKomisyon = polSigortali.PoliceGenel.DovizliKomisyon;
                    sonucModel.DovizliNetPrim = polSigortali.PoliceGenel.DovizliNetPrim;
                    sonucModel.OdemeSekli = polSigortali.PoliceGenel.OdemeSekli.HasValue ? polSigortali.PoliceGenel.OdemeSekli.Value.ToString() : null;
                    sonucModel.SigortaSirketi = polSigortali.PoliceGenel.SigortaSirketleri.SirketAdi;
                    sonucModel.PoliceNo = polSigortali.PoliceGenel.PoliceNumarasi;
                    sonucModel.TaksitSayisi = policetcvkn.OfflineSigortali.Find(s => s.PoliceId == polSigortali.PoliceId).PoliceGenel.PoliceOdemePlanis.Count();
                    sonucModel.Yeni_is = polSigortali.PoliceGenel.Yeni_is != null ? (int)polSigortali.PoliceGenel.Yeni_is : sonucModel.Yeni_is;
                    sonucModel.MuhasebeyeAktarildiMi = polSigortali.PoliceGenel.MuhasebeyeAktarildiMi;


                    if (polSigortali.PoliceGenel.BransKodu == BransKodlari.Kasko || polSigortali.PoliceGenel.BransKodu == BransKodlari.Trafik)

                    {
                        sonucModel.IlIlce = "";
                    }
                    else
                    {
                        sonucModel.IlIlce = polSigortali.PoliceGenel.PoliceSigortali.IlAdi + "/" + polSigortali.PoliceGenel.PoliceSigortali.IlceAdi;
                    }

                    if (polSigortali.PoliceGenel.PoliceArac != null)
                    {
                        sonucModel.PlakaKodu = polSigortali.PoliceGenel.PoliceArac.PlakaKodu;
                        sonucModel.PlakaNo = polSigortali.PoliceGenel.PoliceArac.PlakaNo;
                    }








                    if (sonucModel.OdemeSekli == "1")
                    {
                        sonucModel.OdemeTipi = "Peşin";
                    }
                    else
                    {
                        sonucModel.OdemeTipi = "Taksit";
                    }
                    var odemeTipleri = polSigortali.PoliceGenel.PoliceOdemePlanis.FirstOrDefault();
                    if (odemeTipleri != null)
                    {
                        sonucModel.OdemeTipim = odemeTipleri.OdemeTipi.ToString();
                    }
                    string odemetipi = sonucModel.OdemeTipim;
                    this.OdemeTipiText(ref odemetipi);
                    sonucModel.OdemeTipim = odemetipi;
                    model.listPolOffline.Add(sonucModel);
                }
            }
            #endregion

            #region plakaNo
            if (model.PlakaKodu != null && model.PlakaNo != null)
            {
                PoliceService.PoliceOffLineServiceModel policePlakaNo = _PoliceService.PoliceOffLinePlakaNo(ViewBag.AnaTVM, model.PlakaNo, model.PlakaKodu, _AktifKullaniciService.TVMKodu, model.Donem);
                PoliceGenel police = new PoliceGenel();
                for (int i = 0; i < policePlakaNo.OfflineGenel.Count(); i++)
                {
                    police = policePlakaNo.OfflineGenel[i];
                    sonucModel = new PoliceAraRaporOffLineModel();
                    sonucModel.PoliceId = police.PoliceId;
                    sonucModel.SigortaliUnvani = police.PoliceSigortali.AdiUnvan + " " + police.PoliceSigortali.SoyadiUnvan;
                    sonucModel.YenilemeNo = police.YenilemeNo.HasValue ? police.YenilemeNo.Value.ToString() : null;
                    sonucModel.BransAdi = police.BransAdi;
                    sonucModel.UrunAdi = police.TUMUrunAdi;



                    string tcK = police.PoliceSigortali.KimlikNo;
                    if (!String.IsNullOrEmpty(tcK))
                    {
                        police.PoliceSigortali.KimlikNo = tcK;
                        sonucModel.TcknVkn = police.PoliceSigortali.KimlikNo;
                    }

                    string vkn = police.PoliceSigortali.VergiKimlikNo;
                    if (!String.IsNullOrEmpty(vkn))
                    {
                        police.PoliceSigortali.VergiKimlikNo = vkn;
                        sonucModel.TcknVkn = police.PoliceSigortali.VergiKimlikNo;
                    }

                    //string tcKSEttiren = police.PoliceSigortaEttiren.KimlikNo;
                    //if (!String.IsNullOrEmpty(tcKSEttiren))
                    //{
                    //    police.PoliceSigortaEttiren.KimlikNo = tcKSEttiren;
                    //    sonucModel.TcknVkn = police.PoliceSigortaEttiren.KimlikNo;
                    //}


                    //string vknSEttiren = police.PoliceSigortaEttiren.VergiKimlikNo;
                    //if (!String.IsNullOrEmpty(vknSEttiren))
                    //{
                    //    police.PoliceSigortaEttiren.VergiKimlikNo = vknSEttiren;
                    //    sonucModel.TcknVkn = police.PoliceSigortaEttiren.VergiKimlikNo;
                    //}


                    if (police.PoliceSigortali.PoliceGenel.OnaylayanKullaniciKodu == null)
                    {
                        sonucModel.OnaylayanUnvan = "";
                    }

                    else
                    {
                        sonucModel.OnaylayanUnvan = police.TVMKullanicilar.Adi + " " + police.TVMKullanicilar.Soyadi;
                    }
                    sonucModel.ManuelPoliceMi = police.Durum;

                    if (police.TaliAcenteKodu != null)
                    {
                        sonucModel.TaliAcenteKodu = police.TaliAcenteKodu.Value.ToString();
                        var taliTvmUnvan = _TvmService.GetDetay(police.TaliAcenteKodu.Value);
                        sonucModel.TaliAcenteAdi = taliTvmUnvan != null ? taliTvmUnvan.Unvani : null;
                    }
                    if (police.UretimTaliAcenteKodu != null)
                    {
                        sonucModel.DisKaynakKodu = police.UretimTaliAcenteKodu.Value.ToString();
                        var disKaynakUnvan = _TvmService.GetDetay(police.UretimTaliAcenteKodu.Value);
                        sonucModel.DisKaynakAdi = disKaynakUnvan != null ? disKaynakUnvan.Unvani : null;
                    }
                    sonucModel.VerilenKomisyon = police.TaliKomisyon;
                    sonucModel.BaslangicTarihi = police.BaslangicTarihi;
                    if (police.BitisTarihi.Value.Date != null)
                    {
                        sonucModel.BitisTarihi = police.BitisTarihi.Value.Date;
                    }
                    if (police.TanzimTarihi.Value.Date != null)
                    {
                        sonucModel.TanzimTarihi = police.TanzimTarihi.Value.Date;
                    }
                    sonucModel.BrütPrim = police.PoliceSigortali.PoliceGenel.BrutPrim != null ? police.PoliceSigortali.PoliceGenel.BrutPrim : 0;
                    sonucModel.EkNo = police.EkNo.HasValue ? police.EkNo.Value.ToString() : null;
                    sonucModel.Komisyon = police.Komisyon;
                    sonucModel.NetPrim = police.NetPrim;
                    sonucModel.DovizliBrütPrim = police.DovizliBrutPrim;
                    sonucModel.DovizliKomisyon = police.DovizliKomisyon;
                    sonucModel.DovizliNetPrim = police.DovizliNetPrim;
                    sonucModel.OdemeSekli = police.OdemeSekli.HasValue ? police.OdemeSekli.Value.ToString() : null;
                    sonucModel.SigortaSirketi = police.SigortaSirketleri.SirketAdi;
                    sonucModel.PoliceNo = police.PoliceNumarasi;
                    sonucModel.TaksitSayisi = police.PoliceOdemePlanis.Count();
                    sonucModel.Yeni_is = Convert.ToInt32(police.Yeni_is != null ? police.Yeni_is : 0);
                    sonucModel.MuhasebeyeAktarildiMi = police.MuhasebeyeAktarildiMi;

                    if (police.PoliceArac != null)
                    {
                        sonucModel.PlakaKodu = police.PoliceArac.PlakaKodu;
                        sonucModel.PlakaNo = police.PoliceArac.PlakaNo;
                    }


                    if (police.BransKodu == BransKodlari.Kasko || police.BransKodu == BransKodlari.Trafik)

                    {
                        sonucModel.IlIlce = "";
                    }
                    else
                    {
                        sonucModel.IlIlce = police.PoliceSigortali.IlAdi + "/" + police.PoliceSigortali.IlceAdi;
                    }

                    if (sonucModel.OdemeSekli == "1")
                    {
                        sonucModel.OdemeTipi = "Peşin";
                    }
                    else
                    {
                        sonucModel.OdemeTipi = "Taksit";
                    }

                    var odemeTipleri = police.PoliceOdemePlanis.FirstOrDefault();
                    if (odemeTipleri != null)
                    {
                        sonucModel.OdemeTipim = odemeTipleri.OdemeTipi.ToString();
                    }

                    string odemetipi = sonucModel.OdemeTipim;
                    this.OdemeTipiText(ref odemetipi);
                    sonucModel.OdemeTipim = odemetipi;



                    model.listPolOffline.Add(sonucModel);
                }

            }
            #endregion

            #region Unvan
            if (model.Durum == 0)
            {
                if (model.Unvan != null && model.UnvanSoyad != null)
                {
                    model.Unvan = model.Unvan.Trim();
                    model.UnvanSoyad = model.UnvanSoyad.Trim();
                    PoliceService.PoliceOffLineServiceModel policeUnvan = _PoliceService.PoliceOffLineUnvan(ViewBag.AnaTVM, model.Unvan, model.UnvanSoyad, _AktifKullaniciService.TVMKodu, model.Durum, model.Donem);
                    PoliceGenel police = new PoliceGenel();
                    for (int i = 0; i < policeUnvan.OfflineGenel.Count(); i++)
                    {
                        police = policeUnvan.OfflineGenel[i];
                        sonucModel = new PoliceAraRaporOffLineModel();
                        sonucModel.PoliceId = police.PoliceId;
                        sonucModel.SigortaliUnvani = police.PoliceSigortali.AdiUnvan + " " + police.PoliceSigortali.SoyadiUnvan;
                        sonucModel.YenilemeNo = police.YenilemeNo.HasValue ? police.YenilemeNo.Value.ToString() : null;
                        sonucModel.BransAdi = police.BransAdi;
                        sonucModel.UrunAdi = police.TUMUrunAdi;



                        string tcK = police.PoliceSigortali.KimlikNo;
                        if (!String.IsNullOrEmpty(tcK))
                        {
                            police.PoliceSigortali.KimlikNo = tcK;
                            sonucModel.TcknVkn = police.PoliceSigortali.KimlikNo;
                        }

                        string vkn = police.PoliceSigortali.VergiKimlikNo;
                        if (!String.IsNullOrEmpty(vkn))
                        {
                            police.PoliceSigortali.VergiKimlikNo = vkn;
                            sonucModel.TcknVkn = police.PoliceSigortali.VergiKimlikNo;
                        }

                        //string tcKSEttiren = police.PoliceSigortaEttiren.KimlikNo;
                        //if (!String.IsNullOrEmpty(tcKSEttiren))
                        //{
                        //    police.PoliceSigortaEttiren.KimlikNo = tcKSEttiren;
                        //    sonucModel.TcknVkn = police.PoliceSigortaEttiren.KimlikNo;
                        //}


                        //string vknSEttiren = police.PoliceSigortaEttiren.VergiKimlikNo;
                        //if (!String.IsNullOrEmpty(vknSEttiren))
                        //{
                        //    police.PoliceSigortaEttiren.VergiKimlikNo = vknSEttiren;
                        //    sonucModel.TcknVkn = police.PoliceSigortaEttiren.VergiKimlikNo;
                        //}


                        if (police.PoliceSigortali.PoliceGenel.OnaylayanKullaniciKodu == null)
                        {
                            sonucModel.OnaylayanUnvan = "";
                        }

                        else
                        {
                            sonucModel.OnaylayanUnvan = police.TVMKullanicilar.Adi + " " + police.TVMKullanicilar.Soyadi;
                        }

                        sonucModel.ManuelPoliceMi = police.Durum;


                        if (police.TaliAcenteKodu != null)
                        {
                            sonucModel.TaliAcenteKodu = police.TaliAcenteKodu.Value.ToString();
                            var taliTvmUnvan = _TvmService.GetDetay(police.TaliAcenteKodu.Value);
                            sonucModel.TaliAcenteAdi = taliTvmUnvan != null ? taliTvmUnvan.Unvani : null;
                        }
                        if (police.UretimTaliAcenteKodu != null)
                        {
                            sonucModel.DisKaynakKodu = police.UretimTaliAcenteKodu.Value.ToString();
                            var disKaynakUnvan = _TvmService.GetDetay(police.UretimTaliAcenteKodu.Value);
                            sonucModel.DisKaynakAdi = disKaynakUnvan != null ? disKaynakUnvan.Unvani : null;
                        }
                        sonucModel.VerilenKomisyon = police.TaliKomisyon;
                        sonucModel.BaslangicTarihi = police.BaslangicTarihi;
                        if (police.BitisTarihi != null)
                        {
                            sonucModel.BitisTarihi = police.BitisTarihi.Value.Date;
                        }
                        if (police.TanzimTarihi.Value.Date != null)
                        {
                            sonucModel.TanzimTarihi = police.TanzimTarihi.Value.Date;
                        }
                        sonucModel.BrütPrim = police.BrutPrim != null ? police.BrutPrim : 0;
                        sonucModel.EkNo = police.EkNo.HasValue ? police.EkNo.Value.ToString() : null;
                        sonucModel.Komisyon = police.Komisyon;
                        sonucModel.NetPrim = police.NetPrim;
                        sonucModel.DovizliBrütPrim = police.DovizliBrutPrim;
                        sonucModel.DovizliKomisyon = police.DovizliKomisyon;
                        sonucModel.DovizliNetPrim = police.DovizliNetPrim;
                        sonucModel.OdemeSekli = police.OdemeSekli.HasValue ? police.OdemeSekli.Value.ToString() : null;
                        sonucModel.SigortaSirketi = police.SigortaSirketleri.SirketAdi;
                        sonucModel.PoliceNo = police.PoliceNumarasi;
                        sonucModel.TaksitSayisi = police.PoliceOdemePlanis.Count();
                        sonucModel.Yeni_is = Convert.ToInt32(police.Yeni_is != null ? police.Yeni_is : 0);
                        sonucModel.MuhasebeyeAktarildiMi = police.MuhasebeyeAktarildiMi;

                        if (police.PoliceArac != null)
                        {
                            sonucModel.PlakaKodu = police.PoliceArac.PlakaKodu;
                            sonucModel.PlakaNo = police.PoliceArac.PlakaNo;
                        }

                        if (police.BransKodu == BransKodlari.Kasko || police.BransKodu == BransKodlari.Trafik)

                        {
                            sonucModel.IlIlce = "";
                        }
                        //else
                        //{
                        //    sonucModel.IlIlce = police.PoliceArac.PoliceGenel.PoliceRizikoAdresi.Il + "/" + police.PoliceArac.PoliceGenel.PoliceRizikoAdresi.Ilce;
                        //} 
                        else
                        {
                            sonucModel.IlIlce = police.PoliceSigortali.IlAdi + "/" + police.PoliceSigortali.IlceAdi;
                        }


                        if (sonucModel.OdemeSekli == "1")
                        {
                            sonucModel.OdemeTipi = "Peşin";
                        }
                        else
                        {
                            sonucModel.OdemeTipi = "Taksit";
                        }
                        var odemeTipleri = police.PoliceOdemePlanis.FirstOrDefault();
                        if (odemeTipleri != null)
                        {
                            sonucModel.OdemeTipim = odemeTipleri.OdemeTipi.ToString();
                        }
                        string odemetipi = sonucModel.OdemeTipim;
                        this.OdemeTipiText(ref odemetipi);
                        sonucModel.OdemeTipim = odemetipi;
                        model.listPolOffline.Add(sonucModel);
                    }
                }
            }
            if (model.Durum == 1)
            {
                if (model.UnvanFirma != null)
                {
                    PoliceSigortali polSigortali = new PoliceSigortali();
                    model.UnvanFirma = model.UnvanFirma.Trim();
                    PoliceService.PoliceOffLineServiceModel policeUnvan = _PoliceService.PoliceOffLineFirmaUnvan(ViewBag.AnaTVM, model.UnvanFirma, _AktifKullaniciService.TVMKodu, model.Durum, model.Donem);
                    for (int i = 0; i < policeUnvan.OfflineSigortali.Count(); i++)
                    {
                        polSigortali = policeUnvan.OfflineSigortali[i];
                        sonucModel = new PoliceAraRaporOffLineModel();
                        sonucModel.PoliceId = polSigortali.PoliceId;
                        sonucModel.SigortaliUnvani = polSigortali.PoliceGenel.PoliceSigortali.AdiUnvan + " " + polSigortali.PoliceGenel.PoliceSigortali.SoyadiUnvan;
                        sonucModel.YenilemeNo = polSigortali.PoliceGenel.YenilemeNo.HasValue ? polSigortali.PoliceGenel.YenilemeNo.Value.ToString() : null;
                        sonucModel.BransAdi = polSigortali.PoliceGenel.BransAdi;
                        sonucModel.UrunAdi = polSigortali.PoliceGenel.TUMUrunAdi;



                        string tcK = polSigortali.KimlikNo;
                        if (!String.IsNullOrEmpty(tcK))
                        {
                            polSigortali.KimlikNo = tcK;
                            sonucModel.TcknVkn = polSigortali.KimlikNo;
                        }

                        string vkn = polSigortali.VergiKimlikNo;
                        if (!String.IsNullOrEmpty(vkn))
                        {
                            polSigortali.VergiKimlikNo = vkn;
                            sonucModel.TcknVkn = polSigortali.VergiKimlikNo;
                        }

                        //string tcKSEttiren = polSigortali.PoliceGenel.PoliceSigortaEttiren.KimlikNo;
                        //if (!String.IsNullOrEmpty(tcKSEttiren))
                        //{
                        //    polSigortali.PoliceGenel.PoliceSigortaEttiren.KimlikNo = tcKSEttiren;
                        //    sonucModel.TcknVkn = polSigortali.PoliceGenel.PoliceSigortaEttiren.KimlikNo;
                        //}


                        //string vknSEttiren = polSigortali.PoliceGenel.PoliceSigortaEttiren.VergiKimlikNo;
                        //if (!String.IsNullOrEmpty(vknSEttiren))
                        //{
                        //    polSigortali.PoliceGenel.PoliceSigortaEttiren.VergiKimlikNo = vknSEttiren;
                        //    sonucModel.TcknVkn = polSigortali.PoliceGenel.PoliceSigortaEttiren.VergiKimlikNo;
                        //}



                        if (polSigortali.PoliceGenel.PoliceSigortali.PoliceGenel.OnaylayanKullaniciKodu == null)
                        {
                            sonucModel.OnaylayanUnvan = "";
                        }

                        else
                        {
                            sonucModel.OnaylayanUnvan = polSigortali.PoliceGenel.TVMKullanicilar.Adi + " " + polSigortali.PoliceGenel.TVMKullanicilar.Soyadi;
                        }
                        sonucModel.ManuelPoliceMi = polSigortali.PoliceGenel.Durum;


                        if (polSigortali.PoliceGenel.TaliAcenteKodu != null)
                        {
                            sonucModel.TaliAcenteKodu = polSigortali.PoliceGenel.TaliAcenteKodu.Value.ToString();
                            var taliTvmUnvan = _TvmService.GetDetay(polSigortali.PoliceGenel.TaliAcenteKodu.Value);
                            sonucModel.TaliAcenteAdi = taliTvmUnvan != null ? taliTvmUnvan.Unvani : null;
                        }
                        if (polSigortali.PoliceGenel.UretimTaliAcenteKodu != null)
                        {
                            sonucModel.DisKaynakKodu = polSigortali.PoliceGenel.UretimTaliAcenteKodu.Value.ToString();
                            var disKaynakUnvan = _TvmService.GetDetay(polSigortali.PoliceGenel.UretimTaliAcenteKodu.Value);
                            sonucModel.DisKaynakAdi = disKaynakUnvan != null ? disKaynakUnvan.Unvani : null;
                        }
                        sonucModel.VerilenKomisyon = polSigortali.PoliceGenel.TaliKomisyon;
                        sonucModel.BaslangicTarihi = polSigortali.PoliceGenel.BaslangicTarihi;

                        if (polSigortali.PoliceGenel.BransKodu == BransKodlari.Kasko || polSigortali.PoliceGenel.BransKodu == BransKodlari.Trafik)

                        {
                            sonucModel.IlIlce = "";
                        }
                        else
                        {
                            sonucModel.IlIlce = polSigortali.PoliceGenel.PoliceSigortali.IlAdi + "/" + polSigortali.PoliceGenel.PoliceSigortali.IlceAdi;
                        }

                        if (polSigortali.PoliceGenel.PoliceArac != null)
                        {
                            sonucModel.PlakaKodu = polSigortali.PoliceGenel.PoliceArac.PlakaKodu;
                            sonucModel.PlakaNo = polSigortali.PoliceGenel.PoliceArac.PlakaNo;
                        }

                        if (polSigortali.PoliceGenel.BitisTarihi != null)
                        {
                            sonucModel.BitisTarihi = polSigortali.PoliceGenel.BitisTarihi.Value.Date;
                        }
                        if (polSigortali.PoliceGenel.TanzimTarihi.Value.Date != null)
                        {
                            sonucModel.TanzimTarihi = polSigortali.PoliceGenel.TanzimTarihi.Value.Date;
                        }
                        sonucModel.BrütPrim = polSigortali.PoliceGenel.BrutPrim;
                        sonucModel.EkNo = polSigortali.PoliceGenel.EkNo.HasValue ? polSigortali.PoliceGenel.EkNo.Value.ToString() : null;
                        sonucModel.Komisyon = polSigortali.PoliceGenel.Komisyon;
                        sonucModel.NetPrim = polSigortali.PoliceGenel.NetPrim;
                        sonucModel.DovizliBrütPrim = polSigortali.PoliceGenel.DovizliBrutPrim;
                        sonucModel.DovizliKomisyon = polSigortali.PoliceGenel.DovizliKomisyon;
                        sonucModel.DovizliNetPrim = polSigortali.PoliceGenel.DovizliNetPrim;
                        sonucModel.OdemeSekli = polSigortali.PoliceGenel.OdemeSekli.HasValue ? polSigortali.PoliceGenel.OdemeSekli.Value.ToString() : null;
                        sonucModel.SigortaSirketi = polSigortali.PoliceGenel.SigortaSirketleri.SirketAdi;
                        sonucModel.PoliceNo = polSigortali.PoliceGenel.PoliceNumarasi;
                        sonucModel.TaksitSayisi = polSigortali.PoliceGenel.PoliceOdemePlanis.Count();
                        sonucModel.Yeni_is = Convert.ToInt32(polSigortali.PoliceGenel.Yeni_is != null ? polSigortali.PoliceGenel.Yeni_is : 0);
                        if (sonucModel.OdemeSekli == "1")
                        {
                            sonucModel.OdemeTipi = "Peşin";
                        }
                        else
                        {
                            sonucModel.OdemeTipi = "Taksit";
                        }
                        var odemeTipleri = polSigortali.PoliceGenel.PoliceOdemePlanis.FirstOrDefault();
                        if (odemeTipleri != null)
                        {
                            sonucModel.OdemeTipim = odemeTipleri.OdemeTipi.ToString();
                        }
                        string odemetipi = sonucModel.OdemeTipim;
                        this.OdemeTipiText(ref odemetipi);
                        sonucModel.OdemeTipim = odemetipi;
                        model.listPolOffline.Add(sonucModel);
                    }
                }
            }

            #endregion


            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.AnaTVM = false;
            }

            return View(model);
        }
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceYaslandirmaTablosu, SekmeKodu = 0)]
        public ActionResult PoliceYaslandirmaTablosu()
        {
            PoliceYaslandirmaTablosuModel model = new PoliceYaslandirmaTablosuModel();
            ViewBag.AcenteTipi = _AktifKullaniciService.TvmTipi;
            List<SelectListItem> raporTipleri = new List<SelectListItem>();
            raporTipleri.AddRange(new SelectListItem[] {
                    new SelectListItem() { Value = "0"  , Text = babonline.All /*"Tümü"*/},
                    new SelectListItem() { Value = "1"  , Text = babonline.Unpaid /*"Ödenmemişler"*/},
                    new SelectListItem() { Value = "2"  , Text = babonline.Paid /*"Ödenmişler"*/},
                });
            model.RaporTipi = "0";
            model.RaporTipleri = new SelectList(raporTipleri, "Value", "Text", model.RaporTipi).ToList();
            List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");
            return View(model);
        }
        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceYaslandirmaTablosu, SekmeKodu = 0)]
        public ActionResult PoliceYaslandirmaTablosu(PoliceYaslandirmaTablosuModel model)
        {

            //PoliceAraRaporOffLineModel sonucModel;
            List<SelectListItem> raporTipleri = new List<SelectListItem>();
            ViewBag.AcenteTipi = _AktifKullaniciService.TvmTipi;
            raporTipleri.AddRange(new SelectListItem[] {
                    new SelectListItem() { Value = "0"  , Text = babonline.AllOf},
                    new SelectListItem() { Value = "1"  , Text = babonline.Owing},
                    new SelectListItem() { Value = "2"  , Text = babonline.Paid_Up},
                });
            model.RaporTipleri = new SelectList(raporTipleri, "Value", "Text", model.RaporTipi).ToList();

            if (!model.BaslangicTarihi.HasValue || !model.BitisTarihi.HasValue)
            {
                model.Mesaj = babonline.Please_Select_Date;
            }
            else if (model.BaslangicTarihi.HasValue && model.BitisTarihi.HasValue)
            {
                //6 aylık sorgulama yapma için kontrol simdilik pasif
                //var tempdatediff = (model.BitisTarihi.Value.Month - model.BaslangicTarihi.Value.Month);
                //if (tempdatediff>6)
                //{
                //    model.Mesaj = babonline._warningYouCanQueryMax6MonthlyReports;
                //}
            }
            List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");
            if (string.IsNullOrEmpty(model.Mesaj))
                model = _PoliceService.getBrokerPoliceRapor(model);

            return View(model);
        }
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceTeklifListesiUWDetayli, SekmeKodu = 0)]
        public ActionResult PoliceTeklifListesiUwDetayli()
        {
            TeklifPoliceListesiUWDetay model = new TeklifPoliceListesiUWDetay();

            try
            {
                model.durum = 2;
                model.durumlar = new SelectList(DurumListesiAktifPasif.TeklifPoliceListesi(), "Value", "Text", "0");
                model.TVMKodu = _AktifKullaniciService.TVMKodu;
                model.TVMUnvani = _AktifKullaniciService.TVMUnvani;
                ViewBag.AcenteTipi = _AktifKullaniciService.TvmTipi;
                model.BaslangicTarihi = TurkeyDateTime.Now.AddDays(-2);
                model.BitisTarihi = TurkeyDateTime.Now;
                //model.RaporSonuc = new List<PoliceListesiOfflineRaporProcedureModel>();

                model.PoliceTarihiTipleri = new SelectList(RaporListProvider.GetPoliceTarihiTipleri(), "Value", "Text", "0").ToList();

                List<Bran> brans = _BransService.GetListBroker();
                model.BranslarItems = new MultiSelectList(brans, "BransKodu", "BransAdi");

                model.TVMLerItems = new MultiSelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
                model.uretimTvmler = new MultiSelectList(_TVMService.GetDisUretimTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");

                model.procedurePoliceOfflineList = new List<ReasurorPoliceListesiProcedureModel>();
                model.procedureTeklifOfflineList = new List<ReasurorTeklifListesiProcedureModel>();

                List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
                model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");

                model.OdemeTipleri = new SelectList(OdemeTipleriRaporModel.OdemeTipleriList(), "Value", "Text", "").ListWithOptionLabel();
                model.OdemeSekilleri = new SelectList(OdemeSekilleriRaporModel.OdemeSekilleriList(), "Value", "Text", "").ListWithOptionLabel();

                ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
                _TvmService = DependencyResolver.Current.GetService<ITVMService>();
                bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
                var getTVMDetay = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu);
                if (getTVMDetay != null)
                {
                    int KontrolTVMKod = getTVMDetay.BagliOlduguTVMKodu;
                    if (tvmTaliVar || KontrolTVMKod == -9999)
                    {
                        ViewBag.AnaTVM = true;
                    }
                    else
                    {
                        ViewBag.AnaTVM = false;
                    }

                    if (getTVMDetay.BolgeYetkilisiMi == 1)
                    {
                        model.BolgeYetkilisiMi = true;
                    }
                }
            }
            catch (Exception ex)
            {

                throw;
            }


            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.AnaTVM = false;
            }
            return View(model);
        }
        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceTeklifListesiUWDetayli, SekmeKodu = 0)]
        public ActionResult PoliceTeklifListesiUwDetayli(TeklifPoliceListesiUWDetay model)
        {
            #region multiselects / branslar - tvmler - sirketler

            if (model.TVMLerSelectList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.TVMLerSelectList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.TVMListe = String.Empty;
                if (liste.Count > 0)
                {
                    for (int i = 0; i < liste.Count; i++)
                    {
                        if (i != liste.Count - 1)
                            model.TVMListe = model.TVMListe + liste[i] + ",";
                        else model.TVMListe = model.TVMListe + liste[i];
                    }
                }
                else
                {
                    model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
                }

            }
            else
            {
                model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
            }
            if (model.SigortaSirketleriSelectList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.SigortaSirketleriSelectList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.SigortaSirket = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.SigortaSirket = model.SigortaSirket + liste[i] + ",";
                    else model.SigortaSirket = model.SigortaSirket + liste[i];
                }
            }
            if (model.BransSelectList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.BransSelectList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.BransList = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.BransList = model.BransList + liste[i] + ",";
                    else model.BransList = model.BransList + liste[i];
                }
            }
            if (model.uretimTvmList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.uretimTvmList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.UretimTVMListe = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.UretimTVMListe = model.UretimTVMListe + liste[i] + ",";
                    else model.UretimTVMListe = model.UretimTVMListe + liste[i];
                }
            }
            else
            {
                // model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
                model.UretimTVMListe = String.Empty;
            }
            //else
            //{
            //    // model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
            //    model.TVMListe = String.Empty;
            //}

            #endregion

            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TVMUnvani = _AktifKullaniciService.TVMUnvani;
            ViewBag.AcenteTipi = _AktifKullaniciService.TvmTipi;

            int anaTVMKodu = _AktifKullaniciService.TVMKodu;
            List<Bran> brans = _BransService.GetListBroker();
            model.BranslarItems = new MultiSelectList(brans, "BransKodu", "BransAdi");

            model.durumlar = new SelectList(DurumListesiAktifPasif.TeklifPoliceListesi(), "Value", "Text", model.durum);
            List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");

            //model.tvmler = new MultiSelectList(_TaliPoliceService.GetYetkiliTVM(model.TVMKodu).OrderBy(s => s.Unvani), "Kodu", "Unvani");

            model.TVMLerItems = new MultiSelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.uretimTvmler = new MultiSelectList(_TVMService.GetDisUretimTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");

            model.OdemeTipleri = new SelectList(OdemeTipleriRaporModel.OdemeTipleriList(), "Value", "Text", "").ListWithOptionLabel();
            model.OdemeSekilleri = new SelectList(OdemeSekilleriRaporModel.OdemeSekilleriList(), "Value", "Text", "").ListWithOptionLabel();

            model.PoliceTarihiTipleri = new SelectList(RaporListProvider.GetPoliceTarihiTipleri(), "Value", "Text", "0").ToList();

            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            int KontrolTVMKod = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
            TVMDetay tvmDetay = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu);


            if (tvmDetay.BolgeYetkilisiMi == 1)
            {
                model.BolgeYetkilisiMi = true;
            }
            byte Merkez = 0;
            if (tvmDetay != null && tvmDetay.BagliOlduguTVMKodu == -9999)
            {
                Merkez = 1;
            }

            anaTVMKodu = _AktifKullaniciService.TVMKodu;

            // teklif Liste Arama
            if (model.durum == 1)
            {

                if (tvmTaliVar || KontrolTVMKod == -9999)
                {
                    #region   talisi olan anaacente ya da talisi olmayan anaacanete
                    if (model.TVMListe != "" || model.PoliceNo != null)
                    {
                        model.procedureTeklifOfflineList = new List<ReasurorTeklifListesiProcedureModel>();
                        model.procedureTeklifOfflineList = _RaporService.ReasurorTeklifListesi(model.TVMKodu, model.PoliceTarihTipi, model.BaslangicTarihi, model.BitisTarihi, model.TVMListe,
                                                       model.SigortaSirket, model.BransList,
                                                       model.PoliceNo, model.OdemeSekli, model.OdemeTipi, anaTVMKodu, model.UretimTVMListe);
                    }
                    #endregion
                }
                else
                {
                    #region tali tvm
                    anaTVMKodu = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
                    if (anaTVMKodu == -9999)
                    {
                        anaTVMKodu = _AktifKullaniciService.TVMKodu;
                    }
                    if (model.TVMListe != "" || model.PoliceNo != null)
                    {
                        model.procedureTeklifOfflineList = new List<ReasurorTeklifListesiProcedureModel>();
                        model.procedureTeklifOfflineList = _RaporService.ReasurorTeklifListesi(model.TVMKodu, model.PoliceTarihTipi, model.BaslangicTarihi, model.BitisTarihi, model.TVMListe,
                                                       model.SigortaSirket, model.BransList,
                                                       model.PoliceNo, model.OdemeSekli, model.OdemeTipi, anaTVMKodu, model.UretimTVMListe);

                    }
                    ViewBag.AnaTVM = false;
                    #endregion
                }
            }
            //poliçe Liste Arama
            else
            {
                if (tvmTaliVar || KontrolTVMKod == -9999)
                {
                    #region   talisi olan anaacente ya da talisi olmayan anaacanete
                    if (model.TVMListe != "" || model.PoliceNo != null)
                    {
                        model.procedurePoliceOfflineList = new List<ReasurorPoliceListesiProcedureModel>();
                        model.procedurePoliceOfflineList = _RaporService.ReasurorPoliceListesi(model.TVMKodu, model.PoliceTarihTipi, model.BaslangicTarihi, model.BitisTarihi, model.TVMListe,
                                                       model.SigortaSirket, model.BransList,
                                                       model.PoliceNo, model.OdemeSekli, model.OdemeTipi, anaTVMKodu, model.UretimTVMListe);
                    }
                    ViewBag.AnaTVM = true;

                    #endregion
                }
                else
                {
                    #region tali tvm
                    anaTVMKodu = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
                    if (anaTVMKodu == -9999)
                    {
                        anaTVMKodu = _AktifKullaniciService.TVMKodu;
                    }
                    if (model.TVMListe != "" || model.PoliceNo != null)
                    {
                        model.procedurePoliceOfflineList = new List<ReasurorPoliceListesiProcedureModel>();
                        model.procedurePoliceOfflineList = _RaporService.ReasurorPoliceListesi(model.TVMKodu, model.PoliceTarihTipi, model.BaslangicTarihi, model.BitisTarihi, model.TVMListe,
                                                       model.SigortaSirket, model.BransList,
                                                       model.PoliceNo, model.OdemeSekli, model.OdemeTipi, anaTVMKodu, model.UretimTVMListe);

                    }
                    ViewBag.AnaTVM = false;
                    #endregion
                }
            }



            #region değerleri sıfırlama
            model.GenelPolToplamSayac = 0;
            model.GenelZeylToplamSayac = 0;
            #region eski toplamtutar tanımlamalari
            //tahakkuk toplam
            model.ToplamTeminatTutariTLTahakkuk = 0;
            model.ToplamYurtdisiPrimTLTahakkuk = 0;
            model.ToplamYurtdisiDisKaynakKomisyonTLTahakkuk = 0;
            model.ToplamYurtdisiAlinanKomisyonTLTahakkuk = 0;
            model.ToplamFrontingSigortaSirketiKomisyonTLTahakkuk = 0;
            model.ToplamSatisKanaliKomisyonTLTahakkuk = 0;
            model.ToplamYurticiAlinanKomisyonTLTahakkuk = 0;
            model.ToplamYurtdisiNetPrimTLTahakkuk = 0;
            model.ToplamYurtdisiBrokerNetPrimTLTahakkuk = 0;
            model.ToplamYurticiNetPrimTLTahakkuk = 0;
            model.ToplamYurticiBrutPrimTLTahakkuk = 0;
            model.ToplamBsmvTLTahakkuk = 0;

            //iptal toplam 
            model.ToplamTeminatTutariTLIptal = 0;
            model.ToplamYurtdisiPrimTLIptal = 0;
            model.ToplamYurtdisiDisKaynakKomisyonTLIptal = 0;
            model.ToplamYurtdisiAlinanKomisyonTLIptal = 0;
            model.ToplamFrontingSigortaSirketiKomisyonTLIptal = 0;
            model.ToplamSatisKanaliKomisyonTLIptal = 0;
            model.ToplamYurticiAlinanKomisyonTLIptal = 0;
            model.ToplamYurtdisiNetPrimTLIptal = 0;
            model.ToplamYurtdisiBrokerNetPrimTLIptal = 0;
            model.ToplamYurticiNetPrimTLIptal = 0;
            model.ToplamYurticiBrutPrimTLIptal = 0;
            model.ToplamBsmvTLIptal = 0;

            // genel toplam (tahakkuk + iptal)
            model.ToplamTeminatTutariTL = 0;
            model.ToplamYurtdisiPrimTL = 0;
            model.ToplamYurtdisiDisKaynakKomisyonTL = 0;
            model.ToplamYurtdisiAlinanKomisyonTL = 0;
            model.ToplamFrontingSigortaSirketiKomisyonTL = 0;
            model.ToplamSatisKanaliKomisyonTL = 0;
            model.ToplamYurticiAlinanKomisyonTL = 0;
            model.ToplamYurtdisiNetPrimTL = 0;
            model.ToplamYurtdisiBrokerNetPrimTL = 0;
            model.ToplamYurticiNetPrimTL = 0;
            model.ToplamYurticiBrutPrimTL = 0;
            model.ToplamBsmvTL = 0;

            // dolar
            model.ToplamDolarTeminatTutari = 0;
            model.ToplamDolarYurtdisiPrim = 0;
            model.ToplamDolarYurtdisiDisKaynakKomisyon = 0;
            model.ToplamDolarYurtdisiAlinanKomisyon = 0;
            model.ToplamDolarFrontingSigortaSirketiKomisyon = 0;
            model.ToplamDolarSatisKanaliKomisyon = 0;
            model.ToplamDolarYurticiAlinanKomisyon = 0;
            model.ToplamDolarYurtdisiNetPrim = 0;
            model.ToplamDolarYurtdisiBrokerNetPrim = 0;
            model.ToplamDolarYurticiNetPrim = 0;
            model.ToplamDolarYurticiBrutPrim = 0;
            model.ToplamDolarBsmv = 0;

            //euro

            model.ToplamEuroTeminatTutari = 0;
            model.ToplamEuroYurtdisiPrim = 0;
            model.ToplamEuroYurtdisiDisKaynakKomisyon = 0;
            model.ToplamEuroYurtdisiAlinanKomisyon = 0;
            model.ToplamEuroFrontingSigortaSirketiKomisyon = 0;
            model.ToplamEuroSatisKanaliKomisyon = 0;
            model.ToplamEuroYurticiAlinanKomisyon = 0;
            model.ToplamEuroYurtdisiNetPrim = 0;
            model.ToplamEuroYurtdisiBrokerNetPrim = 0;
            model.ToplamEuroYurticiNetPrim = 0;
            model.ToplamEuroYurticiBrutPrim = 0;
            model.ToplamEuroBsmv = 0;

            //aed

            model.ToplamAedTeminatTutari = 0;
            model.ToplamAedYurtdisiPrim = 0;
            model.ToplamAedYurtdisiDisKaynakKomisyon = 0;
            model.ToplamAedYurtdisiAlinanKomisyon = 0;
            model.ToplamAedFrontingSigortaSirketiKomisyon = 0;
            model.ToplamAedSatisKanaliKomisyon = 0;
            model.ToplamAedYurticiAlinanKomisyon = 0;
            model.ToplamAedYurtdisiNetPrim = 0;
            model.ToplamAedYurtdisiBrokerNetPrim = 0;
            model.ToplamAedYurticiNetPrim = 0;
            model.ToplamAedYurticiBrutPrim = 0;
            model.ToplamAedBsmv = 0;
            #endregion

            #endregion
            if (model.procedurePoliceOfflineList != null)
            {
                if (model.procedurePoliceOfflineList.Count > 0)
                {
                    model.TeklifPoliceUWToplamItem = new List<TeklifPoliceParaBirimiToplamItem>();
                    TeklifPoliceParaBirimiToplamItem teklifPoliceParaBirimiToplamItem;
                    for (int i = model.procedurePoliceOfflineList.Count - 1; i >= 0; i--)
                    {
                        var underwriters = _TeklifService.getUnderwriters(model.procedurePoliceOfflineList[i].PoliceId.ToString(), "");
                        if (underwriters == null || underwriters.Count == 0)
                        {
                            continue;
                        }
                        else
                        {
                            model.Underwriters.Add(new UWDetayUnderwritersListItem { PoliceId = model.procedurePoliceOfflineList[i].PoliceId, Underwriters = underwriters });
                        }
                        var topPoliceSayac = 0;
                        var topZeylSayac = 0;
                        if (model.procedurePoliceOfflineList[i].SirketAdi == "ALLIANZ SİGORTA A.Ş." && model.procedurePoliceOfflineList[i].EkNo == 1)
                        {
                            topPoliceSayac++;
                        }
                        else if (model.procedurePoliceOfflineList[i].EkNo == 0 && model.procedurePoliceOfflineList[i].SirketAdi != "ALLIANZ SİGORTA A.Ş.")
                        {
                            topPoliceSayac++;
                        }
                        else if (model.procedurePoliceOfflineList[i].EkNo != 0 && model.procedurePoliceOfflineList[i].SirketAdi != "ALLIANZ SİGORTA A.Ş.")
                        {
                            topZeylSayac++;
                        }
                        else if (model.procedurePoliceOfflineList[i].SirketAdi == "ALLIANZ SİGORTA A.Ş." && model.procedurePoliceOfflineList[i].BransAdi == "DASK" && model.procedurePoliceOfflineList[i].EkNo.ToString().Length > 3)
                        {
                            if (model.procedurePoliceOfflineList[i].EkNo.ToString().Substring(4, 1) == "1")
                            {
                                topPoliceSayac++;
                            }
                            else
                            {
                                topZeylSayac++;
                            }
                        }
                        else
                        {
                            topZeylSayac++;
                        }
                        model.GenelPolToplamSayac += topPoliceSayac;
                        model.GenelZeylToplamSayac += topZeylSayac;

                        if (model.TeklifPoliceUWToplamItem.Where(x => x.ParaBirimi == model.procedurePoliceOfflineList[i].ParaBirimi).FirstOrDefault() == null)
                        {
                            teklifPoliceParaBirimiToplamItem = new TeklifPoliceParaBirimiToplamItem();
                            teklifPoliceParaBirimiToplamItem.ParaBirimi = model.procedurePoliceOfflineList[i].ParaBirimi;
                            teklifPoliceParaBirimiToplamItem.ToplamYurtdisiAlinanKomisyon = 0;
                            teklifPoliceParaBirimiToplamItem.ToplamYurtdisiDisKaynakKomisyon = 0;
                            teklifPoliceParaBirimiToplamItem.ToplamYurtdisiNetPrim = 0;
                            teklifPoliceParaBirimiToplamItem.PoliceId = model.procedurePoliceOfflineList[i].PoliceId;
                            if (model.procedurePoliceOfflineList[i].ParaBirimi.Trim() != "TL")
                            {
                                teklifPoliceParaBirimiToplamItem.ToplamBsmv = model.procedurePoliceOfflineList[i].Bsmv;
                                teklifPoliceParaBirimiToplamItem.ToplamFrontingSigortaSirketiKomisyon = model.procedurePoliceOfflineList[i].FrontingSigortaSirketiKomisyon;
                                teklifPoliceParaBirimiToplamItem.ToplamSatisKanaliKomisyon = model.procedurePoliceOfflineList[i].SatisKanaliKomisyon;
                                teklifPoliceParaBirimiToplamItem.ToplamTeminatTutari = model.procedurePoliceOfflineList[i].TeminatTutari;
                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiAlinanKomisyon = model.procedurePoliceOfflineList[i].YurtdisiAlinanKomisyon;
                                teklifPoliceParaBirimiToplamItem.ToplamYurtdisiBrokerNetPrim = model.procedurePoliceOfflineList[i].YurtdisiBrokerNetPrim;
                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiDisKaynakKomisyon = model.procedurePoliceOfflineList[i].YurtdisiDisKaynakKomisyon;
                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiNetPrim = model.procedurePoliceOfflineList[i].YurtdisiNetPrim;
                                teklifPoliceParaBirimiToplamItem.ToplamYurtdisiPrim = model.procedurePoliceOfflineList[i].YurtdisiPrim;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiAlinanKomisyon = model.procedurePoliceOfflineList[i].YurticiAlinanKomisyon;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiBrutPrim = model.procedurePoliceOfflineList[i].YurticiBrutPrim;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiNetPrim = model.procedurePoliceOfflineList[i].YurticiNetPrim;

                            }
                            else
                            {
                                teklifPoliceParaBirimiToplamItem.ToplamBsmv = model.procedurePoliceOfflineList[i].BsmvTL;
                                teklifPoliceParaBirimiToplamItem.ToplamFrontingSigortaSirketiKomisyon = model.procedurePoliceOfflineList[i].FrontingSigortaSirketiKomisyonTL;
                                teklifPoliceParaBirimiToplamItem.ToplamSatisKanaliKomisyon = model.procedurePoliceOfflineList[i].SatisKanaliKomisyonTL;
                                teklifPoliceParaBirimiToplamItem.ToplamTeminatTutari = model.procedurePoliceOfflineList[i].TeminatTutariTL;
                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiAlinanKomisyon = model.procedurePoliceOfflineList[i].YurtdisiAlinanKomisyonTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurtdisiBrokerNetPrim = model.procedurePoliceOfflineList[i].YurtdisiBrokerNetPrimTL;
                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiDisKaynakKomisyon = model.procedurePoliceOfflineList[i].YurtdisiDisKaynakKomisyonTL;
                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiNetPrim = model.procedurePoliceOfflineList[i].YurtdisiNetPrimTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurtdisiPrim = model.procedurePoliceOfflineList[i].YurtdisiPrimTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiAlinanKomisyon = model.procedurePoliceOfflineList[i].YurticiAlinanKomisyonTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiBrutPrim = model.procedurePoliceOfflineList[i].YurticiBrutPrimTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiNetPrim = model.procedurePoliceOfflineList[i].YurticiNetPrimTL;
                            }
                            model.TeklifPoliceUWToplamItem.Add(teklifPoliceParaBirimiToplamItem);
                        }
                        else
                        {
                            teklifPoliceParaBirimiToplamItem = model.TeklifPoliceUWToplamItem.Where(x => x.ParaBirimi == model.procedurePoliceOfflineList[i].ParaBirimi).FirstOrDefault();
                            if (model.procedurePoliceOfflineList[i].ParaBirimi.Trim() != "TL")
                            {
                                teklifPoliceParaBirimiToplamItem.ToplamBsmv += model.procedurePoliceOfflineList[i].Bsmv;
                                teklifPoliceParaBirimiToplamItem.ToplamFrontingSigortaSirketiKomisyon += model.procedurePoliceOfflineList[i].FrontingSigortaSirketiKomisyon;
                                teklifPoliceParaBirimiToplamItem.ToplamSatisKanaliKomisyon += model.procedurePoliceOfflineList[i].SatisKanaliKomisyon;
                                teklifPoliceParaBirimiToplamItem.ToplamTeminatTutari += model.procedurePoliceOfflineList[i].TeminatTutari;

                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurtdisiAlinanKomisyon;
                                teklifPoliceParaBirimiToplamItem.ToplamYurtdisiBrokerNetPrim += model.procedurePoliceOfflineList[i].YurtdisiBrokerNetPrim;

                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiDisKaynakKomisyon += model.procedurePoliceOfflineList[i].YurtdisiDisKaynakKomisyon;

                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiNetPrim += model.procedurePoliceOfflineList[i].YurtdisiNetPrim;
                                teklifPoliceParaBirimiToplamItem.ToplamYurtdisiPrim += model.procedurePoliceOfflineList[i].YurtdisiPrim;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurticiAlinanKomisyon;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiBrutPrim += model.procedurePoliceOfflineList[i].YurticiBrutPrim;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiNetPrim += model.procedurePoliceOfflineList[i].YurticiNetPrim;

                            }
                            else
                            {
                                teklifPoliceParaBirimiToplamItem.ToplamBsmv += model.procedurePoliceOfflineList[i].BsmvTL;
                                teklifPoliceParaBirimiToplamItem.ToplamFrontingSigortaSirketiKomisyon += model.procedurePoliceOfflineList[i].FrontingSigortaSirketiKomisyonTL;
                                teklifPoliceParaBirimiToplamItem.ToplamSatisKanaliKomisyon += model.procedurePoliceOfflineList[i].SatisKanaliKomisyonTL;
                                teklifPoliceParaBirimiToplamItem.ToplamTeminatTutari += model.procedurePoliceOfflineList[i].TeminatTutariTL;
                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurtdisiAlinanKomisyonTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurtdisiBrokerNetPrim += model.procedurePoliceOfflineList[i].YurtdisiBrokerNetPrimTL;
                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiDisKaynakKomisyon += model.procedurePoliceOfflineList[i].YurtdisiDisKaynakKomisyonTL;
                                //teklifPoliceParaBirimiToplamItem.ToplamYurtdisiNetPrim += model.procedurePoliceOfflineList[i].YurtdisiNetPrimTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurtdisiPrim += model.procedurePoliceOfflineList[i].YurtdisiPrimTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurticiAlinanKomisyonTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiBrutPrim += model.procedurePoliceOfflineList[i].YurticiBrutPrimTL;
                                teklifPoliceParaBirimiToplamItem.ToplamYurticiNetPrim += model.procedurePoliceOfflineList[i].YurticiNetPrimTL;
                            }
                        }

                        #region eski toplamtutar kod blogu
                        //if (model.procedurePoliceOfflineList[i].YurticiBrutPrimTL > 0)
                        //{
                        //    //tahakkuk toplam
                        //    model.ToplamTeminatTutariTLTahakkuk += model.procedurePoliceOfflineList[i].TeminatTutariTL;
                        //    model.ToplamYurtdisiPrimTLTahakkuk += model.procedurePoliceOfflineList[i].YurtdisiPrimTL;
                        //    model.ToplamYurtdisiDisKaynakKomisyonTLTahakkuk += model.procedurePoliceOfflineList[i].YurtdisiDisKaynakKomisyonTL;
                        //    model.ToplamYurtdisiAlinanKomisyonTLTahakkuk += model.procedurePoliceOfflineList[i].YurtdisiAlinanKomisyonTL;
                        //    model.ToplamFrontingSigortaSirketiKomisyonTLTahakkuk += model.procedurePoliceOfflineList[i].FrontingSigortaSirketiKomisyonTL;
                        //    model.ToplamSatisKanaliKomisyonTLTahakkuk += model.procedurePoliceOfflineList[i].SatisKanaliKomisyonTL;
                        //    model.ToplamYurticiAlinanKomisyonTLTahakkuk += model.procedurePoliceOfflineList[i].YurticiAlinanKomisyonTL;
                        //    model.ToplamYurtdisiNetPrimTLTahakkuk += model.procedurePoliceOfflineList[i].YurtdisiNetPrimTL;
                        //    model.ToplamYurtdisiBrokerNetPrimTLTahakkuk += model.procedurePoliceOfflineList[i].YurtdisiBrokerNetPrimTL;
                        //    model.ToplamYurticiNetPrimTLTahakkuk += model.procedurePoliceOfflineList[i].YurticiNetPrimTL;
                        //    model.ToplamYurticiBrutPrimTLTahakkuk += model.procedurePoliceOfflineList[i].YurticiBrutPrimTL;
                        //    model.ToplamBsmvTLTahakkuk += model.procedurePoliceOfflineList[i].BsmvTL;
                        //}
                        //else
                        //{
                        //    //iptal toplam 
                        //    model.ToplamTeminatTutariTLIptal += model.procedurePoliceOfflineList[i].TeminatTutariTL;
                        //    model.ToplamYurtdisiPrimTLIptal += model.procedurePoliceOfflineList[i].YurtdisiPrimTL;
                        //    model.ToplamYurtdisiDisKaynakKomisyonTLIptal += model.procedurePoliceOfflineList[i].YurtdisiDisKaynakKomisyonTL;
                        //    model.ToplamYurtdisiAlinanKomisyonTLIptal += model.procedurePoliceOfflineList[i].YurtdisiAlinanKomisyonTL;
                        //    model.ToplamFrontingSigortaSirketiKomisyonTLIptal += model.procedurePoliceOfflineList[i].FrontingSigortaSirketiKomisyonTL;
                        //    model.ToplamSatisKanaliKomisyonTLIptal += model.procedurePoliceOfflineList[i].SatisKanaliKomisyonTL;
                        //    model.ToplamYurticiAlinanKomisyonTLIptal += model.procedurePoliceOfflineList[i].YurticiAlinanKomisyonTL;
                        //    model.ToplamYurtdisiNetPrimTLIptal += model.procedurePoliceOfflineList[i].YurtdisiNetPrimTL;
                        //    model.ToplamYurtdisiBrokerNetPrimTLIptal += model.procedurePoliceOfflineList[i].YurtdisiBrokerNetPrimTL;
                        //    model.ToplamYurticiNetPrimTLIptal += model.procedurePoliceOfflineList[i].YurticiNetPrimTL;
                        //    model.ToplamYurticiBrutPrimTLIptal += model.procedurePoliceOfflineList[i].YurticiBrutPrimTL;
                        //    model.ToplamBsmvTLIptal += model.procedurePoliceOfflineList[i].BsmvTL;

                        //}

                        //// dolar
                        //if (model.procedurePoliceOfflineList[i].ParaBirimi == "USD")
                        //{
                        //    model.ToplamDolarTeminatTutari += model.procedurePoliceOfflineList[i].TeminatTutari;
                        //    model.ToplamDolarYurtdisiPrim += model.procedurePoliceOfflineList[i].YurtdisiPrim;
                        //    model.ToplamDolarYurtdisiDisKaynakKomisyon += model.procedurePoliceOfflineList[i].YurtdisiDisKaynakKomisyon;
                        //    model.ToplamDolarYurtdisiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurtdisiAlinanKomisyon;
                        //    model.ToplamDolarFrontingSigortaSirketiKomisyon += model.procedurePoliceOfflineList[i].FrontingSigortaSirketiKomisyon;
                        //    model.ToplamDolarSatisKanaliKomisyon += model.procedurePoliceOfflineList[i].SatisKanaliKomisyon;
                        //    model.ToplamDolarYurticiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurticiAlinanKomisyon;
                        //    model.ToplamDolarYurtdisiNetPrim += model.procedurePoliceOfflineList[i].YurtdisiNetPrim;
                        //    model.ToplamDolarYurtdisiBrokerNetPrim += model.procedurePoliceOfflineList[i].YurtdisiBrokerNetPrim;
                        //    model.ToplamDolarYurticiNetPrim += model.procedurePoliceOfflineList[i].YurticiNetPrim;
                        //    model.ToplamDolarYurticiBrutPrim += model.procedurePoliceOfflineList[i].YurticiBrutPrim;
                        //    model.ToplamDolarBsmv += model.procedurePoliceOfflineList[i].Bsmv;

                        //}
                        ////euro
                        //if (model.procedurePoliceOfflineList[i].ParaBirimi == "EUR")
                        //{

                        //    model.ToplamEuroTeminatTutari += model.procedurePoliceOfflineList[i].TeminatTutari;
                        //    model.ToplamEuroYurtdisiPrim += model.procedurePoliceOfflineList[i].YurtdisiPrim;
                        //    model.ToplamEuroYurtdisiDisKaynakKomisyon += model.procedurePoliceOfflineList[i].YurtdisiDisKaynakKomisyon;
                        //    model.ToplamEuroYurtdisiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurtdisiAlinanKomisyon;
                        //    model.ToplamEuroFrontingSigortaSirketiKomisyon += model.procedurePoliceOfflineList[i].FrontingSigortaSirketiKomisyon;
                        //    model.ToplamEuroSatisKanaliKomisyon += model.procedurePoliceOfflineList[i].SatisKanaliKomisyon;
                        //    model.ToplamEuroYurticiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurticiAlinanKomisyon;
                        //    model.ToplamEuroYurtdisiNetPrim += model.procedurePoliceOfflineList[i].YurtdisiNetPrim;
                        //    model.ToplamEuroYurtdisiBrokerNetPrim += model.procedurePoliceOfflineList[i].YurtdisiBrokerNetPrim;
                        //    model.ToplamEuroYurticiNetPrim += model.procedurePoliceOfflineList[i].YurticiNetPrim;
                        //    model.ToplamEuroYurticiBrutPrim += model.procedurePoliceOfflineList[i].YurticiBrutPrim;
                        //    model.ToplamEuroBsmv += model.procedurePoliceOfflineList[i].Bsmv;


                        //}
                        ////aed
                        //if (model.procedurePoliceOfflineList[i].ParaBirimi == "AED")
                        //{

                        //    model.ToplamAedTeminatTutari += model.procedurePoliceOfflineList[i].TeminatTutari;
                        //    model.ToplamAedYurtdisiPrim += model.procedurePoliceOfflineList[i].YurtdisiPrim;
                        //    model.ToplamAedYurtdisiDisKaynakKomisyon += model.procedurePoliceOfflineList[i].YurtdisiDisKaynakKomisyon;
                        //    model.ToplamAedYurtdisiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurtdisiAlinanKomisyon;
                        //    model.ToplamAedFrontingSigortaSirketiKomisyon += model.procedurePoliceOfflineList[i].FrontingSigortaSirketiKomisyon;
                        //    model.ToplamAedSatisKanaliKomisyon += model.procedurePoliceOfflineList[i].SatisKanaliKomisyon;
                        //    model.ToplamAedYurticiAlinanKomisyon += model.procedurePoliceOfflineList[i].YurticiAlinanKomisyon;
                        //    model.ToplamAedYurtdisiNetPrim += model.procedurePoliceOfflineList[i].YurtdisiNetPrim;
                        //    model.ToplamAedYurtdisiBrokerNetPrim += model.procedurePoliceOfflineList[i].YurtdisiBrokerNetPrim;
                        //    model.ToplamAedYurticiNetPrim += model.procedurePoliceOfflineList[i].YurticiNetPrim;
                        //    model.ToplamAedYurticiBrutPrim += model.procedurePoliceOfflineList[i].YurticiBrutPrim;
                        //    model.ToplamAedBsmv += model.procedurePoliceOfflineList[i].Bsmv;

                        //}
                        #endregion
                    }
                }

            }
            if (model.procedureTeklifOfflineList != null)
            {
                if (model.procedureTeklifOfflineList.Count > 0)
                {
                    for (int i = model.procedureTeklifOfflineList.Count - 1; i >= 0; i--)
                    {

                        model.GenelPolToplamSayac += 1;


                        //if (model.procedureTeklifOfflineList[i].YurticiBrutPrimTL > 0)
                        //{
                        //    //tahakkuk toplam
                        //    model.ToplamTeminatTutariTLTahakkuk += model.procedureTeklifOfflineList[i].TeminatTutariTL;
                        //    model.ToplamYurtdisiPrimTLTahakkuk += model.procedureTeklifOfflineList[i].YurtdisiPrimTL;
                        //    model.ToplamYurtdisiDisKaynakKomisyonTLTahakkuk += model.procedureTeklifOfflineList[i].YurtdisiDisKaynakKomisyonTL;
                        //    model.ToplamYurtdisiAlinanKomisyonTLTahakkuk += model.procedureTeklifOfflineList[i].YurtdisiAlinanKomisyonTL;
                        //    model.ToplamFrontingSigortaSirketiKomisyonTLTahakkuk += model.procedureTeklifOfflineList[i].FrontingSigortaSirketiKomisyonTL;
                        //    model.ToplamSatisKanaliKomisyonTLTahakkuk += model.procedureTeklifOfflineList[i].SatisKanaliKomisyonTL;
                        //    model.ToplamYurticiAlinanKomisyonTLTahakkuk += model.procedureTeklifOfflineList[i].YurticiAlinanKomisyonTL;
                        //    model.ToplamYurtdisiNetPrimTLTahakkuk += model.procedureTeklifOfflineList[i].YurtdisiNetPrimTL;
                        //    model.ToplamYurtdisiBrokerNetPrimTLTahakkuk += model.procedureTeklifOfflineList[i].YurtdisiBrokerNetPrimTL;
                        //    model.ToplamYurticiNetPrimTLTahakkuk += model.procedureTeklifOfflineList[i].YurticiNetPrimTL;
                        //    model.ToplamYurticiBrutPrimTLTahakkuk += model.procedureTeklifOfflineList[i].YurticiBrutPrimTL;
                        //    model.ToplamBsmvTLTahakkuk += model.procedureTeklifOfflineList[i].BsmvTL;
                        //}
                        //else
                        //{
                        //    //iptal toplam 
                        //    model.ToplamTeminatTutariTLIptal += model.procedureTeklifOfflineList[i].TeminatTutariTL;
                        //    model.ToplamYurtdisiPrimTLIptal += model.procedureTeklifOfflineList[i].YurtdisiPrimTL;
                        //    model.ToplamYurtdisiDisKaynakKomisyonTLIptal += model.procedureTeklifOfflineList[i].YurtdisiDisKaynakKomisyonTL;
                        //    model.ToplamYurtdisiAlinanKomisyonTLIptal += model.procedureTeklifOfflineList[i].YurtdisiAlinanKomisyonTL;
                        //    model.ToplamFrontingSigortaSirketiKomisyonTLIptal += model.procedureTeklifOfflineList[i].FrontingSigortaSirketiKomisyonTL;
                        //    model.ToplamSatisKanaliKomisyonTLIptal += model.procedureTeklifOfflineList[i].SatisKanaliKomisyonTL;
                        //    model.ToplamYurticiAlinanKomisyonTLIptal += model.procedureTeklifOfflineList[i].YurticiAlinanKomisyonTL;
                        //    model.ToplamYurtdisiNetPrimTLIptal += model.procedureTeklifOfflineList[i].YurtdisiNetPrimTL;
                        //    model.ToplamYurtdisiBrokerNetPrimTLIptal += model.procedureTeklifOfflineList[i].YurtdisiBrokerNetPrimTL;
                        //    model.ToplamYurticiNetPrimTLIptal += model.procedureTeklifOfflineList[i].YurticiNetPrimTL;
                        //    model.ToplamYurticiBrutPrimTLIptal += model.procedureTeklifOfflineList[i].YurticiBrutPrimTL;
                        //    model.ToplamBsmvTLIptal += model.procedureTeklifOfflineList[i].BsmvTL;

                        //}

                        //// dolar
                        //if (model.procedureTeklifOfflineList[i].DovizTuru == "USD")
                        //{
                        //    model.ToplamDolarTeminatTutari += model.procedureTeklifOfflineList[i].TeminatTutari;
                        //    model.ToplamDolarYurtdisiPrim += model.procedureTeklifOfflineList[i].YurtdisiPrim;
                        //    model.ToplamDolarYurtdisiDisKaynakKomisyon += model.procedureTeklifOfflineList[i].YurtdisiDisKaynakKomisyon;
                        //    model.ToplamDolarYurtdisiAlinanKomisyon += model.procedureTeklifOfflineList[i].YurtdisiAlinanKomisyon;
                        //    model.ToplamDolarFrontingSigortaSirketiKomisyon += model.procedureTeklifOfflineList[i].FrontingSigortaSirketiKomisyon;
                        //    model.ToplamDolarSatisKanaliKomisyon += model.procedureTeklifOfflineList[i].SatisKanaliKomisyon;
                        //    model.ToplamDolarYurticiAlinanKomisyon += model.procedureTeklifOfflineList[i].YurticiAlinanKomisyon;
                        //    model.ToplamDolarYurtdisiNetPrim += model.procedureTeklifOfflineList[i].YurtdisiNetPrim;
                        //    model.ToplamDolarYurtdisiBrokerNetPrim += model.procedureTeklifOfflineList[i].YurtdisiBrokerNetPrim;
                        //    model.ToplamDolarYurticiNetPrim += model.procedureTeklifOfflineList[i].YurticiNetPrim;
                        //    model.ToplamDolarYurticiBrutPrim += model.procedureTeklifOfflineList[i].YurticiBrutPrim;
                        //    model.ToplamDolarBsmv += model.procedureTeklifOfflineList[i].Bsmv;

                        //}
                        ////euro
                        //if (model.procedureTeklifOfflineList[i].DovizTuru == "EUR")
                        //{

                        //    model.ToplamEuroTeminatTutari += model.procedureTeklifOfflineList[i].TeminatTutari;
                        //    model.ToplamEuroYurtdisiPrim += model.procedureTeklifOfflineList[i].YurtdisiPrim;
                        //    model.ToplamEuroYurtdisiDisKaynakKomisyon += model.procedureTeklifOfflineList[i].YurtdisiDisKaynakKomisyon;
                        //    model.ToplamEuroYurtdisiAlinanKomisyon += model.procedureTeklifOfflineList[i].YurtdisiAlinanKomisyon;
                        //    model.ToplamEuroFrontingSigortaSirketiKomisyon += model.procedureTeklifOfflineList[i].FrontingSigortaSirketiKomisyon;
                        //    model.ToplamEuroSatisKanaliKomisyon += model.procedureTeklifOfflineList[i].SatisKanaliKomisyon;
                        //    model.ToplamEuroYurticiAlinanKomisyon += model.procedureTeklifOfflineList[i].YurticiAlinanKomisyon;
                        //    model.ToplamEuroYurtdisiNetPrim += model.procedureTeklifOfflineList[i].YurtdisiNetPrim;
                        //    model.ToplamEuroYurtdisiBrokerNetPrim += model.procedureTeklifOfflineList[i].YurtdisiBrokerNetPrim;
                        //    model.ToplamEuroYurticiNetPrim += model.procedureTeklifOfflineList[i].YurticiNetPrim;
                        //    model.ToplamEuroYurticiBrutPrim += model.procedureTeklifOfflineList[i].YurticiBrutPrim;
                        //    model.ToplamEuroBsmv += model.procedureTeklifOfflineList[i].Bsmv;


                        //}
                        ////aed
                        //if (model.procedureTeklifOfflineList[i].DovizTuru == "AED")
                        //{

                        //    model.ToplamAedTeminatTutari += model.procedureTeklifOfflineList[i].TeminatTutari;
                        //    model.ToplamAedYurtdisiPrim += model.procedureTeklifOfflineList[i].YurtdisiPrim;
                        //    model.ToplamAedYurtdisiDisKaynakKomisyon += model.procedureTeklifOfflineList[i].YurtdisiDisKaynakKomisyon;
                        //    model.ToplamAedYurtdisiAlinanKomisyon += model.procedureTeklifOfflineList[i].YurtdisiAlinanKomisyon;
                        //    model.ToplamAedFrontingSigortaSirketiKomisyon += model.procedureTeklifOfflineList[i].FrontingSigortaSirketiKomisyon;
                        //    model.ToplamAedSatisKanaliKomisyon += model.procedureTeklifOfflineList[i].SatisKanaliKomisyon;
                        //    model.ToplamAedYurticiAlinanKomisyon += model.procedureTeklifOfflineList[i].YurticiAlinanKomisyon;
                        //    model.ToplamAedYurtdisiNetPrim += model.procedureTeklifOfflineList[i].YurtdisiNetPrim;
                        //    model.ToplamAedYurtdisiBrokerNetPrim += model.procedureTeklifOfflineList[i].YurtdisiBrokerNetPrim;
                        //    model.ToplamAedYurticiNetPrim += model.procedureTeklifOfflineList[i].YurticiNetPrim;
                        //    model.ToplamAedYurticiBrutPrim += model.procedureTeklifOfflineList[i].YurticiBrutPrim;
                        //    model.ToplamAedBsmv += model.procedureTeklifOfflineList[i].Bsmv;

                        //}

                    }
                }
            }

            // genel toplam (tahakkuk + iptal)

            //model.ToplamTeminatTutariTL = model.ToplamTeminatTutariTLTahakkuk + model.ToplamTeminatTutariTLIptal;
            //model.ToplamYurtdisiPrimTL = model.ToplamYurtdisiPrimTLTahakkuk + model.ToplamYurtdisiPrimTLIptal;
            //model.ToplamYurtdisiDisKaynakKomisyonTL = model.ToplamYurtdisiDisKaynakKomisyonTLTahakkuk + model.ToplamYurtdisiDisKaynakKomisyonTLIptal;
            //model.ToplamYurtdisiAlinanKomisyonTL = model.ToplamYurtdisiAlinanKomisyonTLTahakkuk + model.ToplamYurtdisiAlinanKomisyonTLIptal;
            //model.ToplamFrontingSigortaSirketiKomisyonTL = model.ToplamFrontingSigortaSirketiKomisyonTLTahakkuk + model.ToplamFrontingSigortaSirketiKomisyonTLIptal;
            //model.ToplamSatisKanaliKomisyonTL = model.ToplamSatisKanaliKomisyonTLTahakkuk + model.ToplamSatisKanaliKomisyonTLIptal;
            //model.ToplamYurticiAlinanKomisyonTL = model.ToplamYurticiAlinanKomisyonTLTahakkuk + model.ToplamYurticiAlinanKomisyonTLIptal;
            //model.ToplamYurtdisiNetPrimTL = model.ToplamYurtdisiNetPrimTLTahakkuk + model.ToplamYurtdisiNetPrimTLIptal;
            //model.ToplamYurtdisiBrokerNetPrimTL = model.ToplamYurtdisiBrokerNetPrimTLTahakkuk + model.ToplamYurtdisiBrokerNetPrimTLIptal;
            //model.ToplamYurticiNetPrimTL = model.ToplamYurticiNetPrimTLTahakkuk + model.ToplamYurticiNetPrimTLIptal;
            //model.ToplamYurticiBrutPrimTL = model.ToplamYurticiBrutPrimTLTahakkuk + model.ToplamYurticiBrutPrimTLIptal;
            //model.ToplamBsmvTL = model.ToplamBsmvTLTahakkuk + model.ToplamBsmvTLIptal;

            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.AnaTVM = false;
            }
            else
            {
                ViewBag.AnaTVM = true;
            }
            /////// 
            model = _PoliceService.getBrokerPoliceTeklifListesiUWDetayli(model);
            //////

            return View(model);
        }
        //[ValidateAntiForgeryToken]
        public ActionResult GetPoliceOfflineDetail(int? id)
        {

            PoliceOffLineModel model = new PoliceOffLineModel();
            model.listPolOffline = new List<PoliceAraRaporOffLineModel>();
            model.TVMKodu = _AktifKullaniciService.TVMKodu;

            List<TVMBankaHesaplari> bankaHesaplar = new List<TVMBankaHesaplari>();
            model.AcenteBankaHesapList = new SelectList(bankaHesaplar, "TVMKodu", "AcenteKrediKartiNo", "").ListWithOptionLabel();

            model.TvmUnvani = _AktifKullaniciService.TVMUnvani;
            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            int KontrolTVMKod = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
            if (id > 0)
            {
                Neosinerji.BABOnlineTP.Business.Police police = _PoliceService.GetPoliceById(id.Value);
                if (police.GenelBilgiler.TVMKodu == model.TVMKodu)
                {
                    if (id.HasValue && id > 0 && model.listPolOffline != null)
                    {

                        if (police == null)
                            return null;

                        // List<TeklifTUMDetayPartialModel> teklifs = _TeklifService.GetAllListTeklif(policeId.Value);
                        string tcK = police.GenelBilgiler.PoliceSigortali.KimlikNo;
                        if (!String.IsNullOrEmpty(tcK))
                        {
                            police.GenelBilgiler.PoliceSigortali.KimlikNo = tcK;
                        }

                        string vkn = police.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                        if (!String.IsNullOrEmpty(vkn))
                        {
                            police.GenelBilgiler.PoliceSigortali.VergiKimlikNo = vkn;
                        }

                        string tcKSEttiren = police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo;
                        if (!String.IsNullOrEmpty(tcKSEttiren))
                        {
                            police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo = tcKSEttiren;
                        }


                        string vknSEttiren = police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        if (!String.IsNullOrEmpty(vknSEttiren))
                        {
                            police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo = vknSEttiren;
                        }


                        if (police.GenelBilgiler.BransKodu != 4)
                        {
                            if (police.GenelBilgiler.PoliceArac != null)
                            {
                                string sasi = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceArac.SasiNo) ? police.GenelBilgiler.PoliceArac.SasiNo : null;
                                if (sasi != null)
                                {
                                    if (!String.IsNullOrEmpty(sasi) && sasi.Length > 3)
                                    {
                                        police.GenelBilgiler.PoliceArac.SasiNo = sasi.Substring(0, 3) + "******";
                                    }
                                }
                                string motono = police.GenelBilgiler.PoliceArac.MotorNo;
                                if (!string.IsNullOrEmpty(motono) && motono.Length > 3)
                                {
                                    police.GenelBilgiler.PoliceArac.MotorNo = motono.Substring(0, 3) + "******";
                                }
                            }


                        }
                        police.GenelBilgiler.SigortaSirketleri = _PoliceService.getSigortaSirketi(police.GenelBilgiler.TUMBirlikKodu);

                        if (police.GenelBilgiler.TVMKodu.HasValue) // Poliçe kaydında TVM Kodu var ise yurtdışı broker olup olmadığını kontrol et
                        {
                            var tvmDetay = _TVMService.getAnaAcenteTvmDetay(police.GenelBilgiler.TVMKodu.Value);
                            if (tvmDetay.Tipi == 1) //yurtdışı broker ise yurtdışı broker için özel olan tahsilat sayfasını kullan
                            {
                                var reasurorGenel = _TeklifService.getReasurorGenel(police.GenelBilgiler.PoliceId.ToString(), "");
                                if (reasurorGenel == null)
                                {
                                    return View(police);
                                }
                                var disKaynakUnvan = _TvmService.GetDetay(police.GenelBilgiler.UretimTaliAcenteKodu.Value);
                                ViewBag.DisKaynakUnvani = disKaynakUnvan.Unvani;
                                var taliTvmUnvan = _TvmService.GetDetay(police.GenelBilgiler.TaliAcenteKodu.Value);
                                ViewBag.SatisKanali = taliTvmUnvan.Unvani;
                                ViewBag.ParaBirimKodu = _TVMService.GetParaBirimleri().Where(x => x.Birimi == police.GenelBilgiler.ParaBirimi).FirstOrDefault().Id;
                                ViewBag.SlipNo = reasurorGenel.YurtdisiPoliceNo;
                                return View("YDBrokerGetPoliceOfflineDetail", police);

                            }
                            else
                            {
                                return View(police);
                            }
                        }
                        else // Poliçe üzerinde tvm kodu null ise varsayılan view sayfasını kullan
                        {
                            return View(police);
                        }

                    }

                }
                return new RedirectResult("~/Error/ErrorPage/500");

            }
            return null;
        }

        public ActionResult GetParaBirimiKoduByPoliceId(int policeId)
        {
            string paraBirimiKodu;
            var police = _PoliceService.GetPoliceById(policeId);
            paraBirimiKodu = _TVMService.GetParaBirimiByBirimi(police.GenelBilgiler.ParaBirimi).Id.ToString().PadLeft(2, '0');

            return Content(paraBirimiKodu);
        }


        //tek tek ödeme butonu +
        [HttpPost]
        [AjaxException]
        public ActionResult GetYurtdisiBrokerPoliceOfflineDetail(int Polid, int taksitNo, decimal OdenenTutar, string BelgeNo, string BelgeTarihi, string OdemeTuru, string AcenteKrediKarti, string odeyenCariHesapKodu, string dekontEvrakNo, bool topluTahsilatMi)
        {
            // PoliceTahsilat model = new PoliceTahsilat();
            PoliceGenel polGenelmodel = new PoliceGenel();
            CariHesapBorcAlacak cariBorcAlacakModel = new CariHesapBorcAlacak();
            CariHareketleri cariHaraketler = new CariHareketleri();
            int _TVMKodu = _AktifKullaniciService.TVMKodu;
            var tvmDetay = _TVMService.GetDetay(_TVMKodu);
            var polGenel = _PoliceService.GetPoliceById(Polid);

            var polOdeme = _PoliceService.GetPoliceOdemePlani(Polid, taksitNo);
            PoliceTahsilat polTahsilat = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid && s.TaksitNo == taksitNo).FirstOrDefault();
            string mesaj = string.Empty;
            List<PoliceTahsilat> polTahsilatList = new List<PoliceTahsilat>();
            polTahsilatList = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid && s.TaksitNo == taksitNo).ToList<PoliceTahsilat>();
            var odeyenCariHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapByVKN(polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo, Polid);

            List<PoliceTahsilat> polTahsilatListOtomatikTahKKMiOtoKontrol = new List<PoliceTahsilat>();
            polTahsilatListOtomatikTahKKMiOtoKontrol = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid).ToList<PoliceTahsilat>();
            if (polTahsilatListOtomatikTahKKMiOtoKontrol != null || polTahsilatListOtomatikTahKKMiOtoKontrol.Count > 0)
            {
                if (polTahsilatListOtomatikTahKKMiOtoKontrol.Count == 1)
                {
                    foreach (var itemOtomatikTahKKMi in polTahsilatListOtomatikTahKKMiOtoKontrol)
                    {
                        if (itemOtomatikTahKKMi.OdemTipi == 2 && OdemeTuru != "2")
                        {
                            itemOtomatikTahKKMi.OtomatikTahsilatiKkMi = null;
                            _PoliceService.UpdatePoliceTahsilat(itemOtomatikTahKKMi);

                        }
                    }
                }
            }

            #region kayıt guncelle

            if (polOdeme != null && OdenenTutar <= polOdeme.TaksitTutari)
            {

                if (odeyenCariHesabiVarmi.Item2 != null)
                {
                    ReasurorGenel reasurorGenel = _TeklifService.getReasurorGenel(polGenel.GenelBilgiler.PoliceId.ToString(), "0");

                    TVMDetay anaAcenteTvmDetay = _TVMService.getAnaAcenteTvmDetay(_AktifKullaniciService.TVMKodu);

                    //normal acenteler için tahsilat
                    if (anaAcenteTvmDetay.Tipi != 1)
                    {
                        //Nakitse
                        if (OdemeTuru == "1")
                        {
                            var kasaHesabi = "100.01.";
                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            if (kasaHesaplari == null || carihesap == null)
                            {
                                mesaj = "false";
                            }
                            var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);

                            if (carihesap != null && carihesap.Count > 0 && kasaHesabiVarmi != null && kasaHesabiVarmi.Count > 0)
                            {
                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                                if (kasaHesabiVarmi != null)
                                {
                                    #region borç alacak

                                    foreach (var items in kasaHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);

                                    #endregion

                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }
                                #region pol tah
                                if (polTahsilatList.Count != 0)
                                {
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        //müşteri kredi kartı ve havale ise
                                        polTahsilat.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    mesaj = "true";
                                }
                                else
                                {
                                    PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilatt.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        polTahsilatt.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                    polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                    mesaj = "true";
                                }
                                #endregion

                                #region odemeplaniiş odemetipi güncelle
                                if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                                {
                                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                                }
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }

                        }
                        //Müşteri Kredi Kartı
                        if (OdemeTuru == "2")
                        {
                            var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                            var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                            var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                            var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);

                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            //var musteriKkartiCariKodu = odeyenCariHesapKodu; // hangi şirket olduğu bılınmıyor

                            if (carihesap != null && carihesap.Count > 0 && sigortaSirketiCariHesasbiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null)
                            {

                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                                if (sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                                {
                                    foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                    donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = BelgeNo + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;

                                    foreach (var itemSigortasirketCari in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSigortasirketCari.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }

                                #region pol tah
                                if (polTahsilatList.Count != 0)
                                {
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        //müşteri kredi kartı ve havale ise
                                        polTahsilat.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    mesaj = "true";
                                }
                                else
                                {
                                    PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilatt.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        polTahsilatt.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                    polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                    mesaj = "true";
                                }
                                #endregion
                                #region odemeplaniiş odemetipi güncelle
                                if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                                {
                                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                                }
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }
                        }
                        //Havale ise
                        if (OdemeTuru == "3")
                        {
                            //var bankaHesabi = "102.01.";
                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            // havale ise acentenin banka hesabını çağırıyoruz. o yüzden 8 yazdık. 8= acente banka hesabı
                            var bankaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, 8, AcenteKrediKarti);
                            var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(bankaHesaplari.CariHesapNo);

                            //var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariKasaHesapList(bankaHesabi);
                            if (carihesap != null && carihesap.Count > 0 && bankaHesabiVarmi != null && bankaHesabiVarmi.Count > 0)
                            {

                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                                if (bankaHesabiVarmi != null)
                                {
                                    foreach (var itemss in bankaHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = itemss.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = itemss.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = itemss.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = itemss.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = itemss.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);

                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemBankaCariHesap in bankaHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemBankaCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }

                                #region pol tah
                                if (polTahsilatList.Count != 0)
                                {
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        //müşteri kredi kartı ve havale ise
                                        polTahsilat.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    mesaj = "true";
                                }
                                else
                                {
                                    PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilatt.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        polTahsilatt.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                    polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                    mesaj = "true";
                                }
                                #endregion
                                #region odemeplaniiş odemetipi güncelle
                                if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                                {
                                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                                }
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }

                        }
                        //Çek
                        if (OdemeTuru == "4")
                        {
                            int odemeturu = Convert.ToInt32(OdemeTuru);

                            //var alinanCekler = "101.01.";
                            var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                            var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                            var alinanCekHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);

                            var alinanCekHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanCekHesaplari.CariHesapNo);
                            if (carihesap != null && carihesap.Count > 0 && alinanCekHesabiVarmi != null && alinanCekHesabiVarmi.Count > 0)
                            {
                                //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                                cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                                if (alinanCekHesabiVarmi != null)
                                {
                                    foreach (var items in alinanCekHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemCekCariHesap in alinanCekHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemCekCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }

                                #region pol tah
                                if (polTahsilatList.Count != 0)
                                {
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        //müşteri kredi kartı ve havale ise
                                        polTahsilat.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.UpdatePoliceTahsilat(polTahsilat);

                                    mesaj = "true";
                                }
                                else
                                {
                                    PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilatt.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        polTahsilatt.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                    polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                    mesaj = "true";
                                }
                                #endregion
                                #region odemeplaniiş odemetipi güncelle
                                if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                                {
                                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                                }
                                #endregion
                            }
                            else
                            {

                                mesaj = "false";
                            }

                        }
                        //Acente Kredi Kartı
                        if (OdemeTuru == "5")
                        {
                            //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var acenteKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                            var acenteKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteKKHesaplari.CariHesapNo);

                            //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                            var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                            var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                            var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                            var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                            if (acenteKKHesabiVarmi != null && acenteKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                            {

                                foreach (var item in acenteKKHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                                if (sigortaSirketiCariHesasbiVarmi != null)
                                {
                                    foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                    donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                    #region cari haraket ekleme
                                    // ss şirketi
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    //Acente kk
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemsss in acenteKKHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                    #endregion
                                }

                                #region pol tah
                                if (polTahsilatList.Count != 0)
                                {
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        //müşteri kredi kartı ve havale ise
                                        polTahsilat.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    mesaj = "true";
                                }
                                else
                                {
                                    PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilatt.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        polTahsilatt.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                    polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                    mesaj = "true";
                                }
                                #endregion
                                #region odemeplaniiş odemetipi güncelle
                                if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                                {
                                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                                }
                                #endregion
                            }
                            else
                            {

                                mesaj = "false";
                            }

                        }
                        //Acente Pos Hesabi
                        if (OdemeTuru == "6")
                        {
                            int odemeturu = Convert.ToInt32(OdemeTuru);

                            var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                            var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                            var posHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);

                            var posHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(posHesaplari.CariHesapNo);
                            if (carihesap != null && carihesap.Count > 0 && posHesabiVarmi != null && posHesabiVarmi.Count > 0)
                            {
                                //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                                cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                                if (posHesabiVarmi != null)
                                {
                                    foreach (var items in posHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemPosCariHesap in posHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemPosCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }

                                #region pol tah
                                if (polTahsilatList.Count != 0)
                                {
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        //müşteri kredi kartı ve havale ise
                                        polTahsilat.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    mesaj = "true";
                                }
                                else
                                {
                                    PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilatt.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        polTahsilatt.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                    polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                    mesaj = "true";
                                }
                                #endregion
                                #region odemeplaniiş odemetipi güncelle
                                if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                                {
                                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                                }
                                #endregion
                            }
                            else
                            {

                                mesaj = "false";
                            }

                        }
                        //Senet
                        if (OdemeTuru == "7")
                        {
                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var alinanSenetHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                            //var Alacak senetleri = "121.01.";
                            var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                            var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                            var alacakSenetHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanSenetHesaplari.CariHesapNo);
                            if (carihesap != null && carihesap.Count > 0 && alacakSenetHesabiVarmi != null && alacakSenetHesabiVarmi.Count > 0)
                            {
                                //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                                cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                                if (alacakSenetHesabiVarmi != null)
                                {
                                    foreach (var items in alacakSenetHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemSenetCariHesap in alacakSenetHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSenetCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }

                                #region pol tah
                                if (polTahsilatList.Count != 0)
                                {
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        //müşteri kredi kartı ve havale ise
                                        polTahsilat.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    mesaj = "true";
                                }
                                else
                                {
                                    PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilatt.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        polTahsilatt.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                    polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                    mesaj = "true";
                                }
                                #endregion
                                #region odemeplaniiş odemetipi güncelle
                                if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                                {
                                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                                }
                                #endregion
                            }
                            else
                            {

                                mesaj = "false";
                            }

                        }
                        //Acente Bireysel Kredi Kartı
                        if (OdemeTuru == "9")
                        {
                            //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var acenteBKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                            var acenteBKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteBKKHesaplari.CariHesapNo);

                            //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                            var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                            var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                            var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                            var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                            if (acenteBKKHesabiVarmi != null && acenteBKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                            {

                                foreach (var item in acenteBKKHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                                if (sigortaSirketiCariHesasbiVarmi != null)
                                {
                                    foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                    donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                    #region cari haraket ekleme
                                    // ss şirketi
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    //Acente kk
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemsss in acenteBKKHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                    #endregion
                                }

                                #region pol tah
                                if (polTahsilatList.Count != 0)
                                {
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        //müşteri kredi kartı ve havale ise
                                        polTahsilat.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    mesaj = "true";
                                }
                                else
                                {
                                    PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilatt.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        polTahsilatt.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                    polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                    mesaj = "true";
                                }
                                #endregion
                                #region odemeplaniiş odemetipi güncelle
                                if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                                {
                                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                                }
                                #endregion
                            }
                            {

                                mesaj = "false";
                            }

                        }
                        //Mal-Hizmet Alımı
                        if (OdemeTuru == "11")
                        {

                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            if (kasaHesaplari == null || carihesap == null)
                            {
                                mesaj = "false";
                            }
                            var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);

                            if (carihesap != null && carihesap.Count > 0 && kasaHesabiVarmi != null && kasaHesabiVarmi.Count > 0)
                            {
                                //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                                if (kasaHesabiVarmi != null)
                                {
                                    foreach (var items in kasaHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }
                                #region pol tah
                                if (polTahsilatList.Count != 0)
                                {
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        //müşteri kredi kartı ve havale ise
                                        polTahsilat.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    mesaj = "true";
                                }
                                else
                                {
                                    PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                    foreach (var item in polTahsilatList)
                                    {
                                        polTahsilat.TahsilatId = item.TahsilatId;
                                    }
                                    polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                    polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    if (OdemeTuru != null)
                                    {
                                        polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                    }
                                    polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                    polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                    polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                    polTahsilatt.OdenenTutar += OdenenTutar;
                                    if (OdemeTuru == "2")
                                    {
                                        polTahsilatt.OdemeBelgeNo = BelgeNo;
                                    }
                                    else
                                    {
                                        polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                    }
                                    polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                    polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                    mesaj = "true";
                                }
                                #endregion

                                #region odemeplaniiş odemetipi güncelle
                                if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                                {
                                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                                }
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }

                        }
                    }
                    else
                    {
                        if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi != 2)
                        {
                            mesaj = "false";
                            return Json(new { mesaj, Muhasebe = false });
                        }
                        var brokerUwTahakkukKontrol = Convert.ToInt32(polGenel.GenelBilgiler.TUMBirlikKodu);
                        //if (polGenel.GenelBilgiler.TUMBirlikKodu == "500")
                        if (brokerUwTahakkukKontrol >= 500 && brokerUwTahakkukKontrol <= 530)
                        {
                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var kasaHesapList = _TVMService.GetListTVMBankaHesaplari(polGenel.GenelBilgiler.TVMKodu.Value);
                            var policeParaBirimi = _TVMService.GetParaBirimiByBirimi(polGenel.GenelBilgiler.ParaBirimi);
                            string policeParaBirimiKodu = policeParaBirimi.Id.ToString().PadLeft(2, '0');
                            var kasahesapno = policeParaBirimiKodu + "." + AcenteKrediKarti;
                            var kasaHesaplari = kasaHesapList.Where(x => x.CariHesapNo.Contains(kasahesapno)).FirstOrDefault();
                            var sigortaSirketi = _PoliceService.getSirketBilgisi(polGenel.GenelBilgiler.SigortaSirketleri.SirketKodu);
                            var underWriters = _TeklifService.getUnderwriters(polGenel.GenelBilgiler.PoliceId.ToString(), "");
                            // yurt dışı brokerler için tahsilat
                            string OdemeTuruIsmı = "", cariHareketAciklama = "", evrakNoAciklama = "";
                            switch (OdemeTuru)
                            {
                                case "1":
                                    OdemeTuruIsmı = "Nakit";
                                    break;
                                case "2":
                                    OdemeTuruIsmı = "Müşteri Kredi Kartı";
                                    break;
                                case "3":
                                    OdemeTuruIsmı = "Havale";
                                    break;
                                case "4":
                                    OdemeTuruIsmı = "Çek";
                                    break;
                                case "5":
                                    OdemeTuruIsmı = "Acente Kredi Kartı";
                                    break;
                                case "6":
                                    OdemeTuruIsmı = "Acente Pos Hesabi";
                                    break;
                                case "7":
                                    OdemeTuruIsmı = "Senet";
                                    break;
                                case "9":
                                    OdemeTuruIsmı = "Acente Bireysel Kredi Kartı";
                                    break;
                            }

                            #region müşteri alacak 120'li hesap

                            string musteriHesapKodu = "120." + policeParaBirimiKodu + ".";
                            if (!string.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo))
                            {
                                musteriHesapKodu += polGenel.GenelBilgiler.PoliceSigortali.KimlikNo;
                            }
                            else
                            {
                                musteriHesapKodu += polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;

                            }
                            if (topluTahsilatMi)
                            {
                                cariHareketAciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            else
                            {
                                cariHareketAciklama = OdemeTuruIsmı + "-" + "Tahsilat, " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            evrakNoAciklama = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                            cariHareketveCariBorcAlacakEkle(polGenel, reasurorGenel, polOdeme, OdenenTutar, musteriHesapKodu, policeParaBirimiKodu, BelgeTarihi, dekontEvrakNo, evrakNoAciklama, OdemeTuru, "A", cariHareketAciklama, CariEvrakTipKodu.PrimTahsilat);
                            #endregion

                            #region SATICILAR Yurtdışı BROKER BORÇ 340'lı hesap (Poliçe Brüt Prim.)- yeni hali    

                            string frontingCarihesapKodu = "340." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');
                            if (topluTahsilatMi)
                            {
                                cariHareketAciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            else
                            {
                                cariHareketAciklama = OdemeTuruIsmı + "-" + "Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            evrakNoAciklama = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;

                            cariHareketveCariBorcAlacakEkle(polGenel, reasurorGenel, polOdeme, OdenenTutar, frontingCarihesapKodu, policeParaBirimiKodu, BelgeTarihi, dekontEvrakNo, evrakNoAciklama, OdemeTuru, "B", cariHareketAciklama, CariEvrakTipKodu.PrimTahsilat);
                            #endregion


                            decimal yurtdisiBrokerOdenecekTaksitTutar = 0, yurtdisiUWWOdenecekTaksitTutar = 0, digerUWKalanKomisyonTutari = 0, digerUwKalanPrimTutari = 0, digerUwKalanPrimTutariTL = 0, digerUWKalanKomisyonTutariTL = 0;
                            decimal[] tempYurtdisiBrokerOdenecekTutarTL = null, tempYurtdisiBrokerOdenecekTutar = null;
                            decimal[] tempYurtdisiUWWOdenecekTutarTL = null, tempYurtdisiUWWOdenecekTutar = null;
                            var toplamTaksitSayisi = polGenel.GenelBilgiler.PoliceTahsilats.Count;
                            tempYurtdisiBrokerOdenecekTutar = Utils.TaksitDuzenle(Convert.ToDecimal(reasurorGenel.YurtdisiNetPrim) - Convert.ToDecimal(reasurorGenel.YurtdisiDisKaynakKomisyon), toplamTaksitSayisi);
                            tempYurtdisiBrokerOdenecekTutarTL = Utils.TaksitDuzenle(Convert.ToDecimal(reasurorGenel.YurtdisiNetPrimTL) - Convert.ToDecimal(reasurorGenel.YurtdisiDisKaynakKomisyonTL), toplamTaksitSayisi);
                            tempYurtdisiUWWOdenecekTutar = Utils.TaksitDuzenle(Convert.ToDecimal(reasurorGenel.YurtdisiNetPrim) - (Convert.ToDecimal(reasurorGenel.YurtdisiDisKaynakKomisyon) + Convert.ToDecimal(reasurorGenel.YurtdisiAlinanKomisyon)), toplamTaksitSayisi);
                            tempYurtdisiUWWOdenecekTutarTL = Utils.TaksitDuzenle(Convert.ToDecimal(reasurorGenel.YurtdisiNetPrimTL) - (Convert.ToDecimal(reasurorGenel.YurtdisiDisKaynakKomisyonTL) + Convert.ToDecimal(reasurorGenel.YurtdisiAlinanKomisyonTL)), toplamTaksitSayisi);
                            if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                            {
                                yurtdisiBrokerOdenecekTaksitTutar = tempYurtdisiBrokerOdenecekTutar[0];
                                yurtdisiUWWOdenecekTaksitTutar = tempYurtdisiUWWOdenecekTutar[0];
                                if (toplamTaksitSayisi == taksitNo)
                                {
                                    yurtdisiBrokerOdenecekTaksitTutar = tempYurtdisiBrokerOdenecekTutar[1];
                                    yurtdisiUWWOdenecekTaksitTutar = tempYurtdisiUWWOdenecekTutar[1];
                                }
                            }
                            else
                            {
                                yurtdisiBrokerOdenecekTaksitTutar = tempYurtdisiBrokerOdenecekTutarTL[0];
                                yurtdisiUWWOdenecekTaksitTutar = tempYurtdisiUWWOdenecekTutarTL[0];
                                if (toplamTaksitSayisi == taksitNo)
                                {
                                    yurtdisiBrokerOdenecekTaksitTutar = tempYurtdisiBrokerOdenecekTutarTL[1];
                                    yurtdisiUWWOdenecekTaksitTutar = tempYurtdisiUWWOdenecekTutarTL[1];
                                }
                            }
                            #region SATICILAR Yurtdışı BROKER ALACAK 340'lı hesap 
                            ///////////////////////////////////////// yeni hali  (Yurtdışı Net PrimY.D Kaynak Kom.) 
                            if (topluTahsilatMi)
                            {
                                cariHareketAciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            else
                            {
                                cariHareketAciklama = OdemeTuruIsmı + "-" + "Tahsilat, Yurt İçi Brüt Prim " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            evrakNoAciklama = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;

                            //cariHareketveCariBorcAlacakEkle(polGenel, reasurorGenel, polOdeme, yurtdisiBrokerOdenecekTaksitTutar, frontingCarihesapKodu, policeParaBirimiKodu, BelgeTarihi, dekontEvrakNo, evrakNoAciklama, OdemeTuru, "A", cariHareketAciklama, CariEvrakTipKodu.PrimTahsilat);
                            #endregion
                            #region BANKA HESABI BORÇ 102'lı hesap 
                            ///////////////////////////////////////// yeni hali  (Yurtdışı Net PrimY.D Kaynak Kom.) 

                            //cariHareketAciklama = AcenteKrediKarti + "-" + "Tahsilat";

                            evrakNoAciklama = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;

                            //cariHareketveCariBorcAlacakEkle(polGenel, reasurorGenel, polOdeme, yurtdisiBrokerOdenecekTaksitTutar, kasaHesaplari.CariHesapNo, policeParaBirimiKodu, BelgeTarihi, dekontEvrakNo, evrakNoAciklama, OdemeTuru, "B", cariHareketAciklama, CariEvrakTipKodu.PrimTahsilat);
                            #endregion
                            ///////////////////////////////////////// yeni hali
                            #region SATICILAR- UW Yurtdışı UW Reasürör Şirketler BORÇ 326'lı hesap -900-901
                            ///////////////////////////////////////// yeni hali  (Yurtdışı Net Prim-Y.D Kaynak Kom.) 
                            decimal odenecekTutarUW = 0;
                            if (topluTahsilatMi)
                            {
                                cariHareketAciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            else
                            {
                                cariHareketAciklama = OdemeTuruIsmı + "-" + "Tahsilat, " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            evrakNoAciklama = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                            List<UnderWriterItem> frontingUWHesap = new List<UnderWriterItem>();
                            foreach (var item in underWriters)
                            {
                                var getSirket = _SigortaSirketleriService.GetSirket(item.UnderwriterKodu);
                                if (getSirket != null)
                                {
                                    getSirket.VergiNumarasi = getSirket.VergiNumarasi.Trim();
                                    var sirketHesapKodu = "326." + policeParaBirimiKodu + "." + getSirket.VergiNumarasi;
                                    var tempfrontingYurticiHesap = _Muhasebe_CariHesapService.GetCariHesap(sirketHesapKodu);
                                    if (tempfrontingYurticiHesap != null)
                                    {
                                        frontingUWHesap.Add(new UnderWriterItem { CariHesaplari = tempfrontingYurticiHesap, UnderWriterKodu = item.UnderwriterKodu });
                                    }
                                }
                                //if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                                //{
                                digerUwKalanPrimTutari += Convert.ToDecimal(item.UnderwriterPrim);
                                digerUWKalanKomisyonTutari += Convert.ToDecimal(item.UnderwriterKomisyon);
                                //}
                                //else
                                //{
                                //    digerUwKalanPrimTutariTL += Convert.ToDecimal(item.UnderwriterPrim) * Convert.ToDecimal(reasurorGenel.DovizKur);
                                //    digerUWKalanKomisyonTutariTL += Convert.ToDecimal(item.UnderwriterKomisyon) * Convert.ToDecimal(reasurorGenel.DovizKur);
                                //}
                            }
                            if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                            {
                                digerUwKalanPrimTutari = Convert.ToDecimal(reasurorGenel.YurtdisiNetPrim) - digerUwKalanPrimTutari;
                                digerUWKalanKomisyonTutari = (Convert.ToDecimal(reasurorGenel.YurtdisiAlinanKomisyon) + Convert.ToDecimal(reasurorGenel.YurtdisiDisKaynakKomisyon)) - digerUWKalanKomisyonTutari;
                            }
                            else
                            {
                                digerUwKalanPrimTutari = Convert.ToDecimal(reasurorGenel.YurtdisiNetPrimTL) - digerUwKalanPrimTutari;
                                digerUWKalanKomisyonTutari = (Convert.ToDecimal(reasurorGenel.YurtdisiAlinanKomisyonTL) + Convert.ToDecimal(reasurorGenel.YurtdisiDisKaynakKomisyonTL)) - digerUWKalanKomisyonTutari;
                            }
                            foreach (var item in frontingUWHesap)
                            {
                                var uwPrim = underWriters.Where(x => x.UnderwriterKodu == item.UnderWriterKodu).FirstOrDefault().UnderwriterPrim;
                                var uwKomisyon = underWriters.Where(x => x.UnderwriterKodu == item.UnderWriterKodu).FirstOrDefault().UnderwriterKomisyon;
                                ///////// UW Prim Borç yazılıyor
                                var taksitItem = Utils.TaksitDuzenle(Convert.ToDecimal(uwPrim), toplamTaksitSayisi);

                                //if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                                //{
                                odenecekTutarUW = taksitItem[0];
                                if (toplamTaksitSayisi == taksitNo)
                                {
                                    odenecekTutarUW = taksitItem[1];
                                }
                                //}
                                //else
                                //{
                                //    taksitItem = Utils.TaksitDuzenle((decimal)reasurorGenel.DovizKur * (decimal)uwPrim, toplamTaksitSayisi);
                                //    odenecekTutarUW = taksitItem[0];
                                //    if (toplamTaksitSayisi == taksitNo)
                                //    {
                                //        odenecekTutarUW = taksitItem[1];
                                //    }
                                //}
                                //cariHareketveCariBorcAlacakEkle(polGenel, reasurorGenel, polOdeme, odenecekTutarUW, item.CariHesaplari.CariHesapKodu, policeParaBirimiKodu, BelgeTarihi, dekontEvrakNo, evrakNoAciklama, OdemeTuru, "B", cariHareketAciklama, CariEvrakTipKodu.PrimTahsilat);
                                #region BANKA HESABI ALACAK 102'lı hesap -UW Prim banka hesabına işleniyor  

                                evrakNoAciklama = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;

                                //cariHareketveCariBorcAlacakEkle(polGenel, reasurorGenel, polOdeme, odenecekTutarUW, kasaHesaplari.CariHesapNo, policeParaBirimiKodu, BelgeTarihi, dekontEvrakNo, evrakNoAciklama, OdemeTuru, "A", cariHareketAciklama, CariEvrakTipKodu.PrimTahsilat);
                                #endregion
                                ///////// UW Komisyon Alacak yazılıyor(ters işlemle yapılarak kapatılıyor)
                                taksitItem = Utils.TaksitDuzenle(Convert.ToDecimal(uwKomisyon), toplamTaksitSayisi);
                                //if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                                //{
                                odenecekTutarUW = taksitItem[0];
                                if (toplamTaksitSayisi == taksitNo)
                                {
                                    odenecekTutarUW = taksitItem[1];
                                }
                                //}
                                //else
                                //{
                                //    taksitItem = Utils.TaksitDuzenle((decimal)reasurorGenel.DovizKur * (decimal)uwKomisyon, toplamTaksitSayisi);
                                //    odenecekTutarUW = taksitItem[0];
                                //    if (toplamTaksitSayisi == taksitNo)
                                //    {
                                //        odenecekTutarUW = taksitItem[1];
                                //    }
                                //}

                                //cariHareketveCariBorcAlacakEkle(polGenel, reasurorGenel, polOdeme, odenecekTutarUW, item.CariHesaplari.CariHesapKodu, policeParaBirimiKodu, BelgeTarihi, dekontEvrakNo, evrakNoAciklama, OdemeTuru, "A", cariHareketAciklama, CariEvrakTipKodu.KomisyonTahsilati);

                            }
                            //oransal Uw Prim ve Komisyon kalanları kapatılıyor -900,901 hesaplar - sadece taksitno 1 calisacak - bir kalemde tutuldugu icin
                            if (taksitNo == 1)
                            {
                                cariHareketAciklama = OdemeTuruIsmı + "-" + "Tahsilat, Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                var digerUWKomisyonKodu = "900." + policeParaBirimiKodu + "." + _TVMKodu.ToString().PadLeft(10, '0');
                                var digerUWKPrimKodu = "901." + policeParaBirimiKodu + "." + _TVMKodu.ToString().PadLeft(10, '0');
                                //900 komisyon
                                if (digerUWKalanKomisyonTutari > 0)
                                    cariHareketveCariBorcAlacakEkle(polGenel, reasurorGenel, polOdeme, digerUWKalanKomisyonTutari, digerUWKomisyonKodu, policeParaBirimiKodu, BelgeTarihi, dekontEvrakNo, evrakNoAciklama, OdemeTuru, "A", cariHareketAciklama, CariEvrakTipKodu.DigerUwKomisyon);
                                //901 prim
                                if (digerUwKalanPrimTutari > 0)
                                    cariHareketveCariBorcAlacakEkle(polGenel, reasurorGenel, polOdeme, digerUwKalanPrimTutari, digerUWKPrimKodu, policeParaBirimiKodu, BelgeTarihi, dekontEvrakNo, evrakNoAciklama, OdemeTuru, "B", cariHareketAciklama, CariEvrakTipKodu.DigerUWPrim);
                            }
                            #endregion
                            ///////////////////////////////////////// yeni hali
                            #region policeTahsilat İslemleri

                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                //polTahsilat.OdenenTutar += OdenenTutar;
                                polTahsilat.OdenenTutar += polOdeme.TaksitTutari.Value;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                var vergiKimlikNo = String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo : polGenel.GenelBilgiler.PoliceSigortali.KimlikNo;
                                polTahsilat.CariHesapKodu = _Muhasebe_CariHesapService.GetCariHesapByVKN(vergiKimlikNo, polGenel.GenelBilgiler.PoliceId).Item2;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += polOdeme.TaksitTutari.Value;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion

                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }

                            #endregion
                        }
                        else
                        {
                            var policeParaBirimi = _TVMService.GetParaBirimiByBirimi(polGenel.GenelBilgiler.ParaBirimi);
                            string policeParaBirimiKodu = policeParaBirimi.Id.ToString().PadLeft(2, '0');
                            var sigortaSirketi = _PoliceService.getSirketBilgisi(polGenel.GenelBilgiler.SigortaSirketleri.SirketKodu);
                            // yurt dışı brokerler için tahsilat
                            string OdemeTuruIsmı = "";
                            switch (OdemeTuru)
                            {
                                case "1":
                                    OdemeTuruIsmı = "Nakit";
                                    break;
                                case "2":
                                    OdemeTuruIsmı = "Müşteri Kredi Kartı";
                                    break;
                                case "3":
                                    OdemeTuruIsmı = "Havale";
                                    break;
                                case "4":
                                    OdemeTuruIsmı = "Çek";
                                    break;
                                case "5":
                                    OdemeTuruIsmı = "Acente Kredi Kartı";
                                    break;
                                case "6":
                                    OdemeTuruIsmı = "Acente Pos Hesabi";
                                    break;
                                case "7":
                                    OdemeTuruIsmı = "Senet";
                                    break;
                                case "9":
                                    OdemeTuruIsmı = "Acente Bireysel Kredi Kartı";
                                    break;
                            }

                            #region müşteri alacak
                            cariBorcAlacakModel = new CariHesapBorcAlacak();
                            cariHaraketler = new CariHareketleri();
                            #region borç alacak


                            //var musteriCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            //foreach (var items in musteriCariHesap)
                            //{
                            //    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                            //    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                            //    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                            //    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                            //    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                            //}
                            string musteriCariHesap = "120." + policeParaBirimiKodu + ".";
                            if (!string.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo))
                            {
                                musteriCariHesap += polGenel.GenelBilgiler.PoliceSigortali.KimlikNo;
                            }
                            else
                            {
                                musteriCariHesap += polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                            }
                            var cariHesap = _Muhasebe_CariHesapService.GetCariHesap(musteriCariHesap);
                            cariBorcAlacakModel.CariHesapId = cariHesap.CariHesapId;
                            cariBorcAlacakModel.CariHesapKodu = cariHesap.CariHesapKodu;
                            cariBorcAlacakModel.TVMKodu = cariHesap.TVMKodu;
                            cariBorcAlacakModel.KimlikNo = cariHesap.KimlikNo;
                            cariBorcAlacakModel.KayitTarihi = cariHesap.KayitTarihi;

                            string donemKasaYil = String.Empty;
                            string donemKasaAy = String.Empty;
                            if (!String.IsNullOrEmpty(BelgeTarihi))
                            {
                                var parts = BelgeTarihi.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    donemKasaYil = parts[2];
                                    donemKasaAy = parts[1];
                                }
                            }

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, OdenenTutar);

                            #endregion

                            #region cari haraket ekleme

                            cariHaraketler.CariHesapId = cariHesap.CariHesapId;
                            cariHaraketler.EvrakNo = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                            cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                            cariHaraketler.Tutar = OdenenTutar;
                            if (topluTahsilatMi == true)
                            {
                                cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            else
                            {
                                cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tahsilat, " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }

                            cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                            cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                            cariHaraketler.CariHesapKodu = cariHesap.CariHesapKodu;
                            cariHaraketler.BorcAlacakTipi = "A";
                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                            #endregion


                            #endregion

                            #region fronting borç

                            cariBorcAlacakModel = new CariHesapBorcAlacak();
                            cariHaraketler = new CariHareketleri();

                            #region borç alacak

                            string frontingCarihesapKodu = "320." + policeParaBirimiKodu + "." + sigortaSirketi.VergiNumarasi;

                            //var frontingCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(frontingCarihesapKodu, _AktifKullaniciService.TVMKodu);

                            //foreach (var items in frontingCariHesap)
                            //{
                            //    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                            //    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                            //    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                            //    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                            //    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                            //}
                            cariHesap = _Muhasebe_CariHesapService.GetCariHesap(frontingCarihesapKodu);
                            cariBorcAlacakModel.CariHesapId = cariHesap.CariHesapId;
                            cariBorcAlacakModel.CariHesapKodu = cariHesap.CariHesapKodu;
                            cariBorcAlacakModel.TVMKodu = cariHesap.TVMKodu;
                            cariBorcAlacakModel.KimlikNo = cariHesap.KimlikNo;
                            cariBorcAlacakModel.KayitTarihi = cariHesap.KayitTarihi;

                            donemKasaYil = String.Empty;
                            donemKasaAy = String.Empty;
                            if (!String.IsNullOrEmpty(BelgeTarihi))
                            {
                                var parts = BelgeTarihi.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    donemKasaYil = parts[2];
                                    donemKasaAy = parts[1];
                                }
                            }

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);

                            #endregion

                            #region cari haraket ekleme

                            cariHaraketler.CariHesapId = cariHesap.CariHesapId;
                            cariHaraketler.EvrakNo = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                            cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                            cariHaraketler.Tutar = OdenenTutar;
                            if (topluTahsilatMi == true)
                            {
                                cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            else
                            {
                                cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tahsilat, " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                            cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                            cariHaraketler.CariHesapKodu = frontingCarihesapKodu;
                            cariHaraketler.BorcAlacakTipi = "B";
                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                            #endregion


                            #endregion

                            decimal yurtDisiNetPrimTaksit = reasurorGenel.YurtdisiNetPrimTL.Value / polGenel.GenelBilgiler.PoliceTahsilats.Count;
                            decimal dovizliYurtDisiNetPrimTaksit = (reasurorGenel.YurtdisiNetPrim ?? 0) / polGenel.GenelBilgiler.PoliceTahsilats.Count;

                            #region fronting alacak  (y.dışı net prim pasife alındı manuel yapılacak -03.08.2022)
                            //cariBorcAlacakModel = new CariHesapBorcAlacak();
                            //cariHaraketler = new CariHareketleri();
                            //#region borç alacak

                            //frontingCarihesapKodu = "320." + policeParaBirimiKodu + "." + sigortaSirketi.VergiNumarasi;

                            //cariHesap = _Muhasebe_CariHesapService.GetCariHesap(frontingCarihesapKodu);
                            //cariBorcAlacakModel.CariHesapId = cariHesap.CariHesapId;
                            //cariBorcAlacakModel.CariHesapKodu = cariHesap.CariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = cariHesap.TVMKodu;
                            //cariBorcAlacakModel.KimlikNo = cariHesap.KimlikNo;
                            //cariBorcAlacakModel.KayitTarihi = cariHesap.KayitTarihi;

                            //donemKasaYil = String.Empty;
                            //donemKasaAy = String.Empty;
                            //if (!String.IsNullOrEmpty(BelgeTarihi))
                            //{
                            //    var parts = BelgeTarihi.Split('.');
                            //    if (parts != null && parts.Count() == 3)
                            //    {
                            //        donemKasaYil = parts[2];
                            //        donemKasaAy = parts[1];
                            //    }
                            //}

                            //cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                            //cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            //if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                            //{
                            //    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, dovizliYurtDisiNetPrimTaksit);
                            //}
                            //else
                            //{
                            //    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, yurtDisiNetPrimTaksit);
                            //}
                            //#endregion
                            //#region cari haraket ekleme
                            //cariHaraketler.CariHesapId = cariHesap.CariHesapId;
                            //cariHaraketler.EvrakNo = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                            //cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                            //cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                            //cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                            //cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                            //if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                            //{
                            //    cariHaraketler.Tutar = dovizliYurtDisiNetPrimTaksit;
                            //}
                            //else
                            //{
                            //    cariHaraketler.Tutar = yurtDisiNetPrimTaksit;
                            //}
                            //if (topluTahsilatMi == true)
                            //{
                            //    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            //}
                            //else
                            //{
                            //    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tahsilat, " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            //}

                            //cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                            //cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                            //cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                            //cariHaraketler.CariHesapKodu = frontingCarihesapKodu;
                            //cariHaraketler.BorcAlacakTipi = "A";
                            //cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                            //cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                            //_Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                            //#endregion

                            #endregion

                            #region yurtdisi broker borc (y.dışı net prim manuel girilecek -03.08.2022)
                            //cariBorcAlacakModel = new CariHesapBorcAlacak();
                            //cariHaraketler = new CariHareketleri();
                            //#region borç alacak

                            //string yurtDisiBrokerCariHesapKodu = "340." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');

                            //cariHesap = _Muhasebe_CariHesapService.GetCariHesap(yurtDisiBrokerCariHesapKodu);
                            //cariBorcAlacakModel.CariHesapId = cariHesap.CariHesapId;
                            //cariBorcAlacakModel.CariHesapKodu = cariHesap.CariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = cariHesap.TVMKodu;
                            //cariBorcAlacakModel.KimlikNo = cariHesap.KimlikNo;
                            //cariBorcAlacakModel.KayitTarihi = cariHesap.KayitTarihi;

                            //donemKasaYil = String.Empty;
                            //donemKasaAy = String.Empty;
                            //if (!String.IsNullOrEmpty(BelgeTarihi))
                            //{
                            //    var parts = BelgeTarihi.Split('.');
                            //    if (parts != null && parts.Count() == 3)
                            //    {
                            //        donemKasaYil = parts[2];
                            //        donemKasaAy = parts[1];
                            //    }
                            //}

                            //cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                            //cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            //if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                            //{
                            //    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, dovizliYurtDisiNetPrimTaksit, 0);
                            //}
                            //else
                            //{
                            //    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, yurtDisiNetPrimTaksit, 0);
                            //}
                            //#endregion
                            //#region cari haraket ekleme
                            //cariHaraketler.CariHesapId = cariHesap.CariHesapId;
                            //cariHaraketler.EvrakNo = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                            //cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                            //cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                            //cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                            //cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                            //if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                            //{
                            //    cariHaraketler.Tutar = dovizliYurtDisiNetPrimTaksit;
                            //}
                            //else
                            //{
                            //    cariHaraketler.Tutar = yurtDisiNetPrimTaksit;
                            //}

                            //if (topluTahsilatMi == true)
                            //{
                            //    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            //}
                            //else
                            //{
                            //    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tahsilat, " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            //}
                            //cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                            //cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                            //cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                            //cariHaraketler.CariHesapKodu = yurtDisiBrokerCariHesapKodu;
                            //cariHaraketler.BorcAlacakTipi = "B";
                            //cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                            //cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                            //_Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                            //#endregion

                            #endregion
                            #region yurtdisi broker alacak (brüt prim eklendi -03.08.2022)
                            cariBorcAlacakModel = new CariHesapBorcAlacak();
                            cariHaraketler = new CariHareketleri();
                            #region borç alacak

                            string yurtDisiBrokerCariHesapKodu = "340." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');

                            cariHesap = _Muhasebe_CariHesapService.GetCariHesap(yurtDisiBrokerCariHesapKodu);
                            cariBorcAlacakModel.CariHesapId = cariHesap.CariHesapId;
                            cariBorcAlacakModel.CariHesapKodu = cariHesap.CariHesapKodu;
                            cariBorcAlacakModel.TVMKodu = cariHesap.TVMKodu;
                            cariBorcAlacakModel.KimlikNo = cariHesap.KimlikNo;
                            cariBorcAlacakModel.KayitTarihi = cariHesap.KayitTarihi;

                            donemKasaYil = String.Empty;
                            donemKasaAy = String.Empty;
                            if (!String.IsNullOrEmpty(BelgeTarihi))
                            {
                                var parts = BelgeTarihi.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    donemKasaYil = parts[2];
                                    donemKasaAy = parts[1];
                                }
                            }

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                            }
                            else
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                            }
                            #endregion
                            #region cari haraket ekleme
                            cariHaraketler.CariHesapId = cariHesap.CariHesapId;
                            cariHaraketler.EvrakNo = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                            cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                            if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                            {
                                cariHaraketler.Tutar = OdenenTutar;
                            }
                            else
                            {
                                cariHaraketler.Tutar = OdenenTutar;
                            }

                            if (topluTahsilatMi == true)
                            {
                                cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            else
                            {
                                cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tahsilat, " + polOdeme.TaksitNo + ".Taksit" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                            }
                            cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                            cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                            cariHaraketler.CariHesapKodu = yurtDisiBrokerCariHesapKodu;
                            cariHaraketler.BorcAlacakTipi = "A";
                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                            #endregion

                            #endregion

                            #region eski kod
                            /*   decimal yurtDisiAlinanKomisyonTaksit = reasurorGenel.YurtdisiAlinanKomisyonTL.Value / polGenel.GenelBilgiler.PoliceTahsilats.Count;
                               decimal dovizliYurtDisiAlinanKomisyonTaksit = reasurorGenel.YurtdisiAlinanKomisyon.Value / polGenel.GenelBilgiler.PoliceTahsilats.Count;

                               #region yurtdisi broker alacak
                               cariBorcAlacakModel = new CariHesapBorcAlacak();
                               cariHaraketler = new CariHareketleri();
                               #region borç alacak
                               yurtDisiBrokerCariHesapKodu = "340." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');
                               yurtDisiBrokerCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(yurtDisiBrokerCariHesapKodu, _AktifKullaniciService.TVMKodu);

                               foreach (var items in yurtDisiBrokerCariHesap)
                               {
                                   cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                   cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                   cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                   cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                   cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                               }

                               donemKasaYil = String.Empty;
                               donemKasaAy = String.Empty;
                               if (!String.IsNullOrEmpty(BelgeTarihi))
                               {
                                   var parts = BelgeTarihi.Split('.');
                                   if (parts != null && parts.Count() == 3)
                                   {
                                       donemKasaYil = parts[2];
                                       donemKasaAy = parts[1];
                                   }
                               }

                               cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                               cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                               if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                               {
                                   _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, dovizliYurtDisiAlinanKomisyonTaksit);
                               }
                               else
                               {
                                   _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, yurtDisiAlinanKomisyonTaksit);
                               }
                               #endregion
                               #region cari haraket ekleme

                               cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo + "/" + polOdeme.TaksitNo; ;
                               cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                               cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                               cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                               cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                               if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                               {
                                   cariHaraketler.Tutar = dovizliYurtDisiAlinanKomisyonTaksit;
                               }
                               else
                               {
                                   cariHaraketler.Tutar = yurtDisiAlinanKomisyonTaksit;
                               }
                               cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tahsilat, Yurt Dışı Alınan Komisyon" + polOdeme.TaksitNo + ".Taksit"; 
                               cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                               cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                               cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                               cariHaraketler.CariHesapKodu = yurtDisiBrokerCariHesapKodu;
                               cariHaraketler.BorcAlacakTipi = "A";
                               cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                               cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                               _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                               #endregion

                               #endregion

                               #region komisyon gelirleri
                               cariBorcAlacakModel = new CariHesapBorcAlacak();
                               cariHaraketler = new CariHareketleri();
                               #region borç alacak
                               string komisyonGelirleriCariHesapKodu = "600." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');
                               var komisyonGelirleriCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(komisyonGelirleriCariHesapKodu, _AktifKullaniciService.TVMKodu);
                               foreach (var items in komisyonGelirleriCariHesap)
                               {
                                   cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                   cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                   cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                   cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                   cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                               }

                               donemKasaYil = String.Empty;
                               donemKasaAy = String.Empty;
                               if (!String.IsNullOrEmpty(BelgeTarihi))
                               {
                                   var parts = BelgeTarihi.Split('.');
                                   if (parts != null && parts.Count() == 3)
                                   {
                                       donemKasaYil = parts[2];
                                       donemKasaAy = parts[1];
                                   }
                               }

                               cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                               cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                               if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                               {
                                   _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, dovizliYurtDisiAlinanKomisyonTaksit, 0);
                               }
                               else
                               {
                                   _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, yurtDisiAlinanKomisyonTaksit, 0);
                               }
                               #endregion
                               #region cari haraket ekleme

                               cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo  + "/" + polOdeme.TaksitNo;
                               cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                               cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                               cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                               cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                               if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                               {
                                   cariHaraketler.Tutar = dovizliYurtDisiAlinanKomisyonTaksit;
                               }
                               else
                               {
                                   cariHaraketler.Tutar = yurtDisiAlinanKomisyonTaksit;
                               }
                               cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tahsilat, Yurt Dışı Alınan Komisyon" + polOdeme.TaksitNo + ".Taksit";
                               cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                               cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                               cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                               cariHaraketler.CariHesapKodu = komisyonGelirleriCariHesapKodu;
                               cariHaraketler.BorcAlacakTipi = "B";
                               cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                               cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                               _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                               #endregion

                               #endregion*/
                            #endregion
                            #region police tahsilat
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                                    polTahsilat.OdenenTutar += polOdeme.TaksitTutari.Value;
                                else
                                    polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                var vergiKimlikNo = String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo : polGenel.GenelBilgiler.PoliceSigortali.KimlikNo;
                                polTahsilat.CariHesapKodu = _Muhasebe_CariHesapService.GetCariHesapByVKN(vergiKimlikNo, polGenel.GenelBilgiler.PoliceId).Item2;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion

                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }

                    }
                }
            }

            #endregion

            return Json(new { mesaj });
        }
        void cariHareketveCariBorcAlacakEkle(nsbusiness.Police polGenel, ReasurorGenel reasurorGenel, PoliceOdemePlani polOdeme, decimal OdenenTutar, string cariHesapKodu, string policeParaBirimiKodu, string BelgeTarihi, string dekontEvrakNo, string EvrakNo, string OdemeTuru, string BorcAlacakTipi, string cariHareketAciklama, byte EvrakTipi)
        {
            CariHesapBorcAlacak cariBorcAlacakModel = new CariHesapBorcAlacak();
            CariHareketleri cariHaraketler = new CariHareketleri();
            #region borç alacak
            var cariHesap = _Muhasebe_CariHesapService.GetCariHesap(cariHesapKodu);

            cariBorcAlacakModel.CariHesapId = cariHesap.CariHesapId;
            cariBorcAlacakModel.CariHesapKodu = cariHesap.CariHesapKodu;
            cariBorcAlacakModel.TVMKodu = cariHesap.TVMKodu;
            cariBorcAlacakModel.KimlikNo = cariHesap.KimlikNo;
            cariBorcAlacakModel.KayitTarihi = cariHesap.KayitTarihi;

            string donemKasaYil = String.Empty;
            string donemKasaAy = String.Empty;
            if (!String.IsNullOrEmpty(BelgeTarihi))
            {
                var parts = BelgeTarihi.Split('.');
                if (parts != null && parts.Count() == 3)
                {
                    donemKasaYil = parts[2];
                    donemKasaAy = parts[1];
                }
            }

            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

            if (BorcAlacakTipi == "A")
                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, OdenenTutar);
            else
                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);

            #endregion
            #region cari haraket ekleme

            cariHaraketler.EvrakNo = EvrakNo;
            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
            cariHaraketler.EvrakTipi = EvrakTipi;
            cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
            cariHaraketler.Tutar = OdenenTutar;
            cariHaraketler.Aciklama = cariHareketAciklama;

            cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
            cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
            cariHaraketler.CariHesapId = cariHesap.CariHesapId;
            cariHaraketler.CariHesapKodu = cariHesap.CariHesapKodu;
            cariHaraketler.BorcAlacakTipi = BorcAlacakTipi;
            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

            #endregion


        }
        //tek tek ödeme butonu +

        [HttpPost]
        [AjaxException]
        public ActionResult GetPoliceOfflineDetail(int Polid, int taksitNo, decimal OdenenTutar, string BelgeNo, string BelgeTarihi, string OdemeTuru, string AcenteKrediKarti, string odeyenCariHesapKodu, string dekontEvrakNo)
        {
            //Neosinerji.BABOnlineTP.Business.Police models
            // PoliceTahsilat model = new PoliceTahsilat();
            PoliceGenel polGenelmodel = new PoliceGenel();
            CariHesapBorcAlacak cariBorcAlacakModel = new CariHesapBorcAlacak();
            CariHareketleri cariHaraketler = new CariHareketleri();
            int _TVMKodu = _AktifKullaniciService.TVMKodu;
            var polGenel = _PoliceService.GetPoliceById(Polid);
            var polOdeme = _PoliceService.GetPoliceOdemePlani(Polid, taksitNo);
            PoliceTahsilat polTahsilat = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid && s.TaksitNo == taksitNo).FirstOrDefault();
            string mesaj = string.Empty;
            List<PoliceTahsilat> polTahsilatList = new List<PoliceTahsilat>();
            polTahsilatList = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid && s.TaksitNo == taksitNo).ToList<PoliceTahsilat>();
            var odeyenCariHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAdi(odeyenCariHesapKodu);

            List<PoliceTahsilat> polTahsilatListOtomatikTahKKMiOtoKontrol = new List<PoliceTahsilat>();
            polTahsilatListOtomatikTahKKMiOtoKontrol = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid).ToList<PoliceTahsilat>();
            if (polTahsilatListOtomatikTahKKMiOtoKontrol != null || polTahsilatListOtomatikTahKKMiOtoKontrol.Count > 0)
            {
                if (polTahsilatListOtomatikTahKKMiOtoKontrol.Count == 1)
                {
                    foreach (var itemOtomatikTahKKMi in polTahsilatListOtomatikTahKKMiOtoKontrol)
                    {
                        if (itemOtomatikTahKKMi.OdemTipi == 2 && OdemeTuru != "2")
                        {
                            itemOtomatikTahKKMi.OtomatikTahsilatiKkMi = null;
                            _PoliceService.UpdatePoliceTahsilat(itemOtomatikTahKKMi);

                        }
                    }
                }
            }

            #region kayıt guncelle

            if (polOdeme != null && OdenenTutar <= polOdeme.TaksitTutari)
            {

                if (odeyenCariHesabiVarmi.Item2 != null)
                {
                    //Nakitse
                    if (OdemeTuru == "1")
                    {
                        var kasaHesabi = "100.01.";
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        if (kasaHesaplari == null || carihesap == null)
                        {
                            mesaj = "false";
                        }
                        var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);

                        if (carihesap != null && carihesap.Count > 0 && kasaHesabiVarmi != null && kasaHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, OdenenTutar * -1, 0);

                            }
                            else
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            }

                            if (kasaHesabiVarmi != null)
                            {
                                foreach (var items in kasaHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }
                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion

                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Müşteri Kredi Kartı
                    if (OdemeTuru == "2")
                    {
                        var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                        var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                        var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);

                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        //var musteriKkartiCariKodu = odeyenCariHesapKodu; // hangi şirket olduğu bılınmıyor

                        if (carihesap != null && carihesap.Count > 0 && sigortaSirketiCariHesasbiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null)
                        {

                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, OdenenTutar * -1, 0);

                            }
                            else
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            }




                            if (sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = BelgeNo + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;

                                foreach (var itemSigortasirketCari in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemSigortasirketCari.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }
                    }
                    //Havale ise
                    if (OdemeTuru == "3")
                    {
                        //var bankaHesabi = "102.01.";
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        // havale ise acentenin banka hesabını çağırıyoruz. o yüzden 8 yazdık. 8= acente banka hesabı
                        var bankaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, 8, AcenteKrediKarti);
                        var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(bankaHesaplari.CariHesapNo);

                        //var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariKasaHesapList(bankaHesabi);
                        if (carihesap != null && carihesap.Count > 0 && bankaHesabiVarmi != null && bankaHesabiVarmi.Count > 0)
                        {

                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, OdenenTutar * -1, 0);

                            }
                            else
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            }




                            if (bankaHesabiVarmi != null)
                            {
                                foreach (var itemss in bankaHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = itemss.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = itemss.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = itemss.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = itemss.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = itemss.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);

                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemBankaCariHesap in bankaHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemBankaCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Çek
                    if (OdemeTuru == "4")
                    {
                        int odemeturu = Convert.ToInt32(OdemeTuru);

                        //var alinanCekler = "101.01.";
                        var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                        var alinanCekHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);

                        var alinanCekHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanCekHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && alinanCekHesabiVarmi != null && alinanCekHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                            cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (alinanCekHesabiVarmi != null)
                            {
                                foreach (var items in alinanCekHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemCekCariHesap in alinanCekHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemCekCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);

                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {

                            mesaj = "false";
                        }

                    }
                    //Acente Kredi Kartı
                    if (OdemeTuru == "5")
                    {
                        //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var acenteKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var acenteKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteKKHesaplari.CariHesapNo);

                        //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                        var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                        var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                        var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                        if (acenteKKHesabiVarmi != null && acenteKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                        {

                            foreach (var item in acenteKKHesabiVarmi)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (sigortaSirketiCariHesasbiVarmi != null)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme
                                // ss şirketi
                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                //Acente kk
                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemsss in acenteKKHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "A";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {

                            mesaj = "false";
                        }

                    }
                    //Acente Pos Hesabi
                    if (OdemeTuru == "6")
                    {
                        int odemeturu = Convert.ToInt32(OdemeTuru);

                        var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                        var posHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);

                        var posHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(posHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && posHesabiVarmi != null && posHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                            cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (posHesabiVarmi != null)
                            {
                                foreach (var items in posHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemPosCariHesap in posHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemPosCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {

                            mesaj = "false";
                        }

                    }
                    //Senet
                    if (OdemeTuru == "7")
                    {
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var alinanSenetHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        //var Alacak senetleri = "121.01.";
                        var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                        var alacakSenetHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanSenetHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && alacakSenetHesabiVarmi != null && alacakSenetHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                            cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (alacakSenetHesabiVarmi != null)
                            {
                                foreach (var items in alacakSenetHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemSenetCariHesap in alacakSenetHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemSenetCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {

                            mesaj = "false";
                        }

                    }
                    //Acente Bireysel Kredi Kartı
                    if (OdemeTuru == "9")
                    {
                        //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var acenteBKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var acenteBKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteBKKHesaplari.CariHesapNo);

                        //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                        var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                        var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                        var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                        if (acenteBKKHesabiVarmi != null && acenteBKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                        {

                            foreach (var item in acenteBKKHesabiVarmi)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (sigortaSirketiCariHesasbiVarmi != null)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme
                                // ss şirketi
                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                //Acente kk
                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti;
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemsss in acenteBKKHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "A";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = "true";
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        {

                            mesaj = "false";
                        }

                    }
                }

            }

            #endregion

            return Json(new { mesaj });
        }

        bool UpdateManuelPoliceDetail(int Polid, int taksitNo, decimal OdenenTutar, string BelgeNo, string BelgeTarihi, string OdemeTuru, string AcenteKrediKarti, string odeyenCariHesapKodu, string dekontEvrakNo)
        {
            //Neosinerji.BABOnlineTP.Business.Police models
            // PoliceTahsilat model = new PoliceTahsilat();
            PoliceGenel polGenelmodel = new PoliceGenel();
            CariHesapBorcAlacak cariBorcAlacakModel = new CariHesapBorcAlacak();
            CariHareketleri cariHaraketler = new CariHareketleri();
            int _TVMKodu = _AktifKullaniciService.TVMKodu;
            var polGenel = _PoliceService.GetPoliceById(Polid);
            var polOdeme = _PoliceService.GetPoliceOdemePlani(Polid, taksitNo);
            PoliceTahsilat polTahsilat = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid && s.TaksitNo == taksitNo).FirstOrDefault();
            bool mesaj = false;
            List<PoliceTahsilat> polTahsilatList = new List<PoliceTahsilat>();
            polTahsilatList = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid && s.TaksitNo == taksitNo).ToList<PoliceTahsilat>();
            var odeyenCariHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAdi(odeyenCariHesapKodu);

            List<PoliceTahsilat> polTahsilatListOtomatikTahKKMiOtoKontrol = new List<PoliceTahsilat>();
            polTahsilatListOtomatikTahKKMiOtoKontrol = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid).ToList<PoliceTahsilat>();
            if (polTahsilatListOtomatikTahKKMiOtoKontrol != null || polTahsilatListOtomatikTahKKMiOtoKontrol.Count > 0)
            {
                if (polTahsilatListOtomatikTahKKMiOtoKontrol.Count == 1)
                {
                    foreach (var itemOtomatikTahKKMi in polTahsilatListOtomatikTahKKMiOtoKontrol)
                    {
                        if (itemOtomatikTahKKMi.OdemTipi == 2 && OdemeTuru != "2")
                        {
                            itemOtomatikTahKKMi.OtomatikTahsilatiKkMi = null;
                            _PoliceService.UpdatePoliceTahsilat(itemOtomatikTahKKMi);

                        }
                    }
                }
            }

            #region kayıt guncelle

            if (polOdeme != null && OdenenTutar <= polOdeme.TaksitTutari)
            {

                if (odeyenCariHesabiVarmi.Item2 != null)
                {
                    //Nakitse
                    if (OdemeTuru == "1")
                    {
                        var kasaHesabi = "100.01.";
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        if (kasaHesaplari == null || carihesap == null)
                        {
                            mesaj = false;
                        }
                        var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);

                        if (carihesap != null && carihesap.Count > 0 && kasaHesabiVarmi != null && kasaHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, OdenenTutar * -1, 0);

                            }
                            else
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            }

                            if (kasaHesabiVarmi != null)
                            {
                                foreach (var items in kasaHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var tempDate = Convert.ToDateTime(BelgeTarihi);
                                    donemKasaAy = tempDate.Month.ToString();
                                    donemKasaYil = tempDate.Year.ToString();
                                    //var parts = BelgeTarihi.Split('.');
                                    //if (parts != null && parts.Count() == 3)
                                    //{
                                    //    donemKasaYil = parts[2];
                                    //    donemKasaAy = parts[1];
                                    //}
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }
                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = true;
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = true;
                            }
                            #endregion

                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {
                            mesaj = false;
                        }

                    }
                    //Müşteri Kredi Kartı
                    if (OdemeTuru == "2")
                    {
                        var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                        var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                        var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);

                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        //var musteriKkartiCariKodu = odeyenCariHesapKodu; // hangi şirket olduğu bılınmıyor

                        if (carihesap != null && carihesap.Count > 0 && sigortaSirketiCariHesasbiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null)
                        {

                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, OdenenTutar * -1, 0);

                            }
                            else
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, OdenenTutar, OdenenTutar);

                            }




                            if (sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = BelgeNo + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;

                                foreach (var itemSigortasirketCari in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemSigortasirketCari.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = true;
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = true;
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {
                            mesaj = false;
                        }
                    }
                    //Havale ise
                    if (OdemeTuru == "3")
                    {
                        //var bankaHesabi = "102.01.";
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        // havale ise acentenin banka hesabını çağırıyoruz. o yüzden 8 yazdık. 8= acente banka hesabı
                        var bankaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, 8, AcenteKrediKarti);
                        var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(bankaHesaplari.CariHesapNo);

                        //var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariKasaHesapList(bankaHesabi);
                        if (carihesap != null && carihesap.Count > 0 && bankaHesabiVarmi != null && bankaHesabiVarmi.Count > 0)
                        {

                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, OdenenTutar * -1, 0);

                            }
                            else
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            }




                            if (bankaHesabiVarmi != null)
                            {
                                foreach (var itemss in bankaHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = itemss.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = itemss.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = itemss.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = itemss.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = itemss.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);

                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemBankaCariHesap in bankaHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemBankaCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = true;
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = true;
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {
                            mesaj = false;
                        }

                    }
                    //Çek
                    if (OdemeTuru == "4")
                    {
                        int odemeturu = Convert.ToInt32(OdemeTuru);

                        //var alinanCekler = "101.01.";
                        var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                        var alinanCekHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);

                        var alinanCekHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanCekHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && alinanCekHesabiVarmi != null && alinanCekHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                            cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (alinanCekHesabiVarmi != null)
                            {
                                foreach (var items in alinanCekHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemCekCariHesap in alinanCekHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemCekCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);

                                mesaj = true;
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = true;
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {

                            mesaj = false;
                        }

                    }
                    //Acente Kredi Kartı
                    if (OdemeTuru == "5")
                    {
                        //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var acenteKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var acenteKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteKKHesaplari.CariHesapNo);

                        //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                        var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                        var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                        var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                        if (acenteKKHesabiVarmi != null && acenteKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                        {

                            foreach (var item in acenteKKHesabiVarmi)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (sigortaSirketiCariHesasbiVarmi != null)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme
                                // ss şirketi
                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                //Acente kk
                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemsss in acenteKKHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "A";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = true;
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = true;
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {

                            mesaj = false;
                        }

                    }
                    //Acente Pos Hesabi
                    if (OdemeTuru == "6")
                    {
                        int odemeturu = Convert.ToInt32(OdemeTuru);

                        var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                        var posHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);

                        var posHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(posHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && posHesabiVarmi != null && posHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                            cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (posHesabiVarmi != null)
                            {
                                foreach (var items in posHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemPosCariHesap in posHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemPosCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = true;
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = true;
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {

                            mesaj = false;
                        }

                    }
                    //Senet
                    if (OdemeTuru == "7")
                    {
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var alinanSenetHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        //var Alacak senetleri = "121.01.";
                        var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                        var alacakSenetHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanSenetHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && alacakSenetHesabiVarmi != null && alacakSenetHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                            cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (alacakSenetHesabiVarmi != null)
                            {
                                foreach (var items in alacakSenetHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemSenetCariHesap in alacakSenetHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemSenetCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = true;
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = true;
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        else
                        {

                            mesaj = false;
                        }

                    }
                    //Acente Bireysel Kredi Kartı
                    if (OdemeTuru == "9")
                    {
                        //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var acenteBKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var acenteBKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteBKKHesaplari.CariHesapNo);

                        //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                        var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                        var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                        var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                        if (acenteBKKHesabiVarmi != null && acenteBKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                        {

                            foreach (var item in acenteBKKHesabiVarmi)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            string donemYil = String.Empty;
                            string donemAy = String.Empty;
                            donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                            donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, OdenenTutar);

                            if (sigortaSirketiCariHesasbiVarmi != null)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, OdenenTutar, 0);
                                #region cari haraket ekleme
                                // ss şirketi
                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                //Acente kk
                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = OdenenTutar;
                                cariHaraketler.Aciklama = AcenteKrediKarti;
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                foreach (var itemsss in acenteBKKHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "A";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                #endregion
                            }

                            #region pol tah
                            if (polTahsilatList.Count != 0)
                            {
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilat.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilat.OdenenTutar;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = true;
                            }
                            else
                            {
                                PoliceTahsilat polTahsilatt = new PoliceTahsilat();
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilatt.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilatt.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilatt.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilatt.CariHesapKodu = odeyenCariHesapKodu;
                                polTahsilatt.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilatt.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (OdemeTuru != null)
                                {
                                    polTahsilatt.OdemTipi = Convert.ToInt32(OdemeTuru);
                                }
                                polTahsilatt.Dekont_EvrakNo = dekontEvrakNo;
                                polTahsilatt.TaksitNo = polOdeme.TaksitNo;
                                polTahsilatt.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilatt.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilatt.OdenenTutar += OdenenTutar;
                                if (OdemeTuru == "2")
                                {
                                    polTahsilatt.OdemeBelgeNo = BelgeNo;
                                }
                                else
                                {
                                    polTahsilatt.OdemeBelgeNo = AcenteKrediKarti;
                                }
                                polTahsilatt.OdemeBelgeTarihi = Convert.ToDateTime(BelgeTarihi);
                                polTahsilatt.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilatt.KalanTaksitTutari = polOdeme.TaksitTutari.Value - polTahsilatt.OdenenTutar;
                                polTahsilatt.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilatt);
                                mesaj = true;
                            }
                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            if (polGenel.GenelBilgiler.PoliceOdemePlanis.Count == 1)
                            {
                                var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(Polid, OdemeTuru);
                            }
                            #endregion
                        }
                        {

                            mesaj = false;
                        }

                    }
                }

            }

            #endregion

            return mesaj;
        }

        // tek tek iptal butonu +
        [HttpPost]
        [AjaxException]
        public ActionResult GetPoliceTahsilatIptali(int Polid, int taksitNo, string odenenTutar, string BelgeNo, string BelgeTarihi, string OdemeTuru, string acenteKrediKarti, string odeyenCariHesapKodu, string dekontEvrakNo)
        {
            decimal OdenenTutar = Convert.ToDecimal(odenenTutar);
            PoliceGenel polGenelmodel = new PoliceGenel();
            int _TVMKodu = _AktifKullaniciService.TVMKodu;
            var polGenel = _PoliceService.GetPoliceById(Polid);
            var polOdeme = _PoliceService.GetPoliceOdemePlani(Polid, taksitNo);
            CariHareketleri cariHaraketler = new CariHareketleri();
            PoliceTahsilat polTahsilat = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid && s.TaksitNo == taksitNo).FirstOrDefault();
            string mesaj = string.Empty;
            List<PoliceTahsilat> polTahsilatList = new List<PoliceTahsilat>();
            polTahsilatList = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == Polid && s.TaksitNo == taksitNo).ToList<PoliceTahsilat>();
            CariHesapBorcAlacak cariBorcAlacakModel = new CariHesapBorcAlacak();

            string kimlikNo;
            if (!String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo))
            {
                kimlikNo = polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
            }
            else
            {
                kimlikNo = polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo;
            }

            var _odeyenCariHesapKodu = _Muhasebe_CariHesapService.GetCariHesapByVKN(kimlikNo, Polid).Item2;
            var odeyenCariHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAdi(_odeyenCariHesapKodu);

            #region kayıt işlemini geri al

            if (polOdeme != null)
            {
                #region carihesaba yapılan odemeyı gerı al
                decimal dusulecekTaksitTutari = 0;
                int i = -1;
                foreach (var itemCari in polTahsilatList)
                {
                    i++;
                    if (polGenel.GenelBilgiler.ParaBirimi.Trim() != "TL")
                    {
                        if (OdenenTutar != 0 && polGenel.GenelBilgiler.PoliceOdemePlanis.ElementAt(i).DovizliTaksitTutari.Value != Convert.ToDecimal(odenenTutar))
                        {
                            dusulecekTaksitTutari = (polGenel.GenelBilgiler.PoliceOdemePlanis.ElementAt(i).DovizliTaksitTutari.Value - OdenenTutar);
                        }
                        else
                        {
                            dusulecekTaksitTutari = (polGenel.GenelBilgiler.PoliceOdemePlanis.ElementAt(i).DovizliTaksitTutari.Value);
                        }

                    }
                    else
                    {
                        if (OdenenTutar != 0 && itemCari.TaksitTutari != Convert.ToDecimal(odenenTutar))
                        {
                            dusulecekTaksitTutari = (itemCari.TaksitTutari - OdenenTutar);
                        }
                        else
                        {
                            dusulecekTaksitTutari = itemCari.TaksitTutari;
                        }

                    }
                }
                if (odeyenCariHesabiVarmi.Item2 != null)
                {
                    ReasurorGenel reasurorGenel = _TeklifService.getReasurorGenel(polGenel.GenelBilgiler.PoliceId.ToString(), "0");
                    TVMDetay anaAcenteTvmDetay = _TVMService.getAnaAcenteTvmDetay(_AktifKullaniciService.TVMKodu);

                    // normal acenteler için tahsilat iptali
                    if (anaAcenteTvmDetay.Tipi != 1)
                    {
                        //Nakitse
                        if (OdemeTuru == "1")
                        {
                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);
                            if (carihesap != null && kasaHesabiVarmi != null && carihesap.Count > 0 && kasaHesabiVarmi.Count > 0)
                            {

                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                {
                                    if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, dusulecekTaksitTutari, 0);

                                    }
                                    else
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);

                                    }

                                }
                                if (kasaHesabiVarmi != null)
                                {
                                    foreach (var items in kasaHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                    if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                    }
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal -" + kasaHesaplari.AcenteKrediKartiNo;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }
                                #region pol tah
                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme

                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polOdeme.OdemeTipi != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar = 0;
                                polTahsilat.OdemeBelgeNo = null;
                                polTahsilat.OdemeBelgeTarihi = null;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }

                        }
                        //Müşteri Kredi Kartı
                        if (OdemeTuru == "2")
                        {
                            var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                            var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                            var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                            var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);

                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            //var musteriKkartiCariKodu = odeyenCariHesapKodu; // hangi şirket olduğu bılınmıyor

                            if (carihesap != null && sigortaSirketiCariHesasbiVarmi.Count > 0 && carihesap.Count > 0 && sigortaSirketiCariHesasbiVarmi != null)
                            {

                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                {
                                    if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, dusulecekTaksitTutari, 0);

                                    }
                                    else
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);

                                    }

                                }
                                if (sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                                {
                                    foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                    donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                    if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                    }
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = BelgeNo + "-" + "Tah. iptal";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemSigortasirketCari in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSigortasirketCari.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }
                                #region pol tah
                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme

                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polOdeme.OdemeTipi != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar = 0;
                                polTahsilat.OdemeBelgeNo = null;
                                polTahsilat.OdemeBelgeTarihi = null;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }


                        }
                        //Havale ise
                        if (OdemeTuru == "3")
                        {
                            // var bankaHesabi = "102.01.";
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            // havale ise acentenin banka hesabını çağırıyoruz. o yüzden 8 yazdık. 8= acente banka hesabı
                            var bankaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, 8, acenteKrediKarti);
                            var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(bankaHesaplari.CariHesapNo);
                            if (carihesap != null && carihesap.Count > 0 && bankaHesabiVarmi != null && bankaHesabiVarmi.Count > 0)
                            {

                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                {
                                    if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, dusulecekTaksitTutari, 0);

                                    }
                                    else
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);

                                    }

                                }
                                if (bankaHesabiVarmi != null)
                                {
                                    foreach (var items in bankaHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                    if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                    }
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal" + bankaHesaplari.AcenteKrediKartiNo;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemBankaCariHesap in bankaHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemBankaCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }
                                #region pol tah
                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme

                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polOdeme.OdemeTipi != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar = 0;
                                polTahsilat.OdemeBelgeNo = null;
                                polTahsilat.OdemeBelgeTarihi = null;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }

                        }
                        //Çek
                        if (OdemeTuru == "4")
                        {
                            //var alinanCekler = "101.01.";
                            var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                            var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var alinanCekHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                            var alinanCekHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanCekHesaplari.CariHesapNo);
                            if (carihesap != null && carihesap.Count > 0 && alinanCekHesabiVarmi != null && alinanCekHesabiVarmi.Count > 0)
                            {
                                //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                                cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                {
                                    if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, dusulecekTaksitTutari, 0);

                                    }
                                    else
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);

                                    }

                                }
                                if (alinanCekHesabiVarmi != null)
                                {
                                    foreach (var items in alinanCekHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                    if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                    }
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal" + alinanCekHesaplari.AcenteKrediKartiNo;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemCekCariHesap in alinanCekHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemCekCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }
                                #region pol tah
                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme

                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polOdeme.OdemeTipi != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar = 0;
                                polTahsilat.OdemeBelgeNo = null;
                                polTahsilat.OdemeBelgeTarihi = null;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }


                        }
                        //Acente Kredi Kartı
                        if (OdemeTuru == "5")
                        {
                            //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var acenteKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                            var acenteKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteKKHesaplari.CariHesapNo);

                            //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                            var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                            var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                            var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                            var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                            if (acenteKKHesabiVarmi != null && acenteKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                            {

                                foreach (var item in acenteKKHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                {
                                    if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, (dusulecekTaksitTutari * (-1)));

                                    }
                                    else
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, (dusulecekTaksitTutari * (-1)), 0);

                                    }

                                }


                                if (sigortaSirketiCariHesasbiVarmi != null)
                                {
                                    foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                    donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                    if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                    }
                                    #region cari haraket ekleme
                                    // ss şirketi
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    //Acente kk
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal" + acenteKKHesaplari.AcenteKrediKartiNo;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemsss in acenteKKHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                    #endregion

                                }
                                #region pol tah
                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme

                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polOdeme.OdemeTipi != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar = 0;
                                polTahsilat.OdemeBelgeNo = null;
                                polTahsilat.OdemeBelgeTarihi = null;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }

                        }
                        //Acente Pos Hesabi
                        if (OdemeTuru == "6")
                        {
                            var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                            var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var posHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                            var posHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(posHesaplari.CariHesapNo);
                            if (carihesap != null && carihesap.Count > 0 && posHesabiVarmi != null && posHesabiVarmi.Count > 0)
                            {
                                //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                                cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                {
                                    if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, dusulecekTaksitTutari, 0);

                                    }
                                    else
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);

                                    }

                                }
                                if (posHesabiVarmi != null)
                                {
                                    foreach (var items in posHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }
                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                    if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                    }
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal" + posHesaplari.AcenteKrediKartiNo;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemPosCariHesap in posHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemPosCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }
                                #region pol tah
                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme

                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polOdeme.OdemeTipi != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar = 0;
                                polTahsilat.OdemeBelgeNo = null;
                                polTahsilat.OdemeBelgeTarihi = null;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }

                        }
                        //Senet
                        if (OdemeTuru == "7")
                        {
                            //var Alacak senetleri = "121.01.";
                            var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                            var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var alinanSenetHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                            var alacakSenetHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanSenetHesaplari.CariHesapNo);
                            if (carihesap != null && carihesap.Count > 0 && alacakSenetHesabiVarmi != null && alacakSenetHesabiVarmi.Count > 0)
                            {
                                //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                                cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                {
                                    if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, dusulecekTaksitTutari, 0);

                                    }
                                    else
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);

                                    }
                                }



                                if (alacakSenetHesabiVarmi != null)
                                {
                                    foreach (var items in alacakSenetHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                    if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                    }
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal" + alinanSenetHesaplari.AcenteKrediKartiNo;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemSenetCariHesap in alacakSenetHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSenetCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }
                                #region pol tah
                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme

                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polOdeme.OdemeTipi != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar = 0;
                                polTahsilat.OdemeBelgeNo = null;
                                polTahsilat.OdemeBelgeTarihi = null;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }

                        }
                        //Acente bİREYSEL Kredi Kartı
                        if (OdemeTuru == "9")
                        {
                            //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            var acenteBKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                            var acenteBKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteBKKHesaplari.CariHesapNo);

                            //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                            var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                            var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                            var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                            var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                            if (acenteBKKHesabiVarmi != null && acenteBKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                            {

                                foreach (var item in acenteBKKHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                {
                                    if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, (dusulecekTaksitTutari * (-1)));

                                    }
                                    else
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, (dusulecekTaksitTutari * (-1)), 0);

                                    }

                                }


                                if (sigortaSirketiCariHesasbiVarmi != null)
                                {
                                    foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    donemKasaAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                    donemKasaYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                    if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                    }
                                    #region cari haraket ekleme
                                    // ss şirketi
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    //Acente kk
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal" + acenteBKKHesaplari.AcenteKrediKartiNo;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    foreach (var itemsss in acenteBKKHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                    #endregion

                                }
                                #region pol tah
                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme

                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polOdeme.OdemeTipi != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar = 0;
                                polTahsilat.OdemeBelgeNo = null;
                                polTahsilat.OdemeBelgeTarihi = null;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                                #endregion
                            }
                            else
                            {

                                mesaj = "false";
                            }


                        }
                        //Mal-Hizmet Alımı
                        if (OdemeTuru == "11")
                        {
                            //var kasaHesabi = "100.01.";
                            //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            //var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariKasaHesapList(kasaHesabi);
                            int odemeturu = Convert.ToInt32(OdemeTuru);
                            //if (String.IsNullOrEmpty(acenteKrediKarti))
                            //{
                            //    acenteKrediKarti = polTahsilat.OdemeBelgeNo;
                            //}
                            var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                            var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                            var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);
                            if (carihesap != null && kasaHesabiVarmi != null && carihesap.Count > 0 && kasaHesabiVarmi.Count > 0)
                            {
                                //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                foreach (var item in carihesap)
                                {
                                    cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                }
                                string tcVkn = String.Empty;
                                if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                {
                                    var parts = odeyenCariHesapKodu.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        tcVkn = parts[2];
                                    }
                                }
                                cariBorcAlacakModel.KimlikNo = tcVkn;
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                {
                                    if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, dusulecekTaksitTutari, 0);

                                    }
                                    else
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);

                                    }

                                }
                                if (kasaHesabiVarmi != null)
                                {
                                    foreach (var items in kasaHesabiVarmi)
                                    {
                                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                        cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                    }

                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    if (!String.IsNullOrEmpty(BelgeTarihi))
                                    {
                                        var parts = BelgeTarihi.Split('.');
                                        if (parts != null && parts.Count() == 3)
                                        {
                                            donemKasaYil = parts[2];
                                            donemKasaAy = parts[1];
                                        }
                                    }

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                    //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                    if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                    {
                                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                    }
                                    #region cari haraket ekleme

                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = OdenenTutar;
                                    cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tah. iptal -" + kasaHesaplari.AcenteKrediKartiNo;
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                                    cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    #endregion
                                }
                                #region pol tah
                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme

                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                foreach (var item in polTahsilatList)
                                {
                                    polTahsilat.TahsilatId = item.TahsilatId;
                                }
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polOdeme.OdemeTipi != null)
                                {
                                    polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                                }
                                polTahsilat.TaksitNo = polOdeme.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                polTahsilat.OdenenTutar = 0;
                                polTahsilat.OdemeBelgeNo = null;
                                polTahsilat.OdemeBelgeTarihi = null;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                mesaj = "true";
                                #endregion
                            }
                            else
                            {
                                mesaj = "false";
                            }

                        }
                    }

                    // yurt dışı brokerler için tahsilat iptali
                    else
                    {
                        int.TryParse(polGenel.GenelBilgiler.TUMBirlikKodu, out int tempTumBirlikKodu);
                        if (tempTumBirlikKodu >= 500 && tempTumBirlikKodu <= 530)
                        {
                            mesaj = "Tahsilat İptal işleminde çalışma olduğu için işlem yapılamaz!";
                            return Json(new { mesaj, uyari = true }); ;
                        }

                        var policeParaBirimi = _TVMService.GetParaBirimiByBirimi(polGenel.GenelBilgiler.ParaBirimi);
                        string policeParaBirimiKodu = policeParaBirimi.Id.ToString().PadLeft(2, '0');
                        var sigortaSirketi = _PoliceService.getSirketBilgisi(polGenel.GenelBilgiler.SigortaSirketleri.SirketKodu);

                        string OdemeTuruIsmı = "";
                        switch (OdemeTuru)
                        {
                            case "1":
                                OdemeTuruIsmı = "Nakit";
                                break;
                            case "2":
                                OdemeTuruIsmı = "Müşteri Kredi Kartı";
                                break;
                            case "3":
                                OdemeTuruIsmı = "Havale";
                                break;
                            case "4":
                                OdemeTuruIsmı = "Çek";
                                break;
                            case "5":
                                OdemeTuruIsmı = "Acente Kredi Kartı";
                                break;
                            case "6":
                                OdemeTuruIsmı = "Acente Pos Hesabi";
                                break;
                            case "7":
                                OdemeTuruIsmı = "Senet";
                                break;
                            case "9":
                                OdemeTuruIsmı = "Acente Bireysel Kredi Kartı";
                                break;
                        }
                        var teklif = _TeklifService.GetTeklif(reasurorGenel.Teklif_ID);
                        #region müşteri alacak
                        cariBorcAlacakModel = new CariHesapBorcAlacak();
                        cariHaraketler = new CariHareketleri();
                        #region borç alacak


                        var musteriCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                        foreach (var items in musteriCariHesap)
                        {
                            cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                            cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                            cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                            cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                            cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                        }

                        string donemKasaYil = String.Empty;
                        string donemKasaAy = String.Empty;
                        if (!String.IsNullOrEmpty(BelgeTarihi))
                        {
                            var parts = BelgeTarihi.Split('.');
                            if (parts != null && parts.Count() == 3)
                            {
                                donemKasaYil = parts[2];
                                donemKasaAy = parts[1];
                            }
                        }

                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                        {
                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, dusulecekTaksitTutari, 0);
                        }

                        #endregion

                        #region cari haraket ekleme

                        cariHaraketler.CariHesapId = cariBorcAlacakModel.CariHesapId.Value;
                        cariHaraketler.EvrakNo = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                        cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                        cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                        cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                        cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                        cariHaraketler.Tutar = OdenenTutar;
                        cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tahsilat İptal " + polOdeme.TaksitNo + ".Taksit iptal" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                        cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                        cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                        cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                        cariHaraketler.CariHesapKodu = odeyenCariHesabiVarmi.Item2;
                        cariHaraketler.BorcAlacakTipi = "B";
                        cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                        cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                        _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                        #endregion

                        #endregion

                        #region fronting borç

                        cariBorcAlacakModel = new CariHesapBorcAlacak();
                        cariHaraketler = new CariHareketleri();

                        #region borç alacak

                        string frontingCarihesapKodu = "320." + policeParaBirimiKodu + "." + sigortaSirketi.VergiNumarasi;

                        var frontingCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(frontingCarihesapKodu, _AktifKullaniciService.TVMKodu);

                        foreach (var items in frontingCariHesap)
                        {
                            cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                            cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                            cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                            cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                            cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                        }

                        donemKasaYil = String.Empty;
                        donemKasaAy = String.Empty;
                        if (!String.IsNullOrEmpty(BelgeTarihi))
                        {
                            var parts = BelgeTarihi.Split('.');
                            if (parts != null && parts.Count() == 3)
                            {
                                donemKasaYil = parts[2];
                                donemKasaAy = parts[1];
                            }
                        }

                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                        {
                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, dusulecekTaksitTutari);
                        }
                        #endregion

                        #region cari haraket ekleme
                        cariHaraketler.CariHesapId = cariBorcAlacakModel.CariHesapId.Value;
                        cariHaraketler.EvrakNo = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                        cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                        cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                        cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                        cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                        cariHaraketler.Tutar = OdenenTutar;
                        cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tah. " + polOdeme.TaksitNo + ".Taksit iptal" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                        cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                        cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                        cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                        cariHaraketler.CariHesapKodu = frontingCarihesapKodu;
                        cariHaraketler.BorcAlacakTipi = "A";
                        cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                        cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                        _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                        #endregion

                        #endregion
                        decimal yurtDisiNetPrimTaksit;
                        decimal dovizliYurtDisiNetPrimTaksit = reasurorGenel.YurtdisiNetPrim ?? 0 / polGenel.GenelBilgiler.PoliceTahsilats.Count;

                        if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                        {
                            yurtDisiNetPrimTaksit = Math.Round((Convert.ToDecimal(reasurorGenel.YurtdisiNetPrim) / polGenel.GenelBilgiler.PoliceTahsilats.Count), 2);
                        }
                        else
                        {
                            yurtDisiNetPrimTaksit = Math.Round((Convert.ToDecimal(reasurorGenel.YurtdisiNetPrimTL) / polGenel.GenelBilgiler.PoliceTahsilats.Count), 2);
                        }

                        foreach (var itemCari in polTahsilatList)
                        {

                            if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                            {

                                if (yurtDisiNetPrimTaksit != 0 && dovizliYurtDisiNetPrimTaksit != Convert.ToDecimal(yurtDisiNetPrimTaksit))
                                {
                                    dusulecekTaksitTutari = (dovizliYurtDisiNetPrimTaksit - yurtDisiNetPrimTaksit);
                                }
                                else
                                {
                                    dusulecekTaksitTutari = dovizliYurtDisiNetPrimTaksit;
                                }
                            }
                            else
                            {
                                if (yurtDisiNetPrimTaksit != 0 && itemCari.TaksitTutari != Convert.ToDecimal(yurtDisiNetPrimTaksit))
                                {
                                    dusulecekTaksitTutari = (itemCari.TaksitTutari - yurtDisiNetPrimTaksit) * (-1);
                                }
                                else
                                {
                                    dusulecekTaksitTutari = itemCari.TaksitTutari * (-1);
                                }
                            }

                        }
                        #region fronting alacak
                        cariBorcAlacakModel = new CariHesapBorcAlacak();
                        cariHaraketler = new CariHareketleri();
                        #region borç alacak

                        frontingCarihesapKodu = "320." + policeParaBirimiKodu + "." + sigortaSirketi.VergiNumarasi;

                        frontingCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(frontingCarihesapKodu, _AktifKullaniciService.TVMKodu);

                        foreach (var items in frontingCariHesap)
                        {
                            cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                            cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                            cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                            cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                            cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                        }

                        donemKasaYil = String.Empty;
                        donemKasaAy = String.Empty;
                        if (!String.IsNullOrEmpty(BelgeTarihi))
                        {
                            var parts = BelgeTarihi.Split('.');
                            if (parts != null && parts.Count() == 3)
                            {
                                donemKasaYil = parts[2];
                                donemKasaAy = parts[1];
                            }
                        }

                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                        {
                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, dusulecekTaksitTutari, 0);
                        }
                        #endregion
                        #region cari haraket ekleme

                        cariHaraketler.CariHesapId = cariBorcAlacakModel.CariHesapId.Value;
                        cariHaraketler.EvrakNo = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                        cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                        cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                        cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                        cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                        cariHaraketler.Tutar = yurtDisiNetPrimTaksit;
                        cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tah. Yurt Dışı Net Prim " + polOdeme.TaksitNo + ".Taksit iptal" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                        cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                        cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                        cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                        cariHaraketler.CariHesapKodu = frontingCarihesapKodu;
                        cariHaraketler.BorcAlacakTipi = "B";
                        cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                        cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                        _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                        #endregion

                        #endregion
                        #region yurtdisi broker borc
                        cariBorcAlacakModel = new CariHesapBorcAlacak();
                        cariHaraketler = new CariHareketleri();
                        #region borç alacak

                        string yurtDisiBrokerCariHesapKodu = "340." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');
                        var yurtDisiBrokerCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(yurtDisiBrokerCariHesapKodu, _AktifKullaniciService.TVMKodu);


                        foreach (var items in yurtDisiBrokerCariHesap)
                        {
                            cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                            cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                            cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                            cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                            cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                        }

                        donemKasaYil = String.Empty;
                        donemKasaAy = String.Empty;
                        if (!String.IsNullOrEmpty(BelgeTarihi))
                        {
                            var parts = BelgeTarihi.Split('.');
                            if (parts != null && parts.Count() == 3)
                            {
                                donemKasaYil = parts[2];
                                donemKasaAy = parts[1];
                            }
                        }

                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                        {
                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, dusulecekTaksitTutari);
                        }
                        #endregion
                        #region cari haraket ekleme

                        cariHaraketler.CariHesapId = cariBorcAlacakModel.CariHesapId.Value;
                        cariHaraketler.EvrakNo = "Evr.No:" + dekontEvrakNo + "-" + "Slip:" + reasurorGenel.YurtdisiPoliceNo + "/" + polOdeme.TaksitNo;
                        cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                        cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                        cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                        cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                        cariHaraketler.Tutar = yurtDisiNetPrimTaksit;
                        cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tah. Yurt Dışı Net Prim " + polOdeme.TaksitNo + ".Taksit iptal" + "-" + "Pol.No:" + polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                        cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                        cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                        cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                        cariHaraketler.CariHesapKodu = yurtDisiBrokerCariHesapKodu;
                        cariHaraketler.BorcAlacakTipi = "A";
                        cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                        cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                        _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                        #endregion

                        #endregion

                        #region eski kod blogu
                        /*    decimal yurtDisiAlinanKomisyonTaksit;
                            if(polGenel.GenelBilgiler.ParaBirimi != "TL")
                            {
                                yurtDisiAlinanKomisyonTaksit = reasurorGenel.YurtdisiAlinanKomisyon.Value / polGenel.GenelBilgiler.PoliceTahsilats.Count;
                            }
                            else
                            {
                                yurtDisiAlinanKomisyonTaksit = reasurorGenel.YurtdisiAlinanKomisyonTL.Value / polGenel.GenelBilgiler.PoliceTahsilats.Count;
                            }


                            foreach (var itemCari in polTahsilatList)
                            {
                                if (yurtDisiAlinanKomisyonTaksit != 0 && itemCari.TaksitTutari != Convert.ToDecimal(yurtDisiAlinanKomisyonTaksit))
                                {
                                    dusulecekTaksitTutari = (itemCari.TaksitTutari - yurtDisiAlinanKomisyonTaksit) * (-1);
                                }
                                else
                                {
                                    dusulecekTaksitTutari = itemCari.TaksitTutari * (-1);
                                }

                            }
                            #region yurtdisi broker alacak
                            cariBorcAlacakModel = new CariHesapBorcAlacak();
                            cariHaraketler = new CariHareketleri();
                            #region borç alacak
                            yurtDisiBrokerCariHesapKodu = "340." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');
                            yurtDisiBrokerCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(yurtDisiBrokerCariHesapKodu, _AktifKullaniciService.TVMKodu);

                            foreach (var items in yurtDisiBrokerCariHesap)
                            {
                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                            }

                            donemKasaYil = String.Empty;
                            donemKasaAy = String.Empty;
                            if (!String.IsNullOrEmpty(BelgeTarihi))
                            {
                                var parts = BelgeTarihi.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    donemKasaYil = parts[2];
                                    donemKasaAy = parts[1];
                                }
                            }

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, dusulecekTaksitTutari);
                            }
                            #endregion
                            #region cari haraket ekleme

                            cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo + "/" + polOdeme.TaksitNo;
                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                            cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                            cariHaraketler.Tutar = yurtDisiAlinanKomisyonTaksit;
                            cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tah. Yurt Dışı Alınan Komisyon" + polOdeme.TaksitNo + ".Taksit iptal";
                            cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                            cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                            cariHaraketler.CariHesapKodu = yurtDisiBrokerCariHesapKodu;
                            cariHaraketler.BorcAlacakTipi = "B";
                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                            #endregion

                            #endregion
                            #region komisyon gelirleri
                            cariBorcAlacakModel = new CariHesapBorcAlacak();
                            cariHaraketler = new CariHareketleri();
                            #region borç alacak
                            string komisyonGelirleriCariHesapKodu = "600." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');
                            var komisyonGelirleriCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(komisyonGelirleriCariHesapKodu, _AktifKullaniciService.TVMKodu);
                            foreach (var items in komisyonGelirleriCariHesap)
                            {
                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                            }

                            donemKasaYil = String.Empty;
                            donemKasaAy = String.Empty;
                            if (!String.IsNullOrEmpty(BelgeTarihi))
                            {
                                var parts = BelgeTarihi.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    donemKasaYil = parts[2];
                                    donemKasaAy = parts[1];
                                }
                            }

                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                            if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                            {
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, (dusulecekTaksitTutari * (-1)), 0);
                            }
                            #endregion
                            #region cari haraket ekleme

                            cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo + "/" + polOdeme.TaksitNo;
                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                            cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                            cariHaraketler.Tutar = yurtDisiAlinanKomisyonTaksit;
                            cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Tah. Yurt Dışı Alınan Komisyon" + polOdeme.TaksitNo + ".Taksit iptal";
                            cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                            cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                            cariHaraketler.CariHesapKodu = komisyonGelirleriCariHesapKodu;
                            cariHaraketler.BorcAlacakTipi = "A";
                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                            #endregion

                            #endregion*/
                        #endregion

                        #region pol tah
                        polTahsilat = new PoliceTahsilat();
                        // yeni kayıt ekleme

                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                        foreach (var item in polTahsilatList)
                        {
                            polTahsilat.TahsilatId = item.TahsilatId;
                        }
                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                        if (polOdeme.OdemeTipi != null)
                        {
                            polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                        }
                        polTahsilat.TaksitNo = polOdeme.TaksitNo;
                        polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                        polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                        polTahsilat.OdenenTutar = 0;
                        polTahsilat.OdemeBelgeNo = null;
                        polTahsilat.OdemeBelgeTarihi = null;
                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                        polTahsilat.KalanTaksitTutari = polOdeme.TaksitTutari.Value;
                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                        mesaj = "true";
                        #endregion
                    }

                }
                #endregion
            }

            #endregion

            return Json(new { mesaj });
        }



        //toplutahsilat kapatma butonu kayıt etme. +
        [HttpPost]
        public ActionResult TopluTahsilatKapama(int policeid, string topluOdemeTipi, string odemeBelgeNo, string acenteKrediKarti, string odemeBelgeTarihi, string cariHesapKodu, string odenenTutar, string dekontevrakNo)
        {
            //database de carihesapkodu olmadığı için kayıt etmiyor carihesapkodunu
            string Message = String.Empty;
            PoliceGenel polGenelmodel = new PoliceGenel();
            int _TVMKodu = _AktifKullaniciService.TVMKodu;

            var polGenel = _PoliceService.GetPoliceById(policeid);
            var polOdeme = _PoliceService.GetTopluTahsilatPoliceOdemePlani(policeid);

            //PoliceTahsilat polTahsilat = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == policeid).FirstOrDefault();
            string mesaj = string.Empty;
            List<PoliceTahsilat> polTahsilatList = new List<PoliceTahsilat>();
            PoliceTahsilat polTahsilat = new PoliceTahsilat();
            polTahsilatList = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == policeid).ToList<PoliceTahsilat>();
            try
            {

                #region cari borç alacak ve cari haraket işlemleri
                CariHesapBorcAlacak cariBorcAlacakModel = new CariHesapBorcAlacak();
                CariHareketleri cariHaraketler = new CariHareketleri();
                decimal OdenenTutar = Convert.ToDecimal(odenenTutar);
                var OdemeTuru = topluOdemeTipi;
                var odeyenCariHesapKodu = cariHesapKodu;
                var BelgeTarihi = odemeBelgeTarihi;
                var AcenteKrediKarti = acenteKrediKarti;
                var BelgeNo = odemeBelgeNo;
                var odeyenCariHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAdi(odeyenCariHesapKodu);

                TVMDetay anaAcenteTvmDetay = _TVMService.getAnaAcenteTvmDetay(_AktifKullaniciService.TVMKodu);

                ReasurorGenel reasurorGenel = _TeklifService.getReasurorGenel(polGenel.GenelBilgiler.PoliceId.ToString(), "0");
                // normal acenteler için tahsilat
                if (anaAcenteTvmDetay.Tipi != 1)
                {
                    //Nakitse
                    if (OdemeTuru == "1")
                    {
                        var kasaHesabi = "100.01.";
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && kasaHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;

                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;

                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";
                                var taksitliOdenenTutar = item.TaksitTutari;
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, Convert.ToDecimal(taksitliOdenenTutar) * -1, 0);

                                }
                                else
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(taksitliOdenenTutar));

                                }


                            }
                            if (kasaHesabiVarmi != null)
                            {
                                foreach (var items in kasaHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;


                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim), 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }
                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) <= items.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = items.TaksitTutari;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                            }

                                        }
                                        else
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = items.TaksitTutari;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                            }

                                        }


                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) < items.TaksitTutari)
                                            {
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                                polTahsilat.KalanTaksitTutari = 0;
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                        }
                                        else
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                            {
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                                polTahsilat.KalanTaksitTutari = 0;
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);

                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);


                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Müşteri Kredi Kartı
                    if (OdemeTuru == "2")
                    {
                        var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                        var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                        var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);

                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        //var musteriKkartiCariKodu = odeyenCariHesapKodu; // hangi şirket olduğu bılınmıyor

                        if (carihesap != null && carihesap.Count > 0 && sigortaSirketiCariHesasbiVarmi.Count > 0)
                        {

                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";
                                var taksitliOdenenTutar = item.TaksitTutari;
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, Convert.ToDecimal(taksitliOdenenTutar) * -1, 0);

                                }
                                else
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(taksitliOdenenTutar));

                                }

                            }

                            if (sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    var taksitliodenenTutar = item.TaksitTutari;
                                    donemKasaAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                    donemKasaYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";
                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    //if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                    //{
                                    //    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0,Convert.ToDecimal(taksitliodenenTutar) * -1);
                                    //}
                                    //else
                                    //{
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(taksitliodenenTutar), 0);
                                    //}

                                }

                                #region cari haraket ekleme
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = Convert.ToDecimal(item.TaksitTutari);
                                    cariHaraketler.Aciklama = BelgeNo + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = item.VadeTarihi;
                                    foreach (var itemSigortasirketCari in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSigortasirketCari.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                }
                                #endregion
                            }

                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) <= items.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = items.TaksitTutari;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                            }

                                        }
                                        else
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = items.TaksitTutari;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                            }

                                        }


                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) < items.TaksitTutari)
                                            {
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                                polTahsilat.KalanTaksitTutari = 0;
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                        }
                                        else
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                            {
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                                polTahsilat.KalanTaksitTutari = 0;
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Havale ise
                    if (OdemeTuru == "3")
                    {
                        //var bankaHesabi = "102.01.";
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        // havale ise acentenin banka hesabını çağırıyoruz. o yüzden 8 yazdık. 8= acente banka hesabı
                        var bankaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, 8, acenteKrediKarti);
                        var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(bankaHesaplari.CariHesapNo);

                        //var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariKasaHesapList(bankaHesabi);
                        if (carihesap != null && carihesap.Count > 0 && bankaHesabiVarmi.Count > 0)
                        {
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                var taksitliOdenenTutar = item.TaksitTutari;
                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, Convert.ToDecimal(taksitliOdenenTutar) * -1, 0);

                                }
                                else
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(taksitliOdenenTutar));

                                }



                            }





                            if (bankaHesabiVarmi != null)
                            {
                                foreach (var itemss in bankaHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = itemss.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = itemss.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = itemss.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = itemss.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = itemss.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim), 0);

                                #region cari haraket ekleme
                                cariHaraketler = new CariHareketleri();
                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = Convert.ToDateTime(BelgeTarihi);
                                foreach (var itemBankaCariHesap in bankaHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemBankaCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }
                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) <= items.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = items.TaksitTutari;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                            }

                                        }
                                        else
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = items.TaksitTutari;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                            }

                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) < items.TaksitTutari)
                                            {
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                                polTahsilat.KalanTaksitTutari = 0;
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                        }
                                        else
                                        {
                                            if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                            {
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                                polTahsilat.KalanTaksitTutari = 0;
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                        }










                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            if (polTahsilat.OdemTipi == 2)
                                            {
                                                polTahsilat.OtomatikTahsilatiKkMi = null;
                                            }
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }
                    }
                    //Çek
                    if (OdemeTuru == "4")
                    {
                        //var alinanCekler = "101.01.";
                        var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var alinanCekHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                        var alinanCekHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanCekHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && alinanCekHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                            cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                var taksitliOdenenTutar = item.TaksitTutari;
                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, Convert.ToDecimal(taksitliOdenenTutar) * -1, 0);

                                }
                                else
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(taksitliOdenenTutar));

                                }
                            }



                            if (alinanCekHesabiVarmi != null)
                            {
                                foreach (var items in alinanCekHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim), 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = Convert.ToDateTime(BelgeTarihi);
                                foreach (var itemCekCariHesap in alinanCekHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemCekCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }
                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = items.TaksitTutari;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                        }


                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                        {
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                            polTahsilat.KalanTaksitTutari = 0;
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            if (polTahsilat.OdemTipi == 2)
                                            {
                                                polTahsilat.OtomatikTahsilatiKkMi = null;
                                            }
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Acente Kredi Kartı
                    if (OdemeTuru == "5")
                    {
                        //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var acenteKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var acenteKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteKKHesaplari.CariHesapNo);

                        //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                        var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                        var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                        var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                        if (acenteKKHesabiVarmi != null && acenteKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi.Count > 0)
                        {
                            foreach (var item in acenteKKHesabiVarmi)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";
                                var TaksitliOdenenTutar = item.TaksitTutari;
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, Convert.ToDecimal(TaksitliOdenenTutar) * -1, 0);

                                }
                                else
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(TaksitliOdenenTutar));

                                }




                            }
                            if (sigortaSirketiCariHesasbiVarmi != null)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    var TaksitliOdenenTutar = item.TaksitTutari;
                                    donemKasaAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                    donemKasaYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";

                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(TaksitliOdenenTutar), 0);
                                }

                                #region cari haraket ekleme
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // ss şirketi
                                    cariHaraketler = new CariHareketleri();
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = Convert.ToDecimal(item.TaksitTutari);
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = item.VadeTarihi;
                                    foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    //Acente kk
                                    cariHaraketler = new CariHareketleri();
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = Convert.ToDecimal(item.TaksitTutari);
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = item.VadeTarihi;
                                    foreach (var itemsss in acenteKKHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                }

                                #endregion
                            }
                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = items.TaksitTutari;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                        }


                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                        {
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                            polTahsilat.KalanTaksitTutari = 0;
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            if (polTahsilat.OdemTipi == 2)
                                            {
                                                polTahsilat.OtomatikTahsilatiKkMi = null;
                                            }
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Acente Pos Hesabi
                    if (OdemeTuru == "6")
                    {
                        var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var posHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                        var posHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(posHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && posHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                            cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                var TaksitliOdenenTutar = item.TaksitTutari;
                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, Convert.ToDecimal(TaksitliOdenenTutar) * -1, 0);

                                }
                                else
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(TaksitliOdenenTutar));

                                }
                            }




                            if (posHesabiVarmi != null)
                            {
                                foreach (var items in posHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim), 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = Convert.ToDateTime(BelgeTarihi);
                                foreach (var itemPosCariHesap in posHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemPosCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }
                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = items.TaksitTutari;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                        }


                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                        {
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                            polTahsilat.KalanTaksitTutari = 0;
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            if (polTahsilat.OdemTipi == 2)
                                            {
                                                polTahsilat.OtomatikTahsilatiKkMi = null;
                                            }
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Senet
                    if (OdemeTuru == "7")
                    {
                        //var Alacak senetleri = "121.01.";
                        var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                        var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var alinanSenetHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, acenteKrediKarti);
                        var alacakSenetHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanSenetHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && alacakSenetHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                            cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                var TaksitliOdenenTutar = item.TaksitTutari;
                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, Convert.ToDecimal(TaksitliOdenenTutar) * -1, 0);
                                }
                                else
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(TaksitliOdenenTutar));

                                }
                            }




                            if (alacakSenetHesabiVarmi != null)
                            {
                                foreach (var items in alacakSenetHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim), 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = Convert.ToDateTime(BelgeTarihi);
                                foreach (var itemSenetCariHesap in alacakSenetHesabiVarmi)
                                {
                                    cariHaraketler.CariHesapKodu = itemSenetCariHesap.CariHesapKodu;

                                }
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }
                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = items.TaksitTutari;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                        }


                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                        {
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                            polTahsilat.KalanTaksitTutari = 0;
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            if (polTahsilat.OdemTipi == 2)
                                            {
                                                polTahsilat.OtomatikTahsilatiKkMi = null;
                                            }
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Acente Bireysel Kredi Kartı
                    if (OdemeTuru == "9")
                    {
                        //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var acenteBKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var acenteBKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteBKKHesaplari.CariHesapNo);

                        //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                        var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                        var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                        var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                        if (acenteBKKHesabiVarmi != null && acenteBKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi.Count > 0)
                        {

                            foreach (var item in acenteBKKHesabiVarmi)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;
                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;
                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";
                                var TaksitliOdenenTutar = item.TaksitTutari;
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(TaksitliOdenenTutar));

                            }

                            if (sigortaSirketiCariHesasbiVarmi != null)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    string donemKasaYil = String.Empty;
                                    string donemKasaAy = String.Empty;
                                    donemKasaAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                    donemKasaYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";
                                    var TaksitliOdenenTutar = item.TaksitTutari;
                                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(TaksitliOdenenTutar), 0);
                                }

                                #region cari haraket ekleme
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // ss şirketi
                                    cariHaraketler = new CariHareketleri();
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = Convert.ToDecimal(item.TaksitTutari);
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = item.VadeTarihi;
                                    foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "B";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                    //Acente kk
                                    cariHaraketler = new CariHareketleri();
                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                    cariHaraketler.Tutar = Convert.ToDecimal(item.TaksitTutari);
                                    cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                    cariHaraketler.CariHareketTarihi = item.VadeTarihi;
                                    foreach (var itemsss in acenteBKKHesabiVarmi)
                                    {
                                        cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                    }
                                    cariHaraketler.BorcAlacakTipi = "A";
                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                }

                                #endregion
                            }
                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = items.TaksitTutari;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                        }


                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                        {
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                            polTahsilat.KalanTaksitTutari = 0;
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            if (polTahsilat.OdemTipi == 2)
                                            {
                                                polTahsilat.OtomatikTahsilatiKkMi = null;
                                            }
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Sig. Şirketi POS hesabı 
                    if (OdemeTuru == "10")
                    {
                        //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                        var sigortaSirketiCariHesabiKodu = acenteKrediKarti;
                        var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        if (carihesap != null && carihesap.Count > 0 && sigortaSirketiCariHesasbiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;

                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;

                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";
                                var taksitliOdenenTutar = item.TaksitTutari;
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, Convert.ToDecimal(taksitliOdenenTutar) * -1, 0);

                                }
                                else
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(taksitliOdenenTutar));

                                }


                            }
                            if (sigortaSirketiCariHesasbiVarmi != null)
                            {
                                foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim), 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                cariHaraketler.Aciklama = acenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHesapKodu = acenteKrediKarti;
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }
                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = items.TaksitTutari;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                        }


                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                        {
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                            polTahsilat.KalanTaksitTutari = 0;
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);

                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);


                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                    //Mal-Hizmet Alımı
                    if (OdemeTuru == "11")
                    {

                        int odemeturu = Convert.ToInt32(OdemeTuru);
                        var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, AcenteKrediKarti);
                        var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);
                        var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);
                        if (carihesap != null && carihesap.Count > 0 && kasaHesabiVarmi.Count > 0)
                        {
                            //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                            //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            foreach (var item in carihesap)
                            {
                                cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                            }
                            cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                            string tcVkn = String.Empty;
                            if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                            {
                                var parts = odeyenCariHesapKodu.Split('.');
                                if (parts != null && parts.Count() == 3)
                                {
                                    tcVkn = parts[2];
                                }
                            }
                            cariBorcAlacakModel.KimlikNo = tcVkn;

                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {
                                string donemYil = String.Empty;
                                string donemAy = String.Empty;

                                donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                                donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";
                                var taksitliOdenenTutar = item.TaksitTutari;
                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                if (polGenel.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, Convert.ToDecimal(taksitliOdenenTutar) * -1, 0);

                                }
                                else
                                {
                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(taksitliOdenenTutar));

                                }



                            }
                            if (kasaHesabiVarmi != null)
                            {
                                foreach (var items in kasaHesabiVarmi)
                                {
                                    cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                    cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                    cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                    cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                    cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                }

                                string donemKasaYil = String.Empty;
                                string donemKasaAy = String.Empty;
                                if (!String.IsNullOrEmpty(BelgeTarihi))
                                {
                                    var parts = BelgeTarihi.Split('.');
                                    if (parts != null && parts.Count() == 3)
                                    {
                                        donemKasaYil = parts[2];
                                        donemKasaAy = parts[1];
                                    }
                                }

                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim), 0);
                                #region cari haraket ekleme

                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                                cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                cariHaraketler.Aciklama = AcenteKrediKarti + "-" + "Tahsilat";
                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHareketTarihi = Convert.ToDateTime(BelgeTarihi);
                                cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                cariHaraketler.BorcAlacakTipi = "B";
                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                #endregion
                            }
                            #region poliçe tahsilat işlemleri

                            if (polTahsilatList != null || polTahsilatList.Count > 0)
                            {
                                foreach (var items in polTahsilatList)
                                {
                                    if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TahsilatId = items.TahsilatId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = items.TaksitNo;
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                        polTahsilat.TaksitTutari = items.TaksitTutari;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = items.TaksitTutari;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                        }


                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve  ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                        {
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                            polTahsilat.KalanTaksitTutari = 0;
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);

                                    }
                                }
                                foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                {
                                    // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                                    var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                                    if (KayitVarMi == null)
                                    {
                                        polTahsilat = new PoliceTahsilat();
                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.CariHesapKodu = cariHesapKodu;
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (polTahsilat.OdemTipi == 2)
                                        {
                                            polTahsilat.OtomatikTahsilatiKkMi = null;
                                        }
                                        polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                        polTahsilat.TaksitNo = item.TaksitNo;
                                        polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                        }
                                        else
                                        {
                                            polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                        }

                                        if (topluOdemeTipi == "2")
                                        {
                                            //müşteri kredi kartı ve havale ise
                                            polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                        }
                                        else
                                        {
                                            // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                            polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                        }
                                        polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                        //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                        {
                                            polTahsilat.KalanTaksitTutari = 0;
                                            odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                        }
                                        else
                                        {
                                            polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                            odenenTutar = "0";
                                        }
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                        _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                    }
                                }

                                mesaj = "true";
                            }
                            else
                            {
                                if (polOdeme != null)
                                {
                                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                                    {

                                        if (polTahsilat.KalanTaksitTutari != 0)
                                        {
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.CariHesapKodu = cariHesapKodu;
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                            polTahsilat.TaksitNo = item.TaksitNo;
                                            polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                            }
                                            else
                                            {
                                                polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                            }
                                            if (topluOdemeTipi == "2")
                                            {
                                                //müşteri kredi kartı ve  ise
                                                polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                            }
                                            else
                                            {
                                                // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                                polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                            }
                                            polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);


                                            //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                            {
                                                polTahsilat.KalanTaksitTutari = 0;
                                                odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                            }
                                            else
                                            {
                                                polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                                odenenTutar = "0";
                                            }
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                            _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                        }
                                    }
                                    mesaj = "true";
                                }
                                else
                                {
                                    mesaj = "false";
                                }
                            }

                            #endregion
                            #region odemeplaniiş odemetipi güncelle
                            var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                            #endregion
                        }
                        else
                        {
                            mesaj = "false";
                        }

                    }
                }
                // yurt dışı brokerler için tahsilat
                else
                {
                    var policeParaBirimi = _TVMService.GetParaBirimiByBirimi(polGenel.GenelBilgiler.ParaBirimi);
                    string policeParaBirimiKodu = policeParaBirimi.Id.ToString().PadLeft(2, '0');
                    var sigortaSirketi = _PoliceService.getSirketBilgisi(polGenel.GenelBilgiler.SigortaSirketleri.SirketKodu.ToString());
                    // yurt dışı brokerler için tahsilat
                    string OdemeTuruIsmı = "";
                    switch (OdemeTuru)
                    {
                        case "1":
                            OdemeTuruIsmı = "Nakit";
                            break;
                        case "2":
                            OdemeTuruIsmı = "Müşteri Kredi Kartı";
                            break;
                        case "3":
                            OdemeTuruIsmı = "Havale";
                            break;
                        case "4":
                            OdemeTuruIsmı = "Çek";
                            break;
                        case "5":
                            OdemeTuruIsmı = "Acente Kredi Kartı";
                            break;
                        case "6":
                            OdemeTuruIsmı = "Acente Pos Hesabi";
                            break;
                        case "7":
                            OdemeTuruIsmı = "Senet";
                            break;
                        case "9":
                            OdemeTuruIsmı = "Acente Bireysel Kredi Kartı";
                            break;
                    }
                    var teklif = _TeklifService.GetTeklif(reasurorGenel.Teklif_ID);

                    #region müşteri alacak
                    cariBorcAlacakModel = new CariHesapBorcAlacak();
                    cariHaraketler = new CariHareketleri();
                    #region borç alacak


                    var musteriCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                    foreach (var items in musteriCariHesap)
                    {
                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                    }

                    string donemKasaYil = String.Empty;
                    string donemKasaAy = String.Empty;
                    if (!String.IsNullOrEmpty(BelgeTarihi))
                    {
                        var parts = BelgeTarihi.Split('.');
                        if (parts != null && parts.Count() == 3)
                        {
                            donemKasaYil = parts[2];
                            donemKasaAy = parts[1];
                        }
                    }

                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                    //_Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, OdenenTutar);
                    // Müşteriye taksitlerin tamamı alacak olarak yazılıyor
                    foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                    {
                        string donemYil = String.Empty;
                        string donemAy = String.Empty;

                        donemAy = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Month.ToString() : "";
                        donemYil = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.Year.ToString() : "";
                        var taksitliOdenenTutar = item.TaksitTutari;
                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                        _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, Convert.ToDecimal(taksitliOdenenTutar));

                    }


                    #endregion

                    #region cari haraket ekleme

                    cariHaraketler.EvrakNo = reasurorGenel.YurtdisiPoliceNo.ToString();
                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                    if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                    {
                        cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.DovizliBrutPrim);
                    }
                    else
                    {
                        cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                    }
                    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat" + "-" + polGenel.GenelBilgiler.PoliceNumarasi;
                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                    cariHaraketler.CariHesapKodu = odeyenCariHesabiVarmi.Item2;
                    cariHaraketler.BorcAlacakTipi = "A";
                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                    #endregion

                    #endregion

                    #region fronting borç

                    cariBorcAlacakModel = new CariHesapBorcAlacak();
                    cariHaraketler = new CariHareketleri();

                    #region borç alacak

                    string frontingCarihesapKodu = "320." + policeParaBirimiKodu + "." + sigortaSirketi.VergiNumarasi;

                    var frontingCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(frontingCarihesapKodu, _AktifKullaniciService.TVMKodu);

                    foreach (var items in frontingCariHesap)
                    {
                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                    }

                    donemKasaYil = String.Empty;
                    donemKasaAy = String.Empty;
                    if (!String.IsNullOrEmpty(BelgeTarihi))
                    {
                        var parts = BelgeTarihi.Split('.');
                        if (parts != null && parts.Count() == 3)
                        {
                            donemKasaYil = parts[2];
                            donemKasaAy = parts[1];
                        }
                    }

                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim), 0);

                    #endregion

                    #region cari haraket ekleme

                    cariHaraketler.EvrakNo = reasurorGenel.YurtdisiPoliceNo.ToString();
                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                    if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                    {
                        cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.DovizliBrutPrim);
                    }
                    else
                    {
                        cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                    }
                    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat" + "-" + polGenel.GenelBilgiler.PoliceNumarasi;
                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                    cariHaraketler.CariHesapKodu = odeyenCariHesabiVarmi.Item2;
                    cariHaraketler.BorcAlacakTipi = "B";
                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                    #endregion
                    #endregion

                    decimal yurtDisiNetPrimTaksit = Math.Round((Convert.ToDecimal(reasurorGenel.YurtdisiNetPrimTL) / polGenel.GenelBilgiler.PoliceTahsilats.Count), 2);
                    decimal yurtDisiNetPrimTL = Convert.ToDecimal(reasurorGenel.YurtdisiNetPrimTL);
                    decimal dovizliYurtDisiNetPrim = Convert.ToDecimal(reasurorGenel.YurtdisiNetPrim);

                    #region fronting alacak
                    cariBorcAlacakModel = new CariHesapBorcAlacak();
                    cariHaraketler = new CariHareketleri();
                    #region borç alacak

                    frontingCarihesapKodu = "320." + policeParaBirimiKodu + "." + sigortaSirketi.VergiNumarasi;

                    frontingCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(frontingCarihesapKodu, _AktifKullaniciService.TVMKodu);

                    foreach (var items in frontingCariHesap)
                    {
                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                    }

                    donemKasaYil = String.Empty;
                    donemKasaAy = String.Empty;
                    if (!String.IsNullOrEmpty(BelgeTarihi))
                    {
                        var parts = BelgeTarihi.Split('.');
                        if (parts != null && parts.Count() == 3)
                        {
                            donemKasaYil = parts[2];
                            donemKasaAy = parts[1];
                        }
                    }

                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, yurtDisiNetPrimTL);
                    #endregion
                    #region cari haraket ekleme

                    cariHaraketler.EvrakNo = reasurorGenel.YurtdisiPoliceNo.ToString();
                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                    if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                    {
                        cariHaraketler.Tutar = dovizliYurtDisiNetPrim;
                    }
                    else
                    {
                        cariHaraketler.Tutar = yurtDisiNetPrimTL;
                    }
                    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat" + "-" + polGenel.GenelBilgiler.PoliceNumarasi;
                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                    cariHaraketler.CariHesapKodu = odeyenCariHesabiVarmi.Item2;
                    cariHaraketler.BorcAlacakTipi = "A";
                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                    #endregion

                    #endregion

                    #region yurtdisi broker borc
                    cariBorcAlacakModel = new CariHesapBorcAlacak();
                    cariHaraketler = new CariHareketleri();
                    #region borç alacak

                    string yurtDisiBrokerCariHesapKodu = "340." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');
                    var yurtDisiBrokerCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(yurtDisiBrokerCariHesapKodu, _AktifKullaniciService.TVMKodu);


                    foreach (var items in yurtDisiBrokerCariHesap)
                    {
                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                    }

                    donemKasaYil = String.Empty;
                    donemKasaAy = String.Empty;
                    if (!String.IsNullOrEmpty(BelgeTarihi))
                    {
                        var parts = BelgeTarihi.Split('.');
                        if (parts != null && parts.Count() == 3)
                        {
                            donemKasaYil = parts[2];
                            donemKasaAy = parts[1];
                        }
                    }

                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, yurtDisiNetPrimTL, 0);
                    #endregion
                    #region cari haraket ekleme

                    cariHaraketler.EvrakNo = reasurorGenel.YurtdisiPoliceNo.ToString();
                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                    if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                    {
                        cariHaraketler.Tutar = dovizliYurtDisiNetPrim;
                    }
                    else
                    {
                        cariHaraketler.Tutar = yurtDisiNetPrimTL;
                    }
                    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat" + "-" + polGenel.GenelBilgiler.PoliceNumarasi;
                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                    cariHaraketler.CariHesapKodu = odeyenCariHesabiVarmi.Item2;
                    cariHaraketler.BorcAlacakTipi = "B";
                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                    #endregion

                    #endregion

                    #region poliçe tahsilat işlemleri

                    if (polTahsilatList != null || polTahsilatList.Count > 0)
                    {
                        foreach (var items in polTahsilatList)
                        {
                            if (items.KalanTaksitTutari != 0 && odenenTutar != "0")
                            {
                                int i = -1;
                                i++;

                                polTahsilat = new PoliceTahsilat();
                                // yeni kayıt ekleme
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.TahsilatId = items.TahsilatId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polTahsilat.OdemTipi == 2)
                                {
                                    polTahsilat.OtomatikTahsilatiKkMi = null;
                                }
                                polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                polTahsilat.TaksitNo = items.TaksitNo;
                                polTahsilat.CariHesapKodu = cariHesapKodu;
                                polTahsilat.TaksitVadeTarihi = items.TaksitVadeTarihi;
                                polTahsilat.TaksitTutari = items.TaksitTutari;
                                if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                                {
                                    var policeOdemePlani = polGenel.GenelBilgiler.PoliceOdemePlanis.ElementAt(i);

                                    if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= policeOdemePlani.DovizliTaksitTutari)
                                    {
                                        polTahsilat.OdenenTutar = policeOdemePlani.DovizliTaksitTutari.Value;
                                    }
                                    else
                                    {
                                        polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                    }
                                }
                                else
                                {
                                    if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) >= items.TaksitTutari)
                                    {
                                        polTahsilat.OdenenTutar = items.TaksitTutari;
                                    }
                                    else
                                    {
                                        polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar) + items.OdenenTutar;
                                    }
                                }


                                if (topluOdemeTipi == "2")
                                {
                                    //müşteri kredi kartı ve  ise
                                    polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                }
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                if ((Convert.ToDecimal(odenenTutar) + items.OdenenTutar) > items.TaksitTutari)
                                {
                                    odenenTutar = (Convert.ToDecimal(odenenTutar) - items.KalanTaksitTutari).ToString();
                                    polTahsilat.KalanTaksitTutari = 0;
                                }
                                else
                                {
                                    polTahsilat.KalanTaksitTutari = (items.KalanTaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                    odenenTutar = "0";
                                }
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.UpdatePoliceTahsilat(polTahsilat);

                            }
                        }
                        foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                        {
                            // poliçe tahsilatında ilgili poliçenin oluşturulmayan taksiti varsa onu oluşturuyor. // olmayan taksitleri ekler.
                            var KayitVarMi = polTahsilatList.Where(s => s.TaksitNo == item.TaksitNo).FirstOrDefault();
                            if (KayitVarMi == null)
                            {
                                polTahsilat = new PoliceTahsilat();
                                polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                polTahsilat.CariHesapKodu = cariHesapKodu;
                                polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                if (polTahsilat.OdemTipi == 2)
                                {
                                    polTahsilat.OtomatikTahsilatiKkMi = null;
                                }
                                polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                polTahsilat.TaksitNo = item.TaksitNo;
                                polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                {
                                    polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                }
                                else
                                {
                                    polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                }

                                if (topluOdemeTipi == "2")
                                {
                                    //müşteri kredi kartı ve havale ise
                                    polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                }
                                else
                                {
                                    // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                    polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                }
                                polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);

                                //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                {
                                    polTahsilat.KalanTaksitTutari = 0;
                                    odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                }
                                else
                                {
                                    polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                    odenenTutar = "0";
                                }
                                polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                _PoliceService.CreatePoliceTahsilat(polTahsilat);
                            }
                        }

                        mesaj = "true";
                    }
                    else
                    {
                        if (polOdeme != null)
                        {
                            foreach (var item in polGenel.GenelBilgiler.PoliceOdemePlanis)
                            {

                                if (polTahsilat.KalanTaksitTutari != 0)
                                {
                                    polTahsilat = new PoliceTahsilat();
                                    // yeni kayıt ekleme

                                    polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                    polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                    polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                    polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                    polTahsilat.CariHesapKodu = cariHesapKodu;
                                    polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                    polTahsilat.OdemTipi = Convert.ToInt32(topluOdemeTipi);
                                    polTahsilat.TaksitNo = item.TaksitNo;
                                    polTahsilat.TaksitVadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.TaksitTutari = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                    polTahsilat.Dekont_EvrakNo = dekontevrakNo;
                                    if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                    {
                                        polTahsilat.OdenenTutar = item.TaksitTutari.HasValue ? item.TaksitTutari.Value : 0;
                                    }
                                    else
                                    {
                                        polTahsilat.OdenenTutar = Convert.ToDecimal(odenenTutar);
                                    }
                                    if (topluOdemeTipi == "2")
                                    {
                                        //müşteri kredi kartı ve  ise
                                        polTahsilat.OdemeBelgeNo = odemeBelgeNo;
                                    }
                                    else
                                    {
                                        // acenta ile ilgili her şey(pos,kk,banka,kasa,çek,senet)
                                        polTahsilat.OdemeBelgeNo = acenteKrediKarti;
                                    }
                                    polTahsilat.OdemeBelgeTarihi = Convert.ToDateTime(odemeBelgeTarihi);


                                    //polTahsilat.OdemeBelgeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                    polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                    polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                    if (Convert.ToDecimal(odenenTutar) > item.TaksitTutari)
                                    {
                                        polTahsilat.KalanTaksitTutari = 0;
                                        odenenTutar = (Convert.ToDecimal(odenenTutar) - item.TaksitTutari).ToString();
                                    }
                                    else
                                    {
                                        polTahsilat.KalanTaksitTutari = (item.TaksitTutari) - (Convert.ToDecimal(odenenTutar));
                                        odenenTutar = "0";
                                    }
                                    polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    _PoliceService.CreatePoliceTahsilat(polTahsilat);
                                }
                            }
                            mesaj = "true";
                        }
                        else
                        {
                            mesaj = "false";
                        }
                    }

                    #endregion
                    #region odemeplaniiş odemetipi güncelle
                    var ödendiMi = _PoliceService.policeOdemePlaniIsOdemeTipiGuncelle(policeid, topluOdemeTipi);
                    #endregion

                    /*decimal yurtDisiAlinanKomisyonTaksit = reasurorGenel.YurtdisiAlinanKomisyonTL.Value / polGenel.GenelBilgiler.PoliceTahsilats.Count;
                    decimal dovizliYurtDisiAlinanKomisyonunTaksit = reasurorGenel.YurtdisiAlinanKomisyon.Value / polGenel.GenelBilgiler.PoliceTahsilats.Count;

                    #region yurtdisi broker alacak
                    cariBorcAlacakModel = new CariHesapBorcAlacak();
                    cariHaraketler = new CariHareketleri();
                    #region borç alacak
                    yurtDisiBrokerCariHesapKodu = "340." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');
                    yurtDisiBrokerCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(yurtDisiBrokerCariHesapKodu, _AktifKullaniciService.TVMKodu);

                    foreach (var items in yurtDisiBrokerCariHesap)
                    {
                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                    }

                    donemKasaYil = String.Empty;
                    donemKasaAy = String.Empty;
                    if (!String.IsNullOrEmpty(BelgeTarihi))
                    {
                        var parts = BelgeTarihi.Split('.');
                        if (parts != null && parts.Count() == 3)
                        {
                            donemKasaYil = parts[2];
                            donemKasaAy = parts[1];
                        }
                    }

                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, yurtDisiAlinanKomisyonTaksit);
                    #endregion
                    #region cari haraket ekleme

                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                    if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                    {
                        cariHaraketler.Tutar = dovizliYurtDisiAlinanKomisyonunTaksit;
                    }
                    else
                    {
                        cariHaraketler.Tutar = yurtDisiAlinanKomisyonTaksit;
                    }
                    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat";
                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                    cariHaraketler.CariHesapKodu = odeyenCariHesabiVarmi.Item2;
                    cariHaraketler.BorcAlacakTipi = "A";
                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                    #endregion

                    #endregion

                    #region komisyon gelirleri
                    cariBorcAlacakModel = new CariHesapBorcAlacak();
                    cariHaraketler = new CariHareketleri();
                    #region borç alacak
                    string komisyonGelirleriCariHesapKodu = "600." + policeParaBirimiKodu + "." + polGenel.GenelBilgiler.UretimTaliAcenteKodu.ToString().PadLeft(10, '0');
                    var komisyonGelirleriCariHesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(komisyonGelirleriCariHesapKodu, _AktifKullaniciService.TVMKodu);
                    foreach (var items in komisyonGelirleriCariHesap)
                    {
                        cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                        cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                        cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                        cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                        cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                    }

                    donemKasaYil = String.Empty;
                    donemKasaAy = String.Empty;
                    if (!String.IsNullOrEmpty(BelgeTarihi))
                    {
                        var parts = BelgeTarihi.Split('.');
                        if (parts != null && parts.Count() == 3)
                        {
                            donemKasaYil = parts[2];
                            donemKasaAy = parts[1];
                        }
                    }

                    cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                    cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;

                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, yurtDisiAlinanKomisyonTaksit, 0);
                    #endregion
                    #region cari haraket ekleme

                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.PrimTahsilat;
                    cariHaraketler.OdemeTipi = Convert.ToInt32(OdemeTuru);
                    if (polGenel.GenelBilgiler.ParaBirimi != "TL")
                    {
                        cariHaraketler.Tutar = dovizliYurtDisiAlinanKomisyonunTaksit;
                    }
                    else
                    {
                        cariHaraketler.Tutar = yurtDisiAlinanKomisyonTaksit;
                    }
                    cariHaraketler.Aciklama = OdemeTuruIsmı + "-" + "Toplu Tahsilat";
                    cariHaraketler.OdemeTarihi = Convert.ToDateTime(BelgeTarihi);
                    cariHaraketler.CariHareketTarihi = polOdeme.VadeTarihi;
                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                    cariHaraketler.CariHesapKodu = odeyenCariHesabiVarmi.Item2;
                    cariHaraketler.BorcAlacakTipi = "B";
                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                    #endregion

                    #endregion*/



                }
                #endregion



                return Json(new { mesaj });
            }
            catch (Exception ex)
            {
                return Json(new { Success = "False", Message = ex.Message });
            }

        }



        // toplu tahsilat iptali butonu +
        public ActionResult TopluTahsilatIptali(string[] lessonType, int policeid, string[] odemebelgenoSecimiListesi)
        {
            string Message = String.Empty;
            PoliceGenel polGenelmodel = new PoliceGenel();
            int _TVMKodu = _AktifKullaniciService.TVMKodu;
            var polGenel = _PoliceService.GetPoliceById(policeid);
            var polOdeme = _PoliceService.GetTopluTahsilatPoliceOdemePlani(policeid);

            //PoliceTahsilat polTahsilat = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == policeid).FirstOrDefault();
            string mesaj = string.Empty;
            List<PoliceTahsilat> polTahsilatList = new List<PoliceTahsilat>();
            PoliceTahsilat polTahsilat = new PoliceTahsilat();
            polTahsilatList = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == policeid).ToList<PoliceTahsilat>();

            CariHareketleri cariHaraketler = new CariHareketleri();
            string odeyenCariHesapKodu = null;
            Boolean cariHareketYapildiMi = false;
            Boolean borcAlacakYapildiMi = false;
            foreach (var itemTopluIptal in polTahsilatList)
            {
                odeyenCariHesapKodu = itemTopluIptal.CariHesapKodu;
                decimal OdenenTutar = 0;
                CariHesapBorcAlacak cariBorcAlacakModel = new CariHesapBorcAlacak();
                var odeyenCariHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAdi(odeyenCariHesapKodu);

                #region kayıt işlemini geri al

                if (polOdeme != null)
                {
                    #region carihesaba yapılan odemeyı gerı al
                    decimal dusulecekTaksitTutari = 0;

                    OdenenTutar = Convert.ToDecimal(itemTopluIptal.OdenenTutar) * (-1);
                    dusulecekTaksitTutari = OdenenTutar;

                    if (OdenenTutar != 0 && OdenenTutar != null)
                    {
                        if (odeyenCariHesabiVarmi.Item2 != null)
                        {

                            TVMDetay anaAcenteTvmDetay = _TVMService.getAnaAcenteTvmDetay(_AktifKullaniciService.TVMKodu);

                            ReasurorGenel reasurorGenel = _TeklifService.getReasurorGenel(polGenel.GenelBilgiler.PoliceId.ToString(), "0");
                            // normal acenteler için tahsilat
                            if (anaAcenteTvmDetay.Tipi != 1)
                            {
                                //Nakitse
                                if (itemTopluIptal.OdemTipi == 1)
                                {
                                    //var kasaHesabi = "100.01.";
                                    //var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariKasaHesapList(kasaHesabi);
                                    var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                                    var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                                    int odemeturu = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                    var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, odemebelgenoSecimiListesi[0]);
                                    var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                                    var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);
                                    if (carihesap != null && kasaHesabiVarmi != null && carihesap.Count > 0 && kasaHesabiVarmi.Count > 0)
                                    {
                                        //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                        //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                        foreach (var item in carihesap)
                                        {
                                            cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                            cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                            cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                        }
                                        string tcVkn = String.Empty;
                                        if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                        {
                                            var parts = odeyenCariHesapKodu.Split('.');
                                            if (parts != null && parts.Count() == 3)
                                            {
                                                tcVkn = parts[2];
                                            }
                                        }
                                        cariBorcAlacakModel.KimlikNo = tcVkn;
                                        string donemYil = String.Empty;
                                        string donemAy = String.Empty;

                                        donemAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                        donemYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                        //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                        {
                                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);
                                        }
                                        if (kasaHesabiVarmi != null)
                                        {
                                            foreach (var items in kasaHesabiVarmi)
                                            {
                                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                                cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                            }

                                            string donemKasaYil = String.Empty;
                                            string donemKasaAy = String.Empty;
                                            if (itemTopluIptal.OdemeBelgeTarihi != null)
                                            {
                                                //var parts = polTahsilat.OdemeBelgeTarihi.Value.;
                                                //if (parts != null && parts.Count() == 3)
                                                {
                                                    donemKasaYil = itemTopluIptal.OdemeBelgeTarihi.Value.Year.ToString();
                                                    donemKasaAy = itemTopluIptal.OdemeBelgeTarihi.Value.Month.ToString();
                                                    //}
                                                }

                                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null && !borcAlacakYapildiMi)
                                                {
                                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim));
                                                    borcAlacakYapildiMi = true;
                                                }
                                                #region cari haraket ekleme
                                                if (!cariHareketYapildiMi)
                                                {
                                                    cariHaraketler = new CariHareketleri();
                                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                                    cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                                    cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                                    cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal" + kasaHesaplari.AcenteKrediKartiNo;
                                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                                    cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                                    cariHaraketler.CariHareketTarihi = itemTopluIptal.OdemeBelgeTarihi;
                                                    cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                                    cariHaraketler.BorcAlacakTipi = "A";
                                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                                    cariHareketYapildiMi = true;
                                                }
                                                #endregion
                                            }
                                            #region pol tah
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.TaksitNo = itemTopluIptal.TaksitNo;
                                            foreach (var item in polTahsilatList)
                                            {
                                                if (polTahsilat.TaksitNo == item.TaksitNo)
                                                {
                                                    polTahsilat.TahsilatId = item.TahsilatId;
                                                }
                                            }
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            if (itemTopluIptal.OdemTipi != null)
                                            {
                                                polTahsilat.OdemTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                            }
                                            polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                            polTahsilat.OdenenTutar = 0;
                                            polTahsilat.OdemeBelgeNo = null;
                                            polTahsilat.OdemeBelgeTarihi = null;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.KalanTaksitTutari = itemTopluIptal.TaksitTutari;
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.TVMKodu;
                                            _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                            mesaj = "true";
                                            #endregion
                                        }
                                        else
                                        {
                                            mesaj = "false";
                                        }

                                    }
                                }
                                //Müşteri Kredi Kartı
                                if (itemTopluIptal.OdemTipi == 2)
                                {
                                    var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                                    var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                                    var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                                    var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                                    var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                                    var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);

                                    var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                                    //var musteriKkartiCariKodu = odeyenCariHesapKodu; // hangi şirket olduğu bılınmıyor

                                    if (carihesap != null && sigortaSirketiCariHesasbiVarmi.Count > 0 && carihesap.Count > 0 && sigortaSirketiCariHesasbiVarmi != null)
                                    {

                                        foreach (var item in carihesap)
                                        {
                                            cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                            cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                            cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                        }
                                        cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                        string tcVkn = String.Empty;
                                        if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                        {
                                            var parts = odeyenCariHesapKodu.Split('.');
                                            if (parts != null && parts.Count() == 3)
                                            {
                                                tcVkn = parts[2];
                                            }
                                        }
                                        cariBorcAlacakModel.KimlikNo = tcVkn;
                                        string donemYil = String.Empty;
                                        string donemAy = String.Empty;
                                        donemAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                        donemYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                        //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                        {
                                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);
                                        }
                                        if (sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                                        {
                                            foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                            {
                                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                                cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                            }

                                            string donemKasaYil = String.Empty;
                                            string donemKasaAy = String.Empty;

                                            donemKasaAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                            donemKasaYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                            //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                            if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                            {
                                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                            }
                                            #region cari haraket ekleme

                                            cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                            cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                            cariHaraketler.Tutar = itemTopluIptal.OdenenTutar;
                                            cariHaraketler.Aciklama = sigortaSirketiCariHesabiKodu + "-" + "Tah. iptal";
                                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.CariHareketTarihi = itemTopluIptal.TaksitVadeTarihi;
                                            foreach (var itemSigortasirketCari in sigortaSirketiCariHesasbiVarmi)
                                            {
                                                cariHaraketler.CariHesapKodu = itemSigortasirketCari.CariHesapKodu;

                                            }
                                            cariHaraketler.BorcAlacakTipi = "A";
                                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                            #endregion
                                        }
                                        #region pol tah
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme

                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TaksitNo = itemTopluIptal.TaksitNo;
                                        foreach (var item in polTahsilatList)
                                        {
                                            if (polTahsilat.TaksitNo == item.TaksitNo)
                                            {
                                                polTahsilat.TahsilatId = item.TahsilatId;
                                            }
                                        }
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (itemTopluIptal.OdemTipi != null)
                                        {
                                            polTahsilat.OdemTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                        }
                                        polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                        polTahsilat.OdenenTutar = 0;
                                        polTahsilat.OdemeBelgeNo = null;
                                        polTahsilat.OdemeBelgeTarihi = null;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.KalanTaksitTutari = itemTopluIptal.TaksitTutari;
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.TVMKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                        mesaj = "true";
                                        #endregion
                                    }
                                    else
                                    {
                                        mesaj = "false";
                                    }


                                }
                                //Havale ise
                                if (itemTopluIptal.OdemTipi == 3)
                                {
                                    var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                                    var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                                    // var bankaHesabi = "102.01.";
                                    var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                                    // havale ise acentenin banka hesabını çağırıyoruz. o yüzden 8 yazdık. 8= acente banka hesabı
                                    var bankaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, 8, itemTopluIptal.OdemeBelgeNo);
                                    var bankaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(bankaHesaplari.CariHesapNo);
                                    if (carihesap != null && carihesap.Count > 0 && bankaHesabiVarmi != null && bankaHesabiVarmi.Count > 0)
                                    {

                                        foreach (var item in carihesap)
                                        {
                                            cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                            cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                            cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                        }
                                        cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                        string tcVkn = String.Empty;
                                        if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                        {
                                            var parts = odeyenCariHesapKodu.Split('.');
                                            if (parts != null && parts.Count() == 3)
                                            {
                                                tcVkn = parts[2];
                                            }
                                        }
                                        cariBorcAlacakModel.KimlikNo = tcVkn;
                                        string donemYil = String.Empty;
                                        string donemAy = String.Empty;
                                        donemAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                        donemYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                        //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                        {
                                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);
                                        }
                                        if (bankaHesabiVarmi != null)
                                        {
                                            foreach (var items in bankaHesabiVarmi)
                                            {
                                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                                cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                            }

                                            string donemKasaYil = String.Empty;
                                            string donemKasaAy = String.Empty;
                                            if (itemTopluIptal.OdemeBelgeTarihi != null)
                                            {
                                                {
                                                    donemKasaYil = itemTopluIptal.OdemeBelgeTarihi.Value.Year.ToString();
                                                    donemKasaAy = itemTopluIptal.OdemeBelgeTarihi.Value.Month.ToString();
                                                }
                                            }

                                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                            //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                            if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null && !borcAlacakYapildiMi)
                                            {
                                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim));
                                                borcAlacakYapildiMi = true;
                                            }
                                            #region cari haraket ekleme
                                            if (!cariHareketYapildiMi)
                                            {
                                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                                cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                                cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal" + bankaHesaplari.AcenteKrediKartiNo;
                                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.CariHareketTarihi = itemTopluIptal.OdemeBelgeTarihi;
                                                foreach (var itemBankaCariHesap in bankaHesabiVarmi)
                                                {
                                                    cariHaraketler.CariHesapKodu = itemBankaCariHesap.CariHesapKodu;
                                                }
                                                cariHaraketler.BorcAlacakTipi = "A";
                                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                                cariHareketYapildiMi = true;
                                            }
                                            #endregion
                                        }
                                        #region pol tah
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme

                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TaksitNo = itemTopluIptal.TaksitNo;
                                        foreach (var item in polTahsilatList)
                                        {
                                            if (polTahsilat.TaksitNo == item.TaksitNo)
                                            {
                                                polTahsilat.TahsilatId = item.TahsilatId;
                                            }
                                        }
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (itemTopluIptal.OdemTipi != null)
                                        {
                                            polTahsilat.OdemTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                        }
                                        polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                        polTahsilat.OdenenTutar = 0;
                                        polTahsilat.OdemeBelgeNo = null;
                                        polTahsilat.OdemeBelgeTarihi = null;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.KalanTaksitTutari = itemTopluIptal.TaksitTutari;
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.TVMKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                        mesaj = "true";
                                        #endregion
                                    }
                                    else
                                    {
                                        mesaj = "false";
                                    }

                                }
                                //Çek
                                if (itemTopluIptal.OdemTipi == 4)
                                {
                                    //var alinanCekler = "101.01.";
                                    var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                                    var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                                    var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                                    int odemeturu = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                    var alinanCekHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, itemTopluIptal.OdemeBelgeNo);
                                    var alinanCekHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanCekHesaplari.CariHesapNo);
                                    if (carihesap != null && carihesap.Count > 0 && alinanCekHesabiVarmi != null && alinanCekHesabiVarmi.Count > 0)
                                    {
                                        //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                        //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                        foreach (var item in carihesap)
                                        {
                                            cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                            cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                            cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                        }
                                        cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                                        cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                                        string donemYil = String.Empty;
                                        string donemAy = String.Empty;

                                        donemAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                        donemYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                        //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                        {
                                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);
                                        }
                                        if (alinanCekHesabiVarmi != null)
                                        {
                                            foreach (var items in alinanCekHesabiVarmi)
                                            {
                                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                                cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                            }

                                            string donemKasaYil = String.Empty;
                                            string donemKasaAy = String.Empty;
                                            if (itemTopluIptal.OdemeBelgeTarihi != null)
                                            {
                                                {
                                                    donemKasaYil = itemTopluIptal.OdemeBelgeTarihi.Value.Year.ToString();
                                                    donemKasaAy = itemTopluIptal.OdemeBelgeTarihi.Value.Month.ToString();
                                                }
                                            }

                                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                            //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                            if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null && !borcAlacakYapildiMi)
                                            {
                                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim));
                                                borcAlacakYapildiMi = true;
                                            }
                                            #region cari haraket ekleme
                                            if (!cariHareketYapildiMi)
                                            {
                                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                                cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                                cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal" + alinanCekHesaplari.AcenteKrediKartiNo;
                                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.CariHareketTarihi = itemTopluIptal.OdemeBelgeTarihi;
                                                foreach (var itemCekCariHesap in alinanCekHesabiVarmi)
                                                {
                                                    cariHaraketler.CariHesapKodu = itemCekCariHesap.CariHesapKodu;

                                                }
                                                cariHaraketler.BorcAlacakTipi = "A";
                                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                                cariHareketYapildiMi = true;
                                            }
                                            #endregion
                                        }
                                        #region pol tah
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme

                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TaksitNo = itemTopluIptal.TaksitNo;
                                        foreach (var item in polTahsilatList)
                                        {
                                            if (polTahsilat.TaksitNo == item.TaksitNo)
                                            {
                                                polTahsilat.TahsilatId = item.TahsilatId;
                                            }
                                        }
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (itemTopluIptal.OdemTipi != null)
                                        {
                                            polTahsilat.OdemTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                        }

                                        polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                        polTahsilat.OdenenTutar = 0;
                                        polTahsilat.OdemeBelgeNo = null;
                                        polTahsilat.OdemeBelgeTarihi = null;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.KalanTaksitTutari = itemTopluIptal.TaksitTutari;
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.TVMKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                        mesaj = "true";
                                        #endregion
                                    }
                                    else
                                    {
                                        mesaj = "false";
                                    }


                                }
                                //Acente Kredi Kartı
                                if (itemTopluIptal.OdemTipi == 5)
                                {
                                    //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                                    int odemeturu = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                    var acenteKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, itemTopluIptal.OdemeBelgeNo);
                                    var acenteKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteKKHesaplari.CariHesapNo);

                                    //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                                    var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                                    var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                                    var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                                    var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                                    if (acenteKKHesabiVarmi != null && acenteKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                                    {

                                        foreach (var item in acenteKKHesabiVarmi)
                                        {
                                            cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                            cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                            cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                        }
                                        cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                        string tcVkn = String.Empty;
                                        if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                        {
                                            var parts = odeyenCariHesapKodu.Split('.');
                                            if (parts != null && parts.Count() == 3)
                                            {
                                                tcVkn = parts[2];
                                            }
                                        }
                                        cariBorcAlacakModel.KimlikNo = tcVkn;
                                        string donemYil = String.Empty;
                                        string donemAy = String.Empty;
                                        donemAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                        donemYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                        //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                        {
                                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, (dusulecekTaksitTutari * (-1)), 0);
                                        }
                                        if (sigortaSirketiCariHesasbiVarmi != null)
                                        {
                                            foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                            {
                                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                                cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                            }

                                            string donemKasaYil = String.Empty;
                                            string donemKasaAy = String.Empty;
                                            donemKasaAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                            donemKasaYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                            //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                            if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                            {
                                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, (dusulecekTaksitTutari * (-1)));
                                            }
                                            #region cari haraket ekleme
                                            // ss şirketi
                                            cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                            cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                            cariHaraketler.Tutar = itemTopluIptal.OdenenTutar;
                                            cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal";
                                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.CariHareketTarihi = itemTopluIptal.TaksitVadeTarihi;
                                            foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                            {
                                                cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                            }
                                            cariHaraketler.BorcAlacakTipi = "A";
                                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                            //Acente kk
                                            cariHaraketler = new CariHareketleri();
                                            cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                            cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                            cariHaraketler.Tutar = itemTopluIptal.OdenenTutar;
                                            cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal" + acenteKKHesaplari.AcenteKrediKartiNo;
                                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.CariHareketTarihi = itemTopluIptal.TaksitVadeTarihi;
                                            foreach (var itemsss in acenteKKHesabiVarmi)
                                            {
                                                cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                            }
                                            cariHaraketler.BorcAlacakTipi = "B";
                                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                            #endregion

                                        }
                                        #region pol tah
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme

                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;

                                        polTahsilat.TaksitNo = itemTopluIptal.TaksitNo;
                                        foreach (var item in polTahsilatList)
                                        {
                                            if (polTahsilat.TaksitNo == item.TaksitNo)
                                            {
                                                polTahsilat.TahsilatId = item.TahsilatId;
                                            }
                                        }
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);

                                        polTahsilat.OdemTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                        polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                        polTahsilat.OdenenTutar = 0;
                                        polTahsilat.OdemeBelgeNo = null;
                                        polTahsilat.OdemeBelgeTarihi = null;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.KalanTaksitTutari = itemTopluIptal.TaksitTutari;
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.TVMKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                        mesaj = "true";
                                        #endregion
                                    }
                                    else
                                    {
                                        mesaj = "false";
                                    }

                                }
                                //Acente Pos Hesabi
                                if (itemTopluIptal.OdemTipi == 6)
                                {
                                    var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                                    var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                                    var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                                    int odemeturu = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                    var posHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, itemTopluIptal.OdemeBelgeNo);
                                    var posHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(posHesaplari.CariHesapNo);
                                    if (carihesap != null && carihesap.Count > 0 && posHesabiVarmi != null && posHesabiVarmi.Count > 0)
                                    {
                                        //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                        //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                        foreach (var item in carihesap)
                                        {
                                            cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                            cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                            cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                        }
                                        cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                                        cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                                        string donemYil = String.Empty;
                                        string donemAy = String.Empty;
                                        donemAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                        donemYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                        //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                        {
                                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);
                                        }
                                        if (posHesabiVarmi != null)
                                        {
                                            foreach (var items in posHesabiVarmi)
                                            {
                                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                                cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                            }

                                            string donemKasaYil = String.Empty;
                                            string donemKasaAy = String.Empty;
                                            if (itemTopluIptal.OdemeBelgeTarihi != null)
                                            {
                                                {
                                                    donemKasaYil = itemTopluIptal.OdemeBelgeTarihi.Value.Year.ToString();
                                                    donemKasaAy = itemTopluIptal.OdemeBelgeTarihi.Value.Month.ToString();
                                                }
                                            }
                                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                            //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                            if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null && !borcAlacakYapildiMi)
                                            {
                                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim));
                                                borcAlacakYapildiMi = true;
                                            }
                                            #region cari haraket ekleme
                                            if (!cariHareketYapildiMi)
                                            {
                                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                                cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                                cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal" + posHesaplari.AcenteKrediKartiNo;
                                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.CariHareketTarihi = itemTopluIptal.OdemeBelgeTarihi;
                                                foreach (var itemPosCariHesap in posHesabiVarmi)
                                                {
                                                    cariHaraketler.CariHesapKodu = itemPosCariHesap.CariHesapKodu;

                                                }
                                                cariHaraketler.BorcAlacakTipi = "A";
                                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                                cariHareketYapildiMi = true;
                                            }
                                            #endregion
                                        }
                                        #region pol tah
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme

                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;

                                        polTahsilat.TaksitNo = itemTopluIptal.TaksitNo;
                                        foreach (var item in polTahsilatList)
                                        {
                                            if (polTahsilat.TaksitNo == item.TaksitNo)
                                            {
                                                polTahsilat.TahsilatId = item.TahsilatId;
                                            }
                                        }
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (itemTopluIptal.OdemTipi != null)
                                        {
                                            polTahsilat.OdemTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                        }
                                        polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                        polTahsilat.OdenenTutar = 0;
                                        polTahsilat.OdemeBelgeNo = null;
                                        polTahsilat.OdemeBelgeTarihi = null;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.KalanTaksitTutari = itemTopluIptal.TaksitTutari;
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.TVMKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                        mesaj = "true";
                                        #endregion
                                    }
                                    else
                                    {
                                        mesaj = "false";
                                    }

                                }
                                //Senet
                                if (itemTopluIptal.OdemTipi == 7)
                                {
                                    //var Alacak senetleri = "121.01.";
                                    var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                                    var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                                    var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                                    int odemeturu = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                    var alinanSenetHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, itemTopluIptal.OdemeBelgeNo);
                                    var alacakSenetHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(alinanSenetHesaplari.CariHesapNo);
                                    if (carihesap != null && carihesap.Count > 0 && alacakSenetHesabiVarmi != null && alacakSenetHesabiVarmi.Count > 0)
                                    {
                                        //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                        //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                        foreach (var item in carihesap)
                                        {
                                            cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                            cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                            cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                        }
                                        cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;

                                        cariBorcAlacakModel.KimlikNo = sEttirenKimlikNo;
                                        string donemYil = String.Empty;
                                        string donemAy = String.Empty;
                                        donemAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                        donemYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                        //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                        {
                                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);
                                        }
                                        if (alacakSenetHesabiVarmi != null)
                                        {
                                            foreach (var items in alacakSenetHesabiVarmi)
                                            {
                                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                                cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                            }

                                            string donemKasaYil = String.Empty;
                                            string donemKasaAy = String.Empty;
                                            if (itemTopluIptal.OdemeBelgeTarihi != null)
                                            {
                                                {
                                                    donemKasaYil = itemTopluIptal.OdemeBelgeTarihi.Value.Year.ToString();
                                                    donemKasaAy = itemTopluIptal.OdemeBelgeTarihi.Value.Month.ToString();
                                                }
                                            }

                                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                            //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                            if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null && !borcAlacakYapildiMi)
                                            {
                                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim));
                                                borcAlacakYapildiMi = true;
                                            }
                                            #region cari haraket ekleme
                                            if (!cariHareketYapildiMi)
                                            {
                                                cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                                cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                                cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                                cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                                cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                                cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                                cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal" + alinanSenetHesaplari.AcenteKrediKartiNo;
                                                cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.CariHareketTarihi = itemTopluIptal.OdemeBelgeTarihi;
                                                foreach (var itemSenetCariHesap in alacakSenetHesabiVarmi)
                                                {
                                                    cariHaraketler.CariHesapKodu = itemSenetCariHesap.CariHesapKodu;

                                                }
                                                cariHaraketler.BorcAlacakTipi = "A";
                                                cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                                cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                                _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                                cariHareketYapildiMi = true;
                                            }
                                            #endregion
                                        }
                                        #region pol tah
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme

                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TaksitNo = itemTopluIptal.TaksitNo;
                                        foreach (var item in polTahsilatList)
                                        {
                                            if (polTahsilat.TaksitNo == item.TaksitNo)
                                            {
                                                polTahsilat.TahsilatId = item.TahsilatId;
                                            }
                                        }
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (itemTopluIptal.OdemTipi != null)
                                        {
                                            polTahsilat.OdemTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                        }
                                        polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                        polTahsilat.OdenenTutar = 0;
                                        polTahsilat.OdemeBelgeNo = null;
                                        polTahsilat.OdemeBelgeTarihi = null;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.KalanTaksitTutari = itemTopluIptal.TaksitTutari;
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.TVMKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                        mesaj = "true";
                                        #endregion
                                    }
                                    else
                                    {
                                        mesaj = "false";
                                    }

                                }
                                //Acente bİREYSEL Kredi Kartı
                                if (itemTopluIptal.OdemTipi == 9)
                                {
                                    //var sigortaSirketi = polGenel.GenelBilgiler.TUMBirlikKodu;

                                    int odemeturu = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                    var acenteBKKHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, itemTopluIptal.OdemeBelgeNo);
                                    var acenteBKKHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(acenteBKKHesaplari.CariHesapNo);

                                    //var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(odeyenCariHesabiVarmi.Item2, _AktifKullaniciService.TVMKodu);

                                    var sigortaSirketKodu = polGenel.GenelBilgiler.TUMBirlikKodu;
                                    var sirketVergiNo = _SigortaSirketleriService.GetSigortaBilgileri(sigortaSirketKodu);
                                    var sigortaSirketiCariHesabiKodu = "320.01." + "" + sirketVergiNo.VergiNumarasi;
                                    var sigortaSirketiCariHesasbiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(sigortaSirketiCariHesabiKodu);
                                    if (acenteBKKHesabiVarmi != null && acenteBKKHesabiVarmi.Count > 0 && sigortaSirketiCariHesasbiVarmi != null && sigortaSirketiCariHesasbiVarmi.Count > 0)
                                    {

                                        foreach (var item in acenteBKKHesabiVarmi)
                                        {
                                            cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                            cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                            cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                        }
                                        cariBorcAlacakModel.KayitTarihi = TurkeyDateTime.Now;
                                        string tcVkn = String.Empty;
                                        if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                        {
                                            var parts = odeyenCariHesapKodu.Split('.');
                                            if (parts != null && parts.Count() == 3)
                                            {
                                                tcVkn = parts[2];
                                            }
                                        }
                                        cariBorcAlacakModel.KimlikNo = tcVkn;
                                        string donemKasaYil = String.Empty;
                                        string donemKasaAy = String.Empty;
                                        donemKasaAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                        donemKasaYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();
                                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                        //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                        {
                                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, (dusulecekTaksitTutari * (-1)), 0);
                                        }
                                        if (sigortaSirketiCariHesasbiVarmi != null)
                                        {
                                            foreach (var items in sigortaSirketiCariHesasbiVarmi)
                                            {
                                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                                cariBorcAlacakModel.KayitTarihi = items.KayitTarihi;
                                            }

                                            string donemKasaYill = String.Empty;
                                            string donemKasaAyy = String.Empty;
                                            donemKasaAyy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                            donemKasaYill = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                            cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYill);
                                            cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                            //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                            if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                            {
                                                _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYill, donemKasaAyy, 0, (dusulecekTaksitTutari * (-1)));
                                            }
                                            #region cari haraket ekleme
                                            // ss şirketi
                                            cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                            cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                            cariHaraketler.Tutar = itemTopluIptal.OdenenTutar;
                                            cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal";
                                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.CariHareketTarihi = itemTopluIptal.TaksitVadeTarihi;
                                            foreach (var itemSSCariHesap in sigortaSirketiCariHesasbiVarmi)
                                            {
                                                cariHaraketler.CariHesapKodu = itemSSCariHesap.CariHesapKodu;

                                            }
                                            cariHaraketler.BorcAlacakTipi = "A";
                                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);

                                            //Acente kk
                                            cariHaraketler = new CariHareketleri();
                                            cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                            cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                            cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                            cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                            cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                            cariHaraketler.Tutar = itemTopluIptal.OdenenTutar;
                                            cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal" + acenteBKKHesaplari.AcenteKrediKartiNo;
                                            cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.CariHareketTarihi = itemTopluIptal.TaksitVadeTarihi;
                                            foreach (var itemsss in acenteBKKHesabiVarmi)
                                            {
                                                cariHaraketler.CariHesapKodu = itemsss.CariHesapKodu;

                                            }
                                            cariHaraketler.BorcAlacakTipi = "B";
                                            cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                            cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                            _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                            #endregion

                                        }
                                        #region pol tah
                                        polTahsilat = new PoliceTahsilat();
                                        // yeni kayıt ekleme

                                        polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                        polTahsilat.TaksitNo = itemTopluIptal.TaksitNo;
                                        foreach (var item in polTahsilatList)
                                        {
                                            if (polTahsilat.TaksitNo == item.TaksitNo)
                                            {
                                                polTahsilat.TahsilatId = item.TahsilatId;
                                            }
                                        }
                                        polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                                        polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                        polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                        polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                        if (itemTopluIptal.OdemTipi != null)
                                        {
                                            polTahsilat.OdemTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                        }
                                        polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                        polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                        polTahsilat.OdenenTutar = 0;
                                        polTahsilat.OdemeBelgeNo = null;
                                        polTahsilat.OdemeBelgeTarihi = null;
                                        polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                        polTahsilat.KalanTaksitTutari = itemTopluIptal.TaksitTutari;
                                        polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.TVMKodu;
                                        _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                        mesaj = "true";
                                        #endregion
                                    }
                                    else
                                    {

                                        mesaj = "false";
                                    }


                                }
                                //MalHizmet Alımı
                                if (itemTopluIptal.OdemTipi == 11)
                                {
                                    //var kasaHesabi = "100.01.";
                                    //var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariKasaHesapList(kasaHesabi);
                                    var sEttirenKimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                                    var sEttirenCariHesabi = "120.01." + "" + sEttirenKimlikNo;
                                    int odemeturu = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                    var kasaHesaplari = _TVMService.GetListTVMBankaCariHesaplari(polGenel.GenelBilgiler.TVMKodu.Value, odemeturu, odemebelgenoSecimiListesi[0]);
                                    var carihesap = _Muhasebe_CariHesapService.getCariHesapListesiByCariHesapKodu(sEttirenCariHesabi, _AktifKullaniciService.TVMKodu);
                                    var kasaHesabiVarmi = _Muhasebe_CariHesapService.GetCariHesapAcenteBankaPosKasaHesapList(kasaHesaplari.CariHesapNo);
                                    if (carihesap != null && kasaHesabiVarmi != null && carihesap.Count > 0 && kasaHesabiVarmi.Count > 0)
                                    {
                                        //cariBorcAlacakModel.CariHesapKodu = odeyenCariHesapKodu;
                                        //cariBorcAlacakModel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                        foreach (var item in carihesap)
                                        {
                                            cariBorcAlacakModel.CariHesapId = item.CariHesapId;
                                            cariBorcAlacakModel.CariHesapKodu = item.CariHesapKodu;
                                            cariBorcAlacakModel.TVMKodu = item.TVMKodu;
                                        }
                                        string tcVkn = String.Empty;
                                        if (!String.IsNullOrEmpty(odeyenCariHesapKodu))
                                        {
                                            var parts = odeyenCariHesapKodu.Split('.');
                                            if (parts != null && parts.Count() == 3)
                                            {
                                                tcVkn = parts[2];
                                            }
                                        }
                                        cariBorcAlacakModel.KimlikNo = tcVkn;
                                        string donemYil = String.Empty;
                                        string donemAy = String.Empty;

                                        donemAy = itemTopluIptal.TaksitVadeTarihi.Month.ToString();
                                        donemYil = itemTopluIptal.TaksitVadeTarihi.Year.ToString();

                                        cariBorcAlacakModel.Donem = Convert.ToInt32(donemYil);
                                        cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                        //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                        if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null)
                                        {
                                            _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemYil, donemAy, 0, dusulecekTaksitTutari);
                                        }
                                        if (kasaHesabiVarmi != null)
                                        {
                                            foreach (var items in kasaHesabiVarmi)
                                            {
                                                cariBorcAlacakModel.CariHesapId = items.CariHesapId;
                                                cariBorcAlacakModel.CariHesapKodu = items.CariHesapKodu;
                                                cariBorcAlacakModel.TVMKodu = items.TVMKodu;
                                                cariBorcAlacakModel.KimlikNo = items.KimlikNo;
                                                cariBorcAlacakModel.GuncellemeTarihi = items.GuncellemeTarihi;
                                            }

                                            string donemKasaYil = String.Empty;
                                            string donemKasaAy = String.Empty;
                                            if (itemTopluIptal.OdemeBelgeTarihi != null)
                                            {
                                                //var parts = polTahsilat.OdemeBelgeTarihi.Value.;
                                                //if (parts != null && parts.Count() == 3)
                                                {
                                                    donemKasaYil = itemTopluIptal.OdemeBelgeTarihi.Value.Year.ToString();
                                                    donemKasaAy = itemTopluIptal.OdemeBelgeTarihi.Value.Month.ToString();
                                                    //}
                                                }

                                                cariBorcAlacakModel.Donem = Convert.ToInt32(donemKasaYil);
                                                cariBorcAlacakModel.GuncellemeTarihi = TurkeyDateTime.Now;
                                                //PoliceGenel tablosunda Cari Hareket Tarihi Null ise CariHesapBorcAlacak Tablosuna update yada create yapmayacak.
                                                if (polGenel.GenelBilgiler.CariHareketKayitTarihi != null && !borcAlacakYapildiMi)
                                                {
                                                    _Muhasebe_CariHesapService.UpdatePolTahCariHesapBorcAlacak(cariBorcAlacakModel.TVMKodu, cariBorcAlacakModel.CariHesapKodu, donemKasaYil, donemKasaAy, 0, Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim));
                                                    borcAlacakYapildiMi = true;
                                                }
                                                #region cari haraket ekleme
                                                if (!cariHareketYapildiMi)
                                                {
                                                    cariHaraketler = new CariHareketleri();
                                                    cariHaraketler.EvrakNo = polGenel.GenelBilgiler.PoliceNumarasi + "-" + polGenel.GenelBilgiler.YenilemeNo + "-" + polGenel.GenelBilgiler.EkNo;
                                                    cariHaraketler.DovizKuru = polGenel.GenelBilgiler.DovizKur;
                                                    cariHaraketler.DovizTipi = polGenel.GenelBilgiler.ParaBirimi;
                                                    cariHaraketler.EvrakTipi = CariEvrakTipKodu.TahsilatIptal;
                                                    cariHaraketler.OdemeTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                                    cariHaraketler.Tutar = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                                    cariHaraketler.Aciklama = odemebelgenoSecimiListesi[0] + "-" + "Tah. iptal" + kasaHesaplari.AcenteKrediKartiNo;
                                                    cariHaraketler.GuncellemeTarihi = TurkeyDateTime.Now;
                                                    cariHaraketler.OdemeTarihi = TurkeyDateTime.Now;
                                                    cariHaraketler.CariHareketTarihi = itemTopluIptal.OdemeBelgeTarihi;
                                                    cariHaraketler.CariHesapKodu = kasaHesaplari.CariHesapNo;
                                                    cariHaraketler.BorcAlacakTipi = "A";
                                                    cariHaraketler.KayitTarihi = TurkeyDateTime.Now;
                                                    cariHaraketler.TVMKodu = polGenel.GenelBilgiler.TVMKodu.Value;
                                                    _Muhasebe_CariHesapService.PolTahCariHareketEkle(cariHaraketler);
                                                    cariHareketYapildiMi = true;
                                                }
                                                #endregion
                                            }
                                            #region pol tah
                                            polTahsilat = new PoliceTahsilat();
                                            // yeni kayıt ekleme

                                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                                            polTahsilat.TaksitNo = itemTopluIptal.TaksitNo;
                                            foreach (var item in polTahsilatList)
                                            {
                                                if (polTahsilat.TaksitNo == item.TaksitNo)
                                                {
                                                    polTahsilat.TahsilatId = item.TahsilatId;
                                                }
                                            }
                                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                                            if (itemTopluIptal.OdemTipi != null)
                                            {
                                                polTahsilat.OdemTipi = Convert.ToInt32(itemTopluIptal.OdemTipi);
                                            }
                                            polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                                            polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                                            polTahsilat.OdenenTutar = 0;
                                            polTahsilat.OdemeBelgeNo = null;
                                            polTahsilat.OdemeBelgeTarihi = null;
                                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                                            polTahsilat.KalanTaksitTutari = itemTopluIptal.TaksitTutari;
                                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.TVMKodu;
                                            _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                                            mesaj = "true";
                                            #endregion
                                        }
                                        else
                                        {
                                            mesaj = "false";
                                        }

                                    }
                                }

                            }
                            else
                            {
                                // yurt dışı brokerler için tahsilat

                            }
                        }
                    }
                    #endregion
                }
                #endregion
            }
            return Json(new { mesaj });
        }


        [HttpPost]
        [AjaxException]
        public ActionResult TopluTaksitOdeme(string[] lessonType, int policeid, decimal odenenTutar)
        {
            string Message = String.Empty;
            PoliceGenel polGenelmodel = new PoliceGenel();
            int _TVMKodu = _AktifKullaniciService.TVMKodu;
            var polGenel = _PoliceService.GetPoliceById(policeid);
            var polOdeme = _PoliceService.GetTopluTahsilatPoliceOdemePlani(policeid);
            string mesaj = string.Empty;
            List<PoliceTahsilat> polTahsilatList = new List<PoliceTahsilat>();
            PoliceTahsilat polTahsilat = new PoliceTahsilat();
            polTahsilatList = polGenel.GenelBilgiler.PoliceTahsilats.Where(s => s.PoliceId == policeid).ToList<PoliceTahsilat>();
            try
            {
                if (polOdeme != null)
                {
                    for (int i = 0; i < polTahsilatList.Count; i++)
                    {
                        if (odenenTutar != 0 && odenenTutar > 0 && polTahsilatList[i].KalanTaksitTutari != 0)
                        {
                            polTahsilat.TahsilatId = polTahsilatList[i].TahsilatId;
                            polTahsilat.PoliceId = polGenel.GenelBilgiler.PoliceId;
                            polTahsilat.KimlikNo = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortali.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortali.KimlikNo : polGenel.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                            polTahsilat.PoliceNo = polGenel.GenelBilgiler.PoliceNumarasi;
                            polTahsilat.ZeyilNo = polGenel.GenelBilgiler.EkNo.ToString();
                            polTahsilat.BrutPrim = Convert.ToDecimal(polGenel.GenelBilgiler.BrutPrim);
                            polTahsilat.OdemTipi = Convert.ToInt32(polOdeme.OdemeTipi);
                            polTahsilat.TaksitNo = polOdeme.TaksitNo;
                            polTahsilat.TaksitVadeTarihi = polOdeme.VadeTarihi.HasValue ? polOdeme.VadeTarihi.Value : TurkeyDateTime.Today.Date;
                            polTahsilat.TaksitTutari = polOdeme.TaksitTutari.HasValue ? polOdeme.TaksitTutari.Value : 0;
                            polTahsilat.OdemeBelgeNo = polTahsilatList[i].OdemeBelgeNo;
                            polTahsilat.OdemeBelgeTarihi = polTahsilatList[i].OdemeBelgeTarihi;
                            polTahsilat.KayitTarihi = TurkeyDateTime.Today.Date;
                            polTahsilat.GuncellemeTarihi = TurkeyDateTime.Today.Date;
                            polTahsilat.KaydiEkleyenKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                            if (odenenTutar < 0)
                            {
                                polTahsilat.OdenenTutar = polTahsilatList[i].TaksitTutari + odenenTutar;
                                // polTahsilat.OdenenTutar = odenenTutar;
                                polTahsilat.KalanTaksitTutari = polTahsilatList[i].TaksitTutari + odenenTutar;/*!!!!*/

                            }
                            else if (odenenTutar >= polTahsilatList[i].TaksitTutari)
                            {
                                polTahsilat.OdenenTutar = polTahsilatList[i].TaksitTutari;
                                polTahsilat.KalanTaksitTutari = 0;/*!!!!*/

                            }
                            else if (odenenTutar < polTahsilatList[i].TaksitTutari && odenenTutar > 0)
                            {
                                polTahsilatList[i].OdenenTutar += odenenTutar;
                                polTahsilat.OdenenTutar = polTahsilatList[i].OdenenTutar;
                                polTahsilat.KalanTaksitTutari = polTahsilatList[i].KalanTaksitTutari - odenenTutar;/*!!!!*/
                            }
                            odenenTutar = odenenTutar - polTahsilatList[i].TaksitTutari;

                            _PoliceService.UpdatePoliceTahsilat(polTahsilat);
                            Message = " İşleminiz Başarıyla Gerçekleşmiştir.";
                            if (odenenTutar < 0)
                            {
                                break;
                            }
                        }
                    }
                }


                return Json(new { Success = "True", Message = Message });

            }
            catch (Exception ex)
            {
                return Json(new
                {
                    Success = "False",
                    Message = ex.Message
                });
            }
        }

        [AjaxException]
        public ActionResult GetAcenteBankaHesaplari(string hesaptipi)
        {
            if (hesaptipi == "3")
            {
                hesaptipi = "8";
            }
            try
            {
                int hesaptip = Convert.ToInt32(hesaptipi);
                var tvmkodu = _AktifKullaniciService.TVMKodu;
                var kartHesaplariList = _TVMService.GetListTVMBankaHesaplari(tvmkodu, hesaptip);
                if (kartHesaplariList.Count > 0)
                {
                    var hesaplar = new SelectList(kartHesaplariList, "AcenteKrediKartiNo", "HesapAdi", kartHesaplariList[0].SiraNo);
                    var Carihesaplar = new SelectList(kartHesaplariList, "CariHesapNo", "HesapAdi", kartHesaplariList[0].SiraNo);
                    return Json(new { success = true, list = hesaplar, carilist = Carihesaplar }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    List<SelectListItem> list = new List<SelectListItem>();
                    list.Insert(0, new SelectListItem() { Value = "", Text = babonline.PleaseSelect, Selected = true });

                    return Json(new { success = false, list = list }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {

                ILogService log = DependencyResolver.Current.GetService<ILogService>();
                log.Error(ex);
                throw;
            }
        }

        public ActionResult TopluTahsilatKapama(int PoliceId)
        {
            Neosinerji.BABOnlineTP.Business.Police police = _PoliceService.GetPoliceById(PoliceId);
            police.GenelBilgiler.PoliceId = PoliceId;

            return PartialView("_TopluTahsilatOdeme", police);
        }
        public ActionResult YurtdisiBrokerTopluTahsilatKapama(int PoliceId)
        {
            Neosinerji.BABOnlineTP.Business.Police police = _PoliceService.GetPoliceById(PoliceId);
            police.GenelBilgiler.PoliceId = PoliceId;

            return PartialView("_YDBroker_TopluTahsilatOdeme", police);
        }

        #endregion

        #region poliçe tahsilat takip rapor

        [Authorization(AnaMenuKodu = AnaMenuler.OnMuhasebe, AltMenuKodu = AltMenuler.PoliceTahsilatRaporu, SekmeKodu = 0)]
        public ActionResult PoliceTahsilatRaporu()
        {

            PoliceTahsilatRaporModel model = new PoliceTahsilatRaporModel();

            model.BaslangicTarihi = TurkeyDateTime.Now.AddDays(-29);
            model.BitisTarihi = TurkeyDateTime.Now;

            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TVMUnvani = _AktifKullaniciService.TVMUnvani;

            List<SelectListItem> aramaTips = new List<SelectListItem>();
            aramaTips.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "0", Text = babonline.SalesChannel + " / " + babonline.InsuranceCompany }, // Satış Kanalı / Sigorta Şirketi
                new SelectListItem() { Value = "1", Text = babonline.CustomerGroupCode }, // Müşteri Grup Kodu
                new SelectListItem() { Value = "2", Text = babonline.OutsourceSalesChannel } //Dış Kaynak Satış Kanalı
            });
            model.AramaTip = 0;
            model.AramaTipTipleri = new SelectList(aramaTips, "Value", "Text", model.AramaTip);
            model.MusteriGurpKodu = "";
            List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");
            model.DisKaynakTvmler = new MultiSelectList(_TVMService.GetDisUretimTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            //model.tvmler = new MultiSelectList(_TaliPoliceService.GetYetkiliTVM(model.TVMKodu).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.tvmler = new MultiSelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            int KontrolTVMKod = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
            List<SelectListItem> raporTip = new List<SelectListItem>();

            raporTip.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "0", Text = babonline.NotPaid }  , // Ödenmemiş
                new SelectListItem() { Value = "2", Text = babonline.PartiallyPaid }, // Kısmi Ödenmiş
                new SelectListItem() { Value = "1", Text = babonline.Paid } // Ödenmiş
            });

            model.RaporTipleri = new SelectList(raporTip, "Value", "Text", model.RaporTipim);
            if (tvmTaliVar || KontrolTVMKod == -9999)
            {
                ViewBag.AnaTVM = true;
            }
            else
            {
                ViewBag.AnaTVM = false;
            }
            return View(model);
        }

        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.OnMuhasebe, AltMenuKodu = AltMenuler.PoliceTahsilatRaporu, SekmeKodu = 0)]
        public ActionResult PoliceTahsilatRaporu(PoliceTahsilatRaporModel model)
        {
            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();

            #region multiselects / branslar - tvmler - sirketler

            if (model.tvmList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.tvmList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.TVMListe = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.TVMListe = model.TVMListe + liste[i] + ",";
                    else model.TVMListe = model.TVMListe + liste[i];
                }
            }
            else
            {
                model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
            }
            if (model.DisKaynakTvmList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.DisKaynakTvmList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.DisKaynakListesi = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.DisKaynakListesi = model.DisKaynakListesi + liste[i] + ",";
                    else model.DisKaynakListesi = model.DisKaynakListesi + liste[i];
                }
            }
            if (model.SigortaSirketleriSelectList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.SigortaSirketleriSelectList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.SigortaSirket = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.SigortaSirket = model.SigortaSirket + liste[i] + ",";
                    else model.SigortaSirket = model.SigortaSirket + liste[i];
                }
            }
            else
            {
                // model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
                model.TVMListe = String.Empty;
            }

            #endregion
            List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");
            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TVMUnvani = _AktifKullaniciService.TVMUnvani;

            List<SelectListItem> aramaTips = new List<SelectListItem>();
            aramaTips.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "0", Text = babonline.SalesChannel + " / " + babonline.InsuranceCompany }, // "Satış Kanalı / Sigorta Şirketi"
                new SelectListItem() { Value = "1", Text = babonline.CustomerGroupCode }, // "Müşteri Grup Kodu" 
                new SelectListItem() { Value = "2", Text = babonline.OutsourceSalesChannel } //  "Dış Kaynak Satış Kanalı"
            });
            model.AramaTipTipleri = new SelectList(aramaTips, "Value", "Text", model.AramaTip);
            model.tvmler = new MultiSelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.DisKaynakTvmler = new MultiSelectList(_TVMService.GetDisUretimTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            List<SelectListItem> raporTip = new List<SelectListItem>();
            raporTip.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "0", Text = babonline.NotPaid }  , // "Ödenmemiş"
                new SelectListItem() { Value = "2", Text = babonline.PartiallyPaid }, // "Kısmi Ödenmiş"
                new SelectListItem() { Value = "1", Text = babonline.Paid } // "Ödenmiş"
            });

            model.RaporTipleri = new SelectList(raporTip, "Value", "Text", model.RaporTipim);

            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            TVMDetay tvmDetay = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu);
            byte MerkezAcenteMi = 0;
            int MerkezAcenteKodu = 0;
            if (tvmDetay != null && tvmDetay.BagliOlduguTVMKodu == -9999)
            {
                MerkezAcenteMi = 1;
                MerkezAcenteKodu = model.TVMKodu;
            }
            else
            {
                MerkezAcenteKodu = tvmDetay.BagliOlduguTVMKodu;
            }
            int anaTVMKodu = _AktifKullaniciService.TVMKodu;

            if (tvmTaliVar || tvmDetay != null && tvmDetay.BagliOlduguTVMKodu == -9999)
            {
                #region   talisi olan anaacente ya da talisi olmayan anaacanete
                anaTVMKodu = _AktifKullaniciService.TVMKodu;

                model.procedureTahsilatList = new List<PoliceTahsilatRaporProcedureModel>();
                if (model.AramaTip == 0)
                {
                    model.procedureTahsilatList = _RaporService.PoliceTahsilatRaporGetir(MerkezAcenteMi, MerkezAcenteKodu, model.BaslangicTarihi, model.BitisTarihi, model.SigortaSirket,
                                                                                 model.tcVkn, model.TVMListe, model.RaporTipim);
                }
                //müşteri grup koduna göre
                else if (model.AramaTip == 1)
                {
                    model.procedureTahsilatList = _RaporService.PoliceTahsilatMusteriGrupKoduRaporGetir(MerkezAcenteMi, MerkezAcenteKodu, model.BaslangicTarihi, model.BitisTarihi,
                                                                                 model.MusteriGurpKodu, model.RaporTipim);
                }
                //dış kaynak satış kanalı ile
                else if (model.AramaTip == 2)
                {
                    model.procedureTahsilatList = _RaporService.PoliceTahsilatDisKaynakRaporGetir(MerkezAcenteMi, MerkezAcenteKodu, model.BaslangicTarihi, model.BitisTarihi,
                                                                                 model.DisKaynakListesi, model.RaporTipim);
                }
                ViewBag.AnaTVM = true;

                #endregion
            }
            else
            {
                #region tali tvm
                anaTVMKodu = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
                if (anaTVMKodu == -9999)
                {
                    anaTVMKodu = _AktifKullaniciService.TVMKodu;
                }
                model.procedureTahsilatList = new List<PoliceTahsilatRaporProcedureModel>();
                model.procedureTahsilatList = _RaporService.PoliceTahsilatRaporGetir(MerkezAcenteMi, MerkezAcenteKodu, model.BaslangicTarihi, model.BitisTarihi, model.SigortaSirket,
                                                                             model.tcVkn, model.TVMListe, model.RaporTipim);

                ViewBag.AnaTVM = false;
                #endregion
            }
            List<PoliceTahsilatRaporProcedureModel> cariHareketPoliceleri = new List<PoliceTahsilatRaporProcedureModel>();
            List<PoliceTahsilatRaporProcedureModel> cariHareketHaricPoliceler = new List<PoliceTahsilatRaporProcedureModel>();
            for (int i = model.procedureTahsilatList.Count() - 1; i >= 0; i--)
            {
                #region ödeme tipi 5 veya 9 ise ( acente kk veya acente bireysel kk ) Cari hareketlerde ödeme varmı kontrol ediyor.
                if (model.AramaTip == 0 || ((model.procedureTahsilatList[i].OdemTipi == 5 || model.procedureTahsilatList[i].OdemTipi == 9) && model.AramaTip == 1) || ((model.procedureTahsilatList[i].OdemTipi == 5 || model.procedureTahsilatList[i].OdemTipi == 9) && model.AramaTip == 2))
                {//AYNI POLİCEYİ LİSTENİN İÇİNE EKLEMİYORUZ.

                    if (cariHareketPoliceleri.Count > 0)
                    {
                        if (cariHareketPoliceleri.Where(w => w.PoliceNo == model.procedureTahsilatList[i].PoliceNo && w.YenilemeNo == model.procedureTahsilatList[i].YenilemeNo && w.EkNo == model.procedureTahsilatList[i].EkNo).FirstOrDefault() == null)
                        {
                            cariHareketPoliceleri.Add(model.procedureTahsilatList[i]);
                        }
                    }
                    else
                    {
                        cariHareketPoliceleri.Add(model.procedureTahsilatList[i]);
                    }
                }
                else
                {
                    cariHareketHaricPoliceler.Add(model.procedureTahsilatList[i]);
                }
                #endregion
            }
            if (cariHareketPoliceleri.Count > 0)
            {
                for (int i = cariHareketPoliceleri.Count - 1; i >= 0; i--)
                {
                    string TCKNVKN = "";
                    if ((cariHareketPoliceleri[i].kimlikNo != null && cariHareketPoliceleri[i].kimlikNo != ""))
                    {
                        TCKNVKN = cariHareketPoliceleri[i].kimlikNo;
                    }
                    else
                    {
                        TCKNVKN = cariHareketPoliceleri[i].vergiKimlikNo;
                    }
                    var CariHareketOdenenTutar = _Muhasebe_CariHesapService.getCarihareketForPoliceTahsilatRaporu(TCKNVKN, cariHareketPoliceleri[i].PoliceNo + "/" + cariHareketPoliceleri[i].YenilemeNo + "/" + cariHareketPoliceleri[i].EkNo);

                    // POLİCELER LİSTENİN İÇİNDE(cariHareketPoliceleri) TEK SEFERDE TUTULDUĞU İÇİN AYNI POLİCEYİ TEKRAR TEKRAR CARİHAREKETLERDE ARAMIYORUZ. 
                    var cariharekettenOdenen = model.procedureTahsilatList.Where(w => w.PoliceNo == cariHareketPoliceleri[i].PoliceNo && w.YenilemeNo == cariHareketPoliceleri[i].YenilemeNo && w.EkNo == cariHareketPoliceleri[i].EkNo && (w.kimlikNo == TCKNVKN || w.vergiKimlikNo == TCKNVKN)).OrderByDescending(w => w.TaksitNo).ToList();
                    var polinceninTumTahsilatlari = _Muhasebe_CariHesapService.getPoliceTahsilat(cariHareketPoliceleri[i].PoliceNo, cariHareketPoliceleri[i].EkNo.ToString(), cariHareketPoliceleri[i].YenilemeNo);

                    int x = 0;
                    // aynı policenin tüm taksitleri arasında dolaşıyoruz. 
                    if (polinceninTumTahsilatlari.Count > 0)
                    {
                        for (int j = polinceninTumTahsilatlari.Count - 1; j >= 0; j--)
                        {
                            if (CariHareketOdenenTutar.Count > 0)
                            {
                                if (CariHareketOdenenTutar[x].OdemeTipi == 5 || CariHareketOdenenTutar[x].OdemeTipi == 9)
                                {
                                    while ((x + 1) < CariHareketOdenenTutar.Count && (CariHareketOdenenTutar[x].OdemeTipi == 5 || CariHareketOdenenTutar[x].OdemeTipi == 9))
                                    {
                                        x = x + 1;
                                    }
                                }
                                //cariharektten girilen ödemeler içinde dolaşılıp tahsilatta olan ödemeler güncelleniyor. (db de değil)  
                                if (CariHareketOdenenTutar[x].OdemeTipi != 5 && CariHareketOdenenTutar[x].OdemeTipi != 9 && CariHareketOdenenTutar[x].Tutar <= 0)
                                {
                                    polinceninTumTahsilatlari[j].OdenenTutar = 0;
                                    polinceninTumTahsilatlari[j].KalanTaksitTutari = polinceninTumTahsilatlari[j].TaksitTutari;
                                }
                                while (CariHareketOdenenTutar[x].Tutar > 0 && CariHareketOdenenTutar[x].OdemeTipi != 5 && CariHareketOdenenTutar[x].OdemeTipi != 9)
                                {
                                    if (polinceninTumTahsilatlari[j].KalanTaksitTutari == null)
                                    {
                                        polinceninTumTahsilatlari[j].KalanTaksitTutari = polinceninTumTahsilatlari[j].TaksitTutari;
                                    }
                                    //odemetipi acente kk veya acente bireysel kk ise tahsilat tablosundan gelenler değil cari harekette olanlar baz alınıyor.
                                    if (polinceninTumTahsilatlari[j].OdemTipi == 5 || polinceninTumTahsilatlari[j].OdemTipi == 9)
                                    {
                                        polinceninTumTahsilatlari[j].KalanTaksitTutari = polinceninTumTahsilatlari[j].TaksitTutari;
                                        polinceninTumTahsilatlari[j].OdenenTutar = 0;
                                        //kalantaksit carihareketten eklenen paradan büyük ise kismi kalantaksit kalıyor.
                                        if (polinceninTumTahsilatlari[j].KalanTaksitTutari > CariHareketOdenenTutar[x].Tutar)
                                        {
                                            polinceninTumTahsilatlari[j].KalanTaksitTutari = polinceninTumTahsilatlari[j].KalanTaksitTutari - CariHareketOdenenTutar[x].Tutar;
                                            polinceninTumTahsilatlari[j].OdenenTutar = polinceninTumTahsilatlari[j].OdenenTutar + CariHareketOdenenTutar[x].Tutar;
                                            polinceninTumTahsilatlari[j].OdemTipi = Convert.ToInt32(CariHareketOdenenTutar[x].OdemeTipi);
                                            polinceninTumTahsilatlari[j].OdemeBelgeNo = CariHareketOdenenTutar[x].Aciklama;
                                            polinceninTumTahsilatlari[j].OdemeBelgeTarihi = CariHareketOdenenTutar[x].OdemeTarihi;
                                            CariHareketOdenenTutar[x].Tutar = 0;
                                            while ((x + 1) < CariHareketOdenenTutar.Count && (CariHareketOdenenTutar[x].OdemeTipi == 5 || CariHareketOdenenTutar[x].OdemeTipi == 9))
                                            {
                                                x = x + 1;
                                            }
                                        }
                                        else
                                        {
                                            polinceninTumTahsilatlari[j].OdenenTutar = polinceninTumTahsilatlari[j].TaksitTutari;
                                            CariHareketOdenenTutar[x].Tutar = CariHareketOdenenTutar[x].Tutar - Convert.ToDecimal(polinceninTumTahsilatlari[j].KalanTaksitTutari);
                                            polinceninTumTahsilatlari[j].KalanTaksitTutari = 0;
                                            polinceninTumTahsilatlari[j].OdemTipi = Convert.ToInt32(CariHareketOdenenTutar[x].OdemeTipi);
                                            polinceninTumTahsilatlari[j].OdemeBelgeNo = CariHareketOdenenTutar[x].Aciklama;
                                            polinceninTumTahsilatlari[j].OdemeBelgeTarihi = CariHareketOdenenTutar[x].OdemeTarihi;
                                            break;
                                        }
                                    }
                                    else
                                    {
                                        //kalantaksit carihareketten eklenen paradan büyük ise kismi kalantaksit kalıyor.
                                        if (polinceninTumTahsilatlari[j].KalanTaksitTutari > CariHareketOdenenTutar[x].Tutar)
                                        {
                                            polinceninTumTahsilatlari[j].KalanTaksitTutari = polinceninTumTahsilatlari[j].KalanTaksitTutari - CariHareketOdenenTutar[x].Tutar;
                                            polinceninTumTahsilatlari[j].OdenenTutar = polinceninTumTahsilatlari[j].OdenenTutar + CariHareketOdenenTutar[x].Tutar;
                                            polinceninTumTahsilatlari[j].OdemTipi = Convert.ToInt32(CariHareketOdenenTutar[x].OdemeTipi);
                                            polinceninTumTahsilatlari[j].OdemeBelgeNo = CariHareketOdenenTutar[x].Aciklama;
                                            polinceninTumTahsilatlari[j].OdemeBelgeTarihi = CariHareketOdenenTutar[x].OdemeTarihi;
                                            CariHareketOdenenTutar[x].Tutar = 0;
                                            while ((x + 1) < CariHareketOdenenTutar.Count && (CariHareketOdenenTutar[x].OdemeTipi == 5 || CariHareketOdenenTutar[x].OdemeTipi == 9))
                                            {
                                                x = x + 1;
                                            }
                                        }
                                        // hali hazırda kalantaksit=0 olanlar var o yüzden içeride if kullandık.
                                        else
                                        {
                                            if (polinceninTumTahsilatlari[j].KalanTaksitTutari > 0)
                                            {
                                                polinceninTumTahsilatlari[j].OdenenTutar = polinceninTumTahsilatlari[j].TaksitTutari;
                                                polinceninTumTahsilatlari[j].OdemTipi = Convert.ToInt32(CariHareketOdenenTutar[x].OdemeTipi);
                                                polinceninTumTahsilatlari[j].OdemeBelgeNo = CariHareketOdenenTutar[x].Aciklama;
                                                polinceninTumTahsilatlari[j].OdemeBelgeTarihi = CariHareketOdenenTutar[x].OdemeTarihi;
                                                CariHareketOdenenTutar[x].Tutar = CariHareketOdenenTutar[x].Tutar - Convert.ToDecimal(polinceninTumTahsilatlari[j].KalanTaksitTutari);
                                                polinceninTumTahsilatlari[j].KalanTaksitTutari = 0;
                                                break;
                                            }
                                            else if (polinceninTumTahsilatlari[j].KalanTaksitTutari == 0)
                                            {
                                                break;
                                            }
                                        }
                                    }
                                }

                            }
                            else
                            {
                                if (polinceninTumTahsilatlari[j].OdemTipi == 5 || polinceninTumTahsilatlari[j].OdemTipi == 9)
                                {
                                    polinceninTumTahsilatlari[j].KalanTaksitTutari = polinceninTumTahsilatlari[j].TaksitTutari;
                                    polinceninTumTahsilatlari[j].OdenenTutar = 0;
                                }
                            }
                        }
                        for (int k = 0; k < cariharekettenOdenen.Count; k++)
                        {
                            var tahsilatTaksit = polinceninTumTahsilatlari.Where(w => w.TaksitNo == cariharekettenOdenen[k].TaksitNo).FirstOrDefault();
                            if (tahsilatTaksit != null)
                            {
                                cariharekettenOdenen[k].OdenenTutar = tahsilatTaksit.OdenenTutar;
                                cariharekettenOdenen[k].KalanTaksitTutari = tahsilatTaksit.KalanTaksitTutari;
                                cariharekettenOdenen[k].OdemTipi = tahsilatTaksit.OdemTipi;
                                cariharekettenOdenen[k].OdemeBelgeNo = tahsilatTaksit.OdemeBelgeNo;
                                cariharekettenOdenen[k].OdemeBelgeTarihi = tahsilatTaksit.OdemeBelgeTarihi;
                                //Ödenmemiş
                                if (cariharekettenOdenen[k].KalanTaksitTutari > 0 && model.RaporTipim == 0)
                                {
                                    cariHareketHaricPoliceler.Add(cariharekettenOdenen[k]);
                                }
                                //Ödenmiş
                                if (cariharekettenOdenen[k].KalanTaksitTutari == 0 && model.RaporTipim == 1)
                                {
                                    cariHareketHaricPoliceler.Add(cariharekettenOdenen[k]);
                                }
                                //Kismi Ödenmiş 
                                if (cariharekettenOdenen[k].KalanTaksitTutari > 0 && model.RaporTipim == 2)
                                {
                                    cariHareketHaricPoliceler.Add(cariharekettenOdenen[k]);
                                }
                            }
                        }
                    }
                    else
                    {
                        cariHareketHaricPoliceler.Add(cariHareketPoliceleri[i]);
                    }
                }
            }
            if (cariHareketHaricPoliceler.Count > 0)
            {
                model.procedureTahsilatList = new List<PoliceTahsilatRaporProcedureModel>();
                model.procedureTahsilatList = cariHareketHaricPoliceler;
            }
            else
            {
                if (model.AramaTip == 0)
                {
                    if (model.procedureTahsilatList.Where(s => s.KalanTaksitTutari == 0).ToList().Count() > 0)
                    {
                        var removeItems = model.procedureTahsilatList.Where(s => s.KalanTaksitTutari == 0).ToList();
                        foreach (var removeItem in removeItems)
                        {
                            model.procedureTahsilatList.Remove(removeItem);
                        }
                    }
                }
            }

            return View(model);
        }

        #endregion

        #region Police Uretim Rapooru

        [Authorization(AnaMenuKodu = AnaMenuler.Rapor, AltMenuKodu = AltMenuler.OfflineRaporlar, SekmeKodu = AltMenuSekmeler.PoliceUretimRaporuListe)]
        public ActionResult PoliceUretimRaporuListe()
        {
            PoliceUretimAramaModel model = new PoliceUretimAramaModel();

            model.Donem = TurkeyDateTime.Now.AddDays(-2);
            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TVMUnvani = _AktifKullaniciService.TVMUnvani;
            ViewBag.AcenteTipi = _AktifKullaniciService.TvmTipi;
            List<Bran> brans = null;
            if (_AktifKullaniciService.TvmTipi != 1)
                brans = _BransService.GetList(_AktifKullaniciService.TvmTipi.ToString());
            else
                brans = _BransService.GetListBroker();
            model.Branslar = new MultiSelectList(brans, "BransKodu", "BransAdi");

            List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
            List<Database.Models.SigortaSirketleri> tempbrokerItem = new List<Database.Models.SigortaSirketleri>();
            foreach (var item in SSirketler)
            {
                if (int.TryParse(item.SirketKodu.ToString(), out int a) && int.TryParse(item.SirketKodu.ToString(), out int b))
                {
                    if (a >= 500 && b <= 530)
                    {
                        tempbrokerItem.Add(item);
                    }
                }
            }
            foreach (var item in tempbrokerItem)
            {
                SSirketler.Remove(item);
                SSirketler.Insert(0, item);
            }
            model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");
            //model.SigortaSirketleri = new MultiSelectList(_TUMService.GetListTUMDetay(), "BirlikKodu", "Unvani");
            //model.tvmler = new MultiSelectList(_TaliPoliceService.GetYetkiliTVM(model.TVMKodu).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.tvmler = new MultiSelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.uretimTvmler = new MultiSelectList(_TVMService.GetDisUretimTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");

            List<SelectListItem> raporTip = new List<SelectListItem>();

            raporTip.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "0", Text = babonline.InsuranceCompany +" +"+ babonline.Branch },
                new SelectListItem() { Value = "1", Text = babonline.Branch +"+ "+ babonline.InsuranceCompany }
            });

            model.RaporTipleri = new SelectList(raporTip, "Value", "Text", model.RaporTipi);

            //List<SelectListItem> listYillar = new List<SelectListItem>();
            //for (int yil = TurkeyDateTime.Today.Year; yil >= 1990; yil--)
            //{
            //    listYillar.AddRange(new SelectListItem[] {
            //    new SelectListItem() { Value = yil.ToString(), Text = yil.ToString() },
            //});
            //}

            //model.Yillar = new SelectList(listYillar, "Value", "Text", "0").ToList();

            //List<SelectListItem> listAylar = new List<SelectListItem>();

            //listAylar.AddRange(new SelectListItem[] {
            //    new SelectListItem() { Value = "01", Text = "01" },
            //    new SelectListItem() { Value = "02", Text = "02" },
            //    new SelectListItem() { Value = "03", Text = "03" },
            //    new SelectListItem() { Value = "04", Text = "04" },
            //    new SelectListItem() { Value = "05", Text = "05" },
            //    new SelectListItem() { Value = "06", Text = "06" },
            //    new SelectListItem() { Value = "07", Text = "07" },
            //    new SelectListItem() { Value = "08", Text = "08" },
            //    new SelectListItem() { Value = "09", Text = "09" },
            //    new SelectListItem() { Value = "10", Text = "10" },
            //    new SelectListItem() { Value = "11", Text = "11" },
            //    new SelectListItem() { Value = "12", Text = "12" },
            //});

            //model.Aylar = new SelectList(listAylar, "Value", "Text").ToList();

            model.BaslangicTarihi = TurkeyDateTime.Now.AddDays(-2);
            model.BitisTarihi = TurkeyDateTime.Now;

            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            var getTVMDetay = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu);
            if (getTVMDetay != null)
            {
                int KontrolTVMKod = getTVMDetay.BagliOlduguTVMKodu;
                if (tvmTaliVar || KontrolTVMKod == -9999)
                {
                    ViewBag.AnaTVM = true;
                }
                else
                {
                    ViewBag.AnaTVM = false;
                }
                if (getTVMDetay.BolgeYetkilisiMi == 1)
                {
                    model.BolgeYetkilisiMi = true;
                }
            }

            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.AnaTVM = false;
            }
            return View(model);
        }

        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Rapor, AltMenuKodu = AltMenuler.OfflineRaporlar, SekmeKodu = AltMenuSekmeler.PoliceUretimRaporuListe)]
        public ActionResult PoliceUretimRaporuListe(PoliceUretimAramaModel model)
        {

            #region return values
            model.Donem = TurkeyDateTime.Now.AddDays(-2);
            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TVMUnvani = _AktifKullaniciService.TVMUnvani;
            ViewBag.AcenteTipi = _AktifKullaniciService.TvmTipi;
            List<Bran> brans = null;
            if (_AktifKullaniciService.TvmTipi != 1)
                brans = _BransService.GetList(_AktifKullaniciService.TvmTipi.ToString());
            else
                brans = _BransService.GetListBroker();
            //List<Bran> brans = _BransService.GetList(_AktifKullaniciService.TvmTipi.ToString());
            model.Branslar = new MultiSelectList(brans, "BransKodu", "BransAdi");
            List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
            List<Database.Models.SigortaSirketleri> tempbrokerItem = new List<Database.Models.SigortaSirketleri>();
            foreach (var item in SSirketler)
            {
                if (int.TryParse(item.SirketKodu.ToString(), out int a) && int.TryParse(item.SirketKodu.ToString(), out int b))
                {
                    if (a >= 500 && b <= 530)
                    {
                        tempbrokerItem.Add(item);
                    }
                }
            }
            foreach (var item in tempbrokerItem)
            {
                SSirketler.Remove(item);
                SSirketler.Insert(0, item);
            }
            model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");
            // model.SigortaSirketleri = new MultiSelectList(_TUMService.GetListTUMDetay(), "BirlikKodu", "Unvani");
            // model.tvmler = new MultiSelectList(_TaliPoliceService.GetYetkiliTVM(model.TVMKodu).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.tvmler = new MultiSelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.uretimTvmler = new MultiSelectList(_TVMService.GetDisUretimTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            List<SelectListItem> raporTip = new List<SelectListItem>();
            raporTip.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "0", Text = babonline.InsuranceCompany +" +"+ babonline.Branch },
                new SelectListItem() { Value = "1", Text = babonline.Branch +"+ "+ babonline.InsuranceCompany }
            });
            model.RaporTipleri = new SelectList(raporTip, "Value", "Text", model.RaporTipi);

            //List<SelectListItem> listYillar = new List<SelectListItem>();
            //for (int yil = TurkeyDateTime.Today.Year; yil >= 1990; yil--)
            //{
            //    listYillar.AddRange(new SelectListItem[] {
            //        new SelectListItem() { Value = yil.ToString(), Text = yil.ToString() },
            //    });

            //}
            //model.Yillar = new SelectList(listYillar, "Value", "Text", "0").ToList();

            //List<SelectListItem> listAylar = new List<SelectListItem>();
            //listAylar.AddRange(new SelectListItem[] {
            //    new SelectListItem() { Value = "01", Text = "01" },
            //    new SelectListItem() { Value = "02", Text = "02" },
            //    new SelectListItem() { Value = "03", Text = "03" },
            //    new SelectListItem() { Value = "04", Text = "04" },
            //    new SelectListItem() { Value = "05", Text = "05" },
            //    new SelectListItem() { Value = "06", Text = "06" },
            //    new SelectListItem() { Value = "07", Text = "07" },
            //    new SelectListItem() { Value = "08", Text = "08" },
            //    new SelectListItem() { Value = "09", Text = "09" },
            //    new SelectListItem() { Value = "10", Text = "10" },
            //    new SelectListItem() { Value = "11", Text = "11" },
            //    new SelectListItem() { Value = "12", Text = "12" },
            //});
            //model.Aylar = new SelectList(listAylar, "Value", "Text").ToList();


            #endregion
            #region multiselects / branslar - tvmler - sirketler

            if (model.BranslarSelectList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.BranslarSelectList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.BransList = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.BransList = model.BransList + liste[i] + ",";
                    else model.BransList = model.BransList + liste[i];
                }
            }

            if (model.SigortaSirketleriSelectList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.SigortaSirketleriSelectList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.SigortaSirket = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.SigortaSirket = model.SigortaSirket + liste[i] + ",";
                    else model.SigortaSirket = model.SigortaSirket + liste[i];
                }
            }


            if (model.tvmList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.tvmList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.TVMListe = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.TVMListe = model.TVMListe + liste[i] + ",";
                    else model.TVMListe = model.TVMListe + liste[i];
                }
            }
            else
            {
                model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
                //   model.TVMListe = String.Empty;
            }

            if (model.tvmList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.tvmList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.TVMListe = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.TVMListe = model.TVMListe + liste[i] + ",";
                    else model.TVMListe = model.TVMListe + liste[i];
                }
            }
            else
            {
                model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
                //model.TVMListe = String.Empty;
            }

            if (model.uretimTvmList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.uretimTvmList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.UretimTVMListe = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.UretimTVMListe = model.UretimTVMListe + liste[i] + ",";
                    else model.UretimTVMListe = model.UretimTVMListe + liste[i];
                }
            }
            else
            {
                // model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
                model.UretimTVMListe = String.Empty;
            }
            #endregion

            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            _TvmService = DependencyResolver.Current.GetService<ITVMService>();

            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            var getTVMDetay = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu);
            int KontrolTVMKod = 0;
            if (getTVMDetay != null)
            {
                KontrolTVMKod = getTVMDetay.BagliOlduguTVMKodu;
                if (getTVMDetay.BolgeYetkilisiMi == 1)
                {
                    model.BolgeYetkilisiMi = true;
                }
            }

            int anaTVMKodu = _AktifKullaniciService.TVMKodu;
            decimal? GenelBrutToplam = 0;
            decimal? GenelNetToplam = 0;
            decimal? GenelKomisyon = 0;
            decimal? GenelVerilenToplam = 0;
            decimal? IptalGenelBrutToplam = 0;
            decimal? IptalGenelNetToplam = 0;
            decimal? IptalGenelKomisyon = 0;
            decimal? IptalGenelVerilenToplam = 0;

            decimal? TotalGenelBrutToplam = 0;
            decimal? TotalGenelNetToplam = 0;
            decimal? TotalGenelKomisyon = 0;
            decimal? TotalGenelVerilenToplam = 0;

            if ((tvmTaliVar || KontrolTVMKod == -9999) || true)
            {
                #region   talisi olan anaacente ya da talisi olmayan anaacanete
                anaTVMKodu = _AktifKullaniciService.TVMKodu;
                if (!(tvmTaliVar || KontrolTVMKod == -9999))
                {
                    anaTVMKodu = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
                }


                List<PoliceUretimRaporProcedureModel> list = _TumContext.PoliceUretimRapor_Getir(model.BaslangicTarihi, model.BitisTarihi, model.SigortaSirket, model.BransList, model.TVMListe, model.UretimTVMListe, anaTVMKodu);
                if (model.RaporTipi == 0)
                {
                    #region rapor tip ss + brans
                    var GroupList = list.GroupBy(ac => new
                    {
                        ac.SirketAdi,
                        ac.BransAdi
                    })
                                            .Select(ac => new
                                            {
                                                SirketAdi = ac.Key.SirketAdi,
                                                BransAdi = ac.Key.BransAdi,
                                                //NetToplam = ac.Sum(s => s.NetPrim),
                                                //BrutToplam = ac.Sum(s => s.BrutPrim),
                                                //Komisyon = ac.Sum(s => s.Komisyon),
                                                //VerilenToplam = ac.Sum(s => s.TaliKomisyon),
                                                list = ac.ToList()
                                            }).OrderBy(s => s.SirketAdi).ToList();

                    List<PoliceUretimGrupModel> mods = new List<PoliceUretimGrupModel>();
                    PoliceUretimGrupModel mod;
                    for (int i = 0; i < GroupList.Count(); i++)
                    {
                        mod = new PoliceUretimGrupModel();
                        mod.BransAdi = GroupList[i].BransAdi;
                        mod.list = GroupList[i].list;
                        mod.SirketAdi = GroupList[i].SirketAdi;

                        //mod.BrutToplam = GroupList[i].BrutToplam;
                        //mod.NetToplam = GroupList[i].NetToplam;
                        //mod.Komisyon = GroupList[i].Komisyon;
                        //mod.VerilenToplam = GroupList[i].VerilenToplam;

                        mod.BrutToplam = 0;
                        mod.NetToplam = 0;
                        mod.Komisyon = 0;
                        mod.VerilenToplam = 0;

                        mod.BrutToplamIptal = 0;
                        mod.NetToplamIptal = 0;
                        mod.KomisyonIptal = 0;
                        mod.VerilenToplamIptal = 0;

                        mod.TotalNetToplam = 0;
                        mod.TotalBrutToplam = 0;
                        mod.TotalKomisyon = 0;
                        mod.TotalVerilenToplam = 0;

                        foreach (var item in mod.list)
                        {
                            if (item.BrutPrim >= 0)
                            {
                                mod.BrutToplam += item.BrutPrim;
                                mod.NetToplam += item.NetPrim;
                                mod.Komisyon += item.Komisyon;
                                mod.VerilenToplam += item.TaliKomisyon;
                            }
                            else
                            {
                                mod.BrutToplamIptal += item.BrutPrim;
                                mod.NetToplamIptal += item.NetPrim;
                                mod.KomisyonIptal += item.Komisyon;
                                mod.VerilenToplamIptal += item.TaliKomisyon;
                            }
                            mod.TotalNetToplam = mod.NetToplam + mod.NetToplamIptal;
                            mod.TotalBrutToplam = mod.BrutToplam + mod.BrutToplamIptal;
                            mod.TotalKomisyon = mod.Komisyon + mod.KomisyonIptal;
                            mod.TotalVerilenToplam = mod.VerilenToplam + mod.VerilenToplamIptal;
                        }
                        mods.Add(mod);
                    }
                    ViewData["grupListe"] = mods;
                    #endregion
                }


                if (model.RaporTipi == 1)
                {
                    #region brans+ ss
                    var GroupList = list.GroupBy(ac => new
                    {
                        ac.BransAdi
                    })
                                              .Select(ac => new
                                              {
                                                  BransAdi = ac.Key.BransAdi,


                                                  //NetToplam = ac.Sum(s => s.NetPrim),
                                                  //BrutToplam = ac.Sum(s => s.BrutPrim),
                                                  //Komisyon = ac.Sum(s => s.Komisyon),
                                                  //VerilenToplam = ac.Sum(s => s.TaliKomisyon),
                                                  list = ac.ToList()
                                              }).ToList();
                    //string temp = string.Empty;
                    //foreach (var item in GroupList[0].list)
                    //{
                    //    temp = item.SirketAdi;
                    //    item.SirketAdi = item.BransAdi;
                    //    item.BransAdi = temp;
                    //}

                    List<PoliceUretimGrupModel> mods = new List<PoliceUretimGrupModel>();
                    PoliceUretimGrupModel mod;
                    for (int i = 0; i < GroupList.Count(); i++)
                    {
                        mod = new PoliceUretimGrupModel();
                        mod.BransAdi = GroupList[i].BransAdi;
                        mod.list = GroupList[i].list.OrderBy(s => s.SirketAdi).ToList();
                        // mod.SirketAdi = GroupList[i].SirketAdi;

                        //mod.BrutToplam = GroupList[i].BrutToplam;
                        //mod.NetToplam = GroupList[i].NetToplam;
                        //mod.Komisyon = GroupList[i].Komisyon;
                        //mod.VerilenToplam = GroupList[i].VerilenToplam;

                        mod.BrutToplam = 0;
                        mod.NetToplam = 0;
                        mod.Komisyon = 0;
                        mod.VerilenToplam = 0;

                        mod.BrutToplamIptal = 0;
                        mod.NetToplamIptal = 0;
                        mod.KomisyonIptal = 0;
                        mod.VerilenToplamIptal = 0;

                        mod.TotalNetToplam = 0;
                        mod.TotalBrutToplam = 0;
                        mod.TotalKomisyon = 0;
                        mod.TotalVerilenToplam = 0;

                        foreach (var item in mod.list)
                        {
                            if (item.BrutPrim >= 0)
                            {
                                mod.BrutToplam += item.BrutPrim;
                                mod.NetToplam += item.NetPrim;
                                mod.Komisyon += item.Komisyon;
                                mod.VerilenToplam += item.TaliKomisyon;
                            }
                            else
                            {
                                mod.BrutToplamIptal += item.BrutPrim;
                                mod.NetToplamIptal += item.NetPrim;
                                mod.KomisyonIptal += item.Komisyon;
                                mod.VerilenToplamIptal += item.TaliKomisyon;
                            }
                            mod.TotalNetToplam = mod.NetToplam + mod.NetToplamIptal;
                            mod.TotalBrutToplam = mod.BrutToplam + mod.BrutToplamIptal;
                            mod.TotalKomisyon = mod.Komisyon + mod.KomisyonIptal;
                            mod.TotalVerilenToplam = mod.VerilenToplam + mod.VerilenToplamIptal;
                        }
                        mods.Add(mod);
                    }
                    ViewData["grupListe"] = mods;

                    #endregion
                }
                #region grup toplamlar (sirkete+ brans a göre // brans a göre)


                var groupBySirket = list.GroupBy(ac => new
                {
                    ac.SirketAdi
                })
                                            .Select(ac => new
                                            {
                                                SirketAdi = ac.Key.SirketAdi,
                                                list = ac.ToList()
                                            }).ToList();



                model.raporGrupToplamlarList = new List<PoliceUretimGrupToplamModel>();
                model.raporGrupToplamlar = new PoliceUretimGrupToplamModel();
                for (int i = 0; i < groupBySirket.Count(); i++)
                {
                    model.raporGrupToplamlar = new PoliceUretimGrupToplamModel();
                    model.raporGrupToplamlar.SirketBrutToplam = 0;
                    model.raporGrupToplamlar.SirketNetToplam = 0;
                    model.raporGrupToplamlar.SirketKomisyon = 0;
                    model.raporGrupToplamlar.SirketVerilenToplam = 0;

                    model.raporGrupToplamlar.IptalSirketBrutToplam = 0;
                    model.raporGrupToplamlar.IptalSirketNetToplam = 0;
                    model.raporGrupToplamlar.IptalSirketKomisyon = 0;
                    model.raporGrupToplamlar.IptalSirketVerilenToplam = 0;

                    model.raporGrupToplamlar.TotalGenelBrutToplam = 0;
                    model.raporGrupToplamlar.TotalGenelNetToplam = 0;
                    model.raporGrupToplamlar.TotalGenelKomisyon = 0;
                    model.raporGrupToplamlar.TotalGenelVerilenToplam = 0;


                    model.raporGrupToplamlar.SirketAdi = groupBySirket[i].SirketAdi;
                    foreach (var item in groupBySirket[i].list)
                    {
                        if (item.BrutPrim >= 0)
                        {
                            model.raporGrupToplamlar.SirketBrutToplam += item.BrutPrim;
                            model.raporGrupToplamlar.SirketNetToplam += item.NetPrim;
                            model.raporGrupToplamlar.SirketKomisyon += item.Komisyon;
                            model.raporGrupToplamlar.SirketVerilenToplam += item.TaliKomisyon;
                        }
                        else
                        {
                            model.raporGrupToplamlar.IptalSirketBrutToplam += item.BrutPrim;
                            model.raporGrupToplamlar.IptalSirketNetToplam += item.NetPrim;
                            model.raporGrupToplamlar.IptalSirketKomisyon += item.Komisyon;
                            model.raporGrupToplamlar.IptalSirketVerilenToplam += item.TaliKomisyon;
                        }


                    }
                    GenelBrutToplam += model.raporGrupToplamlar.SirketBrutToplam;
                    GenelNetToplam += model.raporGrupToplamlar.SirketNetToplam;
                    GenelKomisyon += model.raporGrupToplamlar.SirketKomisyon;
                    GenelVerilenToplam += model.raporGrupToplamlar.SirketVerilenToplam;
                    IptalGenelBrutToplam += model.raporGrupToplamlar.IptalSirketBrutToplam;
                    IptalGenelNetToplam += model.raporGrupToplamlar.IptalSirketNetToplam;
                    IptalGenelKomisyon += model.raporGrupToplamlar.IptalSirketKomisyon;
                    IptalGenelVerilenToplam += model.raporGrupToplamlar.IptalSirketVerilenToplam;

                    TotalGenelBrutToplam = GenelBrutToplam + IptalGenelBrutToplam;
                    TotalGenelNetToplam = GenelNetToplam + IptalGenelNetToplam;
                    TotalGenelKomisyon = GenelKomisyon + IptalGenelKomisyon;
                    TotalGenelVerilenToplam = GenelVerilenToplam + IptalGenelVerilenToplam;

                    model.raporGrupToplamlarList.Add(model.raporGrupToplamlar);
                }

                model.raporGrupToplamlar.GenelBrutToplam = GenelBrutToplam;
                model.raporGrupToplamlar.GenelNetToplam = GenelNetToplam;
                model.raporGrupToplamlar.GenelKomisyon = GenelKomisyon;
                model.raporGrupToplamlar.GenelVerilenToplam = GenelVerilenToplam;

                model.raporGrupToplamlar.IptalGenelBrutToplam = IptalGenelBrutToplam;
                model.raporGrupToplamlar.IptalGenelNetToplam = IptalGenelNetToplam;
                model.raporGrupToplamlar.IptalGenelKomisyon = IptalGenelKomisyon;
                model.raporGrupToplamlar.IptalGenelVerilenToplam = IptalGenelVerilenToplam;

                model.raporGrupToplamlar.TotalGenelNetToplam = TotalGenelNetToplam;
                model.raporGrupToplamlar.TotalGenelBrutToplam = TotalGenelBrutToplam;
                model.raporGrupToplamlar.TotalGenelKomisyon = TotalGenelKomisyon;
                model.raporGrupToplamlar.TotalGenelVerilenToplam = TotalGenelVerilenToplam;



                #endregion

                ViewBag.AnaTVM = true;
                #endregion
            }
            else
            {
                #region tali tvm
                anaTVMKodu = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
                if (anaTVMKodu == -9999)
                {
                    anaTVMKodu = _AktifKullaniciService.TVMKodu;
                }
                List<PoliceUretimRaporProcedureModel> list = _TumContext.PoliceUretimRapor_Getir(model.BaslangicTarihi, model.BitisTarihi, model.SigortaSirket, model.BransList, model.TVMListe, model.UretimTVMListe, anaTVMKodu);

                if (model.RaporTipi == 0)
                {
                    #region rapor tip ss + brans

                    var GroupList = list.GroupBy(ac => new
                    {
                        ac.SirketAdi,
                        ac.BransAdi
                    })
                                            .Select(ac => new
                                            {
                                                SirketAdi = ac.Key.SirketAdi,
                                                BransAdi = ac.Key.BransAdi,
                                                //NetToplam = ac.Sum(s => s.NetPrim),
                                                //BrutToplam = ac.Sum(s => s.BrutPrim),
                                                //Komisyon = ac.Sum(s => s.Komisyon),
                                                //VerilenToplam = ac.Sum(s => s.TaliKomisyon),
                                                list = ac.ToList()
                                            }).OrderBy(s => s.SirketAdi).ToList();
                    List<PoliceUretimGrupModel> mods = new List<PoliceUretimGrupModel>();
                    PoliceUretimGrupModel mod;
                    for (int i = 0; i < GroupList.Count(); i++)
                    {
                        mod = new PoliceUretimGrupModel();
                        mod.BransAdi = GroupList[i].BransAdi;
                        mod.list = GroupList[i].list;
                        mod.SirketAdi = GroupList[i].SirketAdi;

                        //mod.BrutToplam = GroupList[i].BrutToplam;
                        //mod.NetToplam = GroupList[i].NetToplam;
                        //mod.Komisyon = GroupList[i].Komisyon;
                        //mod.VerilenToplam = GroupList[i].VerilenToplam;

                        mod.BrutToplam = 0;
                        mod.NetToplam = 0;
                        mod.Komisyon = 0;
                        mod.VerilenToplam = 0;

                        mod.BrutToplamIptal = 0;
                        mod.NetToplamIptal = 0;
                        mod.KomisyonIptal = 0;
                        mod.VerilenToplamIptal = 0;

                        mod.TotalNetToplam = 0;
                        mod.TotalBrutToplam = 0;
                        mod.TotalKomisyon = 0;
                        mod.TotalVerilenToplam = 0;

                        foreach (var item in mod.list)
                        {
                            if (item.BrutPrim > 0)
                            {
                                mod.BrutToplam += item.BrutPrim;
                                mod.NetToplam += item.NetPrim;
                                mod.Komisyon += item.Komisyon;
                                mod.VerilenToplam += item.TaliKomisyon;
                            }
                            else
                            {
                                mod.BrutToplamIptal += item.BrutPrim;
                                mod.NetToplamIptal += item.NetPrim;
                                mod.KomisyonIptal += item.Komisyon;
                                mod.VerilenToplamIptal += item.TaliKomisyon;
                            }

                            mod.TotalNetToplam = mod.NetToplam + mod.NetToplamIptal;
                            mod.TotalBrutToplam = mod.BrutToplam + mod.BrutToplamIptal;
                            mod.TotalKomisyon = mod.Komisyon + mod.KomisyonIptal;
                            mod.TotalVerilenToplam = mod.VerilenToplam + mod.VerilenToplamIptal;
                        }
                        mods.Add(mod);
                    }
                    ViewData["grupListe"] = mods;
                    #endregion
                }

                if (model.RaporTipi == 1)
                {
                    #region brans+ ss
                    var GroupList = list.GroupBy(ac => new
                    {
                        ac.BransAdi
                    })
                                              .Select(ac => new
                                              {
                                                  BransAdi = ac.Key.BransAdi,

                                                  //NetToplam = ac.Sum(s => s.NetPrim),
                                                  //BrutToplam = ac.Sum(s => s.BrutPrim),
                                                  //Komisyon = ac.Sum(s => s.Komisyon),
                                                  //VerilenToplam = ac.Sum(s => s.TaliKomisyon),
                                                  list = ac.ToList()
                                              }).ToList();
                    //string temp = string.Empty;
                    //foreach (var item in GroupList[0].list)
                    //{
                    //    temp = item.SirketAdi;
                    //    item.SirketAdi = item.BransAdi;
                    //    item.BransAdi = temp;
                    //}

                    List<PoliceUretimGrupModel> mods = new List<PoliceUretimGrupModel>();
                    PoliceUretimGrupModel mod;
                    for (int i = 0; i < GroupList.Count(); i++)
                    {
                        mod = new PoliceUretimGrupModel();
                        mod.BransAdi = GroupList[i].BransAdi;
                        mod.list = GroupList[i].list;
                        // mod.SirketAdi = GroupList[i].SirketAdi;

                        //mod.BrutToplam = GroupList[i].BrutToplam;
                        //mod.NetToplam = GroupList[i].NetToplam;
                        //mod.Komisyon = GroupList[i].Komisyon;
                        //mod.VerilenToplam = GroupList[i].VerilenToplam;

                        mod.BrutToplam = 0;
                        mod.NetToplam = 0;
                        mod.Komisyon = 0;
                        mod.VerilenToplam = 0;

                        mod.BrutToplamIptal = 0;
                        mod.NetToplamIptal = 0;
                        mod.KomisyonIptal = 0;
                        mod.VerilenToplamIptal = 0;

                        mod.TotalNetToplam = 0;
                        mod.TotalBrutToplam = 0;
                        mod.TotalKomisyon = 0;
                        mod.TotalVerilenToplam = 0;

                        foreach (var item in mod.list)
                        {
                            if (item.BrutPrim > 0)
                            {
                                mod.BrutToplam += item.BrutPrim;
                                mod.NetToplam += item.NetPrim;
                                mod.Komisyon += item.Komisyon;
                                mod.VerilenToplam += item.TaliKomisyon;
                            }
                            else
                            {
                                mod.BrutToplamIptal += item.BrutPrim;
                                mod.NetToplamIptal += item.NetPrim;
                                mod.KomisyonIptal += item.Komisyon;
                                mod.VerilenToplamIptal += item.TaliKomisyon;
                            }

                            mod.TotalNetToplam = mod.NetToplam + mod.NetToplamIptal;
                            mod.TotalBrutToplam = mod.BrutToplam + mod.BrutToplamIptal;
                            mod.TotalKomisyon = mod.Komisyon + mod.KomisyonIptal;
                            mod.TotalVerilenToplam = mod.VerilenToplam + mod.VerilenToplamIptal;
                        }
                        mods.Add(mod);
                    }
                    ViewData["grupListe"] = mods;

                    #endregion
                }

                #region grup toplamlar (sirkete+ brans a göre // brans a göre)
                var groupBySirket = list.GroupBy(ac => new
                {
                    ac.SirketAdi
                })
                                            .Select(ac => new
                                            {
                                                SirketAdi = ac.Key.SirketAdi,
                                                list = ac.ToList()
                                            }).ToList();



                model.raporGrupToplamlarList = new List<PoliceUretimGrupToplamModel>();
                model.raporGrupToplamlar = new PoliceUretimGrupToplamModel();
                for (int i = 0; i < groupBySirket.Count(); i++)
                {
                    model.raporGrupToplamlar = new PoliceUretimGrupToplamModel();
                    model.raporGrupToplamlar.SirketBrutToplam = 0;
                    model.raporGrupToplamlar.SirketNetToplam = 0;
                    model.raporGrupToplamlar.SirketKomisyon = 0;
                    model.raporGrupToplamlar.SirketVerilenToplam = 0;
                    model.raporGrupToplamlar.IptalSirketBrutToplam = 0;
                    model.raporGrupToplamlar.IptalSirketNetToplam = 0;
                    model.raporGrupToplamlar.IptalSirketKomisyon = 0;
                    model.raporGrupToplamlar.IptalSirketVerilenToplam = 0;

                    model.raporGrupToplamlar.GenelBrutToplam = 0;
                    model.raporGrupToplamlar.GenelNetToplam = 0;
                    model.raporGrupToplamlar.GenelKomisyon = 0;
                    model.raporGrupToplamlar.GenelVerilenToplam = 0;

                    model.raporGrupToplamlar.IptalGenelBrutToplam = 0;
                    model.raporGrupToplamlar.IptalGenelNetToplam = 0;
                    model.raporGrupToplamlar.IptalGenelKomisyon = 0;
                    model.raporGrupToplamlar.IptalGenelVerilenToplam = 0;

                    model.raporGrupToplamlar.TotalGenelBrutToplam = 0;
                    model.raporGrupToplamlar.TotalGenelNetToplam = 0;
                    model.raporGrupToplamlar.TotalGenelKomisyon = 0;
                    model.raporGrupToplamlar.TotalGenelVerilenToplam = 0;



                    model.raporGrupToplamlar.SirketAdi = groupBySirket[i].SirketAdi;
                    foreach (var item in groupBySirket[i].list)
                    {
                        if (item.BrutPrim > 0)
                        {
                            model.raporGrupToplamlar.SirketBrutToplam += item.BrutPrim;
                            model.raporGrupToplamlar.SirketNetToplam += item.NetPrim;
                            model.raporGrupToplamlar.SirketKomisyon += item.Komisyon;
                            model.raporGrupToplamlar.SirketVerilenToplam += item.TaliKomisyon;
                        }
                        else
                        {
                            model.raporGrupToplamlar.IptalSirketBrutToplam += item.BrutPrim;
                            model.raporGrupToplamlar.IptalSirketNetToplam += item.NetPrim;
                            model.raporGrupToplamlar.IptalSirketKomisyon += item.Komisyon;
                            model.raporGrupToplamlar.IptalSirketVerilenToplam += item.TaliKomisyon;
                        }
                    }
                    GenelBrutToplam += model.raporGrupToplamlar.SirketBrutToplam;
                    GenelNetToplam += model.raporGrupToplamlar.SirketNetToplam;
                    GenelKomisyon += model.raporGrupToplamlar.SirketKomisyon;
                    GenelVerilenToplam += model.raporGrupToplamlar.SirketVerilenToplam;
                    IptalGenelBrutToplam += model.raporGrupToplamlar.IptalSirketBrutToplam;
                    IptalGenelNetToplam += model.raporGrupToplamlar.IptalSirketNetToplam;
                    IptalGenelKomisyon += model.raporGrupToplamlar.IptalSirketKomisyon;
                    IptalGenelVerilenToplam += model.raporGrupToplamlar.IptalSirketVerilenToplam;

                    TotalGenelBrutToplam = GenelBrutToplam + IptalGenelBrutToplam;
                    TotalGenelNetToplam = GenelNetToplam + IptalGenelNetToplam;
                    TotalGenelKomisyon = GenelKomisyon + IptalGenelKomisyon;
                    TotalGenelVerilenToplam = GenelVerilenToplam + IptalGenelVerilenToplam;

                    model.raporGrupToplamlarList.Add(model.raporGrupToplamlar);
                }

                model.raporGrupToplamlar.GenelBrutToplam = GenelBrutToplam;
                model.raporGrupToplamlar.GenelNetToplam = GenelNetToplam;
                model.raporGrupToplamlar.GenelKomisyon = GenelKomisyon;
                model.raporGrupToplamlar.GenelVerilenToplam = GenelVerilenToplam;

                model.raporGrupToplamlar.IptalGenelBrutToplam = IptalGenelBrutToplam;
                model.raporGrupToplamlar.IptalGenelNetToplam = IptalGenelNetToplam;
                model.raporGrupToplamlar.IptalGenelKomisyon = IptalGenelKomisyon;
                model.raporGrupToplamlar.IptalGenelVerilenToplam = IptalGenelVerilenToplam;

                model.raporGrupToplamlar.TotalGenelNetToplam = TotalGenelNetToplam;
                model.raporGrupToplamlar.TotalGenelBrutToplam = TotalGenelBrutToplam;
                model.raporGrupToplamlar.TotalGenelKomisyon = TotalGenelKomisyon;
                model.raporGrupToplamlar.TotalGenelVerilenToplam = TotalGenelVerilenToplam;

                #endregion

                ViewBag.AnaTVM = false;
                #endregion
            }

            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.AnaTVM = false;
            }
            return View(model);
        }


        [HttpPost]
        public ActionResult GetPoliceDetail(int? policeId)
        {
            if (policeId.HasValue && policeId > 0)
            {
                Neosinerji.BABOnlineTP.Business.Police police = _PoliceService.GetPoliceById(policeId.Value);

                if (police == null)
                    return null;

                // List<TeklifTUMDetayPartialModel> teklifs = _TeklifService.GetAllListTeklif(policeId.Value);
                string tcK = police.GenelBilgiler.PoliceSigortali.KimlikNo;
                if (!String.IsNullOrEmpty(tcK))
                {
                    police.GenelBilgiler.PoliceSigortali.KimlikNo = tcK;
                }

                string vkn = police.GenelBilgiler.PoliceSigortali.VergiKimlikNo;
                if (!String.IsNullOrEmpty(vkn))
                {
                    police.GenelBilgiler.PoliceSigortali.VergiKimlikNo = vkn;
                }

                string tcKSEttiren = police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo;
                if (!String.IsNullOrEmpty(tcKSEttiren))
                {
                    police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo = tcKSEttiren;
                }

                string vknSEttiren = police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                if (!String.IsNullOrEmpty(vknSEttiren))
                {
                    police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo = vknSEttiren;
                }


                string sasi = police.GenelBilgiler.PoliceArac.SasiNo;
                if (!String.IsNullOrEmpty(sasi))
                {
                    police.GenelBilgiler.PoliceArac.SasiNo = sasi.Substring(0, 2) + "******";
                }


                return PartialView("PoliceUretimRaporuDetay", police);
            }
            return null;
        }

        //[Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceAra, SekmeKodu = 0)]
        public ActionResult PoliceUretimRaporuListePager()
        {
            if (Request["sEcho"] != null)
            {
                #region anatvmkodu belirleme

                int anaTVMKodu = _AktifKullaniciService.TVMKodu;
                ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
                _TvmService = DependencyResolver.Current.GetService<ITVMService>();
                bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
                int KontrolTVMKod = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;


                // talisi olan anaacente ya da talisi olmayan anaacanete
                if (tvmTaliVar || KontrolTVMKod == -9999)
                {
                    #region talisi olan anaacente ya da talisi olmayan anaacanete
                    anaTVMKodu = _AktifKullaniciService.TVMKodu;
                    PoliceUretimRaporListe arama = new PoliceUretimRaporListe(Request, new Expression<Func<PoliceUretimRaporProcedureModel, object>>[]
                                                                    {
                                                                        t =>t.SirketAdi,
                                                                        t =>t.TaliKodu,
                                                                        t =>t.TaliUnvani,
                                                                        t =>t.BransAdi,
                                                                        t =>t.PoliceNumarasi,
                                                                        t => t.BaslangicTarihi,
                                                                        t => t.BitisTarihi,
                                                                        t => t.BrutPrim,
                                                                        t => t.EkNo,
                                                                        t => t.Unvani,
                                                                        t => t.TanzimTarihi,
                                                                        t => t.Komisyon,
                                                                        t => t.TUMUrunAdi,
                                                                        t => t.NetPrim,
                                                                        t => t.TaliKomisyon,
                                                                        t => t.TaliTVMKodu,
                                                                        t => t.TaliTVMUnvani,
                                                                        t => t.TUMUrunKodu,
                                                                        t => t.YenilemeNo

                                                                    });
                    #region multiselects / branslar - tvmler - sirketler

                    string branslar = arama.TryParseParamString("BranslarSelectList");
                    if (!String.IsNullOrEmpty(branslar))
                    {
                        if (branslar.Contains(','))
                        {
                            var bransindx = branslar.Split(',');
                            List<string> liste = new List<string>();

                            for (int i = 0; i < bransindx.Count(); i++)
                            {
                                if (bransindx[i] != "multiselect-all")
                                {
                                    liste.Add(bransindx[i]);
                                }
                            }
                            arama.BransList = String.Empty;
                            for (int i = 0; i < liste.Count; i++)
                            {
                                if (i != liste.Count - 1)
                                    arama.BransList = arama.BransList + liste[i] + ",";
                                else arama.BransList = arama.BransList + liste[i];
                            }
                        }
                        else
                        {
                            arama.BransList = branslar;
                        }
                    }


                    string tvmler = arama.TryParseParamString("tvmList");
                    if (!String.IsNullOrEmpty(tvmler))
                    {
                        if (tvmler.Contains(','))
                        {
                            var tvmsindx = tvmler.Split(',');
                            List<string> liste = new List<string>();

                            for (int i = 0; i < tvmsindx.Count(); i++)
                            {
                                if (tvmsindx[i] != "multiselect-all")
                                {
                                    liste.Add(tvmsindx[i]);
                                }
                            }
                            arama.TVMList = String.Empty;
                            for (int i = 0; i < liste.Count; i++)
                            {
                                if (i != liste.Count - 1)
                                    arama.TVMList = arama.TVMList + liste[i] + ",";
                                else arama.TVMList = arama.TVMList + liste[i];
                            }
                        }
                        else
                        {
                            arama.TVMList = tvmler;
                        }
                    }
                    else
                    {
                        arama.TVMList = _AktifKullaniciService.TVMKodu.ToString();
                    }

                    string sirketler = arama.TryParseParamString("SigortaSirketleriSelectList");
                    if (!String.IsNullOrEmpty(sirketler))
                    {
                        if (sirketler.Contains(','))
                        {
                            var sirketindx = sirketler.Split(',');
                            List<string> liste = new List<string>();

                            for (int i = 0; i < sirketindx.Count(); i++)
                            {
                                if (sirketindx[i] != "multiselect-all")
                                {
                                    liste.Add(sirketindx[i]);
                                }
                            }
                            arama.SigortaSirketleri = String.Empty;
                            for (int i = 0; i < liste.Count; i++)
                            {
                                if (i != liste.Count - 1)
                                    arama.SigortaSirketleri = arama.SigortaSirketleri + liste[i] + ",";
                                else arama.SigortaSirketleri = arama.SigortaSirketleri + liste[i];
                            }
                        }
                        else
                        {
                            arama.SigortaSirketleri = sirketler;
                        }
                    }
                    #endregion

                    arama.BasTarihi = arama.TryParseParamDate("BaslangicTarihi").Value;
                    arama.BitTarihi = arama.TryParseParamDate("BitisTarihi").Value;

                    //arama.AddFormatter(f => f.PoliceNo, f => String.Format("<a href='{0}{1}'>{2}</a> {3}", TeklifSayfaAdresleri.PoliceAdres(f.UrunKodu),
                    //                                       f.TeklifId, f.TUMPoliceNo, f.PdfURL == null ? "" :
                    //                                       "<a href=" + f.PdfURL + " title='Poliçe PDF' target='_blank' class='pull-right'>" +
                    //                                       "<img src='/content/img/pdf_icon.png' /></a>"));

                    arama.AddFormatter(f => f.BaslangicTarihi, f => String.Format("{0}", f.BaslangicTarihi.HasValue ? f.BaslangicTarihi.Value.ToString("dd.MM.yyyy") : ""));
                    arama.AddFormatter(f => f.BitisTarihi, f => String.Format("{0}", f.BitisTarihi.HasValue ? f.BitisTarihi.Value.ToString("dd.MM.yyyy") : ""));
                    arama.AddFormatter(f => f.TanzimTarihi, f => String.Format("{0}", f.TanzimTarihi.HasValue ? f.TanzimTarihi.Value.ToString("dd.MM.yyyy") : ""));
                    arama.AddFormatter(s => s.BrutPrim, s => String.Format("{0}", BinlikAyracEkle(s.BrutPrim ?? 0)));
                    arama.AddFormatter(s => s.NetPrim, s => String.Format("{0}", BinlikAyracEkle(s.NetPrim ?? 0)));
                    arama.AddFormatter(s => s.Komisyon, s => String.Format("{0}", BinlikAyracEkle(s.Komisyon ?? 0)));
                    arama.AddFormatter(s => s.TaliKomisyon, s => String.Format("{0}", BinlikAyracEkle(s.TaliKomisyon ?? 0)));

                    int totalRowCount = 0;
                    List<PoliceUretimRaporProcedureModel> list = _RaporService.PoliceUretimRaporPagedList(arama, anaTVMKodu, out totalRowCount);

                    arama.Siralama = arama.TryParseParamByte("RaporTipi").Value;

                    //Sadece tek kolon için groupBy
                    //var Grouplists = list.GroupBy(s => s.SirketAdi).Select(grp => new { SirketAdi = grp.Key, list = grp.ToList() }).ToList();

                    //iki kolon için groupBy
                    var GroupList = list
                                        .GroupBy(ac => new
                                        {
                                            ac.SirketAdi,
                                            ac.BransAdi
                                        })
                                        .Select(ac => new
                                        {
                                            SirketAdi = ac.Key.SirketAdi,
                                            BransAdi = ac.Key.BransAdi,
                                            list = ac.ToList()
                                        }).ToList();


                    if (arama.Siralama == 0)
                    {
                        for (int i = 1; i < GroupList.Count; i++)
                        {
                            GroupList[0].list.AddRange(GroupList[i].list);
                        }
                    }

                    if (arama.Siralama == 1 && GroupList.Count > 0)
                    {
                        GroupList = list
                                         .GroupBy(ac => new
                                         {
                                             ac.BransAdi,
                                             ac.SirketAdi
                                         })
                                         .Select(ac => new
                                         {
                                             SirketAdi = ac.Key.BransAdi,
                                             BransAdi = ac.Key.SirketAdi,
                                             list = ac.ToList()
                                         }).ToList();
                        for (int i = 1; i < GroupList.Count; i++)
                        {
                            GroupList[0].list.AddRange(GroupList[i].list);
                        }

                        string temp = string.Empty;
                        foreach (var item in GroupList[0].list)
                        {
                            temp = item.SirketAdi;
                            item.SirketAdi = item.BransAdi;
                            item.BransAdi = temp;
                        }
                    }

                    if (GroupList.Count > 0)
                    {
                        DataTableList result = arama.Prepare(GroupList[0].list, totalRowCount);
                        return Json(result, JsonRequestBehavior.AllowGet);
                    }
                    else
                    {
                        DataTableList result = arama.Prepare(list, totalRowCount);
                        return Json(result, JsonRequestBehavior.AllowGet);
                    }

                    #endregion
                }
                else
                {
                    #region tali tvm
                    anaTVMKodu = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
                    if (anaTVMKodu == -9999)
                    {
                        anaTVMKodu = _AktifKullaniciService.TVMKodu;
                    }
                    PoliceUretimRaporListeTali arama = new PoliceUretimRaporListeTali(Request, new Expression<Func<PoliceUretimRaporProcedureModelTali, object>>[]
                                                                    {
                                                                        t =>t.SirketAdi,
                                                                        t =>t.BransAdi,
                                                                        t =>t.PoliceNumarasi,
                                                                        t => t.BaslangicTarihi,
                                                                        t => t.BitisTarihi,
                                                                        t => t.BrutPrim,
                                                                        t => t.EkNo,
                                                                        t => t.Unvani,
                                                                        t => t.TanzimTarihi,
                                                                        t => t.TUMUrunAdi,
                                                                        t => t.NetPrim,
                                                                        t => t.TaliKomisyon,
                                                                        t => t.TaliTVMKodu,
                                                                        t => t.TaliTVMUnvani,
                                                                        t => t.TUMUrunKodu,
                                                                        t => t.YenilemeNo
                                                                    });

                    #region multiselects / branslar - tvmler - sirketler

                    string branslar = arama.TryParseParamString("BranslarSelectList");
                    if (!String.IsNullOrEmpty(branslar))
                    {
                        if (branslar.Contains(','))
                        {
                            var bransindx = branslar.Split(',');
                            List<string> liste = new List<string>();

                            for (int i = 0; i < bransindx.Count(); i++)
                            {
                                if (bransindx[i] != "multiselect-all")
                                {
                                    liste.Add(bransindx[i]);
                                }
                            }
                            arama.BransList = String.Empty;
                            for (int i = 0; i < liste.Count; i++)
                            {
                                if (i != liste.Count - 1)
                                    arama.BransList = arama.BransList + liste[i] + ",";
                                else arama.BransList = arama.BransList + liste[i];
                            }
                        }
                        else
                        {
                            arama.BransList = branslar;
                        }
                    }


                    string tvmler = arama.TryParseParamString("tvmList");
                    if (!String.IsNullOrEmpty(tvmler))
                    {
                        if (tvmler.Contains(','))
                        {
                            var tvmsindx = tvmler.Split(',');
                            List<string> liste = new List<string>();

                            for (int i = 0; i < tvmsindx.Count(); i++)
                            {
                                if (tvmsindx[i] != "multiselect-all")
                                {
                                    liste.Add(tvmsindx[i]);
                                }
                            }
                            arama.TVMList = String.Empty;
                            for (int i = 0; i < liste.Count; i++)
                            {
                                if (i != liste.Count - 1)
                                    arama.TVMList = arama.TVMList + liste[i] + ",";
                                else arama.TVMList = arama.TVMList + liste[i];
                            }
                        }
                        else
                        {
                            arama.TVMList = tvmler;
                        }
                    }
                    else
                    {
                        arama.TVMList = _AktifKullaniciService.TVMKodu.ToString();
                    }


                    string sirketler = arama.TryParseParamString("SigortaSirketleriSelectList");
                    if (!String.IsNullOrEmpty(sirketler))
                    {
                        if (sirketler.Contains(','))
                        {
                            var sirketindx = sirketler.Split(',');
                            List<string> liste = new List<string>();

                            for (int i = 0; i < sirketindx.Count(); i++)
                            {
                                if (sirketindx[i] != "multiselect-all")
                                {
                                    liste.Add(sirketindx[i]);
                                }
                            }
                            arama.SigortaSirketleri = String.Empty;
                            for (int i = 0; i < liste.Count; i++)
                            {
                                if (i != liste.Count - 1)
                                    arama.SigortaSirketleri = arama.SigortaSirketleri + liste[i] + ",";
                                else arama.SigortaSirketleri = arama.SigortaSirketleri + liste[i];
                            }
                        }
                        else
                        {
                            arama.SigortaSirketleri = sirketler;
                        }
                    }
                    #endregion

                    arama.Ay = arama.TryParseParamInt("Ay").Value;
                    arama.Yil = arama.TryParseParamInt("Yil").Value;

                    //arama.AddFormatter(f => f.PoliceNo, f => String.Format("<a href='{0}{1}'>{2}</a> {3}", TeklifSayfaAdresleri.PoliceAdres(f.UrunKodu),
                    //                                       f.TeklifId, f.TUMPoliceNo, f.PdfURL == null ? "" :
                    //                                       "<a href=" + f.PdfURL + " title='Poliçe PDF' target='_blank' class='pull-right'>" +
                    //                                       "<img src='/content/img/pdf_icon.png' /></a>"));

                    arama.AddFormatter(f => f.BaslangicTarihi, f => String.Format("{0}", f.BaslangicTarihi.HasValue ? f.BaslangicTarihi.Value.ToString("dd.MM.yyyy") : ""));
                    arama.AddFormatter(f => f.BitisTarihi, f => String.Format("{0}", f.BitisTarihi.HasValue ? f.BitisTarihi.Value.ToString("dd.MM.yyyy") : ""));
                    arama.AddFormatter(f => f.TanzimTarihi, f => String.Format("{0}", f.TanzimTarihi.HasValue ? f.TanzimTarihi.Value.ToString("dd.MM.yyyy") : ""));
                    arama.AddFormatter(s => s.BrutPrim, s => String.Format("{0}", BinlikAyracEkle(s.BrutPrim ?? 0), "style='text-align:right'"));
                    arama.AddFormatter(s => s.NetPrim, s => String.Format("{0}", BinlikAyracEkle(s.NetPrim ?? 0), "style='text-align:right'"));
                    arama.AddFormatter(s => s.TaliKomisyon, s => String.Format("{0}", BinlikAyracEkle(s.TaliKomisyon ?? 0), "style='text-align:right'"));

                    int totalRowCount = 0;
                    List<PoliceUretimRaporProcedureModelTali> list = _RaporService.PoliceUretimRaporTaliPagedList(arama, anaTVMKodu, out totalRowCount);
                    arama.Siralama = arama.TryParseParamByte("RaporTipi").Value;
                    var GroupList = list
                                        .GroupBy(ac => new
                                        {
                                            ac.SirketAdi,
                                            ac.BransAdi
                                        })
                                        .Select(ac => new
                                        {
                                            SirketAdi = ac.Key.SirketAdi,
                                            BransAdi = ac.Key.BransAdi,
                                            list = ac.ToList()
                                        }).ToList();
                    if (arama.Siralama == 0)
                    {
                        for (int i = 1; i < GroupList.Count; i++)
                        {
                            GroupList[0].list.AddRange(GroupList[i].list);
                        }
                    }
                    if (arama.Siralama == 1 && GroupList.Count > 0)
                    {
                        GroupList = list
                                         .GroupBy(ac => new
                                         {
                                             ac.BransAdi,
                                             ac.SirketAdi
                                         })
                                         .Select(ac => new
                                         {
                                             SirketAdi = ac.Key.BransAdi,
                                             BransAdi = ac.Key.SirketAdi,
                                             list = ac.ToList()
                                         }).ToList();
                        for (int i = 1; i < GroupList.Count; i++)
                        {
                            GroupList[0].list.AddRange(GroupList[i].list);
                        }

                        string temp = string.Empty;
                        foreach (var item in GroupList[0].list)
                        {
                            temp = item.SirketAdi;
                            item.SirketAdi = item.BransAdi;
                            item.BransAdi = temp;
                        }
                    }

                    if (GroupList.Count > 0)
                    {
                        DataTableList result = arama.Prepare(GroupList[0].list, totalRowCount);
                        return Json(result, JsonRequestBehavior.AllowGet);
                    }
                    else
                    {
                        DataTableList result = arama.Prepare(list, totalRowCount);
                        return Json(result, JsonRequestBehavior.AllowGet);
                    }

                    #region eski gruplama sadece sirket adı için
                    //arama.Siralama = arama.TryParseParamByte("RaporTipi").Value;
                    //var Grouplists = list.GroupBy(s => s.SirketAdi).Select(grp => new { SirketAdi = grp.Key, list = grp.ToList() }).ToList();
                    //if (arama.Siralama == 0)
                    //{
                    //    for (int i = 1; i < Grouplists.Count; i++)
                    //    {
                    //        Grouplists[0].list.AddRange(Grouplists[i].list);
                    //    }
                    //}

                    //if (arama.Siralama == 1)
                    //{
                    //    Grouplists = list.GroupBy(s => s.BransAdi).Select(grp => new { SirketAdi = grp.Key, list = grp.ToList() }).ToList();
                    //    for (int i = 1; i < Grouplists.Count; i++)
                    //    {
                    //        Grouplists[0].list.AddRange(Grouplists[i].list);
                    //    }

                    //    string temp = string.Empty;
                    //    foreach (var item in Grouplists[0].list)
                    //    {
                    //        temp = item.SirketAdi;
                    //        item.SirketAdi = item.BransAdi;
                    //        item.BransAdi = temp;
                    //    }
                    //}
                    //if (Grouplists.Count > 0)
                    //{
                    //    DataTableList result = arama.Prepare(Grouplists[0].list, totalRowCount);
                    //    return Json(result, JsonRequestBehavior.AllowGet);
                    //}
                    //else
                    //{
                    //    DataTableList result = arama.Prepare(list, totalRowCount);
                    //    return Json(result, JsonRequestBehavior.AllowGet);
                    //}
                    #endregion
                    #endregion
                }
                #endregion
            }
            return View();
        }

        #endregion

        public bool AnaAcenteMi()
        {
            return _AktifKullaniciService.BagliOlduguTvmKodu == -9999;
        }

        #region Poliçe Üretim İcmali

        [Authorization(AnaMenuKodu = AnaMenuler.Rapor, AltMenuKodu = AltMenuler.OfflineRaporlar, SekmeKodu = AltMenuSekmeler.PoliceUretimIcmali)]
        public ActionResult PoliceUretimIcmal()
        {
            PoliceUretimIcmalModel model = new PoliceUretimIcmalModel();
            //model.BaslangicTarih = DateTime.Today;
            //model.BitisTarih = DateTime.Today;
            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TVMUnvani = _AktifKullaniciService.TVMUnvani;

            List<Bran> brans = _BransService.GetList(_AktifKullaniciService.TvmTipi.ToString());
            model.Branslar = new MultiSelectList(brans, "BransKodu", "BransAdi");

            List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");
            //model.SigortaSirketleri = new MultiSelectList(_TUMService.GetListTUMDetay(), "BirlikKodu", "Unvani");
            //model.tvmler = new MultiSelectList(_TaliPoliceService.GetYetkiliTVM(model.TVMKodu).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.tvmler = new MultiSelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.uretimTvmler = new MultiSelectList(_TVMService.GetDisUretimTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");

            List<SelectListItem> raporTip = new List<SelectListItem>();

            raporTip.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "0", Text = babonline.InsuranceCompany +" +"+ babonline.Branch },
                new SelectListItem() { Value = "1", Text = babonline.Branch +"+ "+ babonline.InsuranceCompany }
            });

            model.RaporTipleri = new SelectList(raporTip, "Value", "Text", model.RaporTipi);
            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            var getTVMDetay = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu);
            if (getTVMDetay != null)
            {
                int KontrolTVMKod = getTVMDetay.BagliOlduguTVMKodu;
                if (tvmTaliVar || KontrolTVMKod == -9999)
                {
                    ViewBag.AnaTVM = true;
                }
                else
                {
                    ViewBag.AnaTVM = false;
                }

                if (getTVMDetay.BolgeYetkilisiMi == 1)
                {
                    model.BolgeYetkilisiMi = true;
                }
            }

            List<SelectListItem> listYillar = new List<SelectListItem>();
            for (int yil = TurkeyDateTime.Today.Year; yil >= 1990; yil--)
            {
                listYillar.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = yil.ToString(), Text = yil.ToString() },
            });
            }

            model.Yillar = new SelectList(listYillar, "Value", "Text", "0").ToList();

            List<SelectListItem> listAylar = new List<SelectListItem>();

            listAylar.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "01", Text = "01" },
                new SelectListItem() { Value = "02", Text = "02" },
                new SelectListItem() { Value = "03", Text = "03" },
                new SelectListItem() { Value = "04", Text = "04" },
                new SelectListItem() { Value = "05", Text = "05" },
                new SelectListItem() { Value = "06", Text = "06" },
                new SelectListItem() { Value = "07", Text = "07" },
                new SelectListItem() { Value = "08", Text = "08" },
                new SelectListItem() { Value = "09", Text = "09" },
                new SelectListItem() { Value = "10", Text = "10" },
                new SelectListItem() { Value = "11", Text = "11" },
                new SelectListItem() { Value = "12", Text = "12" },
            });

            model.Aylar = new SelectList(listAylar, "Value", "Text").ToList();

            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.AnaTVM = false;
            }
            return View(model);
        }

        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Rapor, AltMenuKodu = AltMenuler.OfflineRaporlar, SekmeKodu = AltMenuSekmeler.PoliceUretimIcmali)]
        public ActionResult PoliceUretimIcmal(PoliceUretimIcmalModel model)
        {
            #region multiselects / sirketler

            if (model.BranslarSelectList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.BranslarSelectList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.BransList = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.BransList = model.BransList + liste[i] + ",";
                    else model.BransList = model.BransList + liste[i];
                }
            }

            if (model.SigortaSirketleriSelectList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.SigortaSirketleriSelectList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.SigortaSirket = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.SigortaSirket = model.SigortaSirket + liste[i] + ",";
                    else model.SigortaSirket = model.SigortaSirket + liste[i];
                }
            }

            if (model.tvmList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.tvmList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.TVMListe = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.TVMListe = model.TVMListe + liste[i] + ",";
                    else model.TVMListe = model.TVMListe + liste[i];
                }
            }
            else
            {
                model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
                //  model.TVMListe = String.Empty;
            }
            if (model.uretimTvmList != null)
            {
                List<string> liste = new List<string>();
                foreach (var item in model.uretimTvmList)
                {
                    if (item != "multiselect-all")
                    {
                        liste.Add(item);
                    }
                }
                model.UretimTVMListe = String.Empty;
                for (int i = 0; i < liste.Count; i++)
                {
                    if (i != liste.Count - 1)
                        model.UretimTVMListe = model.UretimTVMListe + liste[i] + ",";
                    else model.UretimTVMListe = model.UretimTVMListe + liste[i];
                }
            }
            else
            {
                // model.TVMListe = _AktifKullaniciService.TVMKodu.ToString();
                model.UretimTVMListe = String.Empty;
            }
            #endregion

            model.TVMKodu = _AktifKullaniciService.TVMKodu;
            model.TVMUnvani = _AktifKullaniciService.TVMUnvani;

            List<Bran> brans = _BransService.GetList(_AktifKullaniciService.TvmTipi.ToString());
            model.Branslar = new MultiSelectList(brans, "BransKodu", "BransAdi");

            List<Database.Models.SigortaSirketleri> SSirketler = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new MultiSelectList(SSirketler, "SirketKodu", "SirketAdi");
            //model.SigortaSirketleri = new MultiSelectList(_TUMService.GetListTUMDetay(), "BirlikKodu", "Unvani");
            //model.tvmler = new MultiSelectList(_TaliPoliceService.GetYetkiliTVM(model.TVMKodu).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.tvmler = new MultiSelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            model.uretimTvmler = new MultiSelectList(_TVMService.GetDisUretimTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani");
            List<SelectListItem> raporTip = new List<SelectListItem>();

            raporTip.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "0", Text = babonline.InsuranceCompany +" +"+ babonline.Branch },
                new SelectListItem() { Value = "1", Text = babonline.Branch +"+ "+ babonline.InsuranceCompany }
            });
            List<SelectListItem> listYillar = new List<SelectListItem>();
            for (int yil = TurkeyDateTime.Today.Year; yil >= 1990; yil--)
            {
                listYillar.AddRange(new SelectListItem[] {
                    new SelectListItem() { Value = yil.ToString(), Text = yil.ToString() },
                });

            }
            model.Yillar = new SelectList(listYillar, "Value", "Text", "0").ToList();

            List<SelectListItem> listAylar = new List<SelectListItem>();
            listAylar.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "01", Text = "01" },
                new SelectListItem() { Value = "02", Text = "02" },
                new SelectListItem() { Value = "03", Text = "03" },
                new SelectListItem() { Value = "04", Text = "04" },
                new SelectListItem() { Value = "05", Text = "05" },
                new SelectListItem() { Value = "06", Text = "06" },
                new SelectListItem() { Value = "07", Text = "07" },
                new SelectListItem() { Value = "08", Text = "08" },
                new SelectListItem() { Value = "09", Text = "09" },
                new SelectListItem() { Value = "10", Text = "10" },
                new SelectListItem() { Value = "11", Text = "11" },
                new SelectListItem() { Value = "12", Text = "12" },
            });
            model.Aylar = new SelectList(listAylar, "Value", "Text").ToList();
            model.RaporTipleri = new SelectList(raporTip, "Value", "Text", model.RaporTipi);
            ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            _TvmService = DependencyResolver.Current.GetService<ITVMService>();
            bool tvmTaliVar = _TvmService.TvmTaliVarMi(_AktifKullaniciService.TVMKodu);
            int KontrolTVMKod = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
            TVMDetay tvmDetay = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu);

            if (tvmDetay.BolgeYetkilisiMi == 1)
            {
                model.BolgeYetkilisiMi = true;
            }
            byte Merkez = 0;
            if (tvmDetay != null && tvmDetay.BagliOlduguTVMKodu == -9999)
            {
                Merkez = 1;

            }

            int anaTVMKodu = _AktifKullaniciService.TVMKodu;

            if (tvmTaliVar || KontrolTVMKod == -9999)
            {
                #region   talisi olan anaacente ya da talisi olmayan anaacanete
                anaTVMKodu = _AktifKullaniciService.TVMKodu;

                model.procedureList = new List<PoliceUretimIcmalRaporProcedureModel>();
                model.procedureList = _RaporService.PoliceIcmalRaporGetir(model.TVMKodu, Merkez, model.Ay, model.Yil, model.SigortaSirket,
                                                                            model.BransList, model.TVMListe, model.UretimTVMListe, model.RaporTipi);

                ViewBag.AnaTVM = true;

                #endregion
            }
            else
            {
                #region tali tvm
                anaTVMKodu = _TvmService.GetDetay(_AktifKullaniciService.TVMKodu).BagliOlduguTVMKodu;
                if (anaTVMKodu == -9999)
                {
                    anaTVMKodu = _AktifKullaniciService.TVMKodu;
                }
                model.procedureList = new List<PoliceUretimIcmalRaporProcedureModel>();
                model.procedureList = _RaporService.PoliceIcmalRaporGetir(anaTVMKodu, Merkez, model.Ay, model.Yil, model.SigortaSirket,
                                                                            model.BransList, model.TVMListe, model.UretimTVMListe, model.RaporTipi);


                ViewBag.AnaTVM = false;
                #endregion
            }

            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.AnaTVM = false;
            }
            return View(model);
        }

        #endregion

        [Authorization(AnaMenuKodu = AnaMenuler.Rapor, AltMenuKodu = AltMenuler.OfflineRaporlar, SekmeKodu = AltMenuSekmeler.GerceklesenUretimRapor)]
        public ActionResult PoliceHedefRapor()
        {
            PoliceHedefModel model = new PoliceHedefModel();
            model.AcenteTVMKodu = _AktifKullaniciService.TVMKodu;
            model.AcenteTVMUnvani = _AktifKullaniciService.TVMUnvani;

            List<SelectListItem> listYillar = new List<SelectListItem>();
            for (int yil = TurkeyDateTime.Today.Year; yil >= 1990; yil--)
            {
                listYillar.AddRange(new SelectListItem[] {
                                    new SelectListItem() { Value = yil.ToString(), Text = yil.ToString() },
                                                         });

            }

            model.Yillar = new SelectList(listYillar, "Value", "Text", "0").ToList();
            return View(model);
        }

        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Rapor, AltMenuKodu = AltMenuler.OfflineRaporlar, SekmeKodu = AltMenuSekmeler.GerceklesenUretimRapor)]
        public ActionResult PoliceHedefRapor(PoliceHedefModel model)
        {
            try
            {
                ITVMService _TvmService = DependencyResolver.Current.GetService<ITVMService>();
                _TvmService = DependencyResolver.Current.GetService<ITVMService>();

                int BagliOlduguTVMKodu = _TvmService.GetDetay(model.AcenteTVMKodu).BagliOlduguTVMKodu;
                if (BagliOlduguTVMKodu != -9999)
                {
                    model.Rapor = _RaporService.PoliceHedefGerceklesenRapor(BagliOlduguTVMKodu, model.AcenteTVMKodu, model.Yil);
                }
                else
                {
                    model.Rapor = _RaporService.PoliceHedefGerceklesenRapor(model.AcenteTVMKodu, 0, model.Yil);
                }

                model.RaporEkranList = new List<PoliceHedefRaporEkranModel>();

                foreach (var item in model.Rapor)
                {

                    model.RaporEkran = new PoliceHedefRaporEkranModel();
                    model.RaporEkran.Acente = item.Acente;
                    model.RaporEkran.TaliAcente = item.TaliAcente.ToString();
                    model.RaporEkran.Brans = item.Brans;

                    #region aylar
                    model.RaporEkran.GerceklesenPoliceAdediOcak = Convert.ToInt32(item.GerceklesenPoliceAdedi1);
                    model.RaporEkran.GerceklesenPrimOcak = item.GerceklesenPrim1;
                    model.RaporEkran.HedefPoliceAdediOcak = Convert.ToInt32(item.HedefPoliceAdedi1);
                    model.RaporEkran.HedefPrimOcak = item.HedefPrim1;
                    model.RaporEkran.AdetYuzdeOcak = item.AdetYuzde1;
                    model.RaporEkran.PrimYuzdeOcak = item.PrimYuzde1;

                    model.RaporEkran.GerceklesenPoliceAdediSubat = Convert.ToInt32(item.GerceklesenPoliceAdedi2);
                    model.RaporEkran.GerceklesenPrimSubat = item.GerceklesenPrim2;
                    model.RaporEkran.HedefPoliceAdediSubat = Convert.ToInt32(item.HedefPoliceAdedi2);
                    //model.RaporEkran.HedefPrimSubat =  item.HedefPrim2 ;
                    model.RaporEkran.HedefPrimSubat = item.HedefPrim2;
                    model.RaporEkran.AdetYuzdeSubat = item.AdetYuzde2;
                    model.RaporEkran.PrimYuzdeSubat = item.PrimYuzde2;

                    model.RaporEkran.GerceklesenPoliceAdediMart = Convert.ToInt32(item.GerceklesenPoliceAdedi3);
                    model.RaporEkran.GerceklesenPrimMart = item.GerceklesenPrim3;
                    model.RaporEkran.HedefPoliceAdediMart = Convert.ToInt32(item.HedefPoliceAdedi3);
                    model.RaporEkran.HedefPrimMart = item.HedefPrim3;
                    model.RaporEkran.AdetYuzdeMart = item.AdetYuzde3;
                    model.RaporEkran.PrimYuzdeMart = item.PrimYuzde3;

                    model.RaporEkran.GerceklesenPoliceAdediNisan = Convert.ToInt32(item.GerceklesenPoliceAdedi4);
                    model.RaporEkran.GerceklesenPrimNisan = item.GerceklesenPrim4;
                    model.RaporEkran.HedefPoliceAdediNisan = Convert.ToInt32(item.HedefPoliceAdedi4);
                    model.RaporEkran.HedefPrimNisan = item.HedefPrim4;
                    model.RaporEkran.AdetYuzdeNisan = item.AdetYuzde4;
                    model.RaporEkran.PrimYuzdeNisan = item.PrimYuzde4;

                    model.RaporEkran.GerceklesenPoliceAdediMayis = Convert.ToInt32(item.GerceklesenPoliceAdedi5);
                    model.RaporEkran.GerceklesenPrimMayis = item.GerceklesenPrim5;
                    model.RaporEkran.HedefPoliceAdediMayis = Convert.ToInt32(item.HedefPoliceAdedi5);
                    model.RaporEkran.HedefPrimMayis = item.HedefPrim5;
                    model.RaporEkran.AdetYuzdeMayis = item.AdetYuzde5;
                    model.RaporEkran.PrimYuzdeMayis = item.PrimYuzde5;

                    model.RaporEkran.GerceklesenPoliceAdediHaziran = Convert.ToInt32(item.GerceklesenPoliceAdedi6);
                    model.RaporEkran.GerceklesenPrimHaziran = item.GerceklesenPrim6;
                    model.RaporEkran.HedefPoliceAdediHaziran = Convert.ToInt32(item.HedefPoliceAdedi6);
                    model.RaporEkran.HedefPrimHaziran = item.HedefPrim6;
                    model.RaporEkran.AdetYuzdeHaziran = item.AdetYuzde6;
                    model.RaporEkran.PrimYuzdeHaziran = item.PrimYuzde6;

                    model.RaporEkran.GerceklesenPoliceAdediTemmuz = Convert.ToInt32(item.GerceklesenPoliceAdedi7);
                    model.RaporEkran.GerceklesenPrimTemmuz = item.GerceklesenPrim7;
                    model.RaporEkran.HedefPoliceAdediTemmuz = Convert.ToInt32(item.HedefPoliceAdedi7);
                    model.RaporEkran.HedefPrimTemmuz = item.HedefPrim7;
                    model.RaporEkran.AdetYuzdeTemmuz = item.AdetYuzde7;
                    model.RaporEkran.PrimYuzdeTemmuz = item.PrimYuzde7;

                    model.RaporEkran.GerceklesenPoliceAdediAgustos = Convert.ToInt32(item.GerceklesenPoliceAdedi8);
                    model.RaporEkran.GerceklesenPrimAgustos = item.GerceklesenPrim8;
                    model.RaporEkran.HedefPoliceAdediAgustos = Convert.ToInt32(item.HedefPoliceAdedi8);
                    model.RaporEkran.HedefPrimAgustos = item.HedefPrim8;
                    model.RaporEkran.AdetYuzdeAgustos = item.AdetYuzde8;
                    model.RaporEkran.PrimYuzdeAgustos = item.PrimYuzde8;

                    model.RaporEkran.GerceklesenPoliceAdediEylul = Convert.ToInt32(item.GerceklesenPoliceAdedi9);
                    model.RaporEkran.GerceklesenPrimEylul = item.GerceklesenPrim9;
                    model.RaporEkran.HedefPoliceAdediEylul = Convert.ToInt32(item.HedefPoliceAdedi9);
                    model.RaporEkran.HedefPrimEylul = item.HedefPrim9;
                    model.RaporEkran.AdetYuzdeEylul = item.AdetYuzde9;
                    model.RaporEkran.PrimYuzdeEylul = item.PrimYuzde9;

                    model.RaporEkran.GerceklesenPoliceAdediEkim = Convert.ToInt32(item.GerceklesenPoliceAdedi10);
                    model.RaporEkran.GerceklesenPrimEkim = item.GerceklesenPrim10;
                    model.RaporEkran.HedefPoliceAdediEkim = Convert.ToInt32(item.HedefPoliceAdedi10);
                    model.RaporEkran.HedefPrimEkim = item.HedefPrim10;
                    model.RaporEkran.AdetYuzdeEkim = item.AdetYuzde10;
                    model.RaporEkran.PrimYuzdeEkim = item.PrimYuzde10;

                    model.RaporEkran.GerceklesenPoliceAdediKasim = Convert.ToInt32(item.GerceklesenPoliceAdedi11);
                    model.RaporEkran.GerceklesenPrimKasim = item.GerceklesenPrim11;
                    model.RaporEkran.HedefPoliceAdediKasim = Convert.ToInt32(item.HedefPoliceAdedi11);
                    model.RaporEkran.HedefPrimKasim = item.HedefPrim11;
                    model.RaporEkran.AdetYuzdeKasim = item.AdetYuzde11;
                    model.RaporEkran.PrimYuzdeKasim = item.PrimYuzde11;

                    model.RaporEkran.GerceklesenPoliceAdediAralik = Convert.ToInt32(item.GerceklesenPoliceAdedi12);
                    model.RaporEkran.GerceklesenPrimAralik = item.GerceklesenPrim12;
                    model.RaporEkran.HedefPoliceAdediAralik = Convert.ToInt32(item.HedefPoliceAdedi12);
                    model.RaporEkran.HedefPrimAralik = item.HedefPrim12;
                    model.RaporEkran.AdetYuzdeAralik = item.AdetYuzde12;
                    model.RaporEkran.PrimYuzdeAralik = item.PrimYuzde12;
                    #endregion

                    model.RaporEkranList.Add(model.RaporEkran);
                }


                List<SelectListItem> listYillar = new List<SelectListItem>();
                for (int yil = TurkeyDateTime.Today.Year; yil >= 1990; yil--)
                {
                    listYillar.AddRange(new SelectListItem[] {
                                        new SelectListItem() { Value = yil.ToString(), Text = yil.ToString() },
                                                             });
                }
                model.Yillar = new SelectList(listYillar, "Value", "Text", "0").ToList();

                model.AcenteTVMKodu = model.AcenteTVMKodu;
                model.AcenteTVMUnvani = _TvmService.GetDetay(model.AcenteTVMKodu).Unvani;
            }
            catch (Exception ex)
            {
                throw ex;
            }

            return View(model);
        }

        [AjaxException]
        public ActionResult GetPoliceHaritaDetay(string policeler)
        {
            try
            {
                string[] policeList = policeler.Split('|');

                if (policeList.Length > 0)
                {
                    PoliceHaritaModel model = _RaporService.GetPoliceHarita(policeList);

                    if (model != null)
                        return Json(new { Success = "True", Authority = "True", Model = model }, JsonRequestBehavior.AllowGet);
                    else
                        return Json(new { Success = "True", Authority = "False" }, JsonRequestBehavior.AllowGet);
                }

                return Json(new { Success = "True", Authority = "True", Message = "Poliçe numarası gerekli" }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                _Log.Error(ex);
                return Json(new { Success = "False" }, JsonRequestBehavior.AllowGet);
            }
        }

        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceAra_Kimlik_Plaka, SekmeKodu = 0)]
        public ActionResult Sorgu()
        {
            var model = new PoliceSorguModel()
            {
                SorguTipleri = new SelectList(new List<SelectListItem>()
                    {
                        new SelectListItem() { Value = "1", Text =ResourceHelper.GetString("Identity") },
                        new SelectListItem() { Value = "2", Text = ResourceHelper.GetString("Plate") },
                    }, "Value", "Text", "1")
                    ,
                TeklifMi = true,
                PoliceMi = true
            };
            return View(model);
        }

        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.PoliceAra_Kimlik_Plaka, SekmeKodu = 0)]
        public ActionResult SorguList()
        {
            if (Request["sEcho"] != null)
            {
                PoliceSorguListe arama = new PoliceSorguListe(Request, new Expression<Func<PoliceSorguProcedurModel, object>>[]
                                                                    {
                                                                        t => t.TeklifNo,
                                                                        t => t.UrunAdi,
                                                                        t => t.MusteriTemsilcisi,
                                                                        t => t.Acente,
                                                                        t => t.PoliceNo,
                                                                        //t => t.YenilemeNo,
                                                                        //t => t.ZeyilNo,
                                                                        t => t.Sigortali,
                                                                        t => t.SigortaEttiren,
                                                                        t => t.OzelAlan,
                                                                        //t => t.BrutPrim,
                                                                        t => t.PoliceBaslangicTarihi,
                                                                        t => t.PoliceBitisTarihi,
                                                                        t => t.TanzimTarihi,
                                                                        t => t.OdemeTipi,
                                                                        t => t.OdemeSekli,
                                                                        t => t.Taksit,
                                                                     });
                arama.SorguTipi = arama.TryParseParamInt("SorguTipi");
                arama.KimlikNo = arama.TryParseParamString("KimlikNo");
                arama.PlakaKodu = arama.TryParseParamString("PlakaKodu");
                arama.PlakaNo = arama.TryParseParamString("PlakaNo");
                arama.TeklifMi = arama.TryParseParamString("TeklifMi") == "true";
                arama.PoliceMi = arama.TryParseParamString("PoliceMi") == "true";

                arama.AddFormatter(f => f.PoliceBaslangicTarihi, f => String.Format("{0}", f.PoliceBaslangicTarihi.HasValue ? f.PoliceBaslangicTarihi.Value.ToString("dd.MM.yyyy") : ""));
                arama.AddFormatter(f => f.PoliceBitisTarihi, f => String.Format("{0}", f.PoliceBitisTarihi.HasValue ? f.PoliceBitisTarihi.Value.ToString("dd.MM.yyyy") : ""));
                arama.AddFormatter(f => f.TanzimTarihi, f => String.Format("{0}", f.TanzimTarihi.HasValue ? f.TanzimTarihi.Value.ToString("dd.MM.yyyy") : ""));
                arama.AddFormatter(f => f.OdemeTipi, f => String.Format("{0}", f.OdemeTipi.HasValue ? OdemeTipleri.OdemeTipi(f.OdemeTipi) : ""));
                arama.AddFormatter(f => f.OdemeSekli, f => String.Format("{0}", f.OdemeSekli.HasValue ? OdemeSekilleri.OdemeSekli(f.OdemeSekli) : ""));
                arama.AddFormatter(f => f.OzelAlan, f => String.Format("{0}", GetOzelAlan(f.UrunKodu, f.OzelAlan)));
                arama.AddFormatter(f => f.TeklifNo, f => String.Format("<a href='{0}{1}'>{2}</a> {3}", TeklifSayfaAdresleri.DetayAdres(f.UrunKodu),
                                                      f.TeklifId, f.TeklifNo, f.PDFDosyasi == null ? "" :
                                                      "<a href=" + f.PDFDosyasi + " title='Teklif PDF' target='_blank' class='pull-right'>" +
                                                      "<img src='/content/img/pdf_icon.png' /></a>"));
                arama.AddFormatter(f => f.PoliceNo, f => String.Format("<a href='{0}{1}'>{2}</a> {3}", TeklifSayfaAdresleri.PoliceAdres(f.UrunKodu),
                                                        f.TeklifId, f.PoliceNo, f.PDFPolice == null ? "" :
                                                        "<a href=" + f.PDFPolice + " title='Poliçe PDF' target='_blank' class='pull-right'>" +
                                                        "<img src='/content/img/pdf_icon.png' /></a>"));
                var list = _TeklifService.PoliceSorgu(arama);
                var result = arama.Prepare(list, list.Count());
                return Json(result, JsonRequestBehavior.AllowGet);
            }
            return null;
        }

        private static string GetOzelAlan(int urunKodu, string ozelAlan)
        {
            string result = ozelAlan;
            try
            {
                if (ozelAlan != null)
                {
                    switch (urunKodu)
                    {
                        case UrunKodlari.TrafikSigortasi:
                        case UrunKodlari.KaskoSigortasi:
                        case UrunKodlari.MapfreKasko:
                        case UrunKodlari.MapfreTrafik:
                        case UrunKodlari.IkinciElGaranti: result = babonline.LicenceNumber + " : " + ozelAlan; break;
                        case UrunKodlari.DogalAfetSigortasi_Deprem: result = babonline.City + " : " + ozelAlan; break;
                        case UrunKodlari.KrediHayat: result = babonline.CreditType + " : " + ozelAlan; break;
                        case UrunKodlari.YurtDisiSeyehatSaglik: result = babonline.Country + " : " + ozelAlan; break;
                        case UrunKodlari.KonutSigortasi_Paket:
                        case UrunKodlari.IsYeri: result = babonline.City + " : " + ozelAlan; break;
                    }
                }
            }
            catch (Exception)
            {

            }
            return result;
        }

        private static string BinlikAyracEkle(decimal tutar)
        {
            if (tutar < 0)
            {
                string eskiTutarNegatif = tutar.ToString();
                int lengthNegatif = eskiTutarNegatif.Length;
                string resultNegatif = "";
                int sayacNegatif = 0;

                if (lengthNegatif > 7)
                {
                    for (int i = 0; i < lengthNegatif; i++)
                    {
                        sayacNegatif++;
                        resultNegatif += eskiTutarNegatif[i];
                        if (sayacNegatif == (lengthNegatif - 6) || sayacNegatif == (lengthNegatif - 9) || sayacNegatif == (lengthNegatif - 11))
                            resultNegatif += ",";
                    }

                    return resultNegatif;
                }
                else return eskiTutarNegatif;
            }
            string eskiTutar = tutar.ToString();
            if (eskiTutar.Contains(','))
            {
                eskiTutar = eskiTutar.Replace(',', '.');
            }
            int length = eskiTutar.Length;
            string result = "";
            int sayac = 0;

            if (length > 6)
            {
                for (int i = 0; i < length; i++)
                {
                    sayac++;
                    result += eskiTutar[i];
                    if (sayac == (length - 6) || sayac == (length - 9) || sayac == (length - 12))
                        result += ",";
                }

                return result;
            }
            else return eskiTutar;
        }

        public class SigortaSirketleri
        {
            public int BirlikKodu { get; set; }
            public string Unvani { get; set; }
        }

        public ActionResult KimlikGuncelle(int PoliceId)
        {
            KimlikGuncelleModel model = new KimlikGuncelleModel();
            model.policeId = PoliceId;

            return PartialView("_KimlikGuncelle", model);
        }

        [HttpPost]
        public ActionResult KimlikGuncelle(KimlikGuncelleModel model)
        {
            var policeGuncellendiMi = false;
            model.kimlikNo = model.kimlikNo.Trim();
            if (!String.IsNullOrEmpty(model.kimlikNo))
            {
                policeGuncellendiMi = _PoliceService.PoliceKimlikGuncelle(model.policeId, model.kimlikNo);
            }

            return Json(new { Success = policeGuncellendiMi.ToString(), PolId = model.policeId });

        }

        public ActionResult OdemeTipiGuncelle(int PoliceId)
        {
            OdemeTipiGuncelleModel model = new OdemeTipiGuncelleModel();
            model.policeId = PoliceId;

            return PartialView("_OdemeTipiGuncelle", model);
        }

        [HttpPost]
        public ActionResult OdemeTipiGuncelle(int policeId, string OdemeTipi)
        {
            var policeGuncellendiMi = false;
            if (OdemeTipi != null)
            {
                policeGuncellendiMi = _PoliceService.OdemeTipiGuncelle(policeId, OdemeTipi.ToString());
            }

            return Json(new { Success = policeGuncellendiMi.ToString(), PolId = policeId });

        }

        /// <summary>
        /// manuel teklif poliçe girişi
        /// </summary>
        #region manuel teklif poliçe girişi

        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.ManuelTeklifPoliceGirisi, SekmeKodu = 0)]
        public ActionResult ManuelTeklifPoliceGirisi()
        {
            ManuelTeklifPoliceGirisi model = new ManuelTeklifPoliceGirisi();
            //teklif police radiobutton
            model.durumlar = new SelectList(DurumListesiAktifPasif.TeklifPolice(), "Value", "Text", "0");

            ITVMService _TVMService = DependencyResolver.Current.GetService<ITVMService>();
            var sigortaSirketleri = _SigortaSirketleriService.GetList();
            var underwriterListesi = _SigortaSirketleriService.GetList(true);
            List<Bran> brans = _BransService.GetListBroker();
            model.Tvmler = new SelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani").ListWithOptionLabel();
            model.SigortaSirketleri = new SelectList(sigortaSirketleri, "SirketKodu", "SirketAdi").ListWithOptionLabel();
            List<SelectListItem> tempbrokerItem = new List<SelectListItem>();
            foreach (var item in model.SigortaSirketleri)
            {
                if (int.TryParse(item.Value.ToString(), out int a) && int.TryParse(item.Value.ToString(), out int b))
                {
                    if (a >= 500 && b <= 530)
                    {
                        tempbrokerItem.Add(item);
                    }
                }
            }

            foreach (var item in tempbrokerItem)
            {
                model.SigortaSirketleri.Remove(item);
                model.SigortaSirketleri.Insert(1, item);
            }

            model.UnderwriterListesi = new SelectList(underwriterListesi, "SirketKodu", "SirketAdi").ListWithOptionLabel();
            model.Branslar = new SelectList(brans, "BransKodu", "BransAdi").ListWithOptionLabel();
            List<TVMDetay> taliTvmler = _TVMService.GetListTVMDetayPoliceTransferTali();
            model.DisKaynaklar = new SelectList(taliTvmler, "Kodu", "Unvani", "").ListWithOptionLabel();
            model.OdemeSekli = true;
            model.SigortaliSigortaEttirenAynimi = true;
            List<SelectListItem> taksitSayilari = new List<SelectListItem>();
            for (int i = 1; i <= 12; i++)
            {
                taksitSayilari.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = i.ToString(), Text = i.ToString() } });
            }
            model.PoliceTipi = 1;
            List<SelectListItem> policeTipleri = new List<SelectListItem>();
            policeTipleri.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "1", Text = babonline.Accrual }, // tahakkuk
                new SelectListItem() { Value = "0", Text = babonline.Cancelled_Policy } }); // iptal
            model.PoliceTipleri = new SelectList(policeTipleri, "Value", "Text", model.PoliceTipi).ListWithOptionLabel();
            model.TaksitSayisi = 1;
            model.UnderwriterSayisi = 0;
            model.TaksitSayilari = new SelectList(taksitSayilari, "Value", "Text", model.TaksitSayisi).ListWithOptionLabel();
            model.UnderwriterSayilari = new SelectList(taksitSayilari, "Value", "Text", "").ListWithOptionLabel();
            model.TaksitSatirlar = new List<TaksitModel>();
            model.ParaBirimi = "TL ";
            var paraBirimleri = _TVMService.GetParaBirimleri().Select(x => new SelectListItem { Text = x.Birimi, Value = x.Birimi }).ToList();
            model.ParaBirimleri = new SelectList(paraBirimleri, "Value", "Text", model.ParaBirimi);
            //model.ParaBirimleri = new SelectList(TeklifProvider.ParaBirimTipleri(), "Value", "Text", model.ParaBirimi);
            model.OdemeTipi = 2;
            model.OdemeTipleri = new SelectList(TeklifProvider.OdemeTipleriReasuror(), "Value", "Text", model.OdemeTipi).ToList();

            #region default value
            model.TeminatTutari = "0";
            model.TeminatTutariTL = "0";
            model.YurtdisiDisKaynakKomisyon = "0";
            model.YurtdisiDisKaynakKomisyonTL = "0";
            model.YurtdisiAlinanKomisyon = "0";
            model.YurtdisiAlinanKomisyonTL = "0";
            model.YurtdisiNetPrim = "0";
            model.YurtdisiNetPrimTL = "0";
            model.YurtdisiBrokerNetPrim = "0";
            model.YurtdisiBrokerNetPrimTL = "0";
            model.FrontingSigortaSirketiKomisyon = "0";
            model.FrontingSigortaSirketiKomisyonTL = "0";
            model.SatisKanaliKomisyon = "0";
            model.SatisKanaliKomisyonTL = "0";
            model.YurticiAlinanKomisyon = "0";
            model.YurticiAlinanKomisyonTL = "0";
            model.YurticiNetPrim = "0";
            model.YurticiNetPrimTL = "0";
            model.YurticiBrutPrim = "0";
            model.YurticiBrutPrimTL = "0";
            #endregion

            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.Gorevi = false;
            }
            else
            {
                ViewBag.Gorevi = true;
            }

            return View(model);
        }


        public string parayiDuzelt(string para)
        {
            string paraNew = "";
            if (!String.IsNullOrEmpty(para))
            {

                int count = para.Count(w => w == ',');
                if (count > 0)
                {
                    for (int i = 0; i < para.Count(); i++)
                    {
                        if (para[i] == ',')
                        {
                            paraNew += '.';
                        }
                        else
                        {
                            paraNew += para[i];
                        }
                    }
                    para = paraNew;
                }
                int countPoint = para.Count(w => w == '.');
                paraNew = "";
                if (countPoint > 0)
                {
                    int toplam = 0;
                    for (int i = 0; i < para.Count(); i++)
                    {
                        if (para[i] == '.')
                        {
                            if (toplam + 1 == countPoint)
                            {
                                paraNew += para[i];
                            }
                            toplam++;
                        }
                        else
                        {
                            paraNew += para[i];
                        }
                    }
                    para = paraNew;
                }
            }
            return para;
        }


        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.ManuelTeklifPoliceGirisi, SekmeKodu = 0)]
        public ActionResult ManuelTeklifPoliceGirisi(ManuelTeklifPoliceGirisi model)
        {

            if (_AktifKullaniciService.Gorevi == 4)
            {
                ViewBag.Gorevi = false;
            }
            else
            {
                ViewBag.Gorevi = true;
            }

            int musteriKoduSigortaEttiren = 0;
            int musteriKoduSigortali = 0;

            Guid g;

            if (ModelState["Sigortali.KimlikNo"] != null)
                ModelState["Sigortali.KimlikNo"].Errors.Clear();

            if (ModelState["SigortaliSigortaEttirenAynimi"] != null)
                ModelState["SigortaliSigortaEttirenAynimi"].Errors.Clear();

            if (ModelState["OdemeSekli"] != null)
                ModelState["OdemeSekli"].Errors.Clear();

            if (ModelState["durum"].Value.AttemptedValue == "1")
                ModelState["PoliceNo"].Errors.Clear();

            if (ModelState["UnderwriterSayisi"].Value.AttemptedValue == "")
                ModelState["UnderwriterSayisi"].Errors.Clear();
            bool underwriterdongukontrol = false;
            if (model.SigortaSirketiKodu == "500")
            {
                if (model.UnderwriterSatirlar.Count == 0)
                    model.IslemMesaji = babonline._warningMustBeAtLeastOneUnderwriter + "!"; // Yurtdışı UW Reasürör-BAE seçiminde en az 1 tane UnderWriter olmalıdır
                else if (model.UnderwriterSatirlar.Count > 0)
                {
                    foreach (var item in model.UnderwriterSatirlar)
                    {
                        if (item.UnderwriterAdi.ToLower().Contains("lütfen"))
                        {
                            model.IslemMesaji = babonline._warningSelectUnderwritesNames + "!"; // UnderWriter Ad/larını seçiniz
                            underwriterdongukontrol = true;
                            break;
                        }
                        if (item.UnderwriterKomisyon == null || item.UnderwriterKomisyonOrani == null || item.UnderwriterPayOrani == null || item.UnderwriterPrim == null)
                        {
                            model.IslemMesaji = babonline._warningFillUnderwriterRateValues + "!"; // UnderWriter oran ve değerlerini doldurunuz
                            underwriterdongukontrol = true;
                            break;
                        }
                    }
                }
            }
            ModelState.Remove("SigortaEttiren.Telefon");
            ModelState.Remove("SigortaEttiren.Adres");
            model.SigortaEttiren.Telefon = Utils.isNullorEmpty(model.SigortaEttiren.Telefon);
            model.SigortaEttiren.Adres = Utils.isNullorEmpty(model.SigortaEttiren.Adres);

            if (!underwriterdongukontrol)
                if (ModelState.IsValid)
                {
                    int tvmkodu = Convert.ToInt32(model.TVMKodu);

                    //2 = poliçe    
                    if (model.durum == 2)
                    {
                        try
                        {
                            #region müşteri kayit et/güncelle
                            if (model.SigortaliSigortaEttirenAynimi)
                            {
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    musteriKoduSigortali = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    musteri.EMail = Utils.isNullorEmpty(model.EMail);
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.MusteriKodu = musteri.MusteriKodu;
                                        mTel.Numara = !string.IsNullOrEmpty(model.SigortaEttiren.Telefon) ? model.SigortaEttiren.Telefon : "";
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        _MusteriService.CreateTelefon(mTel);
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.MusteriKodu = musteri.MusteriKodu;
                                        mAdres.Adres = !string.IsNullOrEmpty(model.SigortaEttiren.Adres) ? model.SigortaEttiren.Adres : "-";
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        _MusteriService.CreateMusteriAdres(mAdres);
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriGenel.EMail = Utils.isNullorEmpty(model.EMail);
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = !string.IsNullOrEmpty(model.SigortaEttiren.Telefon) ? model.SigortaEttiren.Telefon : "";
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = !string.IsNullOrEmpty(model.SigortaEttiren.Adres) ? model.SigortaEttiren.Adres : "-";
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }
                            }
                            else
                            {
                                #region sigorta ettiren ve sigortali kayit

                                #region sigorta ettiren

                                // sigorta ettiren, müşteri var mı 
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigorta ettiren müşteri var ise
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    musteri.EMail = Utils.isNullorEmpty(model.EMail);
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = !string.IsNullOrEmpty(model.SigortaEttiren.Telefon) ? model.SigortaEttiren.Telefon : "";
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = !string.IsNullOrEmpty(model.SigortaEttiren.Adres) ? model.SigortaEttiren.Adres : "-";
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriGenel.EMail = Utils.isNullorEmpty(model.EMail);
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = !string.IsNullOrEmpty(model.SigortaEttiren.Telefon) ? model.SigortaEttiren.Telefon : "";
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = !string.IsNullOrEmpty(model.SigortaEttiren.Adres) ? model.SigortaEttiren.Adres : "-";
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                }

                                #endregion

                                #region sigortali 

                                // sigortalı, müşteri var mı 
                                var musteriSigortali = _MusteriService.GetMusteri(model.Sigortali.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigortalı müşteri var ise
                                if (musteriSigortali != null)
                                {
                                    //update musteri
                                    musteriKoduSigortali = musteriSigortali.MusteriKodu;
                                    musteriSigortali.AdiUnvan = model.Sigortali.Adi;
                                    musteriSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                    musteriSigortali.EMail = Utils.isNullorEmpty(model.EMail);
                                    if (musteriSigortali.MusteriTelefons.Where(z => z.Numara == model.Sigortali.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = !string.IsNullOrEmpty(model.Sigortali.Telefon) ? model.Sigortali.Telefon : "";
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;
                                        musteriSigortali.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteriSigortali.MusteriAdres.Where(z => z.Adres == model.Sigortali.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = !string.IsNullOrEmpty(model.Sigortali.Adres) ? model.Sigortali.Adres : "-";
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteriSigortali.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteriSigortali);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.Sigortali.Adi;
                                    MusteriGenel.SoyadiUnvan = model.Sigortali.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriGenel.EMail = Utils.isNullorEmpty(model.EMail);
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = !string.IsNullOrEmpty(model.Sigortali.Telefon) ? model.Sigortali.Telefon : "";
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = !string.IsNullOrEmpty(model.Sigortali.Adres) ? model.Sigortali.Adres : "-";
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }

                                #endregion

                                #endregion
                            }
                            #endregion

                            #region Poliçe Genel Bilgiler
                            Business.Police police = new Business.Police();
                            police.GenelBilgiler.TVMKodu = _AktifKullaniciService.TVMKodu;
                            police.GenelBilgiler.TUMBirlikKodu = model.SigortaSirketiKodu;
                            police.GenelBilgiler.BaslangicTarihi = model.BaslangicTarihi;
                            police.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                            police.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                            police.GenelBilgiler.PoliceNumarasi = model.PoliceNo;
                            police.GenelBilgiler.EkNo = model.EkNo;
                            police.GenelBilgiler.YenilemeNo = model.YenilemeNo;
                            police.GenelBilgiler.Durum = PoliceDurumlari.ManuelGiris;
                            police.GenelBilgiler.ParaBirimi = model.ParaBirimi;
                            police.GenelBilgiler.TaliAcenteKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : police.GenelBilgiler.TaliAcenteKodu;
                            police.GenelBilgiler.UretimTaliAcenteKodu = Convert.ToInt32(model.DisKaynakKodu);
                            if (!String.IsNullOrEmpty(model.DovizKuru))
                            {
                                police.GenelBilgiler.DovizKur = Convert.ToDecimal(model.DovizKuru);
                            }

                            if (!String.IsNullOrEmpty(model.BransKodu))
                            {
                                police.GenelBilgiler.BransKodu = Convert.ToInt32(model.BransKodu);

                                var bransDetay = _BransService.GetBrans(police.GenelBilgiler.BransKodu.Value);
                                if (bransDetay != null)
                                {
                                    police.GenelBilgiler.BransAdi = bransDetay.BransAdi;
                                }
                            }
                            else
                            {
                                police.GenelBilgiler.BransKodu = 18; // Tanımsız Branş Kodu
                                police.GenelBilgiler.BransAdi = "TANIMSIZ";
                            }
                            decimal carpan = 1;
                            if (model.PoliceTipi == 0) //İptal 
                            {
                                carpan = -1;
                            }

                            if (model.ParaBirimi.Trim() != "TL")
                            {
                                police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan;
                                police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrimTL) * carpan;
                                police.GenelBilgiler.TaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyonTL) * carpan;
                                police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.YurticiAlinanKomisyonTL) * carpan;
                                police.GenelBilgiler.DovizliKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                police.GenelBilgiler.DovizliNetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                police.GenelBilgiler.DovizliBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                            }
                            else
                            {
                                police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                police.GenelBilgiler.TaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                            }
                            police.GenelBilgiler.TaliAcenteKodu = Convert.ToInt32(model.TVMKodu);
                            police.GenelBilgiler.TaliKomisyonGuncellemeTarihi = TurkeyDateTime.Now;
                            police.GenelBilgiler.TaliKomisyonGuncelleyenKullanici = _AktifKullaniciService.KullaniciKodu;


                            if (model.TaksitSayisi == 1)
                            {
                                police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                            }
                            else
                            {
                                police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                            }

                            #endregion


                            #region Sigortalı / Sigorta Ettiren Bilgileri
                            police.GenelBilgiler.PoliceSigortaEttiren.DainiMurtehinSubeAdi = model.DainiMurteinSubeAdi;
                            if (model.SigortaliSigortaEttirenAynimi)
                            {
                                police.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                                police.GenelBilgiler.PoliceSigortali.AdiUnvan = model.SigortaEttiren.Adi;
                                police.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                police.GenelBilgiler.PoliceSigortali.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                                if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                                {
                                    if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                                    {
                                        police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                        police.GenelBilgiler.PoliceSigortali.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                    else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                                    {
                                        police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                        police.GenelBilgiler.PoliceSigortali.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                }

                                police.GenelBilgiler.PoliceSigortaEttiren.MobilTelefonNo = Utils.isNullorEmpty(model.SigortaEttiren.Telefon);
                                police.GenelBilgiler.PoliceSigortali.MobilTelefonNo = Utils.isNullorEmpty(model.SigortaEttiren.Telefon);
                                police.GenelBilgiler.PoliceSigortaEttiren.Adres = Utils.isNullorEmpty(model.SigortaEttiren.Adres);
                                police.GenelBilgiler.PoliceSigortali.Adres = Utils.isNullorEmpty(model.SigortaEttiren.Adres);
                            }
                            else
                            {
                                ///Sigortalı Bilgileri
                                police.GenelBilgiler.PoliceSigortali.AdiUnvan = model.Sigortali.Adi;
                                police.GenelBilgiler.PoliceSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                if (!String.IsNullOrEmpty(model.Sigortali.KimlikNo))
                                {
                                    if (model.Sigortali.KimlikNo.Trim().Length == 11)
                                    {
                                        police.GenelBilgiler.PoliceSigortali.KimlikNo = model.Sigortali.KimlikNo.Trim();
                                    }
                                    else if (model.Sigortali.KimlikNo.Trim().Length == 10)
                                    {
                                        police.GenelBilgiler.PoliceSigortali.VergiKimlikNo = model.Sigortali.KimlikNo.Trim();
                                    }
                                }

                                police.GenelBilgiler.PoliceSigortali.MobilTelefonNo = Utils.isNullorEmpty(model.Sigortali.Telefon);
                                police.GenelBilgiler.PoliceSigortali.Adres = Utils.isNullorEmpty(model.Sigortali.Adres);

                                ///Sigorta Ettiren Bilgileri
                                police.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                                police.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                                if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                                {
                                    if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                                    {
                                        police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                    else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                                    {
                                        police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                }
                                police.GenelBilgiler.PoliceSigortaEttiren.MobilTelefonNo = Utils.isNullorEmpty(model.SigortaEttiren.Telefon);
                                police.GenelBilgiler.PoliceSigortaEttiren.Adres = Utils.isNullorEmpty(model.SigortaEttiren.Adres);
                            }

                            #endregion

                            #region Ödeme Bilgileri

                            if (model.TaksitSayisi == 1)
                            {
                                PoliceOdemePlani odeme = new PoliceOdemePlani();
                                odeme.TaksitNo = model.TaksitSayisi;
                                odeme.TaksitTutari = Convert.ToDecimal(police.GenelBilgiler.BrutPrim) * carpan;
                                odeme.DovizliTaksitTutari = Convert.ToDecimal(police.GenelBilgiler.DovizliBrutPrim) * carpan;
                                odeme.VadeTarihi = model.BaslangicTarihi;
                                odeme.OdemeTipi = model.OdemeTipi;
                                police.GenelBilgiler.PoliceOdemePlanis.Add(odeme);

                                if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                                {
                                    PoliceTahsilat tahsilat = new PoliceTahsilat();
                                    tahsilat.OdemTipi = OdemeTipleri.KrediKarti;
                                    tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                    tahsilat.TaksitNo = odeme.TaksitNo;
                                    tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                    tahsilat.OdemeBelgeNo = "111111****1111";
                                    tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.KalanTaksitTutari = 0;
                                    tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                    tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                    tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                    tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                    tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                    tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                    tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                    tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                                    tahsilat.OtomatikTahsilatiKkMi = 1;
                                    if (tahsilat.TaksitTutari != 0)
                                    {
                                        police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                    }
                                }
                                else
                                {
                                    PoliceTahsilat tahsilat = new PoliceTahsilat();
                                    tahsilat.OdemTipi = model.OdemeTipi;
                                    tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                    tahsilat.TaksitNo = odeme.TaksitNo;
                                    tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.OdenenTutar = 0;
                                    tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                                    tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                    tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                    tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                    tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                    tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                    tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                    tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                    if (tahsilat.TaksitTutari != 0)
                                    {
                                        police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                    }
                                }
                            }
                            else if (model.TaksitSatirlar != null)
                            {
                                PoliceOdemePlani odeme = new PoliceOdemePlani();
                                foreach (var item in model.TaksitSatirlar)
                                {
                                    odeme = new PoliceOdemePlani();
                                    odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                    if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                    {
                                        odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL) * carpan;
                                    }
                                    else
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                                    }

                                    odeme.OdemeTipi = model.OdemeTipi;
                                    odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                    police.GenelBilgiler.PoliceOdemePlanis.Add(odeme);
                                    if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                                    {
                                        PoliceTahsilat tahsilat = new PoliceTahsilat();
                                        tahsilat.OdemTipi = model.OdemeTipi;
                                        tahsilat.OdemeBelgeNo = "111111****1111";
                                        tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                        tahsilat.TaksitNo = odeme.TaksitNo;
                                        tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                        tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.KalanTaksitTutari = 0;
                                        tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                        tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                        tahsilat.KimlikNo = police.GenelBilgiler.PoliceSigortali.KimlikNo;
                                        tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.Value;
                                        tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                        tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                        tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                        tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                                        tahsilat.OtomatikTahsilatiKkMi = 1;
                                        if (tahsilat.TaksitTutari != 0)
                                        {
                                            police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                        }
                                    }
                                    else
                                    {
                                        PoliceTahsilat tahsilat = new PoliceTahsilat();
                                        tahsilat.OdemTipi = model.OdemeTipi;
                                        tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                        tahsilat.TaksitNo = odeme.TaksitNo;
                                        tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.OdenenTutar = 0;
                                        tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                                        tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                        tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                        tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                        tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                        tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                        tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                        tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                        if (tahsilat.TaksitTutari != 0)
                                        {
                                            police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                        }
                                    }

                                }
                            }

                            #endregion

                            #region Poliçe Kaydetme

                            var policeKaydetResult = _PoliceService.AddPolice(police);

                            if (policeKaydetResult == 1)
                            {
                                model.IslemMesaji = babonline.PolicySavedSuccessfully;// "Police başarılı bir şekilde kaydedildi.";
                            }
                            else if (policeKaydetResult == 2)
                            {
                                model.IslemMesaji = babonline.PolicySavedAlready; // "Bu poliçe daha önceden kaydedilmiştir.";
                            }
                            else
                            {
                                model.IslemMesaji = babonline.PolicySavedError; // "Poliçe Kaydetme aşamadında bir hata oluştu.";
                            }
                            #endregion

                            if (policeKaydetResult == 1)
                            {
                                #region teklif kayıt    

                                nsbusiness.ITeklif teklif = nsbusiness.Teklif.Create(UrunKodlari.Reasuror, tvmkodu, _AktifKullaniciService.KullaniciKodu, musteriKoduSigortaEttiren, _AktifKullaniciService.TVMKodu, _AktifKullaniciService.KullaniciKodu);
                                teklif.GenelBilgiler.TeklifRevizyonNo = 0;
                                teklif.GenelBilgiler.TUMPoliceNo = model.PoliceNo;
                                teklif.GenelBilgiler.TUMKodu = Convert.ToInt32(model.SigortaSirketiKodu);
                                teklif.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                                teklif.GenelBilgiler.Basarili = true;
                                teklif.GenelBilgiler.BaslamaTarihi = model.BaslangicTarihi;
                                teklif.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                                teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                                teklif.GenelBilgiler.TeklifDurumKodu = 2;
                                if (model.TaksitSayisi == 1)
                                {
                                    teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                                }
                                else
                                {
                                    teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                                }

                                if (model.ParaBirimi.Trim() != "TL")
                                {
                                    if (model.DovizKuru != null && model.DovizKuru != "")
                                    {
                                        teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal(model.DovizKuru);
                                    }
                                    else
                                    {
                                        teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal("1");
                                    }
                                }

                                teklif.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim);
                                teklif.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim);
                                teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                                teklif.GenelBilgiler.Otorizasyon = 0;

                                #region teklif sigortali/ sigorta ettiren

                                teklif.SigortaEttiren.MusteriKodu = musteriKoduSigortaEttiren;
                                teklif.SigortaEttiren.SiraNo = 1;
                                TeklifSigortali teklifSigortali = new TeklifSigortali();
                                teklifSigortali.MusteriKodu = musteriKoduSigortali;
                                teklifSigortali.SiraNo = 1;
                                teklif.Sigortalilar.Add(teklifSigortali);

                                #endregion

                                #region Ödeme Bilgileri

                                if (model.TaksitSayisi == 1)
                                {
                                    TeklifOdemePlani odeme = new TeklifOdemePlani();
                                    odeme.TaksitNo = model.TaksitSayisi;
                                    if (model.ParaBirimi.Trim() != "TL")
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrimTL);
                                        odeme.DovizliTaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                    }
                                    else
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                    }
                                    odeme.VadeTarihi = model.BaslangicTarihi;
                                    odeme.OdemeTipi = model.OdemeTipi;
                                    teklif.OdemePlani.Add(odeme);

                                }
                                else if (model.TaksitSatirlar != null)
                                {
                                    TeklifOdemePlani odeme = new TeklifOdemePlani();
                                    foreach (var item in model.TaksitSatirlar)
                                    {
                                        odeme = new TeklifOdemePlani();
                                        odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                        if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                        {
                                            odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                            odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL);
                                        }
                                        else
                                        {
                                            odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                        }

                                        odeme.OdemeTipi = model.OdemeTipi;
                                        odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                        teklif.OdemePlani.Add(odeme);

                                    }
                                }

                                #endregion
                                var teklifID = _TeklifService.Create(teklif);

                                #endregion

                                #region pdf kayit et 
                                string urlCredit = null;
                                string urlDebit = null;
                                string urlPolice = null;

                                if (model.fileCreditNote != null)
                                {
                                    //credit döküman
                                    g = Guid.NewGuid();
                                    //string fileCreditName = System.IO.Path.GetFileName(model.fileCreditNote.FileName);
                                    string fileCreditName = g + "__" + System.IO.Path.GetFileName(model.fileCreditNote.FileName);
                                    urlCredit = _Storage.UploadFile("manuelteklifpolice", fileCreditName, model.fileCreditNote.InputStream);

                                }
                                if (model.fileDebitNote != null)
                                {
                                    //debit döküman
                                    g = Guid.NewGuid();
                                    //string fileDebitName = System.IO.Path.GetFileName(model.fileDebitNote.FileName);
                                    string fileDebitName = g + "__" + System.IO.Path.GetFileName(model.fileDebitNote.FileName);
                                    urlDebit = _Storage.UploadFile("manuelteklifpolice", fileDebitName, model.fileDebitNote.InputStream);
                                }
                                if (model.filePolice != null)
                                {
                                    //poliçe döküman
                                    g = Guid.NewGuid();
                                    //string filePoliceName = System.IO.Path.GetFileName(model.filePolice.FileName);
                                    string filePoliceName = g + "__" + System.IO.Path.GetFileName(model.filePolice.FileName);
                                    urlPolice = _Storage.UploadFile("manuelteklifpolice", filePoliceName, model.filePolice.InputStream);
                                }



                                #endregion

                                #region ReasurorGenel 
                                var policeGenel = _PoliceService.getManuelPolice(model.SigortaSirketiKodu, model.PoliceNo, model.EkNo, model.YenilemeNo, Convert.ToInt32(model.BransKodu));
                                ReasurorGenel reasurorGenel = new ReasurorGenel();
                                reasurorGenel.DisKaynakKodu = !String.IsNullOrEmpty(model.DisKaynakKodu) ? Convert.ToInt32(model.DisKaynakKodu) : reasurorGenel.DisKaynakKodu;
                                reasurorGenel.DovizTuru = model.ParaBirimi;
                                reasurorGenel.PdfPoliceDosyasi = urlPolice;
                                reasurorGenel.PdfPoliceCreditNote = urlCredit;
                                reasurorGenel.PdfPoliceDebitNote = urlDebit;
                                reasurorGenel.PoliceBaslangicSaat = model.PoliceBaslangicSaat;
                                reasurorGenel.PoliceBaslangicTarihi = model.BaslangicTarihi;
                                reasurorGenel.PoliceBitisSaat = model.PoliceBitisSaat;
                                reasurorGenel.PoliceBitisTarihi = model.BitisTarihi;
                                reasurorGenel.SatisKanaliKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : reasurorGenel.SatisKanaliKodu;
                                reasurorGenel.SigortaSirketiKodu = !String.IsNullOrEmpty(model.SigortaSirketiKodu) ? Convert.ToInt32(model.SigortaSirketiKodu) : reasurorGenel.SigortaSirketiKodu;
                                reasurorGenel.Teklif_ID = teklifID.GenelBilgiler.TeklifId;
                                reasurorGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                reasurorGenel.YurtdisiPoliceNo = model.YurtdisiPoliceNo;
                                reasurorGenel.Police_ID = policeGenel.PoliceId;
                                reasurorGenel.Aciklama = model.Aciklama;
                                reasurorGenel.BransKodu = !String.IsNullOrEmpty(model.BransKodu) ? Convert.ToInt32(model.BransKodu) : reasurorGenel.BransKodu;
                                if (model.ParaBirimi.Trim() != "TL")
                                {
                                    // dövizliler
                                    reasurorGenel.DovizKur = Convert.ToDecimal(model.DovizKuru) * carpan;
                                    reasurorGenel.FrontingSigortaSirketiKomisyon = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon) * carpan;
                                    reasurorGenel.SatisKanaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                    reasurorGenel.TeminatTutari = Convert.ToDecimal(model.TeminatTutari) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyon = Convert.ToDecimal(model.YurtdisiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyon = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon) * carpan;
                                    reasurorGenel.YurtdisiNetPrim = Convert.ToDecimal(model.YurtdisiNetPrim) * carpan;
                                    reasurorGenel.YurtdisiBrokerNetPrim = Convert.ToDecimal(model.YurtdisiBrokerNetPrim) * carpan;//yeni satir
                                    reasurorGenel.YurtdisiPrim = Convert.ToDecimal(model.YurtdisiPrim) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurticiBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                    reasurorGenel.YurticiNetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                    if (reasurorGenel.YurticiBrutPrim != reasurorGenel.YurticiNetPrim)
                                        reasurorGenel.Bsmv = Convert.ToDecimal(model.YurticiNetPrim) * carpan * Convert.ToDecimal("0,05");
                                    else
                                        reasurorGenel.Bsmv = 0;

                                    // tl 
                                    reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyonTL) * carpan;
                                    reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyonTL) * carpan;
                                    reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutariTL) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyonTL) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyonTL) * carpan;
                                    reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrimTL) * carpan;
                                    reasurorGenel.YurtdisiBrokerNetPrimTL = Convert.ToDecimal(model.YurtdisiBrokerNetPrimTL) * carpan;//yeni satir
                                    reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrimTL) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyonTL) * carpan;
                                    reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrimTL) * carpan;
                                    reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan;
                                    if (reasurorGenel.YurticiBrutPrimTL != reasurorGenel.YurticiNetPrimTL)
                                        reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan * Convert.ToDecimal("0,05");
                                    else
                                        reasurorGenel.BsmvTL = 0;
                                }
                                else
                                {
                                    reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon) * carpan;
                                    reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                    reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutari) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon) * carpan;
                                    reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrim) * carpan;
                                    reasurorGenel.YurtdisiBrokerNetPrimTL = Convert.ToDecimal(model.YurtdisiBrokerNetPrim) * carpan;//yeni satir

                                    reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrim) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                    reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                    if (reasurorGenel.YurticiBrutPrimTL != reasurorGenel.YurticiNetPrimTL)
                                        reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrim) * carpan * Convert.ToDecimal("0,05");
                                    else
                                        reasurorGenel.BsmvTL = 0;

                                }
                                var reasuror = _TeklifService.CreateReasurorGenel(reasurorGenel);

                                #endregion}

                                #region Underwriters

                                List<Underwriters> uws = new List<Underwriters>();
                                Underwriters uw = new Underwriters();
                                if (model.UnderwriterSatirlar != null)
                                {

                                    if (model.UnderwriterSatirlar.Count > 0 && model.UnderwriterSayisi > 0)
                                    {
                                        string[] uwData;
                                        foreach (var item in model.UnderwriterSatirlar)
                                        {
                                            uwData = item.UnderwriterAdi.Split('|');
                                            uw = new Underwriters();
                                            uw.UnderwriterKodu = uwData[0];
                                            uw.UnderwriterAdi = uwData[1];
                                            uw.UnderwriterPayOrani = item.UnderwriterPayOrani;
                                            uw.UnderwriterPrim = item.UnderwriterPrim * carpan;
                                            uw.UnderwriterKomisyon = item.UnderwriterKomisyon * carpan;
                                            uw.UnderwriterKomisyonOrani = item.UnderwriterKomisyonOrani;
                                            uw.PoliceId = policeGenel.PoliceId;
                                            uw.TeklifId = teklifID.GenelBilgiler.TeklifId;
                                            uws.Add(uw);
                                        }
                                    }
                                    if (uws.Count > 0)
                                    {
                                        var uwsResult = _TeklifService.CreateUnderwriters(uws);
                                    }
                                }
                                #endregion
                            }
                        }

                        catch (Exception ex)
                        {
                            model.IslemMesaji = babonline.ErrorWhileSavingPolicy + "."; //Poliçe Kaydetme aşamadında bir hata oluştu
                            return Json(new { HataMesaji = model.IslemMesaji });
                        }
                    }
                    //3 police eki girisi
                    else if (model.durum == 3)
                    {
                        try
                        {
                            #region müşteri kayit et/güncelle
                            if (model.SigortaliSigortaEttirenAynimi)
                            {
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    musteriKoduSigortali = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.SigortaEttiren.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.SigortaEttiren.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }
                            }
                            else
                            {
                                #region sigorta ettiren ve sigortali kayit

                                #region sigorta ettiren

                                // sigorta ettiren, müşteri var mı 
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigorta ettiren müşteri var ise
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.SigortaEttiren.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.SigortaEttiren.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                }

                                #endregion

                                #region sigortali 

                                // sigortalı, müşteri var mı 
                                var musteriSigortali = _MusteriService.GetMusteri(model.Sigortali.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigortalı müşteri var ise
                                if (musteriSigortali != null)
                                {
                                    //update musteri
                                    musteriKoduSigortali = musteriSigortali.MusteriKodu;
                                    musteriSigortali.AdiUnvan = model.Sigortali.Adi;
                                    musteriSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                    if (musteriSigortali.MusteriTelefons.Where(z => z.Numara == model.Sigortali.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.Sigortali.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;
                                        musteriSigortali.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteriSigortali.MusteriAdres.Where(z => z.Adres == model.Sigortali.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.Sigortali.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteriSigortali.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteriSigortali);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.Sigortali.Adi;
                                    MusteriGenel.SoyadiUnvan = model.Sigortali.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.Sigortali.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.Sigortali.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }

                                #endregion

                                #endregion
                            }
                            #endregion

                            #region Poliçe Genel Bilgiler
                            Business.Police police = new Business.Police();
                            police.GenelBilgiler.TVMKodu = _AktifKullaniciService.TVMKodu;
                            police.GenelBilgiler.TUMBirlikKodu = model.SigortaSirketiKodu;
                            police.GenelBilgiler.BaslangicTarihi = model.BaslangicTarihi;
                            police.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                            police.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                            police.GenelBilgiler.PoliceNumarasi = model.PoliceNo;
                            police.GenelBilgiler.EkNo = model.EkNo;
                            police.GenelBilgiler.YenilemeNo = model.YenilemeNo;
                            police.GenelBilgiler.Durum = PoliceDurumlari.ManuelGiris;
                            police.GenelBilgiler.ParaBirimi = model.ParaBirimi;
                            police.GenelBilgiler.TaliAcenteKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : police.GenelBilgiler.TaliAcenteKodu;
                            police.GenelBilgiler.UretimTaliAcenteKodu = Convert.ToInt32(model.DisKaynakKodu);

                            if (!String.IsNullOrEmpty(model.DovizKuru))
                            {
                                police.GenelBilgiler.DovizKur = Convert.ToDecimal(model.DovizKuru);
                            }

                            if (!String.IsNullOrEmpty(model.BransKodu))
                            {
                                police.GenelBilgiler.BransKodu = Convert.ToInt32(model.BransKodu);

                                var bransDetay = _BransService.GetBrans(police.GenelBilgiler.BransKodu.Value);
                                if (bransDetay != null)
                                {
                                    police.GenelBilgiler.BransAdi = bransDetay.BransAdi;
                                }
                            }
                            else
                            {
                                police.GenelBilgiler.BransKodu = 18; // Tanımsız Branş Kodu
                                police.GenelBilgiler.BransAdi = "TANIMSIZ";
                            }
                            decimal carpan = 1;
                            if (model.PoliceTipi == 0) //İptal 
                            {
                                carpan = -1;
                            }

                            if (model.ParaBirimi.Trim() != "TL")
                            {
                                police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan;
                                police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrimTL) * carpan;
                                police.GenelBilgiler.TaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyonTL) * carpan;
                                police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.YurticiAlinanKomisyonTL) * carpan;
                                police.GenelBilgiler.DovizliKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                police.GenelBilgiler.DovizliNetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                police.GenelBilgiler.DovizliBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                            }
                            else
                            {
                                police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                police.GenelBilgiler.TaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                            }
                            police.GenelBilgiler.TaliAcenteKodu = Convert.ToInt32(model.TVMKodu);
                            police.GenelBilgiler.TaliKomisyonGuncellemeTarihi = TurkeyDateTime.Now;
                            police.GenelBilgiler.TaliKomisyonGuncelleyenKullanici = _AktifKullaniciService.KullaniciKodu;


                            if (model.TaksitSayisi == 1)
                            {
                                police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                            }
                            else
                            {
                                police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                            }

                            #endregion


                            #region Sigortalı / Sigorta Ettiren Bilgileri
                            police.GenelBilgiler.PoliceSigortaEttiren.DainiMurtehinSubeAdi = model.DainiMurteinSubeAdi;
                            if (model.SigortaliSigortaEttirenAynimi)
                            {
                                police.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                                police.GenelBilgiler.PoliceSigortali.AdiUnvan = model.SigortaEttiren.Adi;
                                police.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                police.GenelBilgiler.PoliceSigortali.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                                if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                                {
                                    if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                                    {
                                        police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                        police.GenelBilgiler.PoliceSigortali.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                    else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                                    {
                                        police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                        police.GenelBilgiler.PoliceSigortali.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                }

                                police.GenelBilgiler.PoliceSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                                police.GenelBilgiler.PoliceSigortali.MobilTelefonNo = model.SigortaEttiren.Telefon;
                                police.GenelBilgiler.PoliceSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                                police.GenelBilgiler.PoliceSigortali.Adres = model.SigortaEttiren.Adres;
                            }
                            else
                            {
                                ///Sigortalı Bilgileri
                                police.GenelBilgiler.PoliceSigortali.AdiUnvan = model.Sigortali.Adi;
                                police.GenelBilgiler.PoliceSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                if (!String.IsNullOrEmpty(model.Sigortali.KimlikNo))
                                {
                                    if (model.Sigortali.KimlikNo.Trim().Length == 11)
                                    {
                                        police.GenelBilgiler.PoliceSigortali.KimlikNo = model.Sigortali.KimlikNo.Trim();
                                    }
                                    else if (model.Sigortali.KimlikNo.Trim().Length == 10)
                                    {
                                        police.GenelBilgiler.PoliceSigortali.VergiKimlikNo = model.Sigortali.KimlikNo.Trim();
                                    }
                                }

                                police.GenelBilgiler.PoliceSigortali.MobilTelefonNo = model.Sigortali.Telefon;
                                police.GenelBilgiler.PoliceSigortali.Adres = model.Sigortali.Adres;

                                ///Sigorta Ettiren Bilgileri
                                police.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                                police.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                                if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                                {
                                    if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                                    {
                                        police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                    else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                                    {
                                        police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                }
                                police.GenelBilgiler.PoliceSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                                police.GenelBilgiler.PoliceSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                            }

                            #endregion

                            #region Ödeme Bilgileri

                            if (model.TaksitSayisi == 1)
                            {
                                PoliceOdemePlani odeme = new PoliceOdemePlani();
                                odeme.TaksitNo = model.TaksitSayisi;
                                odeme.TaksitTutari = Convert.ToDecimal(police.GenelBilgiler.BrutPrim) * carpan;
                                odeme.DovizliTaksitTutari = Convert.ToDecimal(police.GenelBilgiler.DovizliBrutPrim) * carpan;
                                odeme.VadeTarihi = model.BaslangicTarihi;
                                odeme.OdemeTipi = model.OdemeTipi;
                                police.GenelBilgiler.PoliceOdemePlanis.Add(odeme);

                                if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                                {
                                    PoliceTahsilat tahsilat = new PoliceTahsilat();
                                    tahsilat.OdemTipi = OdemeTipleri.KrediKarti;
                                    tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                    tahsilat.TaksitNo = odeme.TaksitNo;
                                    tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                    tahsilat.OdemeBelgeNo = "111111****1111";
                                    tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.KalanTaksitTutari = 0;
                                    tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                    tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                    tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                    tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                    tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                    tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                    tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                    tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                                    tahsilat.OtomatikTahsilatiKkMi = 1;
                                    if (tahsilat.TaksitTutari != 0)
                                    {
                                        police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                    }
                                }
                                else
                                {
                                    PoliceTahsilat tahsilat = new PoliceTahsilat();
                                    tahsilat.OdemTipi = model.OdemeTipi;
                                    tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                    tahsilat.TaksitNo = odeme.TaksitNo;
                                    tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.OdenenTutar = 0;
                                    tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                                    tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                    tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                    tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                    tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                    tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                    tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                    tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                    if (tahsilat.TaksitTutari != 0)
                                    {
                                        police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                    }
                                }
                            }
                            else if (model.TaksitSatirlar != null)
                            {
                                PoliceOdemePlani odeme = new PoliceOdemePlani();
                                foreach (var item in model.TaksitSatirlar)
                                {
                                    odeme = new PoliceOdemePlani();
                                    odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                    if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                    {
                                        odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL) * carpan;
                                    }
                                    else
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                                    }

                                    odeme.OdemeTipi = model.OdemeTipi;
                                    odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                    police.GenelBilgiler.PoliceOdemePlanis.Add(odeme);
                                    if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                                    {
                                        PoliceTahsilat tahsilat = new PoliceTahsilat();
                                        tahsilat.OdemTipi = model.OdemeTipi;
                                        tahsilat.OdemeBelgeNo = "111111****1111";
                                        tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                        tahsilat.TaksitNo = odeme.TaksitNo;
                                        tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                        tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.KalanTaksitTutari = 0;
                                        tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                        tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                        tahsilat.KimlikNo = police.GenelBilgiler.PoliceSigortali.KimlikNo;
                                        tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.Value;
                                        tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                        tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                        tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                        tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                                        tahsilat.OtomatikTahsilatiKkMi = 1;
                                        if (tahsilat.TaksitTutari != 0)
                                        {
                                            police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                        }
                                    }
                                    else
                                    {
                                        PoliceTahsilat tahsilat = new PoliceTahsilat();
                                        tahsilat.OdemTipi = model.OdemeTipi;
                                        tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                        tahsilat.TaksitNo = odeme.TaksitNo;
                                        tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.OdenenTutar = 0;
                                        tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                                        tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                        tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                        tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                        tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                        tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                        tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                        tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                        if (tahsilat.TaksitTutari != 0)
                                        {
                                            police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                        }
                                    }

                                }
                            }

                            #endregion

                            #region Poliçe Kaydetme

                            var policeKaydetResult = _PoliceService.AddPolice(police);

                            if (policeKaydetResult == 1)
                            {
                                model.IslemMesaji = babonline.PolicySavedSuccessfully;// "Police başarılı bir şekilde kaydedildi.";
                            }
                            else if (policeKaydetResult == 2)
                            {
                                model.IslemMesaji = babonline.PolicySavedAlready; // "Bu poliçe daha önceden kaydedilmiştir.";
                            }
                            else
                            {
                                model.IslemMesaji = babonline.PolicySavedError; // "Poliçe Kaydetme aşamadında bir hata oluştu.";
                            }
                            #endregion

                            if (policeKaydetResult == 1)
                            {
                                #region teklif kayıt    

                                nsbusiness.ITeklif teklif = nsbusiness.Teklif.Create(UrunKodlari.Reasuror, tvmkodu, _AktifKullaniciService.KullaniciKodu, musteriKoduSigortaEttiren, _AktifKullaniciService.TVMKodu, _AktifKullaniciService.KullaniciKodu);
                                teklif.GenelBilgiler.TeklifRevizyonNo = 0;
                                teklif.GenelBilgiler.TUMPoliceNo = model.PoliceNo;
                                teklif.GenelBilgiler.TUMKodu = Convert.ToInt32(model.SigortaSirketiKodu);
                                teklif.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                                teklif.GenelBilgiler.Basarili = true;
                                teklif.GenelBilgiler.BaslamaTarihi = model.BaslangicTarihi;
                                teklif.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                                teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                                teklif.GenelBilgiler.TeklifDurumKodu = 2;
                                if (model.TaksitSayisi == 1)
                                {
                                    teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                                }
                                else
                                {
                                    teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                                }

                                if (model.ParaBirimi.Trim() != "TL")
                                {
                                    if (model.DovizKuru != null && model.DovizKuru != "")
                                    {
                                        teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal(model.DovizKuru);
                                    }
                                    else
                                    {
                                        teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal("1");
                                    }
                                }

                                teklif.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim);
                                teklif.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim);
                                teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                                teklif.GenelBilgiler.Otorizasyon = 0;

                                #region teklif sigortali/ sigorta ettiren

                                teklif.SigortaEttiren.MusteriKodu = musteriKoduSigortaEttiren;
                                teklif.SigortaEttiren.SiraNo = 1;
                                TeklifSigortali teklifSigortali = new TeklifSigortali();
                                teklifSigortali.MusteriKodu = musteriKoduSigortali;
                                teklifSigortali.SiraNo = 1;
                                teklif.Sigortalilar.Add(teklifSigortali);

                                #endregion

                                #region Ödeme Bilgileri

                                if (model.TaksitSayisi == 1)
                                {
                                    TeklifOdemePlani odeme = new TeklifOdemePlani();
                                    odeme.TaksitNo = model.TaksitSayisi;
                                    if (model.ParaBirimi.Trim() != "TL")
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrimTL);
                                        odeme.DovizliTaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                    }
                                    else
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                    }
                                    odeme.VadeTarihi = model.BaslangicTarihi;
                                    odeme.OdemeTipi = model.OdemeTipi;
                                    teklif.OdemePlani.Add(odeme);

                                }
                                else if (model.TaksitSatirlar != null)
                                {
                                    TeklifOdemePlani odeme = new TeklifOdemePlani();
                                    foreach (var item in model.TaksitSatirlar)
                                    {
                                        odeme = new TeklifOdemePlani();
                                        odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                        if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                        {
                                            odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                            odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL);
                                        }
                                        else
                                        {
                                            odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                        }

                                        odeme.OdemeTipi = model.OdemeTipi;
                                        odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                        teklif.OdemePlani.Add(odeme);

                                    }
                                }

                                #endregion
                                var teklifID = _TeklifService.Create(teklif);

                                #endregion

                                #region pdf kayit et 
                                string urlCredit = null;
                                string urlDebit = null;
                                string urlPolice = null;

                                if (model.fileCreditNote != null)
                                {
                                    //credit döküman
                                    g = Guid.NewGuid();
                                    //string fileCreditName = System.IO.Path.GetFileName(model.fileCreditNote.FileName);
                                    string fileCreditName = g + "__" + System.IO.Path.GetFileName(model.fileCreditNote.FileName);
                                    urlCredit = _Storage.UploadFile("manuelteklifpolice", fileCreditName, model.fileCreditNote.InputStream);
                                }
                                if (model.fileDebitNote != null)
                                {
                                    //debit döküman
                                    g = Guid.NewGuid();
                                    //string fileDebitName = System.IO.Path.GetFileName(model.fileDebitNote.FileName);
                                    string fileDebitName = g + "__" + System.IO.Path.GetFileName(model.fileDebitNote.FileName);
                                    urlDebit = _Storage.UploadFile("manuelteklifpolice", fileDebitName, model.fileDebitNote.InputStream);
                                }
                                if (model.filePolice != null)
                                {
                                    //poliçe döküman
                                    g = Guid.NewGuid();
                                    //string filePoliceName = System.IO.Path.GetFileName(model.filePolice.FileName);
                                    string filePoliceName = g + "__" + System.IO.Path.GetFileName(model.filePolice.FileName);
                                    urlPolice = _Storage.UploadFile("manuelteklifpolice", filePoliceName, model.filePolice.InputStream);
                                }



                                #endregion

                                #region ReasurorGenel 
                                var policeGenel = _PoliceService.getManuelPolice(model.SigortaSirketiKodu, model.PoliceNo, model.EkNo, model.YenilemeNo, Convert.ToInt32(model.BransKodu));
                                ReasurorGenel reasurorGenel = new ReasurorGenel();
                                reasurorGenel.DisKaynakKodu = !String.IsNullOrEmpty(model.DisKaynakKodu) ? Convert.ToInt32(model.DisKaynakKodu) : reasurorGenel.DisKaynakKodu;
                                reasurorGenel.DovizTuru = model.ParaBirimi;
                                reasurorGenel.PdfPoliceDosyasi = urlPolice;
                                reasurorGenel.PdfPoliceCreditNote = urlCredit;
                                reasurorGenel.PdfPoliceDebitNote = urlDebit;
                                reasurorGenel.PoliceBaslangicSaat = model.PoliceBaslangicSaat;
                                reasurorGenel.PoliceBaslangicTarihi = model.BaslangicTarihi;
                                reasurorGenel.PoliceBitisSaat = model.PoliceBitisSaat;
                                reasurorGenel.PoliceBitisTarihi = model.BitisTarihi;
                                reasurorGenel.SatisKanaliKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : reasurorGenel.SatisKanaliKodu;
                                reasurorGenel.SigortaSirketiKodu = !String.IsNullOrEmpty(model.SigortaSirketiKodu) ? Convert.ToInt32(model.SigortaSirketiKodu) : reasurorGenel.SigortaSirketiKodu;
                                reasurorGenel.Teklif_ID = teklifID.GenelBilgiler.TeklifId;
                                reasurorGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                reasurorGenel.YurtdisiPoliceNo = model.YurtdisiPoliceNo;
                                reasurorGenel.Police_ID = policeGenel.PoliceId;
                                reasurorGenel.Aciklama = model.Aciklama;
                                reasurorGenel.BransKodu = !String.IsNullOrEmpty(model.BransKodu) ? Convert.ToInt32(model.BransKodu) : reasurorGenel.BransKodu;
                                if (model.ParaBirimi.Trim() != "TL")
                                {
                                    // dövizliler
                                    reasurorGenel.DovizKur = Convert.ToDecimal(model.DovizKuru) * carpan;
                                    reasurorGenel.FrontingSigortaSirketiKomisyon = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon) * carpan;
                                    reasurorGenel.SatisKanaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                    reasurorGenel.TeminatTutari = Convert.ToDecimal(model.TeminatTutari) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyon = Convert.ToDecimal(model.YurtdisiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyon = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon) * carpan;
                                    reasurorGenel.YurtdisiNetPrim = Convert.ToDecimal(model.YurtdisiNetPrim) * carpan;
                                    reasurorGenel.YurtdisiBrokerNetPrim = Convert.ToDecimal(model.YurtdisiBrokerNetPrim) * carpan;//yeni satir
                                    reasurorGenel.YurtdisiPrim = Convert.ToDecimal(model.YurtdisiPrim) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurticiBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                    reasurorGenel.YurticiNetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                    if (reasurorGenel.YurticiBrutPrim != reasurorGenel.YurticiNetPrim)
                                        reasurorGenel.Bsmv = Convert.ToDecimal(model.YurticiNetPrim) * carpan * Convert.ToDecimal("0,05");
                                    else
                                        reasurorGenel.Bsmv = 0;


                                    // tl 
                                    reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyonTL) * carpan;
                                    reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyonTL) * carpan;
                                    reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutariTL) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyonTL) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyonTL) * carpan;
                                    reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrimTL) * carpan;
                                    reasurorGenel.YurtdisiBrokerNetPrimTL = Convert.ToDecimal(model.YurtdisiBrokerNetPrimTL) * carpan;//yeni satir
                                    reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrimTL) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyonTL) * carpan;
                                    reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrimTL) * carpan;
                                    reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan;
                                    if (reasurorGenel.YurticiBrutPrimTL != reasurorGenel.YurticiNetPrimTL)
                                        reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan * Convert.ToDecimal("0,05");
                                    else
                                        reasurorGenel.BsmvTL = 0;
                                }
                                else
                                {
                                    reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon) * carpan;
                                    reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                    reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutari) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon) * carpan;
                                    reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrim) * carpan;
                                    reasurorGenel.YurtdisiBrokerNetPrimTL = Convert.ToDecimal(model.YurtdisiBrokerNetPrimTL) * carpan;//yeni satir
                                    reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrim) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                    reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                    if (reasurorGenel.YurticiBrutPrimTL != reasurorGenel.YurticiNetPrimTL)
                                        reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrim) * carpan * Convert.ToDecimal("0,05");
                                    else
                                        reasurorGenel.BsmvTL = 0;
                                }
                                var reasuror = _TeklifService.CreateReasurorGenel(reasurorGenel);

                                #endregion}

                                #region Underwriters

                                List<Underwriters> uws = new List<Underwriters>();
                                Underwriters uw = new Underwriters();
                                if (model.UnderwriterSatirlar != null)
                                {

                                    if (model.UnderwriterSatirlar.Count > 0 && model.UnderwriterSayisi > 0)
                                    {
                                        foreach (var item in model.UnderwriterSatirlar)
                                        {
                                            var uwData = item.UnderwriterAdi.Split('|');
                                            uw = new Underwriters();
                                            uw.UnderwriterKodu = uwData[0];
                                            uw.UnderwriterAdi = uwData[1];
                                            uw.UnderwriterAdi = item.UnderwriterAdi;
                                            uw.UnderwriterPayOrani = item.UnderwriterPayOrani;
                                            uw.UnderwriterPrim = item.UnderwriterPrim;
                                            uw.UnderwriterKomisyon = item.UnderwriterKomisyon;
                                            uw.UnderwriterKomisyonOrani = item.UnderwriterKomisyonOrani;
                                            uw.PoliceId = policeGenel.PoliceId;
                                            uw.TeklifId = teklifID.GenelBilgiler.TeklifId;
                                            uws.Add(uw);
                                        }
                                    }
                                    if (uws.Count > 0)
                                    {
                                        var uwsResult = _TeklifService.CreateUnderwriters(uws);
                                    }
                                }
                                #endregion
                            }
                        }

                        catch (Exception ex)
                        {
                            model.IslemMesaji = babonline.ErrorWhileSavingPolicy + "."; //Poliçe Kaydetme aşamadında bir hata oluştu
                            return Json(new { HataMesaji = model.IslemMesaji });
                        }
                    }
                    //1= teklif
                    else if (model.durum == 1)
                    {
                        try
                        {

                            #region müşteri kayit et/güncelle
                            if (model.SigortaliSigortaEttirenAynimi)
                            {
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    musteriKoduSigortali = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.SigortaEttiren.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.SigortaEttiren.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }
                            }
                            else
                            {
                                #region sigorta ettiren ve sigortali kayit

                                #region sigorta ettiren

                                // sigorta ettiren, müşteri var mı 
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigorta ettiren müşteri var ise
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.SigortaEttiren.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.SigortaEttiren.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                }

                                #endregion

                                #region sigortali 

                                // sigortalı, müşteri var mı 
                                var musteriSigortali = _MusteriService.GetMusteri(model.Sigortali.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigortalı müşteri var ise
                                if (musteriSigortali != null)
                                {
                                    //update musteri
                                    musteriKoduSigortali = musteriSigortali.MusteriKodu;
                                    musteriSigortali.AdiUnvan = model.Sigortali.Adi;
                                    musteriSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                    if (musteriSigortali.MusteriTelefons.Where(z => z.Numara == model.Sigortali.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.Sigortali.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;
                                        musteriSigortali.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteriSigortali.MusteriAdres.Where(z => z.Adres == model.Sigortali.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.Sigortali.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteriSigortali.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteriSigortali);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.Sigortali.Adi;
                                    MusteriGenel.SoyadiUnvan = model.Sigortali.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.Sigortali.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.Sigortali.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }

                                #endregion

                                #endregion
                            }
                            #endregion

                            #region teklif kayıt    

                            nsbusiness.ITeklif teklif = nsbusiness.Teklif.Create(UrunKodlari.Reasuror, tvmkodu, _AktifKullaniciService.KullaniciKodu, musteriKoduSigortaEttiren, _AktifKullaniciService.TVMKodu, _AktifKullaniciService.KullaniciKodu);
                            teklif.GenelBilgiler.TeklifRevizyonNo = 0;
                            teklif.GenelBilgiler.TUMTeklifNo = model.PoliceNo;
                            teklif.GenelBilgiler.TUMKodu = Convert.ToInt32(model.SigortaSirketiKodu);
                            teklif.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                            teklif.GenelBilgiler.Basarili = true;
                            teklif.GenelBilgiler.BaslamaTarihi = model.BaslangicTarihi;
                            teklif.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                            teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                            if (model.ParaBirimi.Trim() != "TL")
                            {
                                if (model.DovizKuru != null && model.DovizKuru != "")
                                {
                                    teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal(model.DovizKuru);
                                }
                                else
                                {
                                    teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal("1");
                                }
                            }

                            if (model.TaksitSayisi == 1)
                            {
                                teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                            }
                            else
                            {
                                teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                            }
                            teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                            teklif.GenelBilgiler.Otorizasyon = 0;
                            teklif.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim);
                            teklif.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim);
                            #region teklif sigortali/ sigorta ettiren
                            teklif.SigortaEttiren.MusteriKodu = musteriKoduSigortaEttiren;
                            teklif.SigortaEttiren.SiraNo = 1;
                            TeklifSigortali teklifSigortali = new TeklifSigortali();
                            teklifSigortali.MusteriKodu = musteriKoduSigortali;
                            teklifSigortali.SiraNo = 1;
                            teklif.Sigortalilar.Add(teklifSigortali);

                            #endregion



                            #region Ödeme Bilgileri

                            if (model.TaksitSayisi == 1)
                            {
                                TeklifOdemePlani odeme = new TeklifOdemePlani();
                                odeme.TaksitNo = model.TaksitSayisi;
                                if (model.ParaBirimi.Trim() != "TL")
                                {
                                    odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrimTL);
                                    odeme.DovizliTaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                }
                                else
                                {
                                    odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                }
                                odeme.VadeTarihi = model.BaslangicTarihi;
                                odeme.OdemeTipi = model.OdemeTipi;
                                teklif.OdemePlani.Add(odeme);

                            }
                            else if (model.TaksitSatirlar != null)
                            {
                                TeklifOdemePlani odeme = new TeklifOdemePlani();
                                foreach (var item in model.TaksitSatirlar)
                                {
                                    odeme = new TeklifOdemePlani();
                                    odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                    if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                    {
                                        odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL);
                                    }
                                    else
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                    }

                                    odeme.OdemeTipi = model.OdemeTipi;
                                    odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                    teklif.OdemePlani.Add(odeme);

                                }
                            }

                            #endregion
                            var teklifID = _TeklifService.Create(teklif);

                            #endregion

                            #region pdf kayit et 
                            string urlTeklif = null;
                            if (model.fileTeklif != null)
                            {
                                //teklif döküman
                                g = Guid.NewGuid();
                                string fileTeklifName = g + "__" + System.IO.Path.GetFileName(model.fileTeklif.FileName);
                                //string fileTeklifName = System.IO.Path.GetFileName(model.fileTeklif.FileName);
                                urlTeklif = _Storage.UploadFile("manuelteklifpolice", fileTeklifName, model.fileTeklif.InputStream);
                            }


                            #endregion

                            #region ReasurorGenel 

                            ReasurorGenel reasurorGenel = new ReasurorGenel();
                            reasurorGenel.DisKaynakKodu = !String.IsNullOrEmpty(model.DisKaynakKodu) ? Convert.ToInt32(model.DisKaynakKodu) : reasurorGenel.DisKaynakKodu;
                            reasurorGenel.DovizTuru = model.ParaBirimi;
                            reasurorGenel.PdfTeklifDosyasi = urlTeklif;
                            reasurorGenel.PoliceBaslangicSaat = model.PoliceBaslangicSaat;
                            reasurorGenel.PoliceBaslangicTarihi = model.BaslangicTarihi;
                            reasurorGenel.PoliceBitisSaat = model.PoliceBitisSaat;
                            reasurorGenel.PoliceBitisTarihi = model.BitisTarihi;
                            reasurorGenel.SatisKanaliKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : reasurorGenel.SatisKanaliKodu;
                            reasurorGenel.SigortaSirketiKodu = !String.IsNullOrEmpty(model.SigortaSirketiKodu) ? Convert.ToInt32(model.SigortaSirketiKodu) : reasurorGenel.SigortaSirketiKodu;
                            reasurorGenel.Teklif_ID = teklifID.GenelBilgiler.TeklifId;
                            reasurorGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                            reasurorGenel.YurtdisiPoliceNo = model.YurtdisiPoliceNo;
                            reasurorGenel.Aciklama = model.Aciklama;
                            reasurorGenel.BransKodu = !String.IsNullOrEmpty(model.BransKodu) ? Convert.ToInt32(model.BransKodu) : reasurorGenel.BransKodu;
                            if (model.ParaBirimi.Trim() != "TL")
                            {
                                // dövizliler
                                reasurorGenel.DovizKur = Convert.ToDecimal(model.DovizKuru);
                                reasurorGenel.FrontingSigortaSirketiKomisyon = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon);
                                reasurorGenel.SatisKanaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon);
                                reasurorGenel.TeminatTutari = Convert.ToDecimal(model.TeminatTutari);
                                reasurorGenel.YurtdisiAlinanKomisyon = Convert.ToDecimal(model.YurtdisiAlinanKomisyon);
                                reasurorGenel.YurtdisiDisKaynakKomisyon = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon);
                                reasurorGenel.YurtdisiNetPrim = Convert.ToDecimal(model.YurtdisiNetPrim);
                                reasurorGenel.YurtdisiBrokerNetPrim = Convert.ToDecimal(model.YurtdisiBrokerNetPrim);//yeni satir
                                reasurorGenel.YurtdisiPrim = Convert.ToDecimal(model.YurtdisiPrim);
                                reasurorGenel.YurticiAlinanKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon);
                                reasurorGenel.YurticiBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim);
                                reasurorGenel.YurticiNetPrim = Convert.ToDecimal(model.YurticiNetPrim);
                                if (reasurorGenel.YurticiBrutPrim != reasurorGenel.YurticiNetPrim)
                                    reasurorGenel.Bsmv = Convert.ToDecimal(model.YurticiNetPrim) * Convert.ToDecimal("0,05");
                                else
                                    reasurorGenel.Bsmv = 0;
                                // tl 
                                reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyonTL);
                                reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyonTL);
                                reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutariTL);
                                reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyonTL);
                                reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyonTL);
                                reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrimTL);
                                reasurorGenel.YurtdisiBrokerNetPrimTL = Convert.ToDecimal(model.YurtdisiBrokerNetPrimTL);//yeni satir
                                reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrimTL);
                                reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyonTL);
                                reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrimTL);
                                reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrimTL);
                                if (reasurorGenel.YurticiBrutPrimTL != reasurorGenel.YurticiNetPrimTL)
                                    reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrimTL) * Convert.ToDecimal("0,05");
                                else
                                    reasurorGenel.Bsmv = 0;
                            }
                            else
                            {
                                reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon);
                                reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyon);
                                reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutari);
                                reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyon);
                                reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon);
                                reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrim);
                                reasurorGenel.YurtdisiBrokerNetPrimTL = Convert.ToDecimal(model.YurtdisiBrokerNetPrimTL);//yeni satir
                                reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrim);
                                reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyon);
                                reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrim);
                                reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrim);
                                if (reasurorGenel.YurticiBrutPrimTL != reasurorGenel.YurticiNetPrimTL)
                                    reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrim) * Convert.ToDecimal("0,05");
                                else
                                    reasurorGenel.BsmvTL = 0;

                            }
                            var reasuror = _TeklifService.CreateReasurorGenel(reasurorGenel);

                            #endregion

                            #region Underwriters

                            List<Underwriters> uws = new List<Underwriters>();
                            Underwriters uw = new Underwriters();

                            if (model.UnderwriterSatirlar != null)
                            {

                                if (model.UnderwriterSatirlar.Count > 0 && model.UnderwriterSayisi > 0)
                                {
                                    foreach (var item in model.UnderwriterSatirlar)
                                    {
                                        var uwData = item.UnderwriterAdi.Split('|');
                                        uw = new Underwriters();
                                        uw.UnderwriterKodu = uwData[0];
                                        uw.UnderwriterAdi = uwData[1];
                                        uw.UnderwriterAdi = item.UnderwriterAdi;
                                        uw.UnderwriterPayOrani = item.UnderwriterPayOrani;
                                        uw.UnderwriterPrim = item.UnderwriterPrim;
                                        uw.UnderwriterKomisyon = item.UnderwriterKomisyon;
                                        uw.UnderwriterKomisyonOrani = item.UnderwriterKomisyonOrani;
                                        uw.TeklifId = teklifID.GenelBilgiler.TeklifId;
                                        uws.Add(uw);
                                    }
                                }
                                if (uws.Count > 0)
                                {
                                    var uwsResult = _TeklifService.CreateUnderwriters(uws);
                                }
                            }
                            #endregion

                            model.IslemMesaji = babonline.OfferSavedSuccessfully + "." + babonline.Proposal_No + ": " + teklifID.GenelBilgiler.TeklifNo; // + " Nolu Teklif Olarak Kayıt Edildi.";
                        }
                        catch (Exception ex)
                        {
                            model.IslemMesaji = babonline.ErrorWhileSavingOffer + "."; // Teklif Kaydetme aşamadında bir hata oluştu
                            return Json(new { HataMesaji = model.IslemMesaji });
                        }
                    }
                }
                else
                {
                    model.IslemMesaji = babonline.PleaseFillInTheRequiredFields; // "Lütfen zorunlu alanları doldurunuz.";

                }

            return Json(new { HataMesaji = model.IslemMesaji });
        }
        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.ManuelTeklifPoliceGirisi, SekmeKodu = 0)]
        public ActionResult CheckTeklifPoliceGirisi(ManuelTeklifPoliceGirisi model)
        {

            if (ModelState["Sigortali.KimlikNo"] != null)
                ModelState["Sigortali.KimlikNo"].Errors.Clear();

            if (ModelState["SigortaliSigortaEttirenAynimi"] != null)
                ModelState["SigortaliSigortaEttirenAynimi"].Errors.Clear();

            if (ModelState["OdemeSekli"] != null)
                ModelState["OdemeSekli"].Errors.Clear();

            // police numarası sadece poliçe ise zorunlu
            if (ModelState["durum"].Value.AttemptedValue == "1")
                ModelState["PoliceNo"].Errors.Clear();

            if (ModelState.IsValid)
            {

            }

            return Json(new { HataMesaji = "" });
        }

        [HttpPost]
        public ActionResult PoliceReasurorGuncelle(ManuelTeklifPoliceGirisi model)
        {
            int musteriKoduSigortaEttiren = 0;
            int musteriKoduSigortali = 0;
            model.IslemMesaji = "Poliçe Güncelleme İşlemi Gerçekleşmiştir.";
            if (ModelState["Sigortali.KimlikNo"] != null)
                ModelState["Sigortali.KimlikNo"].Errors.Clear();
            if (ModelState["SigortaliSigortaEttirenAynimi"] != null)
                ModelState["SigortaliSigortaEttirenAynimi"].Errors.Clear();
            if (ModelState["BransKodu"] != null)
                ModelState["BransKodu"].Errors.Clear();
            if (ModelState["OdemeSekli"] != null)
                ModelState["OdemeSekli"].Errors.Clear();
            if (ModelState["UnderwriterSayisi"].Value.AttemptedValue == "")
                ModelState["UnderwriterSayisi"].Errors.Clear();

            if (ModelState.IsValid)
            {
                try
                {
                    if (model.PoliceId.HasValue)
                    {
                        Business.Police police = new nsbusiness.Police();
                        police.GenelBilgiler = _PoliceService.GetPolice(model.PoliceId.Value);
                        if (police.GenelBilgiler.MuhasebeyeAktarildiMi == 2)
                        {
                            model.IslemMesaji = "Poliçe Muhasebeye aktarıldığı için güncelleme yapılamaz.";
                            return Json(new { HataMesaji = model.IslemMesaji });
                        }
                        if (police != null)
                        {

                            #region müşteri kayit et/güncelle
                            if (model.SigortaliSigortaEttirenAynimi)
                            {
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    musteriKoduSigortali = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.SigortaEttiren.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.SigortaEttiren.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }
                            }
                            else
                            {
                                #region sigorta ettiren ve sigortali kayit

                                #region sigorta ettiren

                                // sigorta ettiren, müşteri var mı 
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigorta ettiren müşteri var ise
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.SigortaEttiren.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.SigortaEttiren.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                }

                                #endregion

                                #region sigortali 

                                // sigortalı, müşteri var mı 
                                var musteriSigortali = _MusteriService.GetMusteri(model.Sigortali.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigortalı müşteri var ise
                                if (musteriSigortali != null)
                                {
                                    //update musteri
                                    musteriKoduSigortali = musteriSigortali.MusteriKodu;
                                    musteriSigortali.AdiUnvan = model.Sigortali.Adi;
                                    musteriSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                    if (musteriSigortali.MusteriTelefons.Where(z => z.Numara == model.Sigortali.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.Sigortali.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;
                                        musteriSigortali.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteriSigortali.MusteriAdres.Where(z => z.Adres == model.Sigortali.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.Sigortali.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteriSigortali.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteriSigortali);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.Sigortali.Adi;
                                    MusteriGenel.SoyadiUnvan = model.Sigortali.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.Sigortali.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.Sigortali.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }

                                #endregion

                                #endregion
                            }
                            #endregion

                            #region Poliçe Genel Bilgiler

                            police.GenelBilgiler.TVMKodu = _AktifKullaniciService.TVMKodu;
                            police.GenelBilgiler.TUMBirlikKodu = model.SigortaSirketiKodu;
                            police.GenelBilgiler.BaslangicTarihi = model.BaslangicTarihi;
                            police.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                            police.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                            police.GenelBilgiler.PoliceNumarasi = model.PoliceNo;
                            police.GenelBilgiler.EkNo = model.EkNo;
                            police.GenelBilgiler.YenilemeNo = model.YenilemeNo;
                            police.GenelBilgiler.Durum = PoliceDurumlari.ManuelGiris;
                            police.GenelBilgiler.ParaBirimi = model.ParaBirimi;
                            police.GenelBilgiler.UretimTaliAcenteKodu = Convert.ToInt32(model.DisKaynakKodu);

                            police.GenelBilgiler.TaliAcenteKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : police.GenelBilgiler.TaliAcenteKodu;

                            if (!String.IsNullOrEmpty(model.DovizKuru))
                            {
                                police.GenelBilgiler.DovizKur = Convert.ToDecimal(model.DovizKuru);
                            }

                            if (!String.IsNullOrEmpty(model.BransKodu))
                            {
                                police.GenelBilgiler.BransKodu = Convert.ToInt32(model.BransKodu);

                                var bransDetay = _BransService.GetBrans(police.GenelBilgiler.BransKodu.Value);
                                if (bransDetay != null)
                                {
                                    police.GenelBilgiler.BransAdi = bransDetay.BransAdi;
                                }
                            }
                            else
                            {
                                police.GenelBilgiler.BransKodu = 18; // Tanımsız Branş Kodu
                                police.GenelBilgiler.BransAdi = "TANIMSIZ";
                            }
                            decimal carpan = 1;
                            if (model.PoliceTipi == 0) //İptal 
                            {
                                carpan = -1;
                            }

                            if (model.ParaBirimi != "TL")
                            {
                                police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan;
                                police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrimTL) * carpan;
                                police.GenelBilgiler.TaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyonTL) * carpan;
                                police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.YurticiAlinanKomisyonTL) * carpan;
                                police.GenelBilgiler.DovizliKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                police.GenelBilgiler.DovizliNetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                police.GenelBilgiler.DovizliBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                            }
                            else
                            {
                                police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                police.GenelBilgiler.TaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                            }
                            police.GenelBilgiler.TaliAcenteKodu = Convert.ToInt32(model.TVMKodu);
                            police.GenelBilgiler.TaliKomisyonGuncellemeTarihi = TurkeyDateTime.Now;
                            police.GenelBilgiler.TaliKomisyonGuncelleyenKullanici = _AktifKullaniciService.KullaniciKodu;


                            if (model.TaksitSayisi == 1)
                            {
                                police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                            }
                            else
                            {
                                police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                            }

                            #endregion

                            #region Sigortalı / Sigorta Ettiren Bilgileri
                            police.policeSigortaEttiren.DainiMurtehinSubeAdi = model.DainiMurteinSubeAdi;
                            if (model.SigortaliSigortaEttirenAynimi)
                            {
                                police.policeSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                                police.policeSigortali.AdiUnvan = model.SigortaEttiren.Adi;
                                police.policeSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                police.policeSigortali.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                                if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                                {
                                    if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                                    {
                                        police.policeSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                        police.policeSigortali.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                    else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                                    {
                                        police.policeSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                        police.policeSigortali.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                }

                                police.policeSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                                police.policeSigortali.MobilTelefonNo = model.SigortaEttiren.Telefon;
                                police.policeSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                                police.policeSigortali.Adres = model.SigortaEttiren.Adres;
                            }
                            else
                            {
                                ///Sigortalı Bilgileri
                                police.policeSigortali.AdiUnvan = model.Sigortali.Adi;
                                police.policeSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                if (!String.IsNullOrEmpty(model.Sigortali.KimlikNo))
                                {
                                    if (model.Sigortali.KimlikNo.Trim().Length == 11)
                                    {
                                        police.policeSigortali.KimlikNo = model.Sigortali.KimlikNo.Trim();
                                    }
                                    else if (model.Sigortali.KimlikNo.Trim().Length == 10)
                                    {
                                        police.policeSigortali.VergiKimlikNo = model.Sigortali.KimlikNo.Trim();
                                    }
                                }

                                police.policeSigortali.MobilTelefonNo = model.Sigortali.Telefon;
                                police.policeSigortali.Adres = model.Sigortali.Adres;

                                ///Sigorta Ettiren Bilgileri
                                police.policeSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                                police.policeSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                                if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                                {
                                    if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                                    {
                                        police.policeSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                    else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                                    {
                                        police.policeSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                }
                                police.policeSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                                police.policeSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                            }

                            #endregion

                            #region Ödeme Bilgileri

                            if (model.TaksitSayisi == 1)
                            {
                                PoliceOdemePlani odeme = new PoliceOdemePlani();
                                odeme.TaksitNo = model.TaksitSayisi;
                                odeme.TaksitTutari = Convert.ToDecimal(police.GenelBilgiler.BrutPrim) * carpan;
                                odeme.DovizliTaksitTutari = Convert.ToDecimal(police.GenelBilgiler.DovizliBrutPrim) * carpan;
                                odeme.VadeTarihi = model.BaslangicTarihi;
                                odeme.OdemeTipi = model.OdemeTipi;
                                police.policeOdemePlani.Add(odeme);

                                if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                                {
                                    PoliceTahsilat tahsilat = new PoliceTahsilat();
                                    tahsilat.OdemTipi = OdemeTipleri.KrediKarti;
                                    tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                    tahsilat.TaksitNo = odeme.TaksitNo;
                                    tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                    tahsilat.OdemeBelgeNo = "111111****1111";
                                    tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.KalanTaksitTutari = 0;
                                    tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                    tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                    tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                    tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                    tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                    tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                    tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                    tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                                    tahsilat.OtomatikTahsilatiKkMi = 1;
                                    if (tahsilat.TaksitTutari != 0)
                                    {
                                        police.policeTahsilat.Add(tahsilat);
                                    }
                                }
                                else
                                {
                                    PoliceTahsilat tahsilat = new PoliceTahsilat();
                                    tahsilat.OdemTipi = model.OdemeTipi;
                                    tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                    tahsilat.TaksitNo = odeme.TaksitNo;
                                    tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.OdenenTutar = 0;
                                    tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                                    tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                    tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                    tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                    tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                    tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                    tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                    tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                    if (tahsilat.TaksitTutari != 0)
                                    {
                                        police.policeTahsilat.Add(tahsilat);
                                    }
                                }
                            }
                            else if (model.TaksitSatirlar != null)
                            {
                                PoliceOdemePlani odeme = new PoliceOdemePlani();
                                foreach (var item in model.TaksitSatirlar)
                                {
                                    odeme = new PoliceOdemePlani();
                                    odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                    if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                    {
                                        odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL) * carpan;
                                    }
                                    else
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                                    }

                                    odeme.OdemeTipi = model.OdemeTipi;
                                    odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                    police.policeOdemePlani.Add(odeme);
                                    if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                                    {
                                        PoliceTahsilat tahsilat = new PoliceTahsilat();
                                        tahsilat.OdemTipi = model.OdemeTipi;
                                        tahsilat.OdemeBelgeNo = "111111****1111";
                                        tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                        tahsilat.TaksitNo = odeme.TaksitNo;
                                        tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                        tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.KalanTaksitTutari = 0;
                                        tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                        tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                        tahsilat.KimlikNo = police.GenelBilgiler.PoliceSigortali.KimlikNo;
                                        tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.Value;
                                        tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                        tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                        tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                        tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                                        tahsilat.OtomatikTahsilatiKkMi = 1;
                                        if (tahsilat.TaksitTutari != 0)
                                        {
                                            police.policeTahsilat.Add(tahsilat);
                                        }
                                    }
                                    else
                                    {
                                        PoliceTahsilat tahsilat = new PoliceTahsilat();
                                        tahsilat.OdemTipi = model.OdemeTipi;
                                        tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                        tahsilat.TaksitNo = odeme.TaksitNo;
                                        tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.OdenenTutar = 0;
                                        tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                                        tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                        tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                        tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                        tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                        tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                        tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                        tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                        if (tahsilat.TaksitTutari != 0)
                                        {
                                            police.policeTahsilat.Add(tahsilat);
                                        }
                                    }

                                }
                            }

                            #endregion

                            #region Poliçe Güncelleme

                            var policeUpdateResult = _PoliceService.UpdatePoliceReasuror(police);

                            if (policeUpdateResult)
                            {
                                model.IslemMesaji = "Police başarılı bir şekilde güncellendi.";
                            }
                            else
                            {
                                model.IslemMesaji = "Poliçe Güncelleme aşamadında bir hata oluştu.";
                            }
                            #endregion

                            var reasurorGenel = _TeklifService.getReasurorGenel(model.PoliceId.Value.ToString(), "");
                            if (policeUpdateResult)
                            {

                                Guid g;
                                #region teklif Güncelle    

                                nsbusiness.ITeklif teklif = _TeklifService.GetTeklif(reasurorGenel.Teklif_ID);
                                teklif.GenelBilgiler.TVMKodu = Convert.ToInt32(model.TVMKodu);
                                teklif.GenelBilgiler.TeklifRevizyonNo = 0;
                                teklif.GenelBilgiler.TUMPoliceNo = model.PoliceNo;
                                teklif.GenelBilgiler.TUMKodu = Convert.ToInt32(model.SigortaSirketiKodu);
                                teklif.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                                teklif.GenelBilgiler.Basarili = true;
                                teklif.GenelBilgiler.BaslamaTarihi = model.BaslangicTarihi;
                                teklif.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                                teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                                teklif.GenelBilgiler.TeklifDurumKodu = 2;
                                if (model.TaksitSayisi == 1)
                                {
                                    teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                                }
                                else
                                {
                                    teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                                }

                                if (model.ParaBirimi != "TL")
                                {
                                    if (model.DovizKuru != null && model.DovizKuru != "")
                                    {
                                        teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal(model.DovizKuru);
                                    }
                                    else
                                    {
                                        teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal("1");
                                    }
                                }

                                teklif.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim);
                                teklif.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim);
                                teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                                teklif.GenelBilgiler.Otorizasyon = 0;

                                #region teklif sigortali/ sigorta ettiren

                                teklif.SigortaEttiren.MusteriKodu = musteriKoduSigortaEttiren;
                                teklif.SigortaEttiren.SiraNo = 1;
                                TeklifSigortali teklifSigortali = new TeklifSigortali();
                                teklifSigortali.MusteriKodu = musteriKoduSigortali;
                                teklifSigortali.SiraNo = 1;
                                teklif.Sigortalilar.Add(teklifSigortali);

                                #endregion

                                #region Ödeme Bilgileri

                                if (model.TaksitSayisi == 1)
                                {
                                    TeklifOdemePlani odeme = new TeklifOdemePlani();
                                    odeme.TaksitNo = model.TaksitSayisi;
                                    if (model.ParaBirimi != "TL")
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrimTL);
                                        odeme.DovizliTaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                    }
                                    else
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                    }
                                    odeme.VadeTarihi = model.BaslangicTarihi;
                                    odeme.OdemeTipi = model.OdemeTipi;
                                    teklif.OdemePlani.Add(odeme);

                                }
                                else if (model.TaksitSatirlar != null)
                                {
                                    TeklifOdemePlani odeme = new TeklifOdemePlani();
                                    foreach (var item in model.TaksitSatirlar)
                                    {
                                        odeme = new TeklifOdemePlani();
                                        odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                        if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                        {
                                            odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                            odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL);
                                        }
                                        else
                                        {
                                            odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                        }

                                        odeme.OdemeTipi = model.OdemeTipi;
                                        odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                        teklif.OdemePlani.Add(odeme);

                                    }
                                }

                                #endregion
                                _TeklifService.UpdateTeklif(teklif);

                                #endregion

                                #region pdf kayit et 
                                string urlCredit = null;
                                string urlDebit = null;
                                string urlPolice = null;

                                if (model.fileCreditNote != null)
                                {
                                    //credit döküman
                                    g = Guid.NewGuid();
                                    //string fileCreditName = System.IO.Path.GetFileName(model.fileCreditNote.FileName);
                                    string fileCreditName = g + "__" + System.IO.Path.GetFileName(model.fileCreditNote.FileName);
                                    urlCredit = _Storage.UploadFile("manuelteklifpolice", fileCreditName, model.fileCreditNote.InputStream);


                                }
                                if (model.fileDebitNote != null)
                                {
                                    //debit döküman
                                    g = Guid.NewGuid();
                                    //string fileDebitName = System.IO.Path.GetFileName(model.fileDebitNote.FileName);
                                    string fileDebitName = g + "__" + System.IO.Path.GetFileName(model.fileDebitNote.FileName);
                                    urlDebit = _Storage.UploadFile("manuelteklifpolice", fileDebitName, model.fileDebitNote.InputStream);
                                }
                                if (model.filePolice != null)
                                {
                                    //poliçe döküman
                                    g = Guid.NewGuid();
                                    //string filePoliceName = System.IO.Path.GetFileName(model.filePolice.FileName);
                                    string filePoliceName = g + "__" + System.IO.Path.GetFileName(model.filePolice.FileName);
                                    urlPolice = _Storage.UploadFile("manuelteklifpolice", filePoliceName, model.filePolice.InputStream);
                                }



                                #endregion

                                #region ReasurorGenel 
                                reasurorGenel.DisKaynakKodu = !String.IsNullOrEmpty(model.DisKaynakKodu) ? Convert.ToInt32(model.DisKaynakKodu) : reasurorGenel.DisKaynakKodu;
                                reasurorGenel.DovizTuru = model.ParaBirimi;
                                reasurorGenel.PdfPoliceDosyasi = urlPolice == null ? reasurorGenel.PdfPoliceDosyasi : urlPolice;
                                reasurorGenel.PdfPoliceCreditNote = urlCredit == null ? reasurorGenel.PdfPoliceCreditNote : urlCredit;
                                reasurorGenel.PdfPoliceDebitNote = urlDebit == null ? reasurorGenel.PdfPoliceDebitNote : urlDebit;
                                reasurorGenel.PoliceBaslangicSaat = model.PoliceBaslangicSaat;
                                reasurorGenel.PoliceBaslangicTarihi = model.BaslangicTarihi;
                                reasurorGenel.PoliceBitisSaat = model.PoliceBitisSaat;
                                reasurorGenel.PoliceBitisTarihi = model.BitisTarihi;
                                reasurorGenel.SatisKanaliKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : reasurorGenel.SatisKanaliKodu;
                                reasurorGenel.SigortaSirketiKodu = !String.IsNullOrEmpty(model.SigortaSirketiKodu) ? Convert.ToInt32(model.SigortaSirketiKodu) : reasurorGenel.SigortaSirketiKodu;
                                reasurorGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                reasurorGenel.YurtdisiPoliceNo = model.YurtdisiPoliceNo;
                                reasurorGenel.Aciklama = model.Aciklama;
                                reasurorGenel.BransKodu = !String.IsNullOrEmpty(model.BransKodu) ? Convert.ToInt32(model.BransKodu) : reasurorGenel.BransKodu;
                                if (model.ParaBirimi != "TL")
                                {
                                    // dövizliler
                                    reasurorGenel.DovizKur = Convert.ToDecimal(model.DovizKuru) * carpan;
                                    reasurorGenel.FrontingSigortaSirketiKomisyon = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon) * carpan;
                                    reasurorGenel.SatisKanaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                    reasurorGenel.TeminatTutari = Convert.ToDecimal(model.TeminatTutari) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyon = Convert.ToDecimal(model.YurtdisiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyon = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon) * carpan;
                                    reasurorGenel.YurtdisiNetPrim = Convert.ToDecimal(model.YurtdisiNetPrim) * carpan;
                                    reasurorGenel.YurtdisiBrokerNetPrim = Convert.ToDecimal(model.YurtdisiBrokerNetPrim) * carpan;
                                    reasurorGenel.YurtdisiPrim = Convert.ToDecimal(model.YurtdisiPrim) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurticiBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                    reasurorGenel.YurticiNetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                    reasurorGenel.Bsmv = Convert.ToDecimal(model.YurticiNetPrim) * carpan * Convert.ToDecimal("0,05");

                                    // tl 
                                    reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyonTL) * carpan;
                                    reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyonTL) * carpan;
                                    reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutariTL) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyonTL) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyonTL) * carpan;
                                    reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrimTL) * carpan;
                                    reasurorGenel.YurtdisiBrokerNetPrimTL = Convert.ToDecimal(model.YurtdisiBrokerNetPrimTL) * carpan;
                                    reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrimTL) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyonTL) * carpan;
                                    reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrimTL) * carpan;
                                    reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan;
                                    reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan * Convert.ToDecimal("0,05");
                                }
                                else
                                {
                                    reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon) * carpan;
                                    reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                    reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutari) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon) * carpan;
                                    reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrim) * carpan;
                                    reasurorGenel.YurtdisiBrokerNetPrimTL = Convert.ToDecimal(model.YurtdisiBrokerNetPrim) * carpan;
                                    reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrim) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                    reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                    reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrim) * carpan * Convert.ToDecimal("0,05");

                                }
                                _TeklifService.UpdateReasurorGenel(reasurorGenel);

                                #endregion}

                                #region Underwriters
                                var uwSilResult = _TeklifService.deleteUnderwriters(model.PoliceId.Value.ToString(), reasurorGenel.Teklif_ID.ToString());

                                List<Underwriters> uws = new List<Underwriters>();
                                Underwriters uw = new Underwriters();

                                if (model.UnderwriterSatirlar != null)
                                {

                                    if (model.UnderwriterSatirlar.Count > 0 && model.UnderwriterSayisi > 0)
                                    {
                                        foreach (var item in model.UnderwriterSatirlar)
                                        {
                                            var uwData = item.UnderwriterAdi.Split('|');
                                            uw = new Underwriters();
                                            uw.UnderwriterKodu = uwData[0];
                                            uw.UnderwriterAdi = uwData[1];
                                            uw.UnderwriterAdi = item.UnderwriterAdi;
                                            uw.UnderwriterPayOrani = item.UnderwriterPayOrani;
                                            uw.UnderwriterPrim = item.UnderwriterPrim;
                                            uw.UnderwriterKomisyon = item.UnderwriterKomisyon;
                                            uw.UnderwriterKomisyonOrani = item.UnderwriterKomisyonOrani;
                                            uw.PoliceId = model.PoliceId.Value;
                                            uw.TeklifId = reasurorGenel.Teklif_ID;
                                            uws.Add(uw);
                                        }
                                    }
                                    if (uws.Count > 0)
                                    {
                                        var uwsResult = _TeklifService.CreateUnderwriters(uws);
                                    }
                                }
                                #endregion
                            }
                        }
                    }
                }

                catch (Exception ex)
                {
                    model.IslemMesaji = "Poliçe Güncelleme aşamadında bir hata oluştu." + ex.ToString();
                    return Json(new { HataMesaji = model.IslemMesaji });
                }
            }
            else
            {
                model.IslemMesaji = "Lütfen zorunlu alanları doldurunuz.";
            }

            return Json(new { HataMesaji = model.IslemMesaji });
        }

        [HttpPost]
        public ActionResult PoliceEkiReasurorGuncelle(ManuelTeklifPoliceGirisi model)
        {
            int musteriKoduSigortaEttiren = 0;
            int musteriKoduSigortali = 0;
            model.IslemMesaji = "Poliçe Eki Güncelleme İşlemi Gerçekleşmiştir.";
            if (ModelState["Sigortali.KimlikNo"] != null)
                ModelState["Sigortali.KimlikNo"].Errors.Clear();
            if (ModelState["SigortaliSigortaEttirenAynimi"] != null)
                ModelState["SigortaliSigortaEttirenAynimi"].Errors.Clear();
            if (ModelState["BransKodu"] != null)
                ModelState["BransKodu"].Errors.Clear();
            if (ModelState["OdemeSekli"] != null)
                ModelState["OdemeSekli"].Errors.Clear();
            if (ModelState["UnderwriterSayisi"].Value.AttemptedValue == "")
                ModelState["UnderwriterSayisi"].Errors.Clear();

            if (ModelState.IsValid)
            {
                try
                {
                    if (model.PoliceId.HasValue)
                    {
                        Business.Police police = new nsbusiness.Police();
                        police.GenelBilgiler = _PoliceService.GetPolice(model.PoliceId.Value);
                        if (police != null)
                        {

                            #region müşteri kayit et/güncelle
                            if (model.SigortaliSigortaEttirenAynimi)
                            {
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    musteriKoduSigortali = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.SigortaEttiren.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.SigortaEttiren.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }
                            }
                            else
                            {
                                #region sigorta ettiren ve sigortali kayit

                                #region sigorta ettiren

                                // sigorta ettiren, müşteri var mı 
                                var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigorta ettiren müşteri var ise
                                if (musteri != null)
                                {
                                    musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                    //update musteri
                                    musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                    musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.SigortaEttiren.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                        musteri.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.SigortaEttiren.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteri.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteri);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                    MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                    musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                }

                                #endregion

                                #region sigortali 

                                // sigortalı, müşteri var mı 
                                var musteriSigortali = _MusteriService.GetMusteri(model.Sigortali.KimlikNo, _AktifKullaniciService.TVMKodu);
                                //sigortalı müşteri var ise
                                if (musteriSigortali != null)
                                {
                                    //update musteri
                                    musteriKoduSigortali = musteriSigortali.MusteriKodu;
                                    musteriSigortali.AdiUnvan = model.Sigortali.Adi;
                                    musteriSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                    if (musteriSigortali.MusteriTelefons.Where(z => z.Numara == model.Sigortali.Telefon).FirstOrDefault() == null)
                                    {
                                        MusteriTelefon mTel = new MusteriTelefon();
                                        mTel.Numara = model.Sigortali.Telefon;
                                        mTel.IletisimNumaraTipi = 11;
                                        mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;
                                        musteriSigortali.MusteriTelefons.Add(mTel);
                                    }
                                    if (musteriSigortali.MusteriAdres.Where(z => z.Adres == model.Sigortali.Adres).FirstOrDefault() == null)
                                    {
                                        MusteriAdre mAdres = new MusteriAdre();
                                        mAdres.Adres = model.Sigortali.Adres;
                                        mAdres.Varsayilan = true;
                                        mAdres.SiraNo = 0;
                                        mAdres.AdresTipi = 9;
                                        mAdres.UlkeKodu = "TUR";
                                        mAdres.IlKodu = "34";
                                        mAdres.IlceKodu = 459;
                                        mAdres.Semt = "-";
                                        mAdres.Mahalle = "-";
                                        mAdres.Cadde = "-";
                                        mAdres.Sokak = "-";
                                        mAdres.Apartman = "-";
                                        mAdres.BinaNo = "";
                                        mAdres.DaireNo = "";
                                        mAdres.HanAptFab = null;
                                        mAdres.PostaKodu = 0;
                                        mAdres.Diger = null;
                                        mAdres.Latitude = null;
                                        mAdres.Longitude = null;
                                        musteriSigortali.MusteriAdres.Add(mAdres);
                                    }
                                    var resultMus = _MusteriService.UpdateMusteri(musteriSigortali);
                                }
                                else
                                {
                                    //create musteri
                                    MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                    MusteriGenel.AdiUnvan = model.Sigortali.Adi;
                                    MusteriGenel.SoyadiUnvan = model.Sigortali.Soyadi;
                                    MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                    MusteriGenel.Cinsiyet = "E";
                                    MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                    MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                    MusteriGenel.MusteriTipKodu = 1;
                                    MusteriGenel.Uyruk = 0;
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.Sigortali.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;

                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.Sigortali.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;

                                    var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);
                                    musteriKoduSigortali = resultMus.MusteriKodu;
                                }

                                #endregion

                                #endregion
                            }
                            #endregion

                            #region Poliçe Genel Bilgiler

                            police.GenelBilgiler.TVMKodu = _AktifKullaniciService.TVMKodu;
                            police.GenelBilgiler.TUMBirlikKodu = model.SigortaSirketiKodu;
                            police.GenelBilgiler.BaslangicTarihi = model.BaslangicTarihi;
                            police.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                            police.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                            police.GenelBilgiler.PoliceNumarasi = model.PoliceNo;
                            police.GenelBilgiler.EkNo = model.EkNo;
                            police.GenelBilgiler.YenilemeNo = model.YenilemeNo;
                            police.GenelBilgiler.Durum = PoliceDurumlari.ManuelGiris;
                            police.GenelBilgiler.ParaBirimi = model.ParaBirimi;
                            police.GenelBilgiler.UretimTaliAcenteKodu = Convert.ToInt32(model.DisKaynakKodu);

                            police.GenelBilgiler.TaliAcenteKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : police.GenelBilgiler.TaliAcenteKodu;

                            if (!String.IsNullOrEmpty(model.DovizKuru))
                            {
                                police.GenelBilgiler.DovizKur = Convert.ToDecimal(model.DovizKuru);
                            }

                            if (!String.IsNullOrEmpty(model.BransKodu))
                            {
                                police.GenelBilgiler.BransKodu = Convert.ToInt32(model.BransKodu);

                                var bransDetay = _BransService.GetBrans(police.GenelBilgiler.BransKodu.Value);
                                if (bransDetay != null)
                                {
                                    police.GenelBilgiler.BransAdi = bransDetay.BransAdi;
                                }
                            }
                            else
                            {
                                police.GenelBilgiler.BransKodu = 18; // Tanımsız Branş Kodu
                                police.GenelBilgiler.BransAdi = "TANIMSIZ";
                            }
                            decimal carpan = 1;
                            if (model.PoliceTipi == 0) //İptal 
                            {
                                carpan = -1;
                            }

                            if (model.ParaBirimi != "TL")
                            {
                                police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan;
                                police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrimTL) * carpan;
                                police.GenelBilgiler.TaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyonTL) * carpan;
                                police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.YurticiAlinanKomisyonTL) * carpan;
                                police.GenelBilgiler.DovizliKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                police.GenelBilgiler.DovizliNetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                police.GenelBilgiler.DovizliBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                            }
                            else
                            {
                                police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                police.GenelBilgiler.TaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                            }
                            police.GenelBilgiler.TaliAcenteKodu = Convert.ToInt32(model.TVMKodu);
                            police.GenelBilgiler.TaliKomisyonGuncellemeTarihi = TurkeyDateTime.Now;
                            police.GenelBilgiler.TaliKomisyonGuncelleyenKullanici = _AktifKullaniciService.KullaniciKodu;


                            if (model.TaksitSayisi == 1)
                            {
                                police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                            }
                            else
                            {
                                police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                            }

                            #endregion

                            #region Sigortalı / Sigorta Ettiren Bilgileri
                            police.policeSigortaEttiren.DainiMurtehinSubeAdi = model.DainiMurteinSubeAdi;
                            if (model.SigortaliSigortaEttirenAynimi)
                            {
                                police.policeSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                                police.policeSigortali.AdiUnvan = model.SigortaEttiren.Adi;
                                police.policeSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                police.policeSigortali.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                                if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                                {
                                    if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                                    {
                                        police.policeSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                        police.policeSigortali.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                    else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                                    {
                                        police.policeSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                        police.policeSigortali.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                }

                                police.policeSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                                police.policeSigortali.MobilTelefonNo = model.SigortaEttiren.Telefon;
                                police.policeSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                                police.policeSigortali.Adres = model.SigortaEttiren.Adres;
                            }
                            else
                            {
                                ///Sigortalı Bilgileri
                                police.policeSigortali.AdiUnvan = model.Sigortali.Adi;
                                police.policeSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                if (!String.IsNullOrEmpty(model.Sigortali.KimlikNo))
                                {
                                    if (model.Sigortali.KimlikNo.Trim().Length == 11)
                                    {
                                        police.policeSigortali.KimlikNo = model.Sigortali.KimlikNo.Trim();
                                    }
                                    else if (model.Sigortali.KimlikNo.Trim().Length == 10)
                                    {
                                        police.policeSigortali.VergiKimlikNo = model.Sigortali.KimlikNo.Trim();
                                    }
                                }

                                police.policeSigortali.MobilTelefonNo = model.Sigortali.Telefon;
                                police.policeSigortali.Adres = model.Sigortali.Adres;

                                ///Sigorta Ettiren Bilgileri
                                police.policeSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                                police.policeSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                                if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                                {
                                    if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                                    {
                                        police.policeSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                    else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                                    {
                                        police.policeSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                    }
                                }
                                police.policeSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                                police.policeSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                            }

                            #endregion

                            #region Ödeme Bilgileri

                            if (model.TaksitSayisi == 1)
                            {
                                PoliceOdemePlani odeme = new PoliceOdemePlani();
                                odeme.TaksitNo = model.TaksitSayisi;
                                odeme.TaksitTutari = Convert.ToDecimal(police.GenelBilgiler.BrutPrim) * carpan;
                                odeme.DovizliTaksitTutari = Convert.ToDecimal(police.GenelBilgiler.DovizliBrutPrim) * carpan;
                                odeme.VadeTarihi = model.BaslangicTarihi;
                                odeme.OdemeTipi = model.OdemeTipi;
                                police.policeOdemePlani.Add(odeme);

                                if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                                {
                                    PoliceTahsilat tahsilat = new PoliceTahsilat();
                                    tahsilat.OdemTipi = OdemeTipleri.KrediKarti;
                                    tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                    tahsilat.TaksitNo = odeme.TaksitNo;
                                    tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                    tahsilat.OdemeBelgeNo = "111111****1111";
                                    tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.KalanTaksitTutari = 0;
                                    tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                    tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                    tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                    tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                    tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                    tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                    tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                    tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                                    tahsilat.OtomatikTahsilatiKkMi = 1;
                                    if (tahsilat.TaksitTutari != 0)
                                    {
                                        police.policeTahsilat.Add(tahsilat);
                                    }
                                }
                                else
                                {
                                    PoliceTahsilat tahsilat = new PoliceTahsilat();
                                    tahsilat.OdemTipi = model.OdemeTipi;
                                    tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                    tahsilat.TaksitNo = odeme.TaksitNo;
                                    tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.OdenenTutar = 0;
                                    tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                                    tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                    tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                    tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                    tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                    tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                    tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                    tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                    if (tahsilat.TaksitTutari != 0)
                                    {
                                        police.policeTahsilat.Add(tahsilat);
                                    }
                                }
                            }
                            else if (model.TaksitSatirlar != null)
                            {
                                PoliceOdemePlani odeme = new PoliceOdemePlani();
                                foreach (var item in model.TaksitSatirlar)
                                {
                                    odeme = new PoliceOdemePlani();
                                    odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                    if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                    {
                                        odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL) * carpan;
                                    }
                                    else
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                                    }

                                    odeme.OdemeTipi = model.OdemeTipi;
                                    odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                    police.policeOdemePlani.Add(odeme);
                                    if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                                    {
                                        PoliceTahsilat tahsilat = new PoliceTahsilat();
                                        tahsilat.OdemTipi = model.OdemeTipi;
                                        tahsilat.OdemeBelgeNo = "111111****1111";
                                        tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                        tahsilat.TaksitNo = odeme.TaksitNo;
                                        tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                        tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.KalanTaksitTutari = 0;
                                        tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                        tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                        tahsilat.KimlikNo = police.GenelBilgiler.PoliceSigortali.KimlikNo;
                                        tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.Value;
                                        tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                        tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                        tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                        tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                                        tahsilat.OtomatikTahsilatiKkMi = 1;
                                        if (tahsilat.TaksitTutari != 0)
                                        {
                                            police.policeTahsilat.Add(tahsilat);
                                        }
                                    }
                                    else
                                    {
                                        PoliceTahsilat tahsilat = new PoliceTahsilat();
                                        tahsilat.OdemTipi = model.OdemeTipi;
                                        tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                        tahsilat.TaksitNo = odeme.TaksitNo;
                                        tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                        tahsilat.OdenenTutar = 0;
                                        tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                                        tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                        tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                        tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                        tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                        tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                        tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                        tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                        if (tahsilat.TaksitTutari != 0)
                                        {
                                            police.policeTahsilat.Add(tahsilat);
                                        }
                                    }

                                }
                            }

                            #endregion

                            #region Poliçe Güncelleme

                            var policeUpdateResult = _PoliceService.UpdatePoliceReasuror(police);

                            if (policeUpdateResult)
                            {
                                model.IslemMesaji = "Police Eki başarılı bir şekilde güncellendi.";
                            }
                            else
                            {
                                model.IslemMesaji = "Poliçe Eki Güncelleme aşamadında bir hata oluştu.";
                            }
                            #endregion

                            var reasurorGenel = _TeklifService.getReasurorGenel(model.PoliceId.Value.ToString(), "");
                            if (policeUpdateResult)
                            {

                                Guid g;
                                #region teklif Güncelle    

                                nsbusiness.ITeklif teklif = _TeklifService.GetTeklif(reasurorGenel.Teklif_ID);
                                teklif.GenelBilgiler.TVMKodu = Convert.ToInt32(model.TVMKodu);
                                teklif.GenelBilgiler.TeklifRevizyonNo = 0;
                                teklif.GenelBilgiler.TUMPoliceNo = model.PoliceNo;
                                teklif.GenelBilgiler.TUMKodu = Convert.ToInt32(model.SigortaSirketiKodu);
                                teklif.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                                teklif.GenelBilgiler.Basarili = true;
                                teklif.GenelBilgiler.BaslamaTarihi = model.BaslangicTarihi;
                                teklif.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                                teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                                teklif.GenelBilgiler.TeklifDurumKodu = 2;
                                if (model.TaksitSayisi == 1)
                                {
                                    teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                                }
                                else
                                {
                                    teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                                }

                                if (model.ParaBirimi != "TL")
                                {
                                    if (model.DovizKuru != null && model.DovizKuru != "")
                                    {
                                        teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal(model.DovizKuru);
                                    }
                                    else
                                    {
                                        teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal("1");
                                    }
                                }

                                teklif.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim);
                                teklif.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim);
                                teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                                teklif.GenelBilgiler.Otorizasyon = 0;

                                #region teklif sigortali/ sigorta ettiren

                                teklif.SigortaEttiren.MusteriKodu = musteriKoduSigortaEttiren;
                                teklif.SigortaEttiren.SiraNo = 1;
                                TeklifSigortali teklifSigortali = new TeklifSigortali();
                                teklifSigortali.MusteriKodu = musteriKoduSigortali;
                                teklifSigortali.SiraNo = 1;
                                teklif.Sigortalilar.Add(teklifSigortali);

                                #endregion

                                #region Ödeme Bilgileri

                                if (model.TaksitSayisi == 1)
                                {
                                    TeklifOdemePlani odeme = new TeklifOdemePlani();
                                    odeme.TaksitNo = model.TaksitSayisi;
                                    if (model.ParaBirimi != "TL")
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrimTL);
                                        odeme.DovizliTaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                    }
                                    else
                                    {
                                        odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                                    }
                                    odeme.VadeTarihi = model.BaslangicTarihi;
                                    odeme.OdemeTipi = model.OdemeTipi;
                                    teklif.OdemePlani.Add(odeme);

                                }
                                else if (model.TaksitSatirlar != null)
                                {
                                    TeklifOdemePlani odeme = new TeklifOdemePlani();
                                    foreach (var item in model.TaksitSatirlar)
                                    {
                                        odeme = new TeklifOdemePlani();
                                        odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                        if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                        {
                                            odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                            odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL);
                                        }
                                        else
                                        {
                                            odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                        }

                                        odeme.OdemeTipi = model.OdemeTipi;
                                        odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                        teklif.OdemePlani.Add(odeme);

                                    }
                                }

                                #endregion
                                _TeklifService.UpdateTeklif(teklif);

                                #endregion

                                #region pdf kayit et 
                                string urlCredit = null;
                                string urlDebit = null;
                                string urlPolice = null;

                                if (model.fileCreditNote != null)
                                {
                                    //credit döküman
                                    g = Guid.NewGuid();
                                    //string fileCreditName = System.IO.Path.GetFileName(model.fileCreditNote.FileName);
                                    string fileCreditName = g + "__" + System.IO.Path.GetFileName(model.fileCreditNote.FileName);
                                    urlCredit = _Storage.UploadFile("manuelteklifpolice", fileCreditName, model.fileCreditNote.InputStream);


                                }
                                if (model.fileDebitNote != null)
                                {
                                    //debit döküman
                                    g = Guid.NewGuid();
                                    //string fileDebitName = System.IO.Path.GetFileName(model.fileDebitNote.FileName);
                                    string fileDebitName = g + "__" + System.IO.Path.GetFileName(model.fileDebitNote.FileName);
                                    urlDebit = _Storage.UploadFile("manuelteklifpolice", fileDebitName, model.fileDebitNote.InputStream);
                                }
                                if (model.filePolice != null)
                                {
                                    //poliçe döküman
                                    g = Guid.NewGuid();
                                    //string filePoliceName = System.IO.Path.GetFileName(model.filePolice.FileName);
                                    string filePoliceName = g + "__" + System.IO.Path.GetFileName(model.filePolice.FileName);
                                    urlPolice = _Storage.UploadFile("manuelteklifpolice", filePoliceName, model.filePolice.InputStream);
                                }



                                #endregion

                                #region ReasurorGenel 
                                reasurorGenel.DisKaynakKodu = !String.IsNullOrEmpty(model.DisKaynakKodu) ? Convert.ToInt32(model.DisKaynakKodu) : reasurorGenel.DisKaynakKodu;
                                reasurorGenel.DovizTuru = model.ParaBirimi;
                                reasurorGenel.PdfPoliceDosyasi = urlPolice == null ? reasurorGenel.PdfPoliceDosyasi : urlPolice;
                                reasurorGenel.PdfPoliceCreditNote = urlCredit == null ? reasurorGenel.PdfPoliceCreditNote : urlCredit;
                                reasurorGenel.PdfPoliceDebitNote = urlDebit == null ? reasurorGenel.PdfPoliceDebitNote : urlDebit;
                                reasurorGenel.PoliceBaslangicSaat = model.PoliceBaslangicSaat;
                                reasurorGenel.PoliceBaslangicTarihi = model.BaslangicTarihi;
                                reasurorGenel.PoliceBitisSaat = model.PoliceBitisSaat;
                                reasurorGenel.PoliceBitisTarihi = model.BitisTarihi;
                                reasurorGenel.SatisKanaliKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : reasurorGenel.SatisKanaliKodu;
                                reasurorGenel.SigortaSirketiKodu = !String.IsNullOrEmpty(model.SigortaSirketiKodu) ? Convert.ToInt32(model.SigortaSirketiKodu) : reasurorGenel.SigortaSirketiKodu;
                                reasurorGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                reasurorGenel.YurtdisiPoliceNo = model.YurtdisiPoliceNo;
                                reasurorGenel.Aciklama = model.Aciklama;
                                reasurorGenel.BransKodu = !String.IsNullOrEmpty(model.BransKodu) ? Convert.ToInt32(model.BransKodu) : reasurorGenel.BransKodu;
                                if (model.ParaBirimi != "TL")
                                {
                                    // dövizliler
                                    reasurorGenel.DovizKur = Convert.ToDecimal(model.DovizKuru) * carpan;
                                    reasurorGenel.FrontingSigortaSirketiKomisyon = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon) * carpan;
                                    reasurorGenel.SatisKanaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                    reasurorGenel.TeminatTutari = Convert.ToDecimal(model.TeminatTutari) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyon = Convert.ToDecimal(model.YurtdisiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyon = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon) * carpan;
                                    reasurorGenel.YurtdisiNetPrim = Convert.ToDecimal(model.YurtdisiNetPrim) * carpan;
                                    reasurorGenel.YurtdisiPrim = Convert.ToDecimal(model.YurtdisiPrim) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurticiBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                    reasurorGenel.YurticiNetPrim = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                    reasurorGenel.Bsmv = Convert.ToDecimal(model.YurticiNetPrim) * carpan * Convert.ToDecimal("0,05");

                                    // tl 
                                    reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyonTL) * carpan;
                                    reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyonTL) * carpan;
                                    reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutariTL) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyonTL) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyonTL) * carpan;
                                    reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrimTL) * carpan;
                                    reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrimTL) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyonTL) * carpan;
                                    reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrimTL) * carpan;
                                    reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan;
                                    reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrimTL) * carpan * Convert.ToDecimal("0,05");
                                }
                                else
                                {
                                    reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon) * carpan;
                                    reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyon) * carpan;
                                    reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutari) * carpan;
                                    reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon) * carpan;
                                    reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrim) * carpan;
                                    reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrim) * carpan;
                                    reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyon) * carpan;
                                    reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrim) * carpan;
                                    reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrim) * carpan;
                                    reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrim) * carpan * Convert.ToDecimal("0,05");

                                }
                                _TeklifService.UpdateReasurorGenel(reasurorGenel);

                                #endregion}

                                #region Underwriters
                                var uwSilResult = _TeklifService.deleteUnderwriters(model.PoliceId.Value.ToString(), reasurorGenel.Teklif_ID.ToString());

                                List<Underwriters> uws = new List<Underwriters>();
                                Underwriters uw = new Underwriters();

                                if (model.UnderwriterSatirlar != null)
                                {

                                    if (model.UnderwriterSatirlar.Count > 0 && model.UnderwriterSayisi > 0)
                                    {
                                        foreach (var item in model.UnderwriterSatirlar)
                                        {
                                            var uwData = item.UnderwriterAdi.Split('|');
                                            uw = new Underwriters();
                                            uw.UnderwriterKodu = uwData[0];
                                            uw.UnderwriterAdi = uwData[1];
                                            uw.UnderwriterAdi = item.UnderwriterAdi;
                                            uw.UnderwriterPayOrani = item.UnderwriterPayOrani;
                                            uw.UnderwriterPrim = item.UnderwriterPrim;
                                            uw.UnderwriterKomisyon = item.UnderwriterKomisyon;
                                            uw.UnderwriterKomisyonOrani = item.UnderwriterKomisyonOrani;
                                            uw.PoliceId = model.PoliceId.Value;
                                            uw.TeklifId = reasurorGenel.Teklif_ID;
                                            uws.Add(uw);
                                        }
                                    }
                                    if (uws.Count > 0)
                                    {
                                        var uwsResult = _TeklifService.CreateUnderwriters(uws);
                                    }
                                }
                                #endregion
                            }
                        }
                    }
                }

                catch (Exception ex)
                {
                    model.IslemMesaji = "Poliçe Eki Güncelleme aşamadında bir hata oluştu." + ex.ToString();
                    return Json(new { HataMesaji = model.IslemMesaji });
                }
            }
            else
            {
                model.IslemMesaji = "Lütfen zorunlu alanları doldurunuz.";
            }

            return Json(new { HataMesaji = model.IslemMesaji });
        }

        [HttpPost]
        public ActionResult TeklifReasurorGuncelle(ManuelTeklifPoliceGirisi model)
        {
            int musteriKoduSigortaEttiren = 0;
            int musteriKoduSigortali = 0;
            model.IslemMesaji = "Teklif Güncelleme İşlemi Gerçekleşmiştir.";
            if (ModelState["Sigortali.KimlikNo"] != null)
                ModelState["Sigortali.KimlikNo"].Errors.Clear();
            if (ModelState["SigortaliSigortaEttirenAynimi"] != null)
                ModelState["SigortaliSigortaEttirenAynimi"].Errors.Clear();
            if (ModelState["BransKodu"] != null)
                ModelState["BransKodu"].Errors.Clear();
            if (ModelState["OdemeSekli"] != null)
                ModelState["OdemeSekli"].Errors.Clear();
            if (ModelState["durum"].Value.AttemptedValue == "1")
                ModelState["PoliceNo"].Errors.Clear();
            if (ModelState["UnderwriterSayisi"].Value.AttemptedValue == "")
                ModelState["UnderwriterSayisi"].Errors.Clear();

            if (ModelState.IsValid)
            {
                try
                {
                    if (model.TeklifId.HasValue)
                    {

                        #region müşteri kayit et/güncelle
                        if (model.SigortaliSigortaEttirenAynimi)
                        {
                            var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                            if (musteri != null)
                            {
                                musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                musteriKoduSigortali = musteri.MusteriKodu;
                                //update musteri
                                musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                {
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                    musteri.MusteriTelefons.Add(mTel);
                                }
                                if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                {
                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;
                                    musteri.MusteriAdres.Add(mAdres);
                                }
                                var resultMus = _MusteriService.UpdateMusteri(musteri);
                            }
                            else
                            {
                                //create musteri
                                MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                MusteriGenel.Cinsiyet = "E";
                                MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                MusteriGenel.MusteriTipKodu = 1;
                                MusteriGenel.Uyruk = 0;
                                MusteriTelefon mTel = new MusteriTelefon();
                                mTel.Numara = model.SigortaEttiren.Telefon;
                                mTel.IletisimNumaraTipi = 11;
                                mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                MusteriAdre mAdres = new MusteriAdre();
                                mAdres.Adres = model.SigortaEttiren.Adres;
                                mAdres.Varsayilan = true;
                                mAdres.SiraNo = 0;
                                mAdres.AdresTipi = 9;
                                mAdres.UlkeKodu = "TUR";
                                mAdres.IlKodu = "34";
                                mAdres.IlceKodu = 459;
                                mAdres.Semt = "-";
                                mAdres.Mahalle = "-";
                                mAdres.Cadde = "-";
                                mAdres.Sokak = "-";
                                mAdres.Apartman = "-";
                                mAdres.BinaNo = "";
                                mAdres.DaireNo = "";
                                mAdres.HanAptFab = null;
                                mAdres.PostaKodu = 0;
                                mAdres.Diger = null;
                                mAdres.Latitude = null;
                                mAdres.Longitude = null;

                                var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                                musteriKoduSigortali = resultMus.MusteriKodu;
                            }
                        }
                        else
                        {
                            #region sigorta ettiren ve sigortali kayit

                            #region sigorta ettiren

                            // sigorta ettiren, müşteri var mı 
                            var musteri = _MusteriService.GetMusteri(model.SigortaEttiren.KimlikNo, _AktifKullaniciService.TVMKodu);
                            //sigorta ettiren müşteri var ise
                            if (musteri != null)
                            {
                                musteriKoduSigortaEttiren = musteri.MusteriKodu;
                                //update musteri
                                musteri.AdiUnvan = model.SigortaEttiren.Adi;
                                musteri.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                if (musteri.MusteriTelefons.Where(z => z.Numara == model.SigortaEttiren.Telefon).FirstOrDefault() == null)
                                {
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.SigortaEttiren.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;
                                    musteri.MusteriTelefons.Add(mTel);
                                }
                                if (musteri.MusteriAdres.Where(z => z.Adres == model.SigortaEttiren.Adres).FirstOrDefault() == null)
                                {
                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.SigortaEttiren.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;
                                    musteri.MusteriAdres.Add(mAdres);
                                }
                                var resultMus = _MusteriService.UpdateMusteri(musteri);
                            }
                            else
                            {
                                //create musteri
                                MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                MusteriGenel.AdiUnvan = model.SigortaEttiren.Adi;
                                MusteriGenel.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                                MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                MusteriGenel.Cinsiyet = "E";
                                MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                MusteriGenel.MusteriTipKodu = 1;
                                MusteriGenel.Uyruk = 0;
                                MusteriTelefon mTel = new MusteriTelefon();
                                mTel.Numara = model.SigortaEttiren.Telefon;
                                mTel.IletisimNumaraTipi = 11;
                                mTel.NumaraSahibi = model.SigortaEttiren.Adi + " " + model.SigortaEttiren.Soyadi;

                                MusteriAdre mAdres = new MusteriAdre();
                                mAdres.Adres = model.SigortaEttiren.Adres;
                                mAdres.Varsayilan = true;
                                mAdres.SiraNo = 0;
                                mAdres.AdresTipi = 9;
                                mAdres.UlkeKodu = "TUR";
                                mAdres.IlKodu = "34";
                                mAdres.IlceKodu = 459;
                                mAdres.Semt = "-";
                                mAdres.Mahalle = "-";
                                mAdres.Cadde = "-";
                                mAdres.Sokak = "-";
                                mAdres.Apartman = "-";
                                mAdres.BinaNo = "";
                                mAdres.DaireNo = "";
                                mAdres.HanAptFab = null;
                                mAdres.PostaKodu = 0;
                                mAdres.Diger = null;
                                mAdres.Latitude = null;
                                mAdres.Longitude = null;

                                var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);

                                musteriKoduSigortaEttiren = resultMus.MusteriKodu;
                            }

                            #endregion

                            #region sigortali 

                            // sigortalı, müşteri var mı 
                            var musteriSigortali = _MusteriService.GetMusteri(model.Sigortali.KimlikNo, _AktifKullaniciService.TVMKodu);
                            //sigortalı müşteri var ise
                            if (musteriSigortali != null)
                            {
                                //update musteri
                                musteriKoduSigortali = musteriSigortali.MusteriKodu;
                                musteriSigortali.AdiUnvan = model.Sigortali.Adi;
                                musteriSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                                if (musteriSigortali.MusteriTelefons.Where(z => z.Numara == model.Sigortali.Telefon).FirstOrDefault() == null)
                                {
                                    MusteriTelefon mTel = new MusteriTelefon();
                                    mTel.Numara = model.Sigortali.Telefon;
                                    mTel.IletisimNumaraTipi = 11;
                                    mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;
                                    musteriSigortali.MusteriTelefons.Add(mTel);
                                }
                                if (musteriSigortali.MusteriAdres.Where(z => z.Adres == model.Sigortali.Adres).FirstOrDefault() == null)
                                {
                                    MusteriAdre mAdres = new MusteriAdre();
                                    mAdres.Adres = model.Sigortali.Adres;
                                    mAdres.Varsayilan = true;
                                    mAdres.SiraNo = 0;
                                    mAdres.AdresTipi = 9;
                                    mAdres.UlkeKodu = "TUR";
                                    mAdres.IlKodu = "34";
                                    mAdres.IlceKodu = 459;
                                    mAdres.Semt = "-";
                                    mAdres.Mahalle = "-";
                                    mAdres.Cadde = "-";
                                    mAdres.Sokak = "-";
                                    mAdres.Apartman = "-";
                                    mAdres.BinaNo = "";
                                    mAdres.DaireNo = "";
                                    mAdres.HanAptFab = null;
                                    mAdres.PostaKodu = 0;
                                    mAdres.Diger = null;
                                    mAdres.Latitude = null;
                                    mAdres.Longitude = null;
                                    musteriSigortali.MusteriAdres.Add(mAdres);
                                }
                                var resultMus = _MusteriService.UpdateMusteri(musteriSigortali);
                            }
                            else
                            {
                                //create musteri
                                MusteriGenelBilgiler MusteriGenel = new MusteriGenelBilgiler();
                                MusteriGenel.AdiUnvan = model.Sigortali.Adi;
                                MusteriGenel.SoyadiUnvan = model.Sigortali.Soyadi;
                                MusteriGenel.KimlikNo = model.SigortaEttiren.KimlikNo;
                                MusteriGenel.KayitTarihi = TurkeyDateTime.Now;
                                MusteriGenel.Cinsiyet = "E";
                                MusteriGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                                MusteriGenel.TVMKullaniciKodu = _AktifKullaniciService.KullaniciKodu;
                                MusteriGenel.MusteriTipKodu = 1;
                                MusteriGenel.Uyruk = 0;
                                MusteriTelefon mTel = new MusteriTelefon();
                                mTel.Numara = model.Sigortali.Telefon;
                                mTel.IletisimNumaraTipi = 11;
                                mTel.NumaraSahibi = model.Sigortali.Adi + " " + model.Sigortali.Soyadi;

                                MusteriAdre mAdres = new MusteriAdre();
                                mAdres.Adres = model.Sigortali.Adres;
                                mAdres.Varsayilan = true;
                                mAdres.SiraNo = 0;
                                mAdres.AdresTipi = 9;
                                mAdres.UlkeKodu = "TUR";
                                mAdres.IlKodu = "34";
                                mAdres.IlceKodu = 459;
                                mAdres.Semt = "-";
                                mAdres.Mahalle = "-";
                                mAdres.Cadde = "-";
                                mAdres.Sokak = "-";
                                mAdres.Apartman = "-";
                                mAdres.BinaNo = "";
                                mAdres.DaireNo = "";
                                mAdres.HanAptFab = null;
                                mAdres.PostaKodu = 0;
                                mAdres.Diger = null;
                                mAdres.Latitude = null;
                                mAdres.Longitude = null;

                                var resultMus = _MusteriService.CreateMusteri(MusteriGenel, mAdres, mTel);
                                musteriKoduSigortali = resultMus.MusteriKodu;
                            }

                            #endregion

                            #endregion
                        }
                        #endregion

                        var reasurorGenel = _TeklifService.getReasurorGenel("", model.TeklifId.Value.ToString());


                        #region teklif Güncelle    

                        nsbusiness.ITeklif teklif = _TeklifService.GetTeklif(reasurorGenel.Teklif_ID);
                        teklif.GenelBilgiler.TVMKodu = Convert.ToInt32(model.TVMKodu);
                        teklif.GenelBilgiler.TeklifRevizyonNo = 0;
                        teklif.GenelBilgiler.TUMPoliceNo = model.PoliceNo;
                        teklif.GenelBilgiler.TUMKodu = Convert.ToInt32(model.SigortaSirketiKodu);
                        teklif.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                        teklif.GenelBilgiler.Basarili = true;
                        teklif.GenelBilgiler.BaslamaTarihi = model.BaslangicTarihi;
                        teklif.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                        teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                        teklif.GenelBilgiler.TeklifDurumKodu = 2;
                        if (model.TaksitSayisi == 1)
                        {
                            teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                        }
                        else
                        {
                            teklif.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                        }

                        if (model.ParaBirimi != "TL")
                        {
                            if (model.DovizKuru != null && model.DovizKuru != "")
                            {
                                teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal(model.DovizKuru);
                            }
                            else
                            {
                                teklif.GenelBilgiler.DovizKurBedeli = Convert.ToDecimal("1");
                            }
                        }

                        teklif.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.YurticiBrutPrim);
                        teklif.GenelBilgiler.NetPrim = Convert.ToDecimal(model.YurticiNetPrim);
                        teklif.GenelBilgiler.KayitTarihi = TurkeyDateTime.Now;
                        teklif.GenelBilgiler.Otorizasyon = 0;

                        #region teklif sigortali/ sigorta ettiren

                        teklif.SigortaEttiren.MusteriKodu = musteriKoduSigortaEttiren;
                        teklif.SigortaEttiren.SiraNo = 1;
                        TeklifSigortali teklifSigortali = new TeklifSigortali();
                        teklifSigortali.MusteriKodu = musteriKoduSigortali;
                        teklifSigortali.SiraNo = 1;
                        teklif.Sigortalilar.Add(teklifSigortali);

                        #endregion

                        #region Ödeme Bilgileri

                        if (model.TaksitSayisi == 1)
                        {
                            TeklifOdemePlani odeme = new TeklifOdemePlani();
                            odeme.TaksitNo = model.TaksitSayisi;
                            if (model.ParaBirimi != "TL")
                            {
                                odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrimTL);
                                odeme.DovizliTaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                            }
                            else
                            {
                                odeme.TaksitTutari = Convert.ToDecimal(model.YurticiBrutPrim);
                            }
                            odeme.VadeTarihi = model.BaslangicTarihi;
                            odeme.OdemeTipi = model.OdemeTipi;
                            teklif.OdemePlani.Add(odeme);

                        }
                        else if (model.TaksitSatirlar != null)
                        {
                            TeklifOdemePlani odeme = new TeklifOdemePlani();
                            foreach (var item in model.TaksitSatirlar)
                            {
                                odeme = new TeklifOdemePlani();
                                odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                {
                                    odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                    odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL);
                                }
                                else
                                {
                                    odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                }

                                odeme.OdemeTipi = model.OdemeTipi;
                                odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                teklif.OdemePlani.Add(odeme);

                            }
                        }

                        #endregion
                        _TeklifService.UpdateTeklif(teklif);

                        #endregion

                        Guid g;
                        #region pdf kayit et 
                        string urlTeklif = null;
                        if (model.fileTeklif != null)
                        {
                            //teklif döküman
                            g = Guid.NewGuid();
                            string fileTeklifName = g + "__" + System.IO.Path.GetFileName(model.fileTeklif.FileName);
                            //string fileTeklifName = System.IO.Path.GetFileName(model.fileTeklif.FileName);
                            urlTeklif = _Storage.UploadFile("manuelteklifpolice", fileTeklifName, model.fileTeklif.InputStream);
                        }


                        #endregion

                        #region ReasurorGenel 
                        reasurorGenel.DisKaynakKodu = !String.IsNullOrEmpty(model.DisKaynakKodu) ? Convert.ToInt32(model.DisKaynakKodu) : reasurorGenel.DisKaynakKodu;
                        reasurorGenel.DovizTuru = model.ParaBirimi;
                        reasurorGenel.PdfTeklifDosyasi = urlTeklif == null ? reasurorGenel.PdfTeklifDosyasi : urlTeklif;
                        reasurorGenel.PoliceBaslangicSaat = model.PoliceBaslangicSaat;
                        reasurorGenel.PoliceBaslangicTarihi = model.BaslangicTarihi;
                        reasurorGenel.PoliceBitisSaat = model.PoliceBitisSaat;
                        reasurorGenel.PoliceBitisTarihi = model.BitisTarihi;
                        reasurorGenel.SatisKanaliKodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : reasurorGenel.SatisKanaliKodu;
                        reasurorGenel.SigortaSirketiKodu = !String.IsNullOrEmpty(model.SigortaSirketiKodu) ? Convert.ToInt32(model.SigortaSirketiKodu) : reasurorGenel.SigortaSirketiKodu;
                        reasurorGenel.TVMKodu = _AktifKullaniciService.TVMKodu;
                        reasurorGenel.YurtdisiPoliceNo = model.YurtdisiPoliceNo;
                        reasurorGenel.Aciklama = model.Aciklama;

                        reasurorGenel.BransKodu = !String.IsNullOrEmpty(model.BransKodu) ? Convert.ToInt32(model.BransKodu) : reasurorGenel.BransKodu;
                        if (model.ParaBirimi != "TL")
                        {
                            // dövizliler
                            reasurorGenel.DovizKur = Convert.ToDecimal(model.DovizKuru);
                            reasurorGenel.FrontingSigortaSirketiKomisyon = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon);
                            reasurorGenel.SatisKanaliKomisyon = Convert.ToDecimal(model.SatisKanaliKomisyon);
                            reasurorGenel.TeminatTutari = Convert.ToDecimal(model.TeminatTutari);
                            reasurorGenel.YurtdisiAlinanKomisyon = Convert.ToDecimal(model.YurtdisiAlinanKomisyon);
                            reasurorGenel.YurtdisiDisKaynakKomisyon = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon);
                            reasurorGenel.YurtdisiNetPrim = Convert.ToDecimal(model.YurtdisiNetPrim);
                            reasurorGenel.YurtdisiPrim = Convert.ToDecimal(model.YurtdisiPrim);
                            reasurorGenel.YurticiAlinanKomisyon = Convert.ToDecimal(model.YurticiAlinanKomisyon);
                            reasurorGenel.YurticiBrutPrim = Convert.ToDecimal(model.YurticiBrutPrim);
                            reasurorGenel.YurticiNetPrim = Convert.ToDecimal(model.YurticiNetPrim);
                            reasurorGenel.Bsmv = Convert.ToDecimal(model.YurticiNetPrim) * Convert.ToDecimal("0,05");

                            // tl 
                            reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyonTL);
                            reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyonTL);
                            reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutariTL);
                            reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyonTL);
                            reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyonTL);
                            reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrimTL);
                            reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrimTL);
                            reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyonTL);
                            reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrimTL);
                            reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrimTL);
                            reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrimTL) * Convert.ToDecimal("0,05");
                        }
                        else
                        {
                            reasurorGenel.FrontingSigortaSirketiKomisyonTL = Convert.ToDecimal(model.FrontingSigortaSirketiKomisyon);
                            reasurorGenel.SatisKanaliKomisyonTL = Convert.ToDecimal(model.SatisKanaliKomisyon);
                            reasurorGenel.TeminatTutariTL = Convert.ToDecimal(model.TeminatTutari);
                            reasurorGenel.YurtdisiAlinanKomisyonTL = Convert.ToDecimal(model.YurtdisiAlinanKomisyon);
                            reasurorGenel.YurtdisiDisKaynakKomisyonTL = Convert.ToDecimal(model.YurtdisiDisKaynakKomisyon);
                            reasurorGenel.YurtdisiNetPrimTL = Convert.ToDecimal(model.YurtdisiNetPrim);
                            reasurorGenel.YurtdisiPrimTL = Convert.ToDecimal(model.YurtdisiPrim);
                            reasurorGenel.YurticiAlinanKomisyonTL = Convert.ToDecimal(model.YurticiAlinanKomisyon);
                            reasurorGenel.YurticiBrutPrimTL = Convert.ToDecimal(model.YurticiBrutPrim);
                            reasurorGenel.YurticiNetPrimTL = Convert.ToDecimal(model.YurticiNetPrim);
                            reasurorGenel.BsmvTL = Convert.ToDecimal(model.YurticiNetPrim) * Convert.ToDecimal("0,05");

                        }
                        _TeklifService.UpdateReasurorGenel(reasurorGenel);

                        #endregion

                        #region Underwriters

                        var uwSilResult = _TeklifService.deleteUnderwriters("", reasurorGenel.Teklif_ID.ToString());

                        List<Underwriters> uws = new List<Underwriters>();
                        Underwriters uw = new Underwriters();
                        if (model.UnderwriterSatirlar != null)
                        {
                            if (model.UnderwriterSatirlar.Count > 0 && model.UnderwriterSayisi > 0)
                            {
                                foreach (var item in model.UnderwriterSatirlar)
                                {
                                    var uwData = item.UnderwriterAdi.Split('|');
                                    uw = new Underwriters();
                                    uw.UnderwriterKodu = uwData[0];
                                    uw.UnderwriterAdi = uwData[1];
                                    uw.UnderwriterAdi = item.UnderwriterAdi;
                                    uw.UnderwriterPayOrani = item.UnderwriterPayOrani;
                                    uw.UnderwriterPrim = item.UnderwriterPrim;
                                    uw.UnderwriterKomisyon = item.UnderwriterKomisyon;
                                    uw.UnderwriterKomisyonOrani = item.UnderwriterKomisyonOrani;
                                    uw.PoliceId = model.PoliceId.Value;
                                    uw.TeklifId = reasurorGenel.Teklif_ID;
                                    uws.Add(uw);
                                }
                            }
                            if (uws.Count > 0)
                            {
                                var uwsResult = _TeklifService.CreateUnderwriters(uws);
                            }
                        }
                        #endregion
                    }
                }

                catch (Exception ex)
                {
                    model.IslemMesaji = "Teklif Güncelleme aşamadında bir hata oluştu." + ex.ToString();
                    return Json(new { HataMesaji = model.IslemMesaji });
                }
            }
            else
            {
                model.IslemMesaji = "Lütfen zorunlu alanları doldurunuz.";
            }

            return Json(new { HataMesaji = model.IslemMesaji });
        }



        [AjaxException]
        public ActionResult GetTeklifAraReasurorPartial(TeklifAraReasurorPartialModel model)
        {
            Boolean cariHesapVarMi = false;
            ManuelTeklifPoliceGirisi policeModel = new ManuelTeklifPoliceGirisi();
            try
            {
                policeModel.UnderwriterSayisi = 0;
                int _tvmkodu = !String.IsNullOrEmpty(model.TVMKodu) ? Convert.ToInt32(model.TVMKodu) : 0;

                var teklifDetay = _TeklifService.getTeklifReasuror(model.TeklifNo, model.SigortaSirketiKodu, _tvmkodu);

                if (teklifDetay != null)
                {
                    policeModel.PoliceTipi = 1;
                    policeModel.durum = 1;
                    policeModel.TVMKodu = teklifDetay.GenelBilgiler.TVMKodu.ToString();
                    if (teklifDetay.GenelBilgiler.TUMKodu.ToString().Count() < 2)
                    {
                        policeModel.SigortaSirketiKodu = "00" + teklifDetay.GenelBilgiler.TUMKodu.ToString();
                    }
                    else if (teklifDetay.GenelBilgiler.TUMKodu.ToString().Count() < 3)
                    {
                        policeModel.SigortaSirketiKodu = "0" + teklifDetay.GenelBilgiler.TUMKodu.ToString();
                    }
                    else
                    {
                        policeModel.SigortaSirketiKodu = teklifDetay.GenelBilgiler.TUMKodu.ToString();
                    }
                    policeModel.BransKodu = teklifDetay.GenelBilgiler.UrunKodu.ToString();
                    if (teklifDetay.GenelBilgiler.TUMTeklifNo != null)
                        policeModel.PoliceNo = teklifDetay.GenelBilgiler.TUMTeklifNo.ToString();

                    policeModel.bTarihi = teklifDetay.GenelBilgiler.BaslamaTarihi.ToString("dd.MM.yyyy");
                    policeModel.bitTarihi = teklifDetay.GenelBilgiler.BitisTarihi.ToString("dd.MM.yyyy");
                    policeModel.tTarihi = teklifDetay.GenelBilgiler.TanzimTarihi.ToString("dd.MM.yyyy");


                    var reasurorGenel = _TeklifService.getReasurorGenel("", teklifDetay.GenelBilgiler.TeklifId.ToString());
                    policeModel.sistemTeklifNo = teklifDetay.GenelBilgiler.TeklifNo.ToString();
                    policeModel.TeklifId = teklifDetay.GenelBilgiler.TeklifId;
                    policeModel.ParaBirimi = reasurorGenel.DovizTuru;
                    policeModel.YurtdisiPoliceNo = reasurorGenel.YurtdisiPoliceNo;
                    policeModel.PoliceBaslangicSaat = reasurorGenel.PoliceBaslangicSaat;
                    policeModel.PoliceBitisSaat = reasurorGenel.PoliceBitisSaat;
                    policeModel.DisKaynakKodu = reasurorGenel.DisKaynakKodu.ToString();
                    policeModel.Aciklama = reasurorGenel.Aciklama;
                    policeModel.BransKodu = reasurorGenel.BransKodu.ToString();
                    policeModel.TeklifUrl = reasurorGenel.PdfTeklifDosyasi;
                    if (reasurorGenel.DovizTuru != "TL")
                    {
                        //doviz
                        policeModel.DovizKuru = reasurorGenel.DovizKur.HasValue ? reasurorGenel.DovizKur.Value.ToString().Replace(',', '.') : "";
                        policeModel.FrontingSigortaSirketiKomisyon = reasurorGenel.FrontingSigortaSirketiKomisyon.HasValue ? reasurorGenel.FrontingSigortaSirketiKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.SatisKanaliKomisyon = reasurorGenel.SatisKanaliKomisyon.HasValue ? reasurorGenel.SatisKanaliKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.TeminatTutari = reasurorGenel.TeminatTutari.HasValue ? reasurorGenel.TeminatTutari.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiAlinanKomisyon = reasurorGenel.YurtdisiAlinanKomisyon.HasValue ? reasurorGenel.YurtdisiAlinanKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiDisKaynakKomisyon = reasurorGenel.YurtdisiDisKaynakKomisyon.HasValue ? reasurorGenel.YurtdisiDisKaynakKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiNetPrim = reasurorGenel.YurtdisiNetPrim.HasValue ? reasurorGenel.YurtdisiNetPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiPrim = reasurorGenel.YurtdisiPrim.HasValue ? reasurorGenel.YurtdisiPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiAlinanKomisyon = reasurorGenel.YurticiAlinanKomisyon.HasValue ? reasurorGenel.YurticiAlinanKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiBrutPrim = reasurorGenel.YurticiBrutPrim.HasValue ? reasurorGenel.YurticiBrutPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiNetPrim = reasurorGenel.YurticiNetPrim.HasValue ? reasurorGenel.YurticiNetPrim.Value.ToString().Replace(',', '.') : "";
                        //policeModel.Bsmv = reasurorGenel.Bsmv.HasValue ? reasurorGenel.Bsmv.Value.ToString().Replace(',', '.') : "";

                        // tl 
                        policeModel.FrontingSigortaSirketiKomisyonTL = reasurorGenel.FrontingSigortaSirketiKomisyonTL.HasValue ? reasurorGenel.FrontingSigortaSirketiKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.SatisKanaliKomisyonTL = reasurorGenel.SatisKanaliKomisyonTL.HasValue ? reasurorGenel.SatisKanaliKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.TeminatTutariTL = reasurorGenel.TeminatTutariTL.HasValue ? reasurorGenel.TeminatTutariTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiAlinanKomisyonTL = reasurorGenel.YurtdisiAlinanKomisyonTL.HasValue ? reasurorGenel.YurtdisiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiDisKaynakKomisyonTL = reasurorGenel.YurtdisiDisKaynakKomisyonTL.HasValue ? reasurorGenel.YurtdisiDisKaynakKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiNetPrimTL = reasurorGenel.YurtdisiNetPrimTL.HasValue ? reasurorGenel.YurtdisiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiPrimTL = reasurorGenel.YurtdisiPrimTL.HasValue ? reasurorGenel.YurtdisiPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiAlinanKomisyonTL = reasurorGenel.YurticiAlinanKomisyonTL.HasValue ? reasurorGenel.YurticiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiBrutPrimTL = reasurorGenel.YurticiBrutPrimTL.HasValue ? reasurorGenel.YurticiBrutPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiNetPrimTL = reasurorGenel.YurticiNetPrimTL.HasValue ? reasurorGenel.YurticiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        //policeModel.BsmvTL = reasurorGenel.BsmvTL.HasValue ? reasurorGenel.BsmvTL.Value.ToString().Replace(',', '.') : "";
                    }
                    else
                    {
                        // para birimi türk lirası 
                        policeModel.FrontingSigortaSirketiKomisyon = reasurorGenel.FrontingSigortaSirketiKomisyonTL.HasValue ? reasurorGenel.FrontingSigortaSirketiKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.SatisKanaliKomisyon = reasurorGenel.SatisKanaliKomisyonTL.HasValue ? reasurorGenel.SatisKanaliKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.TeminatTutari = reasurorGenel.TeminatTutariTL.HasValue ? reasurorGenel.TeminatTutariTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiAlinanKomisyon = reasurorGenel.YurtdisiAlinanKomisyonTL.HasValue ? reasurorGenel.YurtdisiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiDisKaynakKomisyon = reasurorGenel.YurtdisiDisKaynakKomisyonTL.HasValue ? reasurorGenel.YurtdisiDisKaynakKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiNetPrim = reasurorGenel.YurtdisiNetPrimTL.HasValue ? reasurorGenel.YurtdisiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiPrim = reasurorGenel.YurtdisiPrimTL.HasValue ? reasurorGenel.YurtdisiPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiAlinanKomisyon = reasurorGenel.YurticiAlinanKomisyonTL.HasValue ? reasurorGenel.YurticiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiBrutPrim = reasurorGenel.YurticiBrutPrimTL.HasValue ? reasurorGenel.YurticiBrutPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiNetPrim = reasurorGenel.YurticiNetPrimTL.HasValue ? reasurorGenel.YurticiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        //policeModel.Bsmv = reasurorGenel.BsmvTL.HasValue ? reasurorGenel.BsmvTL.Value.ToString().Replace(',', '.') : "";

                    }
                    if (teklifDetay.GenelBilgiler.BrutPrim.HasValue)
                    {
                        if (teklifDetay.GenelBilgiler.BrutPrim < 0)
                        {
                            policeModel.PoliceTipi = 0;
                        }
                    }

                    var policeSigortali = teklifDetay.GenelBilgiler.TeklifSigortalis.FirstOrDefault();
                    if (policeSigortali != null)
                    {
                        policeModel.Sigortali = new Sigortali();
                        policeModel.Sigortali.Adi = policeSigortali.MusteriGenelBilgiler.AdiUnvan;
                        policeModel.Sigortali.Soyadi = policeSigortali.MusteriGenelBilgiler.SoyadiUnvan;
                        policeModel.Sigortali.KimlikNo = policeSigortali.MusteriGenelBilgiler.KimlikNo;

                        policeModel.Sigortali.Telefon = policeSigortali.MusteriGenelBilgiler.MusteriTelefons.FirstOrDefault() != null ? policeSigortali.MusteriGenelBilgiler.MusteriTelefons.FirstOrDefault().Numara : "";
                        policeModel.Sigortali.Adres = policeSigortali.MusteriGenelBilgiler.MusteriAdres.FirstOrDefault() != null ? policeSigortali.MusteriGenelBilgiler.MusteriAdres.FirstOrDefault().Adres : "";

                    }

                    var policeSigortaEttiren = teklifDetay.GenelBilgiler.TeklifSigortaEttirens.FirstOrDefault();
                    if (policeSigortaEttiren != null)
                    {
                        policeModel.SigortaEttiren = new SigortaEttiren();
                        policeModel.SigortaEttiren.Adi = policeSigortaEttiren.MusteriGenelBilgiler.AdiUnvan;
                        policeModel.SigortaEttiren.Soyadi = policeSigortaEttiren.MusteriGenelBilgiler.SoyadiUnvan;
                        policeModel.SigortaEttiren.KimlikNo = policeSigortaEttiren.MusteriGenelBilgiler.KimlikNo;
                        policeModel.SigortaEttiren.Telefon = policeSigortaEttiren.MusteriGenelBilgiler.MusteriTelefons.FirstOrDefault() != null ? policeSigortaEttiren.MusteriGenelBilgiler.MusteriTelefons.FirstOrDefault().Numara : "";
                        policeModel.SigortaEttiren.Adres = policeSigortaEttiren.MusteriGenelBilgiler.MusteriAdres.FirstOrDefault() != null ? policeSigortaEttiren.MusteriGenelBilgiler.MusteriAdres.FirstOrDefault().Adres : "";

                    }
                    if (policeModel.Sigortali.KimlikNo != policeModel.SigortaEttiren.KimlikNo)
                    {
                        policeModel.SigortaliSigortaEttirenAynimi = false;
                    }
                    else
                    {
                        policeModel.SigortaliSigortaEttirenAynimi = true;
                    }
                    var odemeSekli = teklifDetay.GenelBilgiler.OdemeSekli;
                    if (odemeSekli.HasValue)
                    {
                        if (odemeSekli.Value == 1)
                        {
                            policeModel.OdemeSekli = true;
                        }
                        else
                        {
                            policeModel.OdemeSekli = false;
                        }
                    }

                    if (teklifDetay.OdemePlani.Count > 0)
                    {
                        foreach (var item in teklifDetay.OdemePlani)
                        {
                            if (item.OdemeTipi.HasValue)
                            {
                                policeModel.OdemeTipi = item.OdemeTipi.Value;
                            }
                        }
                    }
                    if (teklifDetay.OdemePlani != null)
                    {
                        policeModel.TaksitSayisi = Convert.ToByte(teklifDetay.OdemePlani.Count);
                    }
                    if (teklifDetay.OdemePlani.Count > 1)
                    {
                        List<TaksitModel> taksitList = new List<TaksitModel>();
                        TaksitModel tModel = new TaksitModel();
                        foreach (var item in teklifDetay.OdemePlani)
                        {
                            tModel = new TaksitModel();
                            tModel.TaksitNo = item.TaksitNo;
                            tModel.TaksitTutariTL = item.TaksitTutari.HasValue ? item.TaksitTutari.Value.ToString().Replace(',', '.') : "";
                            tModel.VadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.ToString("dd/MM/yyyy") : "";
                            if (reasurorGenel.DovizTuru != "TL")
                            {
                                tModel.TaksitTutari = item.DovizliTaksitTutari.HasValue ? item.DovizliTaksitTutari.ToString().Replace(',', '.') : "";
                            }
                            taksitList.Add(tModel);
                        }

                        policeModel.TaksitSatirlar = taksitList;
                    }
                    // carihesabı açılmış mı kontrol ediyoruz. Eğer açılmışsa ekranda tc değiştirmesini kapatıyoruz.
                    var cariHesap = _Muhasebe_CariHesapService.GetCariHesap("120.01." + policeModel.SigortaEttiren.KimlikNo);
                    if (cariHesap != null)
                    {
                        cariHesapVarMi = true;
                    }
                    else
                    {
                        cariHesapVarMi = false;
                    }
                    //underwriter
                    var uws = _TeklifService.getUnderwriters("", teklifDetay.GenelBilgiler.TeklifId.ToString());
                    if (uws.Count > 0)
                    {
                        policeModel.UnderwriterSayisi = Convert.ToByte(uws.Count());
                        policeModel.UnderwriterSatirlar = new List<UnderwriterModel>();

                        UnderwriterModel uwm = new UnderwriterModel();
                        for (int i = 0; i < uws.Count; i++)
                        {
                            uwm = new UnderwriterModel();
                            uwm.UnderwriterAdi = uws[i].UnderwriterAdi;
                            uwm.UnderwriterPayOrani = uws[i].UnderwriterPayOrani;
                            policeModel.UnderwriterSatirlar.Add(uwm);
                        }

                    }

                }
            }
            catch (Exception ex)
            {
                policeModel.IslemMesaji = "Poliçe görüntüleme işleminde bir hata oluştu." + ex.Message.ToString();
                return Json(new { success = true, data = policeModel, cariHesapVarMi = cariHesapVarMi }, JsonRequestBehavior.AllowGet);
            }
            return Json(new { success = true, data = policeModel, cariHesapVarMi = cariHesapVarMi }, JsonRequestBehavior.AllowGet);
        }


        [AjaxException]
        public ActionResult GetPoliceAraReasurorPartial(PoliceAraReasurorPartialModel model)
        {
            Boolean cariHesapVarMi = false;
            ManuelTeklifPoliceGirisi policeModel = new ManuelTeklifPoliceGirisi();
            try
            {
                policeModel.UnderwriterSayisi = 0;
                var policeDetay = _PoliceService.getManuelPolice(model.SigortaSirketiKodu, model.PoliceNo, model.EkNo, model.YenilemeNo, Convert.ToInt32(model.BransKodu));

                if (policeDetay != null)
                {
                    policeModel.PoliceTipi = 1;
                    policeModel.PoliceId = policeDetay.PoliceId;
                    policeModel.DisKaynakKodu = policeDetay.UretimTaliAcenteKodu.HasValue ? policeDetay.UretimTaliAcenteKodu.ToString() : "";
                    policeModel.TVMKodu = policeDetay.TaliAcenteKodu.HasValue ? policeDetay.TaliAcenteKodu.ToString() : "";

                    if (policeDetay.TUMBirlikKodu.Count() < 2)
                    {
                        policeModel.SigortaSirketiKodu = "00" + policeDetay.TUMBirlikKodu;
                    }
                    else if (policeDetay.TUMBirlikKodu.Count() < 3)
                    {
                        policeModel.SigortaSirketiKodu = "0" + policeDetay.TUMBirlikKodu;
                    }
                    else
                    {
                        policeModel.SigortaSirketiKodu = policeDetay.TUMBirlikKodu;
                    }
                    policeModel.BransKodu = policeDetay.BransKodu.HasValue ? policeDetay.BransKodu.Value.ToString() : "";
                    policeModel.PoliceNo = policeDetay.PoliceNumarasi;
                    policeModel.YenilemeNo = policeDetay.YenilemeNo.HasValue ? policeDetay.YenilemeNo.Value : 0;
                    policeModel.EkNo = policeDetay.EkNo.HasValue ? policeDetay.EkNo.Value : 0;

                    policeModel.bTarihi = policeDetay.BaslangicTarihi.HasValue ? policeDetay.BaslangicTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
                    policeModel.bitTarihi = policeDetay.BitisTarihi.HasValue ? policeDetay.BitisTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
                    policeModel.tTarihi = policeDetay.TanzimTarihi.HasValue ? policeDetay.TanzimTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
                    policeModel.ParaBirimi = policeDetay.ParaBirimi;
                    var reasurorGenel = _TeklifService.getReasurorGenel(policeDetay.PoliceId.ToString(), "");
                    policeModel.YurtdisiPoliceNo = reasurorGenel.YurtdisiPoliceNo;
                    policeModel.PoliceBaslangicSaat = reasurorGenel.PoliceBaslangicSaat;
                    policeModel.PoliceBitisSaat = reasurorGenel.PoliceBitisSaat;
                    policeModel.DisKaynakKodu = reasurorGenel.DisKaynakKodu.ToString();
                    policeModel.TeklifId = reasurorGenel.Teklif_ID;
                    policeModel.Aciklama = reasurorGenel.Aciklama;
                    policeModel.PoliceUrl = reasurorGenel.PdfPoliceDosyasi;
                    policeModel.CreditNoteUrl = reasurorGenel.PdfPoliceCreditNote;
                    policeModel.DebitNoteUrl = reasurorGenel.PdfPoliceDebitNote;
                    policeModel.MuhasebeyeAktarildiMi = policeDetay.MuhasebeyeAktarildiMi;
                    if (reasurorGenel.DovizTuru != "TL")
                    {
                        //doviz
                        policeModel.DovizKuru = reasurorGenel.DovizKur.HasValue ? reasurorGenel.DovizKur.Value.ToString().Replace(',', '.') : "";
                        policeModel.FrontingSigortaSirketiKomisyon = reasurorGenel.FrontingSigortaSirketiKomisyon.HasValue ? reasurorGenel.FrontingSigortaSirketiKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.SatisKanaliKomisyon = reasurorGenel.SatisKanaliKomisyon.HasValue ? reasurorGenel.SatisKanaliKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.TeminatTutari = reasurorGenel.TeminatTutari.HasValue ? reasurorGenel.TeminatTutari.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiAlinanKomisyon = reasurorGenel.YurtdisiAlinanKomisyon.HasValue ? reasurorGenel.YurtdisiAlinanKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiDisKaynakKomisyon = reasurorGenel.YurtdisiDisKaynakKomisyon.HasValue ? reasurorGenel.YurtdisiDisKaynakKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiNetPrim = reasurorGenel.YurtdisiNetPrim.HasValue ? reasurorGenel.YurtdisiNetPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiBrokerNetPrim = reasurorGenel.YurtdisiBrokerNetPrim.HasValue ? reasurorGenel.YurtdisiBrokerNetPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiPrim = reasurorGenel.YurtdisiPrim.HasValue ? reasurorGenel.YurtdisiPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiAlinanKomisyon = reasurorGenel.YurticiAlinanKomisyon.HasValue ? reasurorGenel.YurticiAlinanKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiBrutPrim = reasurorGenel.YurticiBrutPrim.HasValue ? reasurorGenel.YurticiBrutPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiNetPrim = reasurorGenel.YurticiNetPrim.HasValue ? reasurorGenel.YurticiNetPrim.Value.ToString().Replace(',', '.') : "";
                        //policeModel.Bsmv = reasurorGenel.Bsmv.HasValue ? reasurorGenel.Bsmv.Value.ToString().Replace(',', '.') : "";

                        // tl 
                        policeModel.FrontingSigortaSirketiKomisyonTL = reasurorGenel.FrontingSigortaSirketiKomisyonTL.HasValue ? reasurorGenel.FrontingSigortaSirketiKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.SatisKanaliKomisyonTL = reasurorGenel.SatisKanaliKomisyonTL.HasValue ? reasurorGenel.SatisKanaliKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.TeminatTutariTL = reasurorGenel.TeminatTutariTL.HasValue ? reasurorGenel.TeminatTutariTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiAlinanKomisyonTL = reasurorGenel.YurtdisiAlinanKomisyonTL.HasValue ? reasurorGenel.YurtdisiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiDisKaynakKomisyonTL = reasurorGenel.YurtdisiDisKaynakKomisyonTL.HasValue ? reasurorGenel.YurtdisiDisKaynakKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiNetPrimTL = reasurorGenel.YurtdisiNetPrimTL.HasValue ? reasurorGenel.YurtdisiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiBrokerNetPrimTL = reasurorGenel.YurtdisiBrokerNetPrimTL.HasValue ? reasurorGenel.YurtdisiBrokerNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiPrimTL = reasurorGenel.YurtdisiPrimTL.HasValue ? reasurorGenel.YurtdisiPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiAlinanKomisyonTL = reasurorGenel.YurticiAlinanKomisyonTL.HasValue ? reasurorGenel.YurticiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiBrutPrimTL = reasurorGenel.YurticiBrutPrimTL.HasValue ? reasurorGenel.YurticiBrutPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiNetPrimTL = reasurorGenel.YurticiNetPrimTL.HasValue ? reasurorGenel.YurticiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        //policeModel.BsmvTL = reasurorGenel.BsmvTL.HasValue ? reasurorGenel.BsmvTL.Value.ToString().Replace(',', '.') : "";
                    }
                    else
                    {
                        // para birimi türk lirası 
                        policeModel.FrontingSigortaSirketiKomisyon = reasurorGenel.FrontingSigortaSirketiKomisyonTL.HasValue ? reasurorGenel.FrontingSigortaSirketiKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.SatisKanaliKomisyon = reasurorGenel.SatisKanaliKomisyonTL.HasValue ? reasurorGenel.SatisKanaliKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.TeminatTutari = reasurorGenel.TeminatTutariTL.HasValue ? reasurorGenel.TeminatTutariTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiAlinanKomisyon = reasurorGenel.YurtdisiAlinanKomisyonTL.HasValue ? reasurorGenel.YurtdisiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiDisKaynakKomisyon = reasurorGenel.YurtdisiDisKaynakKomisyonTL.HasValue ? reasurorGenel.YurtdisiDisKaynakKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiNetPrim = reasurorGenel.YurtdisiNetPrimTL.HasValue ? reasurorGenel.YurtdisiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiBrokerNetPrim = reasurorGenel.YurtdisiBrokerNetPrimTL.HasValue ? reasurorGenel.YurtdisiBrokerNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiPrim = reasurorGenel.YurtdisiPrimTL.HasValue ? reasurorGenel.YurtdisiPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiAlinanKomisyon = reasurorGenel.YurticiAlinanKomisyonTL.HasValue ? reasurorGenel.YurticiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiBrutPrim = reasurorGenel.YurticiBrutPrimTL.HasValue ? reasurorGenel.YurticiBrutPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiNetPrim = reasurorGenel.YurticiNetPrimTL.HasValue ? reasurorGenel.YurticiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        //policeModel.Bsmv = reasurorGenel.BsmvTL.HasValue ? reasurorGenel.BsmvTL.Value.ToString().Replace(',', '.') : "";

                    }
                    if (policeDetay.BrutPrim.HasValue)
                    {
                        if (policeDetay.BrutPrim < 0)
                        {
                            policeModel.PoliceTipi = 0;
                        }
                    }

                    var policeSigortali = policeDetay.PoliceSigortali;
                    if (policeSigortali != null)
                    {
                        policeModel.Sigortali = new Sigortali();
                        policeModel.Sigortali.Adi = policeSigortali.AdiUnvan;
                        policeModel.Sigortali.Soyadi = policeSigortali.SoyadiUnvan;
                        if (policeSigortali.KimlikNo != null && policeSigortali.KimlikNo != "")
                        {
                            policeModel.Sigortali.KimlikNo = policeSigortali.KimlikNo;
                        }
                        else if (policeSigortali.VergiKimlikNo != null && policeSigortali.VergiKimlikNo != "")
                        {
                            policeModel.Sigortali.KimlikNo = policeSigortali.VergiKimlikNo;
                        }
                        policeModel.Sigortali.Telefon = policeSigortali.MobilTelefonNo;
                        policeModel.Sigortali.Adres = policeSigortali.Adres;

                    }
                    var policeSigortaEttiren = policeDetay.PoliceSigortaEttiren;
                    if (policeSigortaEttiren != null)
                    {
                        policeModel.SigortaEttiren = new SigortaEttiren();
                        policeModel.SigortaEttiren.Adi = policeSigortaEttiren.AdiUnvan;
                        policeModel.SigortaEttiren.Soyadi = policeSigortaEttiren.SoyadiUnvan;
                        if (policeSigortaEttiren.KimlikNo != null && policeSigortaEttiren.KimlikNo != "")
                        {
                            policeModel.SigortaEttiren.KimlikNo = policeSigortaEttiren.KimlikNo;
                        }
                        else if (policeSigortaEttiren.VergiKimlikNo != null && policeSigortaEttiren.VergiKimlikNo != "")
                        {
                            policeModel.SigortaEttiren.KimlikNo = policeSigortaEttiren.VergiKimlikNo;
                        }
                        policeModel.SigortaEttiren.Telefon = policeSigortaEttiren.MobilTelefonNo;
                        policeModel.SigortaEttiren.Adres = policeSigortaEttiren.Adres;
                    }
                    if (policeModel.Sigortali.KimlikNo != policeModel.SigortaEttiren.KimlikNo)
                    {
                        policeModel.SigortaliSigortaEttirenAynimi = false;
                    }
                    else
                    {
                        policeModel.SigortaliSigortaEttirenAynimi = true;
                    }
                    var policeArac = policeDetay.PoliceArac;
                    if (policeArac != null)
                    {
                        policeModel.PlakaKodu = policeArac.PlakaKodu;
                        policeModel.PlakaNumarasi = policeArac.PlakaNo;
                        policeModel.AsbisNo = policeArac.AsbisNo;
                        policeModel.TescilBelgeSeriKodu = policeArac.TescilSeriKod;
                        policeModel.TescilBelgeSeriNo = policeArac.TescilSeriNo;
                    }
                    var odemeSekli = policeDetay.OdemeSekli;
                    if (odemeSekli.HasValue)
                    {
                        if (odemeSekli.Value == 1)
                        {
                            policeModel.OdemeSekli = true;
                        }
                        else
                        {
                            policeModel.OdemeSekli = false;
                        }
                    }

                    if (policeDetay.PoliceOdemePlanis.Count > 0)
                    {
                        foreach (var item in policeDetay.PoliceOdemePlanis)
                        {
                            if (item.OdemeTipi.HasValue)
                            {
                                policeModel.OdemeTipi = item.OdemeTipi.Value;
                            }
                        }
                    }
                    if (policeDetay.PoliceOdemePlanis != null)
                    {
                        policeModel.TaksitSayisi = Convert.ToByte(policeDetay.PoliceOdemePlanis.Count);
                    }
                    if (policeDetay.PoliceOdemePlanis.Count > 1)
                    {
                        List<TaksitModel> taksitList = new List<TaksitModel>();
                        TaksitModel tModel = new TaksitModel();
                        foreach (var item in policeDetay.PoliceOdemePlanis)
                        {
                            tModel = new TaksitModel();
                            tModel.TaksitNo = item.TaksitNo;
                            tModel.TaksitTutariTL = item.TaksitTutari.HasValue ? item.TaksitTutari.Value.ToString().Replace(',', '.') : "";
                            tModel.VadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.ToString("dd/MM/yyyy") : "";
                            if (policeDetay.ParaBirimi != "TL")
                            {
                                tModel.TaksitTutari = item.DovizliTaksitTutari.HasValue ? item.DovizliTaksitTutari.ToString().Replace(',', '.') : "";
                            }
                            taksitList.Add(tModel);
                        }

                        policeModel.TaksitSatirlar = taksitList;
                    }
                    // carihesabı açılmış mı kontrol ediyoruz. Eğer açılmışsa ekranda tc değiştirmesini kapatıyoruz.
                    var cariHesap = _Muhasebe_CariHesapService.GetCariHesap("120.01." + policeModel.SigortaEttiren.KimlikNo);
                    if (cariHesap != null)
                    {
                        cariHesapVarMi = true;
                    }
                    else
                    {
                        cariHesapVarMi = false;
                    }
                    //underwriter
                    var uws = _TeklifService.getUnderwriters(policeDetay.PoliceId.ToString(), "");
                    if (uws.Count > 0)
                    {
                        policeModel.UnderwriterSayisi = Convert.ToByte(uws.Count());
                        policeModel.UnderwriterSatirlar = new List<UnderwriterModel>();

                        UnderwriterModel uwm = new UnderwriterModel();
                        for (int i = 0; i < uws.Count; i++)
                        {
                            uwm = new UnderwriterModel();
                            uwm.UnderwriterAdi = uws[i].UnderwriterAdi;
                            uwm.UnderwriterPayOrani = uws[i].UnderwriterPayOrani;
                            uwm.UnderwriterPrim = uws[i].UnderwriterPrim;
                            uwm.UnderwriterKomisyon = uws[i].UnderwriterKomisyon;
                            uwm.UnderwriterKomisyonOrani = uws[i].UnderwriterKomisyonOrani;
                            uwm.UnderwriterKodu = uws[i].UnderwriterKodu;
                            policeModel.UnderwriterSatirlar.Add(uwm);
                        }

                    }
                }
            }
            catch (Exception ex)
            {
                policeModel.IslemMesaji = "Poliçe görüntüleme işleminde bir hata oluştu." + ex.Message.ToString();
                return Json(new { success = true, data = policeModel, cariHesapVarMi = cariHesapVarMi }, JsonRequestBehavior.AllowGet);
            }
            return Json(new { success = true, data = policeModel, cariHesapVarMi = cariHesapVarMi }, JsonRequestBehavior.AllowGet);
        }

        [AjaxException]
        public ActionResult GetPoliceAraReasurorCariHareketGiris(PoliceAraReasurorCariHareketGirisModel model)
        {
            Boolean cariHesapVarMi = false;
            PoliceAraReasurorCariHareketGirisiModel policeModel = new PoliceAraReasurorCariHareketGirisiModel();
            try
            {
                policeModel.UnderwriterSayisi = 0;
                var policeDetay = _PoliceService.getManuelPolice(model.PoliceNo, model.EkNo, model.YenilemeNo);

                if (policeDetay != null)
                {
                    policeModel.PoliceTipi = 1;
                    policeModel.PoliceId = policeDetay.PoliceId;
                    policeModel.DisKaynakKodu = policeDetay.UretimTaliAcenteKodu.HasValue ? policeDetay.UretimTaliAcenteKodu.ToString() : "";
                    policeModel.TVMKodu = policeDetay.TaliAcenteKodu.HasValue ? policeDetay.TaliAcenteKodu.ToString() : "";

                    if (policeDetay.TUMBirlikKodu.Count() < 2)
                    {
                        policeModel.SigortaSirketiKodu = "00" + policeDetay.TUMBirlikKodu;
                    }
                    else if (policeDetay.TUMBirlikKodu.Count() < 3)
                    {
                        policeModel.SigortaSirketiKodu = "0" + policeDetay.TUMBirlikKodu;
                    }
                    else
                    {
                        policeModel.SigortaSirketiKodu = policeDetay.TUMBirlikKodu;
                    }
                    policeModel.BransKodu = policeDetay.BransKodu.HasValue ? policeDetay.BransKodu.Value.ToString() : "";
                    policeModel.PoliceNo = policeDetay.PoliceNumarasi;
                    policeModel.YenilemeNo = policeDetay.YenilemeNo.HasValue ? policeDetay.YenilemeNo.Value : 0;
                    policeModel.EkNo = policeDetay.EkNo.HasValue ? policeDetay.EkNo.Value : 0;

                    policeModel.bTarihi = policeDetay.BaslangicTarihi.HasValue ? policeDetay.BaslangicTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
                    policeModel.bitTarihi = policeDetay.BitisTarihi.HasValue ? policeDetay.BitisTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
                    policeModel.tTarihi = policeDetay.TanzimTarihi.HasValue ? policeDetay.TanzimTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
                    policeModel.ParaBirimi = policeDetay.ParaBirimi;
                    var reasurorGenel = _TeklifService.getReasurorGenel(policeDetay.PoliceId.ToString(), "");
                    policeModel.YurtdisiPoliceNo = reasurorGenel.YurtdisiPoliceNo;
                    policeModel.PoliceBaslangicSaat = reasurorGenel.PoliceBaslangicSaat;
                    policeModel.PoliceBitisSaat = reasurorGenel.PoliceBitisSaat;
                    policeModel.DisKaynakKodu = reasurorGenel.DisKaynakKodu.ToString();
                    policeModel.TeklifId = reasurorGenel.Teklif_ID;
                    policeModel.Aciklama = reasurorGenel.Aciklama;
                    policeModel.MuhasebeyeAktarildiMi = policeDetay.MuhasebeyeAktarildiMi;
                    if (reasurorGenel.DovizTuru != "TL")
                    {
                        policeModel.DovizKuru = reasurorGenel.DovizKur.HasValue ? reasurorGenel.DovizKur.Value.ToString().Replace('.', ',') : "";
                    }
                    if (policeDetay.PoliceOdemePlanis.Count > 1)
                    {
                        List<TaksitModel> taksitList = new List<TaksitModel>();
                        TaksitModel tModel = new TaksitModel();
                        foreach (var item in policeDetay.PoliceOdemePlanis)
                        {
                            tModel = new TaksitModel();
                            tModel.TaksitNo = item.TaksitNo;
                            tModel.TaksitTutariTL = item.TaksitTutari.HasValue ? item.TaksitTutari.Value.ToString().Replace(',', '.') : "";
                            tModel.VadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.ToString("dd/MM/yyyy") : "";
                            if (policeDetay.ParaBirimi != "TL")
                            {
                                tModel.TaksitTutari = item.DovizliTaksitTutari.HasValue ? item.DovizliTaksitTutari.ToString().Replace(',', '.') : "";
                            }
                            taksitList.Add(tModel);
                        }

                        policeModel.TaksitSatirlar = taksitList;
                    }

                    //underwriter
                    if (model.AramaTuru == 0)
                    {
                        var uws = _TeklifService.getUnderwriters(policeDetay.PoliceId.ToString(), "");
                        List<PoliceYaslandirmaTablosuModelItem> tempUWCariHareketList = null;
                        List<CariHareketleri> cariHareketleris = _Muhasebe_CariHesapService.YaslandirmaTablosuCariHesaplari(model.PoliceNo + "-" + model.YenilemeNo + "-" + model.EkNo);
                        if (uws.Count > 0)
                        {
                            policeModel.UnderwriterSayisi = Convert.ToByte(uws.Count());
                            policeModel.UwVarmi = true;
                            policeModel.UWBrokerList = new List<PoliceYaslandirmaTablosuModelItem>();
                            PoliceYaslandirmaTablosuModelItem uwm = null;
                            decimal[] temptaksit = null;
                            decimal temptutar = 0;
                            foreach (var itemUW in uws)
                            {
                                var tempuwkod = "[" + itemUW.UnderwriterKodu + "]";
                                var cariHareketVarmi = cariHareketleris.Where(x => x.EvrakNo.Contains(tempuwkod)).ToList();
                                tempUWCariHareketList = new List<PoliceYaslandirmaTablosuModelItem>();
                                foreach (var item in cariHareketVarmi)
                                {
                                    var temp2 = item.Aciklama.Split('-').Where(x => x.Contains("Taksit")).FirstOrDefault();
                                    if (temp2 != null)
                                    {
                                        temp2 = temp2.Replace("Taksit", "").Replace(".", "");
                                        if (int.TryParse(temp2, out int tempTaksitNo))
                                            tempUWCariHareketList.Add(new PoliceYaslandirmaTablosuModelItem { TaksitNo = tempTaksitNo });
                                    }
                                }
                                int i = 0;
                                foreach (var item2 in policeModel.TaksitSatirlar)
                                {
                                    i++;
                                    if (tempUWCariHareketList.Count > 0)
                                        if (tempUWCariHareketList.Where(x => x.TaksitNo == i).FirstOrDefault() != null)
                                            continue;
                                    uwm = new PoliceYaslandirmaTablosuModelItem();
                                    uwm.ReasurorAd = itemUW.UnderwriterAdi;
                                    uwm.UwKodu = itemUW.UnderwriterKodu;
                                    uwm.TaksitNo = i;
                                    uwm.TaksitAdet = policeModel.TaksitSatirlar.Count;

                                    temptaksit = Utils.TaksitDuzenle(itemUW.UnderwriterKomisyon.Value, policeModel.TaksitSatirlar.Count);
                                    temptutar = temptaksit[0];
                                    if (i == policeModel.TaksitSatirlar.Count)
                                    {
                                        temptutar = temptaksit[1];
                                    }
                                    uwm.AlinanKomisyon = temptutar;
                                    uwm.ToplamAlinanKomisyon = itemUW.UnderwriterKomisyon.Value;
                                    policeModel.UWBrokerList.Add(uwm);
                                }
                            }
                        }
                    }
                    else
                    {
                        policeModel.UwVarmi = false;
                        policeModel.UWBrokerList = new List<PoliceYaslandirmaTablosuModelItem>();
                        PoliceYaslandirmaTablosuModelItem uwm = null;
                        int i = 0;
                        decimal[] temptaksit = null; decimal temptutar = 0, toplamtutar = 0;
                        if (policeDetay.ParaBirimi.Trim() != "TL")
                        {
                            temptaksit = Utils.TaksitDuzenle(reasurorGenel.YurtdisiDisKaynakKomisyon.Value, policeModel.TaksitSatirlar.Count);
                            toplamtutar = reasurorGenel.YurtdisiDisKaynakKomisyon.Value;
                        }
                        else
                        {
                            temptaksit = Utils.TaksitDuzenle(reasurorGenel.YurtdisiDisKaynakKomisyonTL.Value, policeModel.TaksitSatirlar.Count);
                            toplamtutar = reasurorGenel.YurtdisiDisKaynakKomisyonTL.Value;
                        }
                        temptutar = temptaksit[0];
                        foreach (var item in policeDetay.PoliceOdemePlanis)
                        {
                            i++;
                            if (i == policeModel.TaksitSatirlar.Count)
                            {
                                temptutar = temptaksit[1];
                            }
                            uwm = new PoliceYaslandirmaTablosuModelItem();
                            uwm.TaksitNo = i;
                            uwm.TaksitAdet = policeModel.TaksitSatirlar.Count;
                            uwm.AlinanKomisyon = temptutar;
                            uwm.ToplamAlinanKomisyon = toplamtutar;
                            policeModel.UWBrokerList.Add(uwm);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                policeModel.IslemMesaji = "Poliçe görüntüleme işleminde bir hata oluştu." + ex.Message.ToString();
                return Json(new { success = true, data = policeModel, cariHesapVarMi = cariHesapVarMi }, JsonRequestBehavior.AllowGet);
            }
            return Json(new { success = true, data = policeModel, cariHesapVarMi = cariHesapVarMi }, JsonRequestBehavior.AllowGet);
        }

        [AjaxException]
        public ActionResult GetPoliceEkiAraReasurorPartial(PoliceEkiReasurorAraPartialModel model)
        {
            Boolean cariHesapVarMi = false;
            ManuelTeklifPoliceGirisi policeModel = new ManuelTeklifPoliceGirisi();
            try
            {
                policeModel.UnderwriterSayisi = 0;
                var policeDetay = _PoliceService.getManuelPolice(model.SigortaSirketiKodu, model.PoliceNo, model.EkNo, model.YenilemeNo, Convert.ToInt32(model.BransKodu));

                if (policeDetay != null)
                {
                    policeModel.PoliceTipi = 1;
                    policeModel.PoliceId = policeDetay.PoliceId;
                    policeModel.DisKaynakKodu = policeDetay.UretimTaliAcenteKodu.HasValue ? policeDetay.UretimTaliAcenteKodu.ToString() : "";
                    policeModel.TVMKodu = policeDetay.TaliAcenteKodu.HasValue ? policeDetay.TaliAcenteKodu.ToString() : "";

                    if (policeDetay.TUMBirlikKodu.Count() < 2)
                    {
                        policeModel.SigortaSirketiKodu = "00" + policeDetay.TUMBirlikKodu;
                    }
                    else if (policeDetay.TUMBirlikKodu.Count() < 3)
                    {
                        policeModel.SigortaSirketiKodu = "0" + policeDetay.TUMBirlikKodu;
                    }
                    else
                    {
                        policeModel.SigortaSirketiKodu = policeDetay.TUMBirlikKodu;
                    }
                    policeModel.BransKodu = policeDetay.BransKodu.HasValue ? policeDetay.BransKodu.Value.ToString() : "";
                    policeModel.PoliceNo = policeDetay.PoliceNumarasi;
                    policeModel.YenilemeNo = policeDetay.YenilemeNo.HasValue ? policeDetay.YenilemeNo.Value : 0;
                    policeModel.EkNo = policeDetay.EkNo.HasValue ? policeDetay.EkNo.Value : 0;

                    policeModel.bTarihi = policeDetay.BaslangicTarihi.HasValue ? policeDetay.BaslangicTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
                    policeModel.bitTarihi = policeDetay.BitisTarihi.HasValue ? policeDetay.BitisTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
                    policeModel.tTarihi = policeDetay.TanzimTarihi.HasValue ? policeDetay.TanzimTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
                    policeModel.ParaBirimi = policeDetay.ParaBirimi;
                    var reasurorGenel = _TeklifService.getReasurorGenel(policeDetay.PoliceId.ToString(), "");
                    policeModel.YurtdisiPoliceNo = reasurorGenel.YurtdisiPoliceNo;
                    policeModel.PoliceBaslangicSaat = reasurorGenel.PoliceBaslangicSaat;
                    policeModel.PoliceBitisSaat = reasurorGenel.PoliceBitisSaat;
                    policeModel.DisKaynakKodu = reasurorGenel.DisKaynakKodu.ToString();
                    policeModel.TeklifId = reasurorGenel.Teklif_ID;
                    policeModel.Aciklama = reasurorGenel.Aciklama;
                    policeModel.PoliceUrl = reasurorGenel.PdfPoliceDosyasi;
                    policeModel.CreditNoteUrl = reasurorGenel.PdfPoliceCreditNote;
                    policeModel.DebitNoteUrl = reasurorGenel.PdfPoliceDebitNote;

                    if (reasurorGenel.DovizTuru != "TL")
                    {
                        //doviz
                        policeModel.DovizKuru = reasurorGenel.DovizKur.HasValue ? reasurorGenel.DovizKur.Value.ToString().Replace(',', '.') : "";
                        policeModel.FrontingSigortaSirketiKomisyon = reasurorGenel.FrontingSigortaSirketiKomisyon.HasValue ? reasurorGenel.FrontingSigortaSirketiKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.SatisKanaliKomisyon = reasurorGenel.SatisKanaliKomisyon.HasValue ? reasurorGenel.SatisKanaliKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.TeminatTutari = reasurorGenel.TeminatTutari.HasValue ? reasurorGenel.TeminatTutari.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiAlinanKomisyon = reasurorGenel.YurtdisiAlinanKomisyon.HasValue ? reasurorGenel.YurtdisiAlinanKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiDisKaynakKomisyon = reasurorGenel.YurtdisiDisKaynakKomisyon.HasValue ? reasurorGenel.YurtdisiDisKaynakKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiNetPrim = reasurorGenel.YurtdisiNetPrim.HasValue ? reasurorGenel.YurtdisiNetPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiPrim = reasurorGenel.YurtdisiPrim.HasValue ? reasurorGenel.YurtdisiPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiAlinanKomisyon = reasurorGenel.YurticiAlinanKomisyon.HasValue ? reasurorGenel.YurticiAlinanKomisyon.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiBrutPrim = reasurorGenel.YurticiBrutPrim.HasValue ? reasurorGenel.YurticiBrutPrim.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiNetPrim = reasurorGenel.YurticiNetPrim.HasValue ? reasurorGenel.YurticiNetPrim.Value.ToString().Replace(',', '.') : "";
                        //policeModel.Bsmv = reasurorGenel.Bsmv.HasValue ? reasurorGenel.Bsmv.Value.ToString().Replace(',', '.') : "";

                        // tl 
                        policeModel.FrontingSigortaSirketiKomisyonTL = reasurorGenel.FrontingSigortaSirketiKomisyonTL.HasValue ? reasurorGenel.FrontingSigortaSirketiKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.SatisKanaliKomisyonTL = reasurorGenel.SatisKanaliKomisyonTL.HasValue ? reasurorGenel.SatisKanaliKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.TeminatTutariTL = reasurorGenel.TeminatTutariTL.HasValue ? reasurorGenel.TeminatTutariTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiAlinanKomisyonTL = reasurorGenel.YurtdisiAlinanKomisyonTL.HasValue ? reasurorGenel.YurtdisiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiDisKaynakKomisyonTL = reasurorGenel.YurtdisiDisKaynakKomisyonTL.HasValue ? reasurorGenel.YurtdisiDisKaynakKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiNetPrimTL = reasurorGenel.YurtdisiNetPrimTL.HasValue ? reasurorGenel.YurtdisiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiPrimTL = reasurorGenel.YurtdisiPrimTL.HasValue ? reasurorGenel.YurtdisiPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiAlinanKomisyonTL = reasurorGenel.YurticiAlinanKomisyonTL.HasValue ? reasurorGenel.YurticiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiBrutPrimTL = reasurorGenel.YurticiBrutPrimTL.HasValue ? reasurorGenel.YurticiBrutPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiNetPrimTL = reasurorGenel.YurticiNetPrimTL.HasValue ? reasurorGenel.YurticiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        //policeModel.BsmvTL = reasurorGenel.BsmvTL.HasValue ? reasurorGenel.BsmvTL.Value.ToString().Replace(',', '.') : "";
                    }
                    else
                    {
                        // para birimi türk lirası 
                        policeModel.FrontingSigortaSirketiKomisyon = reasurorGenel.FrontingSigortaSirketiKomisyonTL.HasValue ? reasurorGenel.FrontingSigortaSirketiKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.SatisKanaliKomisyon = reasurorGenel.SatisKanaliKomisyonTL.HasValue ? reasurorGenel.SatisKanaliKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.TeminatTutari = reasurorGenel.TeminatTutariTL.HasValue ? reasurorGenel.TeminatTutariTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiAlinanKomisyon = reasurorGenel.YurtdisiAlinanKomisyonTL.HasValue ? reasurorGenel.YurtdisiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiDisKaynakKomisyon = reasurorGenel.YurtdisiDisKaynakKomisyonTL.HasValue ? reasurorGenel.YurtdisiDisKaynakKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiNetPrim = reasurorGenel.YurtdisiNetPrimTL.HasValue ? reasurorGenel.YurtdisiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurtdisiPrim = reasurorGenel.YurtdisiPrimTL.HasValue ? reasurorGenel.YurtdisiPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiAlinanKomisyon = reasurorGenel.YurticiAlinanKomisyonTL.HasValue ? reasurorGenel.YurticiAlinanKomisyonTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiBrutPrim = reasurorGenel.YurticiBrutPrimTL.HasValue ? reasurorGenel.YurticiBrutPrimTL.Value.ToString().Replace(',', '.') : "";
                        policeModel.YurticiNetPrim = reasurorGenel.YurticiNetPrimTL.HasValue ? reasurorGenel.YurticiNetPrimTL.Value.ToString().Replace(',', '.') : "";
                        //policeModel.Bsmv = reasurorGenel.BsmvTL.HasValue ? reasurorGenel.BsmvTL.Value.ToString().Replace(',', '.') : "";

                    }
                    if (policeDetay.BrutPrim.HasValue)
                    {
                        if (policeDetay.BrutPrim < 0)
                        {
                            policeModel.PoliceTipi = 0;
                        }
                    }

                    var policeSigortali = policeDetay.PoliceSigortali;
                    if (policeSigortali != null)
                    {
                        policeModel.Sigortali = new Sigortali();
                        policeModel.Sigortali.Adi = policeSigortali.AdiUnvan;
                        policeModel.Sigortali.Soyadi = policeSigortali.SoyadiUnvan;
                        if (policeSigortali.KimlikNo != null && policeSigortali.KimlikNo != "")
                        {
                            policeModel.Sigortali.KimlikNo = policeSigortali.KimlikNo;
                        }
                        else if (policeSigortali.VergiKimlikNo != null && policeSigortali.VergiKimlikNo != "")
                        {
                            policeModel.Sigortali.KimlikNo = policeSigortali.VergiKimlikNo;
                        }
                        policeModel.Sigortali.Telefon = policeSigortali.MobilTelefonNo;
                        policeModel.Sigortali.Adres = policeSigortali.Adres;

                    }
                    var policeSigortaEttiren = policeDetay.PoliceSigortaEttiren;
                    if (policeSigortaEttiren != null)
                    {
                        policeModel.SigortaEttiren = new SigortaEttiren();
                        policeModel.SigortaEttiren.Adi = policeSigortaEttiren.AdiUnvan;
                        policeModel.SigortaEttiren.Soyadi = policeSigortaEttiren.SoyadiUnvan;
                        if (policeSigortaEttiren.KimlikNo != null && policeSigortaEttiren.KimlikNo != "")
                        {
                            policeModel.SigortaEttiren.KimlikNo = policeSigortaEttiren.KimlikNo;
                        }
                        else if (policeSigortaEttiren.VergiKimlikNo != null && policeSigortaEttiren.VergiKimlikNo != "")
                        {
                            policeModel.SigortaEttiren.KimlikNo = policeSigortaEttiren.VergiKimlikNo;
                        }
                        policeModel.SigortaEttiren.Telefon = policeSigortaEttiren.MobilTelefonNo;
                        policeModel.SigortaEttiren.Adres = policeSigortaEttiren.Adres;
                    }
                    if (policeModel.Sigortali.KimlikNo != policeModel.SigortaEttiren.KimlikNo)
                    {
                        policeModel.SigortaliSigortaEttirenAynimi = false;
                    }
                    else
                    {
                        policeModel.SigortaliSigortaEttirenAynimi = true;
                    }
                    var policeArac = policeDetay.PoliceArac;
                    if (policeArac != null)
                    {
                        policeModel.PlakaKodu = policeArac.PlakaKodu;
                        policeModel.PlakaNumarasi = policeArac.PlakaNo;
                        policeModel.AsbisNo = policeArac.AsbisNo;
                        policeModel.TescilBelgeSeriKodu = policeArac.TescilSeriKod;
                        policeModel.TescilBelgeSeriNo = policeArac.TescilSeriNo;
                    }
                    var odemeSekli = policeDetay.OdemeSekli;
                    if (odemeSekli.HasValue)
                    {
                        if (odemeSekli.Value == 1)
                        {
                            policeModel.OdemeSekli = true;
                        }
                        else
                        {
                            policeModel.OdemeSekli = false;
                        }
                    }

                    if (policeDetay.PoliceOdemePlanis.Count > 0)
                    {
                        foreach (var item in policeDetay.PoliceOdemePlanis)
                        {
                            if (item.OdemeTipi.HasValue)
                            {
                                policeModel.OdemeTipi = item.OdemeTipi.Value;
                            }
                        }
                    }
                    if (policeDetay.PoliceOdemePlanis != null)
                    {
                        policeModel.TaksitSayisi = Convert.ToByte(policeDetay.PoliceOdemePlanis.Count);
                    }
                    if (policeDetay.PoliceOdemePlanis.Count > 1)
                    {
                        List<TaksitModel> taksitList = new List<TaksitModel>();
                        TaksitModel tModel = new TaksitModel();
                        foreach (var item in policeDetay.PoliceOdemePlanis)
                        {
                            tModel = new TaksitModel();
                            tModel.TaksitNo = item.TaksitNo;
                            tModel.TaksitTutariTL = item.TaksitTutari.HasValue ? item.TaksitTutari.Value.ToString().Replace(',', '.') : "";
                            tModel.VadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.ToString("dd/MM/yyyy") : "";
                            if (policeDetay.ParaBirimi != "TL")
                            {
                                tModel.TaksitTutari = item.DovizliTaksitTutari.HasValue ? item.DovizliTaksitTutari.ToString().Replace(',', '.') : "";
                            }
                            taksitList.Add(tModel);
                        }

                        policeModel.TaksitSatirlar = taksitList;
                    }
                    // carihesabı açılmış mı kontrol ediyoruz. Eğer açılmışsa ekranda tc değiştirmesini kapatıyoruz.
                    var cariHesap = _Muhasebe_CariHesapService.GetCariHesap("120.01." + policeModel.SigortaEttiren.KimlikNo);
                    if (cariHesap != null)
                    {
                        cariHesapVarMi = true;
                    }
                    else
                    {
                        cariHesapVarMi = false;
                    }
                    //underwriter
                    var uws = _TeklifService.getUnderwriters(policeDetay.PoliceId.ToString(), "");
                    if (uws.Count > 0)
                    {
                        policeModel.UnderwriterSayisi = Convert.ToByte(uws.Count());
                        policeModel.UnderwriterSatirlar = new List<UnderwriterModel>();

                        UnderwriterModel uwm = new UnderwriterModel();
                        for (int i = 0; i < uws.Count; i++)
                        {
                            uwm = new UnderwriterModel();
                            uwm.UnderwriterAdi = uws[i].UnderwriterAdi;
                            uwm.UnderwriterPayOrani = uws[i].UnderwriterPayOrani;
                            policeModel.UnderwriterSatirlar.Add(uwm);
                        }

                    }
                }
            }
            catch (Exception ex)
            {
                policeModel.IslemMesaji = "Poliçe eki görüntüleme işleminde bir hata oluştu." + ex.Message.ToString();
                return Json(new { success = true, data = policeModel, cariHesapVarMi = cariHesapVarMi }, JsonRequestBehavior.AllowGet);
            }
            return Json(new { success = true, data = policeModel, cariHesapVarMi = cariHesapVarMi }, JsonRequestBehavior.AllowGet);
        }


        [HttpPost]
        public ActionResult UnderwriterHazirla(int underwriterSayisi)
        {
            List<UnderwriterModel> UnderwritersList = new List<UnderwriterModel>();
            UnderwriterModel Underwriter = new UnderwriterModel();
            for (int i = 0; i < underwriterSayisi; i++)
            {
                Underwriter = new UnderwriterModel();
                Underwriter.UnderwriterAdi = "";
                Underwriter.UnderwriterPayOrani = 0;
                UnderwritersList.Add(Underwriter);
            }
            return Json(new { UnderwritersList = UnderwritersList });

        }

        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.ManuelTeklifPoliceGirisi, SekmeKodu = 0)]
        public ActionResult PoliceSilReasuror(string PoliceId, string Teklifid)
        {
            string islemMesaji = "";

            if (!String.IsNullOrEmpty(PoliceId))
            {
                int _PoliceId = Convert.ToInt32(PoliceId);
                var silinecekPolice = _PoliceService.GetPoliceById(_PoliceId);
                //if (silinecekPolice != null)
                //{
                //    try
                //    {
                //        bool policeSilindi = _PoliceService.DeletePolice(silinecekPolice);
                //        if (policeSilindi)
                //        {
                //            islemMesaji = "Poliçe silme işleminiz başarılı bir şekilde gerçekleşmiştir.";
                //            bool reasuror = _TeklifService.deleteReasurorGenel(PoliceId, "");
                //        }
                //    }

                //    catch (Exception ex)
                //    {
                //        islemMesaji = "Poliçe silme aşamadında bir hata oluştu." + ex.ToString();
                //        return Json(new { HataMesaji = islemMesaji });
                //    }
                //}
                try
                {
                    if (silinecekPolice.GenelBilgiler.MuhasebeyeAktarildiMi != 2 && silinecekPolice.GenelBilgiler.MuhasebeyeAktarildiMi != 4)
                    {
                        bool policeSilindi = _PoliceService.DeleteSadecePolice(silinecekPolice);
                        if (policeSilindi)
                        {
                            islemMesaji = "Poliçe silme işleminiz başarılı bir şekilde gerçekleşmiştir.";
                            bool reasuror = _TeklifService.deleteReasurorGenel(PoliceId, "");
                        }
                    }
                    else
                    {
                        bool policemuhasebedensilindi = _PoliceService.DeletePolice(silinecekPolice);
                        if (policemuhasebedensilindi)
                        {
                            islemMesaji = "Poliçe silme işleminiz başarılı bir şekilde gerçekleşmiştir.";
                        }
                        else
                            islemMesaji = "Bu poliçenin tahsilat kayıtlarında eksiklik olduğu için silme işlemi yapılamamaktadır.";
                    }
                }
                catch (Exception ex)
                {
                    islemMesaji = "Poliçe silme aşamadında bir hata oluştu." + ex.ToString();
                    return Json(new { HataMesaji = islemMesaji });
                }

            }
            else if (!String.IsNullOrEmpty(Teklifid))
            {
                try
                {
                    bool reasuror = _TeklifService.deleteReasurorGenel("", Teklifid);
                    if (reasuror)
                    {
                        islemMesaji = "Teklif silme işleminiz başarılı bir şekilde gerçekleşmiştir.";
                    }
                    else
                    {
                        islemMesaji = "Poliçe silme aşamadında bir hata oluştu.";
                    }

                }
                catch (Exception)
                {
                    islemMesaji = "Poliçe silme aşamadında bir hata oluştu.";
                }

            }

            return Json(new { HataMesaji = islemMesaji });
        }

        #endregion



        #region Manuel Poliçe Girişi
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.OfflinePoliceGirisi, SekmeKodu = 0)]
        public ActionResult PoliceGirisi()
        {
            PoliceGirisiModel model = new PoliceGirisiModel();
            ITVMService _TVMService = DependencyResolver.Current.GetService<ITVMService>();
            var sigortaSirketleri = _SigortaSirketleriService.GetList();
            List<Bran> brans = _BransService.GetList(_AktifKullaniciService.TvmTipi.ToString());
            model.Tvmler = new SelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani").ListWithOptionLabel();
            model.SigortaSirketleri = new SelectList(sigortaSirketleri, "SirketKodu", "SirketAdi").ListWithOptionLabel();
            model.Branslar = new SelectList(brans, "BransKodu", "BransAdi").ListWithOptionLabel();
            List<TVMDetay> taliTvmler = _TVMService.GetListTVMDetayPoliceTransferTali();
            model.DisKaynaklar = new SelectList(taliTvmler, "Kodu", "Unvani", "").ListWithOptionLabel();
            model.OdemeSekli = true;
            model.SigortaliSigortaEttirenAynimi = true;
            List<SelectListItem> taksitSayilari = new List<SelectListItem>();
            for (int i = 1; i <= 12; i++)
            {
                taksitSayilari.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = i.ToString(), Text = i.ToString() } });
            }
            model.PoliceTipi = 1;
            List<SelectListItem> policeTipleri = new List<SelectListItem>();
            policeTipleri.AddRange(new SelectListItem[] {
                new SelectListItem() { Value = "1", Text = babonline.Accrual }, // tahakkuk
                new SelectListItem() { Value = "0", Text = babonline.Cancel } }); // iptal
            model.PoliceTipleri = new SelectList(policeTipleri, "Value", "Text", model.PoliceTipi).ListWithOptionLabel();

            model.TaksitSayisi = 1;
            model.TaksitSayilari = new SelectList(taksitSayilari, "Value", "Text", model.TaksitSayisi).ListWithOptionLabel();
            model.TaksitSatirlar = new List<TaksitModel>();
            model.ParaBirimi = "TL";
            model.ParaBirimleri = new SelectList(TeklifProvider.ParaBirimTipleri(), "Value", "Text", model.ParaBirimi);
            model.YeniIsList = new SelectList(new SelectListItem[] {
                new SelectListItem() { Value = "1", Text = babonline.Yes }, // Evet
                new SelectListItem() { Value = "0", Text = babonline.No} }, "Value", "Text", model.Yeni_is); // hayır

            model.OdemeTipi = 2;
            model.OdemeTipleri = new SelectList(TeklifProvider.OdemeTipleri(), "Value", "Text", model.OdemeTipi).ToList();
            return View(model);
        }

        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.OfflinePoliceGirisi, SekmeKodu = 0)]
        public void OfflinePoliceGirisi()
        {
            int policeId = Convert.ToInt32(Request.Form["PoliceId"]);
            byte Yeni_is = Convert.ToByte(Request.Form["Yeni_is"]);

            _PoliceService.UpdateOfflinePolice(policeId, Yeni_is);
        }

        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.OfflinePoliceGirisi, SekmeKodu = 0)]
        public ActionResult PoliceGirisi(PoliceGirisiModel model)
        {

            if (ModelState["Sigortali.KimlikNo"] != null)
                ModelState["Sigortali.KimlikNo"].Errors.Clear();
            if (ModelState["SigortaliSigortaEttirenAynimi"] != null)
                ModelState["SigortaliSigortaEttirenAynimi"].Errors.Clear();

            if (ModelState["OdemeSekli"] != null)
                ModelState["OdemeSekli"].Errors.Clear();

            if (ModelState.IsValid)
            {
                try
                {
                    #region Genel Bilgiler
                    List<TaliAcenteKomisyonOrani> taliKomisyonOranlari = new List<TaliAcenteKomisyonOrani>();
                    List<TaliAcenteKomisyonOrani> disKaynakKomisyonOranlari = new List<TaliAcenteKomisyonOrani>();
                    TaliAcenteKomisyonOrani taliKomisyonOrani = new TaliAcenteKomisyonOrani();
                    decimal GerceklesenTaliUretim = 0;
                    Business.Police police = new Business.Police();
                    police.GenelBilgiler.TVMKodu = _AktifKullaniciService.TVMKodu;
                    police.GenelBilgiler.TUMBirlikKodu = model.SigortaSirketiKodu;
                    police.GenelBilgiler.BaslangicTarihi = model.BaslangicTarihi;
                    police.GenelBilgiler.BitisTarihi = model.BitisTarihi;
                    police.GenelBilgiler.TanzimTarihi = model.TanzimTarihi;
                    police.GenelBilgiler.PoliceNumarasi = model.PoliceNo;
                    police.GenelBilgiler.EkNo = model.EkNo;
                    police.GenelBilgiler.YenilemeNo = model.YenilemeNo;
                    police.GenelBilgiler.ZeyilAdi = model.ZeylAciklama;
                    police.GenelBilgiler.Durum = PoliceDurumlari.ManuelGiris;
                    police.GenelBilgiler.ParaBirimi = model.ParaBirimi;
                    police.GenelBilgiler.Yeni_is = Convert.ToByte(model.Yeni_is);

                    if (model.MuhasebeyeAktarildiMi != null)
                    {
                        police.GenelBilgiler.MuhasebeyeAktarildiMi = (byte)model.MuhasebeyeAktarildiMi;
                    }

                    if (!String.IsNullOrEmpty(model.DovizKuru))
                    {
                        police.GenelBilgiler.DovizKur = Convert.ToDecimal(model.DovizKuru);
                    }

                    if (!String.IsNullOrEmpty(model.BransKodu))
                    {
                        police.GenelBilgiler.BransKodu = Convert.ToInt32(model.BransKodu);

                        var bransDetay = _BransService.GetBrans(police.GenelBilgiler.BransKodu.Value);
                        if (bransDetay != null)
                        {
                            police.GenelBilgiler.BransAdi = bransDetay.BransAdi;
                        }
                    }
                    else
                    {
                        police.GenelBilgiler.BransKodu = 18; // Tanımsız Branş Kodu
                        police.GenelBilgiler.BransAdi = "TANIMSIZ";
                    }
                    int carpan = 1;
                    if (model.PoliceTipi == 0) //İptal 
                    {
                        carpan = -1;
                    }
                    if (model.ParaBirimi != "TL")
                    {

                        police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.BrutPrimTL) * carpan;
                        police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.NetPrimTL) * carpan;
                        police.GenelBilgiler.ToplamVergi = Convert.ToDecimal(model.VergiTutariTL) * carpan;
                        police.GenelBilgiler.DovizliKomisyon = Convert.ToDecimal(model.KomisyonTutari) * carpan;
                        police.GenelBilgiler.DovizliNetPrim = Convert.ToDecimal(model.NetPrim) * carpan;
                        police.GenelBilgiler.DovizliBrutPrim = Convert.ToDecimal(model.BrutPrim) * carpan;
                        police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.KomisyonTutariTL) * carpan;

                    }
                    else
                    {
                        police.GenelBilgiler.BrutPrim = Convert.ToDecimal(model.BrutPrim) * carpan;
                        police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.NetPrim) * carpan;
                        police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.KomisyonTutariTL) * carpan;

                        police.GenelBilgiler.ToplamVergi = Convert.ToDecimal(model.VergiTutari) * carpan;
                    }
                    //police.GenelBilgiler.Komisyon = Convert.ToDecimal(model.KomisyonTutariTL) * carpan;
                    //if (model.NetPrim != null)
                    //{
                    //    model.NetPrimTL = model.NetPrim;
                    //}

                    //police.GenelBilgiler.NetPrim = Convert.ToDecimal(model.NetPrimTL) * carpan;
                    if (!String.IsNullOrEmpty(model.DisKaynakKodu))
                    {
                        if (String.IsNullOrEmpty(model.TVMKodu))
                        {
                            model.TVMKodu = "0";
                        }
                        disKaynakKomisyonOranlari = _KomisyonService.GetTaliAcenteKomisyon(_AktifKullaniciService.TVMKodu, Convert.ToInt32(model.DisKaynakKodu), 0, model.SigortaSirketiKodu, police.GenelBilgiler.BransKodu.Value);

                        if (disKaynakKomisyonOranlari != null && disKaynakKomisyonOranlari.Count > 0)
                        {
                            var disKaynakKomisyon = disKaynakKomisyonOranlari.FirstOrDefault();
                            police.GenelBilgiler.TaliKomisyonGuncellemeTarihi = TurkeyDateTime.Now;
                            police.GenelBilgiler.TaliKomisyonGuncelleyenKullanici = _AktifKullaniciService.KullaniciKodu;
                            if (disKaynakKomisyon.KomisyonOran > 100)
                            {
                                disKaynakKomisyon.KomisyonOran = disKaynakKomisyon.KomisyonOran / 10;
                            }
                            police.GenelBilgiler.Komisyon = (police.GenelBilgiler.Komisyon * disKaynakKomisyon.KomisyonOran) / 100;
                            police.GenelBilgiler.UretimTaliAcenteKodu = Convert.ToInt32(model.DisKaynakKodu);
                            if (model.TVMKodu != "0")
                            {
                                police.GenelBilgiler.TaliAcenteKodu = Convert.ToInt32(model.TVMKodu);
                            }
                        }
                        else
                        {
                            model.IslemMesaji = "Dış Kaynak komisyon oranı tanımlı olmadığı için poliçe kaydı yapılamamıştır. Lütfen öncelikle seçilen Dış Kaynak' a Komisyon Oranı tanımı yapınız.";
                            return Json(new { HataMesaji = model.IslemMesaji });
                        }
                    }
                    if (!String.IsNullOrEmpty(model.TVMKodu))
                    {
                        if (String.IsNullOrEmpty(model.DisKaynakKodu))
                        {
                            model.DisKaynakKodu = "0";
                        }
                        GerceklesenTaliUretim = _KomisyonService.PoliceTVMGerceklesen(Convert.ToInt32(model.TVMKodu), police.GenelBilgiler.TanzimTarihi.Value.Year, police.GenelBilgiler.BransKodu.Value);
                        taliKomisyonOranlari = _KomisyonService.GetTaliAcenteKomisyon(_AktifKullaniciService.TVMKodu, Convert.ToInt32(model.TVMKodu), Convert.ToInt32(model.DisKaynakKodu), model.SigortaSirketiKodu, police.GenelBilgiler.BransKodu.Value);

                        if (taliKomisyonOranlari != null)
                        {
                            taliKomisyonOrani = new TaliAcenteKomisyonOrani();
                            if (!taliKomisyonOrani.KomisyonOran.HasValue)
                            {
                                if (taliKomisyonOranlari.Count() > 1)
                                {
                                    //kademeli komisyon varsa kademeler içinden en yükseğini belirliyor.
                                    decimal maxUertim = 0;
                                    foreach (var item in taliKomisyonOranlari)
                                    {
                                        if (maxUertim < item.MaxUretim)
                                        {
                                            maxUertim = item.MaxUretim.Value;
                                        }
                                    }

                                    GerceklesenTaliUretim += police.GenelBilgiler.NetPrim ?? 0;
                                    taliKomisyonOrani = taliKomisyonOranlari.Find(s => s.MinUretim <= GerceklesenTaliUretim && GerceklesenTaliUretim <= s.MaxUretim);
                                    // gerçekleşen üretim kademelerden büyükse null gelecek en yüksek kademe atanacak
                                    if (taliKomisyonOrani == null)
                                    {
                                        taliKomisyonOrani = taliKomisyonOranlari.Find(s => s.MaxUretim == maxUertim);
                                    }
                                }
                                //kademeli çalışmıyorsa
                                else if (taliKomisyonOranlari.Count > 0)
                                {
                                    if (taliKomisyonOranlari[0].MinUretim == null && taliKomisyonOranlari[0].MaxUretim == null)
                                    {
                                        taliKomisyonOrani = taliKomisyonOranlari[0];
                                    }
                                }
                            }
                            if (taliKomisyonOrani == null)
                            {
                                if (taliKomisyonOrani.KomisyonOran == null)
                                {
                                    model.IslemMesaji = "Alt Kaynak komisyon oranı tanımlı olmadığı için poliçe kaydı yapılamamıştır. Lütfen öncelikle seçilen Alt Kaynak' a Komisyon Oranı tanımı yapınız.";
                                    return Json(new { HataMesaji = model.IslemMesaji });

                                }
                            }
                            police.GenelBilgiler.TaliAcenteKodu = Convert.ToInt32(model.TVMKodu);
                            police.GenelBilgiler.TaliKomisyonGuncellemeTarihi = TurkeyDateTime.Now;
                            police.GenelBilgiler.TaliKomisyonGuncelleyenKullanici = _AktifKullaniciService.KullaniciKodu;
                            if (taliKomisyonOrani.KomisyonOran > 100)
                            {
                                taliKomisyonOrani.KomisyonOran = taliKomisyonOrani.KomisyonOran / 10;
                            }

                            police.GenelBilgiler.TaliKomisyon = ((police.GenelBilgiler.Komisyon * taliKomisyonOrani.KomisyonOran) / 100);
                            police.GenelBilgiler.TaliKomisyonOran = taliKomisyonOrani.KomisyonOran;
                        }
                        else
                        {
                            model.IslemMesaji = "Alt Kaynak komisyon oranı tanımlı olmadığı için poliçe kaydı yapılamamıştır. Lütfen öncelikle seçilen Alt Kaynak' a Komisyon Oranı tanımı yapınız.";
                            return Json(new { HataMesaji = model.IslemMesaji });
                        }

                    }

                    if (model.TaksitSayisi == 1)
                    {
                        police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Pesin;
                    }
                    else
                    {
                        police.GenelBilgiler.OdemeSekli = OdemeSekilleri.Vadeli;
                    }

                    #endregion

                    #region Araç Bilgileri

                    police.GenelBilgiler.PoliceArac.PlakaKodu = model.PlakaKodu;
                    police.GenelBilgiler.PoliceArac.PlakaNo = model.PlakaNumarasi;
                    police.GenelBilgiler.PoliceArac.TescilSeriKod = model.TescilBelgeSeriKodu;
                    police.GenelBilgiler.PoliceArac.TescilSeriNo = model.TescilBelgeSeriNo;
                    police.GenelBilgiler.PoliceArac.AsbisNo = model.AsbisNo;

                    #endregion

                    #region Sigortalı / Sigorta Ettiren Bilgileri
                    police.GenelBilgiler.PoliceSigortaEttiren.DainiMurtehinSubeAdi = model.DainiMurteinSubeAdi;
                    if (model.Sigortali.KimlikNo == null)
                    {
                        police.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                        police.GenelBilgiler.PoliceSigortali.AdiUnvan = model.SigortaEttiren.Adi;
                        police.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                        police.GenelBilgiler.PoliceSigortali.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                        if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                        {
                            if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                            {
                                police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                police.GenelBilgiler.PoliceSigortali.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                            }
                            else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                            {
                                police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                                police.GenelBilgiler.PoliceSigortali.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                            }
                        }

                        police.GenelBilgiler.PoliceSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                        police.GenelBilgiler.PoliceSigortali.MobilTelefonNo = model.SigortaEttiren.Telefon;
                        police.GenelBilgiler.PoliceSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                        police.GenelBilgiler.PoliceSigortali.Adres = model.SigortaEttiren.Adres;
                    }
                    else
                    {
                        ///Sigortalı Bilgileri
                        police.GenelBilgiler.PoliceSigortali.AdiUnvan = model.Sigortali.Adi;
                        police.GenelBilgiler.PoliceSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                        if (!String.IsNullOrEmpty(model.Sigortali.KimlikNo))
                        {
                            if (model.Sigortali.KimlikNo.Trim().Length == 11)
                            {
                                police.GenelBilgiler.PoliceSigortali.KimlikNo = model.Sigortali.KimlikNo.Trim();
                            }
                            else if (model.Sigortali.KimlikNo.Trim().Length == 10)
                            {
                                police.GenelBilgiler.PoliceSigortali.VergiKimlikNo = model.Sigortali.KimlikNo.Trim();
                            }
                        }

                        police.GenelBilgiler.PoliceSigortali.MobilTelefonNo = model.Sigortali.Telefon;
                        police.GenelBilgiler.PoliceSigortali.Adres = model.Sigortali.Adres;

                        ///Sigorta Ettiren Bilgileri
                        police.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                        police.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                        if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                        {
                            if (model.SigortaEttiren.KimlikNo.Trim().Length == 11)
                            {
                                police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                            }
                            else if (model.SigortaEttiren.KimlikNo.Trim().Length == 10)
                            {
                                police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo.Trim();
                            }
                        }
                        police.GenelBilgiler.PoliceSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                        police.GenelBilgiler.PoliceSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                    }

                    #endregion

                    #region Ödeme Bilgileri

                    if (model.TaksitSayisi == 1)
                    {
                        PoliceOdemePlani odeme = new PoliceOdemePlani();
                        odeme.TaksitNo = model.TaksitSayisi;
                        odeme.TaksitTutari = Convert.ToDecimal(police.GenelBilgiler.BrutPrim);
                        odeme.DovizliTaksitTutari = Convert.ToDecimal(police.GenelBilgiler.DovizliBrutPrim);
                        odeme.VadeTarihi = model.BaslangicTarihi;
                        odeme.OdemeTipi = model.OdemeTipi;
                        police.GenelBilgiler.PoliceOdemePlanis.Add(odeme);

                        if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                        {
                            PoliceTahsilat tahsilat = new PoliceTahsilat();
                            tahsilat.OdemTipi = OdemeTipleri.KrediKarti;
                            tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                            tahsilat.TaksitNo = odeme.TaksitNo;
                            tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                            tahsilat.OdemeBelgeNo = "111111****1111";
                            tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                            tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                            tahsilat.KalanTaksitTutari = 0;
                            tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                            tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                            tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                            tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                            tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                            tahsilat.KayitTarihi = TurkeyDateTime.Now;
                            tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                            //Muhasebeye İşlenmeyecekse kaldılacak 
                            tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                            tahsilat.OtomatikTahsilatiKkMi = 1;
                            if (tahsilat.TaksitTutari != 0)
                            {
                                police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                            }
                        }
                        else
                        {
                            PoliceTahsilat tahsilat = new PoliceTahsilat();
                            tahsilat.OdemTipi = model.OdemeTipi;
                            tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                            tahsilat.TaksitNo = odeme.TaksitNo;
                            tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                            tahsilat.OdenenTutar = 0;
                            tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                            tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                            tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                            tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                            tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                            tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                            tahsilat.KayitTarihi = TurkeyDateTime.Now;
                            tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                            if (tahsilat.TaksitTutari != 0)
                            {
                                police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                            }
                            if (model.PoliceTipi == 0) //İptal 
                            {
                                tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                            }

                        }
                    }
                    else if (model.TaksitSatirlar != null)
                    {
                        PoliceOdemePlani odeme = new PoliceOdemePlani();
                        foreach (var item in model.TaksitSatirlar)
                        {
                            odeme = new PoliceOdemePlani();
                            odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                            if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                            {
                                odeme.DovizliTaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                                odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL) * carpan;
                            }
                            else
                            {
                                odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari) * carpan;
                            }

                            odeme.OdemeTipi = model.OdemeTipi;
                            odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                            police.GenelBilgiler.PoliceOdemePlanis.Add(odeme);
                            if (model.OdemeTipi == OdemeTipleri.KrediKarti)
                            {
                                PoliceTahsilat tahsilat = new PoliceTahsilat();
                                tahsilat.OdemTipi = model.OdemeTipi;
                                tahsilat.OdemeBelgeNo = "111111****1111";
                                tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                tahsilat.TaksitNo = odeme.TaksitNo;
                                tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                tahsilat.KalanTaksitTutari = 0;
                                tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                tahsilat.KimlikNo = police.GenelBilgiler.PoliceSigortali.KimlikNo;
                                tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.Value;
                                tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                tahsilat.CariHesapKodu = "120.01." + model.SigortaEttiren.KimlikNo.Trim();
                                tahsilat.OtomatikTahsilatiKkMi = 1;
                                if (tahsilat.TaksitTutari != 0)
                                {
                                    police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                }
                            }
                            else
                            {
                                PoliceTahsilat tahsilat = new PoliceTahsilat();
                                tahsilat.OdemTipi = model.OdemeTipi;
                                tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.GenelBilgiler.BaslangicTarihi.Value;
                                tahsilat.TaksitNo = odeme.TaksitNo;
                                tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                tahsilat.OdenenTutar = 0;
                                tahsilat.KalanTaksitTutari = tahsilat.TaksitTutari;
                                tahsilat.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                                tahsilat.ZeyilNo = police.GenelBilgiler.EkNo.ToString();
                                tahsilat.KimlikNo = !String.IsNullOrEmpty(police.GenelBilgiler.PoliceSigortali.KimlikNo) ? police.GenelBilgiler.PoliceSigortali.KimlikNo : "";
                                tahsilat.BrutPrim = police.GenelBilgiler.BrutPrim.HasValue ? police.GenelBilgiler.BrutPrim.Value : 0;
                                tahsilat.PoliceId = police.GenelBilgiler.PoliceId;
                                tahsilat.KayitTarihi = TurkeyDateTime.Now;
                                tahsilat.KaydiEkleyenKullaniciKodu = police.GenelBilgiler.TVMKodu.Value;
                                if (tahsilat.TaksitTutari != 0)
                                {
                                    police.GenelBilgiler.PoliceTahsilats.Add(tahsilat);
                                }
                            }

                        }
                    }

                    #endregion

                    #region Vergiler
                    PoliceVergi vergi = null;

                    if (!String.IsNullOrEmpty(model.THG))
                    {
                        vergi = new PoliceVergi()
                        {
                            VergiKodu = 1,
                            VergiTutari = model.ParaBirimi != "TL" ? (Convert.ToDecimal(model.THGFonuTL) * carpan) : (Convert.ToDecimal(model.THG) * carpan)
                        };
                        police.GenelBilgiler.PoliceVergis.Add(vergi);
                    }
                    if (!String.IsNullOrEmpty(model.GiderVergisi))
                    {
                        vergi = new PoliceVergi()
                        {
                            VergiKodu = 2,
                            VergiTutari = model.ParaBirimi != "TL" ? (Convert.ToDecimal(model.GiderVergisiTL) * carpan) : (Convert.ToDecimal(model.GiderVergisi) * carpan)
                        };
                        police.GenelBilgiler.PoliceVergis.Add(vergi);
                    }
                    if (!String.IsNullOrEmpty(model.KTGS))
                    {
                        vergi = new PoliceVergi()
                        {
                            VergiKodu = 3,
                            VergiTutari = model.ParaBirimi != "TL" ? (Convert.ToDecimal(model.KTGSHesabiTL) * carpan) : (Convert.ToDecimal(model.KTGS) * carpan)
                        };
                        police.GenelBilgiler.PoliceVergis.Add(vergi);
                    }
                    if (!String.IsNullOrEmpty(model.YSV))
                    {
                        vergi = new PoliceVergi()
                        {
                            VergiKodu = 4,
                            VergiTutari = model.ParaBirimi != "TL" ? (Convert.ToDecimal(model.YSVTL) * carpan) : (Convert.ToDecimal(model.YSV) * carpan)
                        };
                        police.GenelBilgiler.PoliceVergis.Add(vergi);
                    }
                    #endregion

                    #region Poliçe Kaydetme
                    if (police.GenelBilgiler.MuhasebeyeAktarildiMi == 2 || police.GenelBilgiler.MuhasebeyeAktarildiMi == 4)
                    {
                        police.GenelBilgiler.MuhasebeyeAktarildiMi = null;
                    }

                    var policeKaydetResult = _PoliceService.AddPolice(police);

                    if (policeKaydetResult == 1)
                    {
                        model.IslemMesaji = "Police başarılı bir şekilde kaydedildi.";
                    }
                    else if (policeKaydetResult == 2)
                    {
                        model.IslemMesaji = "Bu poliçe daha önceden kaydedilmiştir.";
                    }
                    else
                    {
                        model.IslemMesaji = "Poliçe Kaydetme aşamadında bir hata oluştu.";
                    }
                    #endregion
                }

                catch (Exception ex)
                {
                    model.IslemMesaji = "Poliçe Kaydetme aşamadında bir hata oluştu." + ex.ToString();
                    return Json(new { HataMesaji = model.IslemMesaji });
                }
            }
            else
            {
                //model.IslemMesaji = "";
                //foreach (var item in ModelState.Values)
                //{
                //    foreach (var error in item.Errors)
                //    {
                //        model.IslemMesaji += " " + error.ErrorMessage;
                //    }
                //}
                //if (String.IsNullOrEmpty(model.IslemMesaji))
                //{
                model.IslemMesaji = "Lütfen zorunlu alanları doldurunuz.";
                //}
            }

            return Json(new { HataMesaji = model.IslemMesaji });
        }

        [HttpPost]//cariye aktarılan policelerde güncelleme işlemi test metodu
        public ActionResult PoliceGuncelleTest(PoliceGirisiModel model)
        {
            if (ModelState["Sigortali.KimlikNo"] != null)
                ModelState["Sigortali.KimlikNo"].Errors.Clear();
            if (ModelState["SigortaliSigortaEttirenAynimi"] != null)
                ModelState["SigortaliSigortaEttirenAynimi"].Errors.Clear();
            if (ModelState["BransKodu"] != null)
                ModelState["BransKodu"].Errors.Clear();
            if (ModelState["OdemeSekli"] != null)
                ModelState["OdemeSekli"].Errors.Clear();

            if (ModelState.IsValid)
            {

                if (model.PoliceId.HasValue)
                {
                    var police = _PoliceService.GetPolice(model.PoliceId.Value);

                    if (model.MuhasebeyeAktarildiMi == 2 || model.MuhasebeyeAktarildiMi == 4)
                    {
                        model.IslemMesaji = "Poliçe Güncelleme aşamadında bir hata oluştu.";

                        var result = PoliceSil(police.PoliceId);
                        model.PoliceId = null;
                        var result1 = PoliceGirisi(model);
                        MuhasebeAktarimKonfigurasyon modelKonfig = new MuhasebeAktarimKonfigurasyon();
                        //Acente Unvanı Aktif Kullanıcının tvmkodu ve unvanı kaydedilecek.
                        modelKonfig.TvmKodu = _AktifKullaniciService.TVMKodu;
                        modelKonfig.TvmUnvani = _AktifKullaniciService.TVMUnvani;
                        //Sira No Db den bakılıp son numaraya 1 eklenerek arttırılacak.
                        modelKonfig.SiraNo = 1;
                        //Aktarım Tamamlandı alanı otomatik 0 olarak kaydedilecek.
                        modelKonfig.AktarimTamamlandi = 0;
                        modelKonfig.BaslangicTarihi = (DateTime)police.BaslangicTarihi;
                        modelKonfig.BitisTarihi = ((DateTime)police.BitisTarihi);
                        if (police.TUMKodu.ToString() == "")
                        {
                            modelKonfig.SirketKodu = null;
                        }
                        else
                        {
                            modelKonfig.SirketKodu = police.TUMKodu.ToString();
                        }
                        modelKonfig.BransKodu = police.BransKodu;

                        int sonuc = _Muhasebe_CariHesapService.PoliceleriCariyeAktarma(modelKonfig);
                        var police_ = _PoliceService.getPolice(police.TaliAcenteKodu, model.SigortaSirketiKodu.ToString(), police.PoliceNumarasi, (int)police.EkNo);
                        police_.MuhasebeyeAktarildiMi = 2;
                        _PoliceService.UpdatePolice(police_);
                        if (result1.ToString().Contains("hata oluştu"))
                            model.IslemMesaji = result1.ToString();
                        else
                            model.IslemMesaji = "Police başarılı bir şekilde güncellendi.";


                    }
                }

            }
            else
            {
                model.IslemMesaji = "";
                foreach (var item in ModelState.Values)
                {
                    model.IslemMesaji = "Lütfen zorunlu alanları doldurunuz.";
                }
                if (String.IsNullOrEmpty(model.IslemMesaji))
                {
                    model.IslemMesaji = "Lütfen zorunlu alanları doldurunuz.";
                }
            }

            return Json(new { HataMesaji = model.IslemMesaji });

        }
        [HttpPost]
        public ActionResult PoliceGuncelle(PoliceGirisiModel model)
        {
            int guncellenenPoliceId = 0, sonuc = 0;
            if (ModelState["Sigortali.KimlikNo"] != null)
                ModelState["Sigortali.KimlikNo"].Errors.Clear();
            if (ModelState["SigortaliSigortaEttirenAynimi"] != null)
                ModelState["SigortaliSigortaEttirenAynimi"].Errors.Clear();
            if (ModelState["BransKodu"] != null)
                ModelState["BransKodu"].Errors.Clear();
            if (ModelState["OdemeSekli"] != null)
                ModelState["OdemeSekli"].Errors.Clear();

            if (ModelState.IsValid)
            {
                //try
                //{
                if (model.PoliceId.HasValue)
                {
                    var police = _PoliceService.GetPolice(model.PoliceId.Value);
                    if (model.MuhasebeyeAktarildiMi == 2 || model.MuhasebeyeAktarildiMi == 4)
                    {
                        model.IslemMesaji = "Poliçe Güncelleme aşamadında bir hata oluştu.";

                        var result = PoliceSil(police.PoliceId);
                        model.PoliceId = null;
                        var result1 = PoliceGirisi(model);
                        MuhasebeAktarimKonfigurasyon modelKonfig = new MuhasebeAktarimKonfigurasyon();
                        //Acente Unvanı Aktif Kullanıcının tvmkodu ve unvanı kaydedilecek.
                        modelKonfig.TvmKodu = _AktifKullaniciService.TVMKodu;
                        modelKonfig.TvmUnvani = _AktifKullaniciService.TVMUnvani;
                        //Sira No Db den bakılıp son numaraya 1 eklenerek arttırılacak.
                        modelKonfig.SiraNo = 1;
                        //Aktarım Tamamlandı alanı otomatik 0 olarak kaydedilecek.
                        modelKonfig.AktarimTamamlandi = 0;
                        modelKonfig.BaslangicTarihi = (DateTime)police.BaslangicTarihi;
                        modelKonfig.BitisTarihi = ((DateTime)police.BitisTarihi);
                        if (police.TUMKodu.ToString() == "")
                        {
                            modelKonfig.SirketKodu = null;
                        }
                        else
                        {
                            modelKonfig.SirketKodu = police.TUMKodu.ToString();
                        }
                        modelKonfig.BransKodu = police.BransKodu;

                        sonuc = _Muhasebe_CariHesapService.PoliceleriCariyeAktarma(modelKonfig);
                        if (sonuc > 0)
                        {
                            var police_ = _PoliceService.getPolice(police.TaliAcenteKodu, model.SigortaSirketiKodu.ToString(), police.PoliceNumarasi, (int)police.EkNo);

                            model.IslemMesaji = "Police başarılı bir şekilde güncellendi.";

                            guncellenenPoliceId = police_.PoliceId;
                        }
                    }
                    else if (police != null)
                    {
                        #region Genel Bilgiler     
                        List<TaliAcenteKomisyonOrani> taliKomisyonOranlari = new List<TaliAcenteKomisyonOrani>();
                        List<TaliAcenteKomisyonOrani> disKaynakKomisyonOranlari = new List<TaliAcenteKomisyonOrani>();
                        TaliAcenteKomisyonOrani taliKomisyonOrani = new TaliAcenteKomisyonOrani();
                        decimal GerceklesenTaliUretim = 0;
                        police.TUMBirlikKodu = model.SigortaSirketiKodu;
                        police.BaslangicTarihi = model.BaslangicTarihi;
                        police.BitisTarihi = model.BitisTarihi;
                        police.TanzimTarihi = model.TanzimTarihi;
                        police.PoliceNumarasi = model.PoliceNo;
                        police.EkNo = model.EkNo;
                        police.YenilemeNo = model.YenilemeNo;
                        police.ZeyilAdi = model.ZeylAciklama;
                        police.Yeni_is = Convert.ToByte(model.Yeni_is);
                        if (model.NetPrim != null)
                        {
                            model.NetPrimTL = model.NetPrim;
                        }
                        int carpan = 1;
                        if (model.PoliceTipi == 0) //İptal 
                        {
                            carpan = -1;
                        }
                        police.Komisyon = Convert.ToDecimal(model.KomisyonTutariTL) * carpan;
                        police.NetPrim = Convert.ToDecimal(model.NetPrimTL) * carpan;
                        police.BrutPrim = Convert.ToDecimal(model.BrutPrim);
                        police.ToplamVergi = Convert.ToDecimal(model.VergiTutari);
                        foreach (var item in police.PoliceVergis)
                        {
                            if (item.VergiKodu == 1)
                            {
                                if (!string.IsNullOrEmpty(model.THG))
                                    item.VergiTutari = Convert.ToDecimal(model.THG);
                            }
                            else if (item.VergiKodu == 2)
                            {
                                if (!string.IsNullOrEmpty(model.GiderVergisi))
                                    item.VergiTutari = Convert.ToDecimal(model.GiderVergisi);

                            }
                            else if (item.VergiKodu == 3)
                            {
                                if (!string.IsNullOrEmpty(model.KTGS))
                                    item.VergiTutari = Convert.ToDecimal(model.KTGS);

                            }
                            else if (item.VergiKodu == 4)
                            {
                                if (!string.IsNullOrEmpty(model.YSV))
                                    item.VergiTutari = Convert.ToDecimal(model.YSV);
                            }

                        }
                        if (!String.IsNullOrEmpty(model.DisKaynakKodu))
                        {
                            if (String.IsNullOrEmpty(model.TVMKodu))
                            {
                                model.TVMKodu = "0";
                            }
                            disKaynakKomisyonOranlari = _KomisyonService.GetTaliAcenteKomisyon(_AktifKullaniciService.TVMKodu, Convert.ToInt32(model.DisKaynakKodu), 0, model.SigortaSirketiKodu, police.BransKodu.Value);

                            if (disKaynakKomisyonOranlari != null && disKaynakKomisyonOranlari.Count > 0)
                            {
                                var disKaynakKomisyon = disKaynakKomisyonOranlari.FirstOrDefault();
                                police.TaliKomisyonGuncellemeTarihi = TurkeyDateTime.Now;
                                police.TaliKomisyonGuncelleyenKullanici = _AktifKullaniciService.KullaniciKodu;
                                if (disKaynakKomisyon.KomisyonOran > 100)
                                {
                                    disKaynakKomisyon.KomisyonOran = disKaynakKomisyon.KomisyonOran / 10;
                                }
                                police.Komisyon = (police.Komisyon * disKaynakKomisyon.KomisyonOran) / 100;
                                police.UretimTaliAcenteKodu = Convert.ToInt32(model.DisKaynakKodu);
                                if (model.TVMKodu != "0")
                                {
                                    police.TaliAcenteKodu = Convert.ToInt32(model.TVMKodu);
                                }
                            }
                            else
                            {
                                model.IslemMesaji = "Dış Kaynak komisyon oranı tanımlı olmadığı için poliçe kaydı yapılamamıştır. Lütfen öncelikle seçilen Dış Kaynak' a Komisyon Oranı tanımı yapınız.";
                                return Json(new { HataMesaji = model.IslemMesaji });
                            }
                        }
                        if (!String.IsNullOrEmpty(model.TVMKodu))
                        {
                            if (String.IsNullOrEmpty(model.DisKaynakKodu))
                            {
                                model.DisKaynakKodu = "0";
                            }
                            GerceklesenTaliUretim = _KomisyonService.PoliceTVMGerceklesen(Convert.ToInt32(model.TVMKodu), police.TanzimTarihi.Value.Year, police.BransKodu.Value);
                            taliKomisyonOranlari = _KomisyonService.GetTaliAcenteKomisyon(_AktifKullaniciService.TVMKodu, Convert.ToInt32(model.TVMKodu), Convert.ToInt32(model.DisKaynakKodu), model.SigortaSirketiKodu, police.BransKodu.Value);

                            if (taliKomisyonOranlari != null)
                            {
                                taliKomisyonOrani = new TaliAcenteKomisyonOrani();
                                if (!taliKomisyonOrani.KomisyonOran.HasValue)
                                {
                                    if (taliKomisyonOranlari.Count() > 1)
                                    {
                                        //kademeli komisyon varsa kademeler içinden en yükseğini belirliyor.
                                        decimal maxUertim = 0;
                                        foreach (var item in taliKomisyonOranlari)
                                        {
                                            if (maxUertim < item.MaxUretim)
                                            {
                                                maxUertim = item.MaxUretim.Value;
                                            }
                                        }

                                        GerceklesenTaliUretim += police.NetPrim ?? 0;
                                        taliKomisyonOrani = taliKomisyonOranlari.Find(s => s.MinUretim <= GerceklesenTaliUretim && GerceklesenTaliUretim <= s.MaxUretim);
                                        // gerçekleşen üretim kademelerden büyükse null gelecek en yüksek kademe atanacak
                                        if (taliKomisyonOrani == null)
                                        {
                                            taliKomisyonOrani = taliKomisyonOranlari.Find(s => s.MaxUretim == maxUertim);
                                        }
                                    }
                                    //kademeli çalışmıyorsa
                                    else if (taliKomisyonOranlari.Count > 0)
                                    {
                                        if (taliKomisyonOranlari[0].MinUretim == null && taliKomisyonOranlari[0].MaxUretim == null)
                                        {
                                            taliKomisyonOrani = taliKomisyonOranlari[0];
                                        }
                                    }
                                }
                                if (taliKomisyonOrani == null)
                                {
                                    if (taliKomisyonOrani.KomisyonOran == null)
                                    {
                                        model.IslemMesaji = "Alt Kaynak komisyon oranı tanımlı olmadığı için poliçe kaydı yapılamamıştır. Lütfen öncelikle seçilen Alt Kaynak' a Komisyon Oranı tanımı yapınız.";
                                        return Json(new { HataMesaji = model.IslemMesaji });

                                    }
                                }
                                police.TaliAcenteKodu = Convert.ToInt32(model.TVMKodu);
                                police.TaliKomisyonGuncellemeTarihi = TurkeyDateTime.Now;
                                police.TaliKomisyonGuncelleyenKullanici = _AktifKullaniciService.KullaniciKodu;
                                if (taliKomisyonOrani.KomisyonOran > 100)
                                {
                                    taliKomisyonOrani.KomisyonOran = taliKomisyonOrani.KomisyonOran / 10;
                                }

                                police.TaliKomisyon = ((police.Komisyon * taliKomisyonOrani.KomisyonOran) / 100);
                                police.TaliKomisyonOran = taliKomisyonOrani.KomisyonOran;
                            }
                            else
                            {
                                model.IslemMesaji = "Alt Kaynak komisyon oranı tanımlı olmadığı için poliçe kaydı yapılamamıştır. Lütfen öncelikle seçilen Alt Kaynak' a Komisyon Oranı tanımı yapınız.";
                                return Json(new { HataMesaji = model.IslemMesaji });
                            }

                        }


                        #endregion

                        #region Araç Bilgileri

                        police.PoliceArac.PlakaKodu = model.PlakaKodu;
                        police.PoliceArac.PlakaNo = model.PlakaNumarasi;
                        police.PoliceArac.TescilSeriKod = model.TescilBelgeSeriKodu;
                        police.PoliceArac.TescilSeriNo = model.TescilBelgeSeriNo;
                        police.PoliceArac.AsbisNo = model.AsbisNo;

                        #endregion

                        #region Sigortalı / Sigorta Ettiren Bilgileri
                        police.PoliceSigortaEttiren.DainiMurtehinSubeAdi = model.DainiMurteinSubeAdi;
                        if (model.Sigortali.KimlikNo == null)
                        {
                            police.PoliceSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                            police.PoliceSigortali.AdiUnvan = model.SigortaEttiren.Adi;
                            police.PoliceSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;
                            police.PoliceSigortali.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                            if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                            {
                                if (model.SigortaEttiren.KimlikNo.Length > 10)
                                {
                                    police.PoliceSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    police.PoliceSigortali.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    police.PoliceSigortaEttiren.VergiKimlikNo = "";
                                    police.PoliceSigortali.VergiKimlikNo = "";
                                }
                                else
                                {
                                    police.PoliceSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo;
                                    police.PoliceSigortali.VergiKimlikNo = model.SigortaEttiren.KimlikNo;

                                    police.PoliceSigortaEttiren.KimlikNo = "";
                                    police.PoliceSigortali.KimlikNo = "";
                                }
                            }

                            police.PoliceSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                            police.PoliceSigortali.MobilTelefonNo = model.SigortaEttiren.Telefon;
                            police.PoliceSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                            police.PoliceSigortali.Adres = model.SigortaEttiren.Adres;
                        }
                        else
                        {
                            ///Sigortalı Bilgileri
                            police.PoliceSigortali.AdiUnvan = model.Sigortali.Adi;
                            police.PoliceSigortali.SoyadiUnvan = model.Sigortali.Soyadi;
                            if (!String.IsNullOrEmpty(model.Sigortali.KimlikNo))
                            {
                                if (model.Sigortali.KimlikNo.Length > 10)
                                {
                                    police.PoliceSigortali.KimlikNo = model.Sigortali.KimlikNo;
                                    police.PoliceSigortali.VergiKimlikNo = "";
                                }
                                else
                                {
                                    police.PoliceSigortali.VergiKimlikNo = model.Sigortali.KimlikNo;
                                    police.PoliceSigortali.KimlikNo = "";
                                }
                            }

                            police.PoliceSigortali.MobilTelefonNo = model.Sigortali.Telefon;
                            police.PoliceSigortali.Adres = model.Sigortali.Adres;

                            ///Sigorta Ettiren Bilgileri
                            police.PoliceSigortaEttiren.AdiUnvan = model.SigortaEttiren.Adi;
                            police.PoliceSigortaEttiren.SoyadiUnvan = model.SigortaEttiren.Soyadi;

                            if (!String.IsNullOrEmpty(model.SigortaEttiren.KimlikNo))
                            {
                                if (model.SigortaEttiren.KimlikNo.Length > 10)
                                {
                                    police.PoliceSigortaEttiren.KimlikNo = model.SigortaEttiren.KimlikNo;
                                    police.PoliceSigortaEttiren.VergiKimlikNo = "";
                                }
                                else
                                {
                                    police.PoliceSigortaEttiren.VergiKimlikNo = model.SigortaEttiren.KimlikNo;
                                    police.PoliceSigortaEttiren.KimlikNo = "";
                                }
                            }
                            police.PoliceSigortaEttiren.MobilTelefonNo = model.SigortaEttiren.Telefon;
                            police.PoliceSigortaEttiren.Adres = model.SigortaEttiren.Adres;
                        }


                        #endregion
                        #region Ödeme Bilgileri

                        if (model.TaksitSayisi == 1)
                        {
                            PoliceOdemePlani odeme = new PoliceOdemePlani();
                            odeme.TaksitNo = model.TaksitSayisi;
                            odeme.TaksitTutari = Convert.ToDecimal(police.BrutPrim);
                            odeme.TaksitTutari = Convert.ToDecimal(police.BrutPrim);
                            odeme.VadeTarihi = model.BaslangicTarihi;
                            odeme.OdemeTipi = model.OdemeTipi;
                            police.PoliceOdemePlanis.Add(odeme);

                            if (model.OdemeTipi != OdemeTipleri.Havale)
                            {
                                PoliceTahsilat tahsilat = new PoliceTahsilat();
                                tahsilat.OdemTipi = model.OdemeTipi;
                                tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.BaslangicTarihi.Value;
                                tahsilat.TaksitNo = odeme.TaksitNo;
                                tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                tahsilat.KalanTaksitTutari = 0;
                                tahsilat.PoliceNo = police.PoliceNumarasi;
                                tahsilat.ZeyilNo = police.EkNo.ToString();
                                tahsilat.KimlikNo = police.PoliceSigortali.KimlikNo;
                                tahsilat.BrutPrim = police.BrutPrim.Value;
                                tahsilat.PoliceId = police.PoliceId;
                                tahsilat.KayitTarihi = DateTime.Today;
                                tahsilat.KaydiEkleyenKullaniciKodu = police.TVMKodu.Value;
                                if (tahsilat.TaksitTutari != 0)
                                {
                                    police.PoliceTahsilats.Add(tahsilat);
                                }
                            }
                        }
                        else if (model.TaksitSatirlar != null)
                        {
                            PoliceOdemePlani odeme = new PoliceOdemePlani();
                            foreach (var item in model.TaksitSatirlar)
                            {
                                odeme = new PoliceOdemePlani();
                                odeme.TaksitNo = Convert.ToInt32(item.TaksitNo);
                                if (!String.IsNullOrEmpty(item.TaksitTutariTL))
                                {
                                    odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutariTL);
                                }
                                else
                                {
                                    odeme.TaksitTutari = Convert.ToDecimal(item.TaksitTutari);
                                }
                                odeme.OdemeTipi = model.OdemeTipi;
                                odeme.VadeTarihi = Convert.ToDateTime(item.VadeTarihi);
                                police.PoliceOdemePlanis.Add(odeme);

                                if (model.OdemeTipi != OdemeTipleri.Havale)
                                {
                                    PoliceTahsilat tahsilat = new PoliceTahsilat();
                                    tahsilat.OdemTipi = model.OdemeTipi;
                                    tahsilat.TaksitVadeTarihi = odeme.VadeTarihi.HasValue ? odeme.VadeTarihi.Value : police.BaslangicTarihi.Value;
                                    tahsilat.TaksitNo = odeme.TaksitNo;
                                    tahsilat.OdemeBelgeTarihi = odeme.VadeTarihi;
                                    tahsilat.TaksitTutari = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.OdenenTutar = odeme.TaksitTutari.HasValue ? odeme.TaksitTutari.Value : 0;
                                    tahsilat.KalanTaksitTutari = 0;
                                    tahsilat.PoliceNo = police.PoliceNumarasi;
                                    tahsilat.ZeyilNo = police.EkNo.ToString();
                                    tahsilat.KimlikNo = police.PoliceSigortali.KimlikNo;
                                    tahsilat.BrutPrim = police.BrutPrim.Value;
                                    tahsilat.PoliceId = police.PoliceId;
                                    tahsilat.KayitTarihi = DateTime.Today;
                                    tahsilat.KaydiEkleyenKullaniciKodu = police.TVMKodu.Value;
                                    if (tahsilat.TaksitTutari != 0)
                                    {
                                        police.PoliceTahsilats.Add(tahsilat);
                                    }
                                }

                            }
                        }

                        #endregion
                        var tahsilat1 = police.PoliceTahsilats.Where(w => w.PoliceId == police.PoliceId && w.TaksitNo == (1)).FirstOrDefault();

                        #region Poliçe Güncelleme
                        model.IslemMesaji = "Poliçe Güncelleme aşamadında bir hata oluştu.";
                        // var policeUpdateResult = _PoliceService.UpdatePolice(police);

                        var result = PoliceSil(police.PoliceId);

                        if (result.ToString().Contains("hata oluştu"))
                        {
                            model.IslemMesaji = "Poliçe Güncelleme aşamadında bir hata oluştu.";
                        }
                        else
                        {
                            model.PoliceId = null;
                            //model.MuhasebeyeAktarildiMi = null;
                            model.TaksitSayisi = byte.Parse(tahsilat1.TaksitNo.ToString());
                            var result1 = PoliceGirisi(model);
                            var police_ = _PoliceService.getPolice(police.TaliAcenteKodu, model.SigortaSirketiKodu.ToString(), police.PoliceNumarasi, (int)police.EkNo);

                            if (result1.ToString().Contains("hata oluştu"))
                                model.IslemMesaji = result1.ToString();
                            else
                                model.IslemMesaji = "Police başarılı bir şekilde güncellendi.";
                            UpdateManuelPoliceDetail(police_.PoliceId, tahsilat1.TaksitNo, decimal.Parse(model.BrutPrim), tahsilat1.OdemeBelgeNo, tahsilat1.OdemeBelgeTarihi.Value.ToString(), model.OdemeTipi.ToString(), "KASA HESABI", tahsilat1.CariHesapKodu, tahsilat1.Dekont_EvrakNo);
                        }

                        //if (policeUpdateResult)
                        //{
                        //    model.IslemMesaji = "Police başarılı bir şekilde güncellendi.";
                        //}
                        //else
                        //{
                        //    model.IslemMesaji = "Poliçe Güncelleme aşamadında bir hata oluştu.";
                        //}
                        #endregion
                    }
                }
                //}

                //catch (Exception ex)
                //{
                // model.IslemMesaji = "Poliçe Güncelleme aşamadında bir hata oluştu." + ex.ToString();
                //return Json(new { HataMesaji = model.IslemMesaji });
                //}
            }
            else
            {
                model.IslemMesaji = "";
                foreach (var item in ModelState.Values)
                {
                    model.IslemMesaji = "Lütfen zorunlu alanları doldurunuz.";
                }
                if (String.IsNullOrEmpty(model.IslemMesaji))
                {
                    model.IslemMesaji = "Lütfen zorunlu alanları doldurunuz.";
                }
            }

            return Json(new { HataMesaji = model.IslemMesaji, MuhasebeAktarilanGuncellenenPoliceId = guncellenenPoliceId, MuahsebeKonfigId = sonuc });
        }
        [HttpPost]
        public ActionResult CariyeAktarilanPoliceGuncelle(int policeId)
        {
            var police_ = _PoliceService.GetPolice(policeId);
            police_.MuhasebeyeAktarildiMi = 2;
            var res = _PoliceService.UpdatePolice(police_);
            return Json(new { HataMesaji = res });
        }
        [HttpPost]
        [Authorization(AnaMenuKodu = AnaMenuler.Police, AltMenuKodu = AltMenuler.OfflinePoliceGirisi, SekmeKodu = 0)]
        public ActionResult PoliceSil(int PoliceId)
        {
            string islemMesaji = "";

            if (PoliceId > 0)
            {
                var silinecekPolice = _PoliceService.GetPoliceById(PoliceId);
                if (silinecekPolice != null)
                {
                    try
                    {


                        if (silinecekPolice.GenelBilgiler.MuhasebeyeAktarildiMi != 2 && silinecekPolice.GenelBilgiler.MuhasebeyeAktarildiMi != 4)
                        // if (silinecekPolice.GenelBilgiler.PoliceNumarasi != null)
                        {

                            bool policeSilindi = _PoliceService.DeleteSadecePolice(silinecekPolice);
                            if (policeSilindi)
                            {
                                islemMesaji = "Poliçe silme işleminiz başarılı bir şekilde gerçekleşmiştir.";
                            }
                        }

                        else
                        {
                            ////
                            bool policemuhasebedensilindi = _PoliceService.DeletePolice(silinecekPolice);
                            if (policemuhasebedensilindi)
                            {
                                islemMesaji = "Poliçe silme işleminiz başarılı bir şekilde gerçekleşmiştir.";
                            }
                            else
                                islemMesaji = "Bu poliçenin tahsilat kayıtlarında eksiklik olduğu için silme işlemi yapılamamaktadır.";

                        }

                    }

                    catch (Exception ex)
                    {
                        islemMesaji = "Poliçe silme aşamadında bir hata oluştu." + ex.ToString();
                        return Json(new { HataMesaji = islemMesaji });
                    }
                }
            }

            return Json(new { HataMesaji = islemMesaji });
        }
        [HttpPost]
        public ActionResult MusteriGetir(string ad, string soyad)
        {
            try
            {
                List<ManuelPoliceGirisiMusteriBilgileri> musteriler = new List<ManuelPoliceGirisiMusteriBilgileri>();
                ManuelPoliceGirisiMusteriBilgileri musteri = new ManuelPoliceGirisiMusteriBilgileri();
                var kisiler = _PoliceService.GetTCKNBilgileriByAdSoyad(ad, soyad);
                for (int i = 0; i < kisiler.Count(); i++)
                {
                    musteri = new ManuelPoliceGirisiMusteriBilgileri();
                    musteri.ad = kisiler[i].AdiUnvan;
                    musteri.soyad = kisiler[i].SoyadiUnvan;
                    musteri.adres = kisiler[i].MusteriAdres.FirstOrDefault().Adres;
                    musteri.tel = kisiler[i].MusteriTelefons.FirstOrDefault().Numara;
                    musteri.tcknVkn = kisiler[i].KimlikNo;
                    if (!(musteriler.Where(w => w.tcknVkn == musteri.tcknVkn).ToList().Count > 0)) musteriler.Add(musteri);
                }
                return Json(new { success = true, data = musteriler });
            }
            catch (Exception ex)
            {
                return Json(new { success = true });
            }
        }
        [HttpPost]
        public ActionResult PoliceOdemePlaniHazirla(int taksitSayisi, string brutPrim, string brutPrimTL, string baslamaTarihi)
        {
            List<TaksitModel> taksitList = new List<TaksitModel>();
            TaksitModel taksit = new TaksitModel();
            //var BrutPrim = Convert.ToDecimal(brutPrim);
            var BrutPrim = Utils.decimalDuzenle(brutPrim);
            decimal BrutPrimTL;
            try
            {
                //BrutPrimTL = Convert.ToDecimal(brutPrimTL);
                BrutPrimTL = Utils.decimalDuzenle(brutPrimTL);
            }
            catch (Exception)
            {
                BrutPrimTL = (decimal)0;
            }
            var taksitTutari = Math.Round((BrutPrim / taksitSayisi), 2);
            var taksitTutariTL = (decimal)0;
            if (BrutPrimTL != 0)
            {
                taksitTutariTL = Math.Round((BrutPrimTL / taksitSayisi), 2);
            }
            bool ayKontrol = false;
            int yeniay = 0;
            for (int i = 0; i < taksitSayisi; i++)
            {
                taksit = new TaksitModel();
                var dmy = baslamaTarihi.Split('.');

                var joindate = new DateTime(
                    Convert.ToInt32(dmy[2], 10),
                    Convert.ToInt32(dmy[1], 10),
                    Convert.ToInt32(dmy[0], 10)
                );
                var ay = joindate.Month + i;
                var yil = joindate.Year;

                if (ay > 12 && !ayKontrol)
                {
                    yeniay = 1;
                    ayKontrol = true;
                }
                if (yeniay != 0 && ayKontrol)
                {
                    ay = yeniay++;
                    yil++;
                }

                var day = joindate.Day;
                string gun = "";
                if (day < 10)
                {
                    gun = "0" + day.ToString();
                }
                else
                {
                    gun = day.ToString();
                }
                var mounth = "";
                if (ay < 10)
                {
                    mounth = "0" + ay.ToString();
                }
                else
                {
                    mounth = ay.ToString();
                }

                if (mounth == "02" && day > 28) //Şubat ayı ise
                {
                    gun = SonGun(yil, ay).ToString();
                }
                var tarih = gun + "." + mounth + "." + yil;
                taksit.TaksitNo = (i + 1);
                taksit.VadeTarihi = tarih;
                if ((i + 1) == taksitSayisi)
                {
                    var hesaplananToplamTutar = taksitTutari * taksitSayisi;
                    if (hesaplananToplamTutar != BrutPrim)
                    {
                        var sonTaksit = BrutPrim - hesaplananToplamTutar;
                        taksitTutari = taksitTutari + sonTaksit;
                    }

                }
                taksit.TaksitTutari = taksitTutari.ToString().ToString().Replace(',', '.');

                if (BrutPrimTL != 0)
                {
                    if ((i + 1) == taksitSayisi)
                    {
                        var hesaplananToplamTutarTL = taksitTutariTL * taksitSayisi;
                        if (hesaplananToplamTutarTL != BrutPrimTL)
                        {
                            var sonTaksit = BrutPrimTL - hesaplananToplamTutarTL;
                            taksitTutariTL = taksitTutariTL + sonTaksit;

                        }
                    }
                    taksit.TaksitTutariTL = taksitTutariTL.ToString().ToString().Replace(',', '.');
                }
                else
                {
                    taksit.TaksitTutariTL = "";
                }

                taksitList.Add(taksit);
            }
            return Json(new { TaksitLsit = taksitList });

        }

        #endregion

        public ActionResult PoliceAraPartial()
        {
            PoliceAraPartialModel model = new PoliceAraPartialModel();
            var sigortaSirketleri = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new SelectList(sigortaSirketleri, "SirketKodu", "SirketAdi").ListWithOptionLabel();

            List<Bran> brans = _BransService.GetList(_AktifKullaniciService.TvmTipi.ToString());
            model.Branslar = new SelectList(brans, "BransKodu", "BransAdi").ListWithOptionLabel();

            return PartialView("_PoliceAraPartial", model);
        }

        public ActionResult PoliceReasurorAraPartial()
        {
            PoliceAraPartialModel model = new PoliceAraPartialModel();
            var sigortaSirketleri = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new SelectList(sigortaSirketleri, "SirketKodu", "SirketAdi").ListWithOptionLabel();

            List<Bran> brans = _BransService.GetListBroker();
            model.Branslar = new SelectList(brans, "BransKodu", "BransAdi").ListWithOptionLabel();

            return PartialView("_PoliceAraPartial", model);
        }
        public ActionResult PoliceEkiReasurorAraPartial()
        {

            PoliceEkiReasurorAraPartialModel model = new PoliceEkiReasurorAraPartialModel();
            var sigortaSirketleri = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new SelectList(sigortaSirketleri, "SirketKodu", "SirketAdi").ListWithOptionLabel();

            List<Bran> brans = _BransService.GetListBroker();
            model.Branslar = new SelectList(brans, "BransKodu", "BransAdi").ListWithOptionLabel();

            return PartialView("_PoliceEkiAraPartial", model);
        }
        public ActionResult TeklifAraPartial()
        {
            ITVMService _TVMService = DependencyResolver.Current.GetService<ITVMService>();
            TeklifAraReasurorPartialModel model = new TeklifAraReasurorPartialModel();
            var sigortaSirketleri = _SigortaSirketleriService.GetList();
            model.SigortaSirketleri = new SelectList(sigortaSirketleri, "SirketKodu", "SirketAdi").ListWithOptionLabel();

            model.Tvmler = new SelectList(_TVMService.GetTVMListeKullaniciYetki(0).OrderBy(s => s.Unvani), "Kodu", "Unvani").ListWithOptionLabel();
            List<Bran> brans = _BransService.GetListBroker();
            model.Branslar = new SelectList(brans, "BransKodu", "BransAdi").ListWithOptionLabel();

            return PartialView("_TeklifAraPartial", model);
        }
        [AjaxException]
        public ActionResult GetPoliceAraPartial(PoliceAraPartialModel model)
        {
            bool cariHesapVarMi = false;
            PoliceGirisiModel policeModel = new PoliceGirisiModel();
            try
            {
                var policeDetay = _PoliceService.getManuelPolice(model.SigortaSirketiKodu, model.PoliceNo, model.EkNo, model.YenilemeNo, Convert.ToInt32(model.BransKodu));


                if (policeDetay != null)
                {
                    SetPoliceModel(ref policeModel, ref policeDetay, ref cariHesapVarMi);
                }
                else
                {
                    policeDetay = _PoliceService.getOfflinePolice(model.SigortaSirketiKodu, model.PoliceNo, model.EkNo, model.YenilemeNo, Convert.ToInt32(model.BransKodu));
                    if (policeDetay != null)
                    {
                        SetPoliceModel(ref policeModel, ref policeDetay, ref cariHesapVarMi);
                    }
                }
            }
            catch (Exception ex)
            {
                policeModel.IslemMesaji = "Poliçe görüntüleme işleminde bir hata oluştu." + ex.Message.ToString();
                // return Json(new { HataMesaji = policeModel.IslemMesaji }, JsonRequestBehavior.AllowGet);
                throw ex;
            }
            return Json(new { success = true, data = policeModel, cariHesapVarMi = cariHesapVarMi }, JsonRequestBehavior.AllowGet);
        }

        private void SetPoliceModel(ref PoliceGirisiModel policeModel, ref PoliceGenel policeDetay, ref bool cariHesapVarMi)
        {
            policeModel.Yeni_is = policeDetay.Yeni_is.ToString();
            policeModel.Durum = policeDetay.Durum;
            policeModel.PoliceTipi = 1;
            policeModel.PoliceId = policeDetay.PoliceId;
            policeModel.MuhasebeyeAktarildiMi = policeDetay.MuhasebeyeAktarildiMi;
            policeModel.DisKaynakKodu = policeDetay.UretimTaliAcenteKodu.HasValue ? policeDetay.UretimTaliAcenteKodu.ToString() : "";
            policeModel.TVMKodu = policeDetay.TaliAcenteKodu.HasValue ? policeDetay.TaliAcenteKodu.ToString() : "";
            policeModel.SigortaSirketiKodu = policeDetay.TUMBirlikKodu;
            policeModel.BransKodu = policeDetay.BransKodu.HasValue ? policeDetay.BransKodu.Value.ToString() : "";
            policeModel.PoliceNo = policeDetay.PoliceNumarasi;
            policeModel.YenilemeNo = policeDetay.YenilemeNo.HasValue ? policeDetay.YenilemeNo.Value : 0;
            policeModel.EkNo = policeDetay.EkNo.HasValue ? policeDetay.EkNo.Value : 0;
            policeModel.ZeylAciklama = policeDetay.ZeyilAdi;

            policeModel.bTarihi = policeDetay.BaslangicTarihi.HasValue ? policeDetay.BaslangicTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
            policeModel.bitTarihi = policeDetay.BitisTarihi.HasValue ? policeDetay.BitisTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
            policeModel.tTarihi = policeDetay.TanzimTarihi.HasValue ? policeDetay.TanzimTarihi.Value.ToString("dd.MM.yyyy") : TurkeyDateTime.Now.ToString("dd.MM.yyyy");
            policeModel.ParaBirimi = policeDetay.ParaBirimi;
            policeModel.DovizKuru = policeDetay.DovizKur.ToString();
            policeModel.NetPrimTL = policeDetay.NetPrim.HasValue ? policeDetay.NetPrim.Value.ToString().Replace(',', '.') : "";

            //if( policeModel == )
            //{

            //        policeDetay = _PoliceService.getManuelPolice(model.SigortaSirketiKodu, model.PoliceNo, model.EkNo, model.YenilemeNo, Convert.ToInt32(model.BransKodu));
            //}

            if (policeDetay.PoliceVergis != null)
            {
                foreach (var item in policeDetay.PoliceVergis)
                {
                    if (item.VergiKodu == 1)
                    {
                        policeModel.THGFonuTL = item.VergiTutari.HasValue ? item.VergiTutari.Value.ToString().Replace(',', '.') : "";
                        if (policeDetay.ParaBirimi != "TL")
                        {
                            policeModel.THG = item.VergiTutari.HasValue ? (item.VergiTutari.Value / policeDetay.DovizKur).ToString().Replace(',', '.') : "";
                        }
                    }
                    else if (item.VergiKodu == 2)
                    {
                        policeModel.GiderVergisiTL = item.VergiTutari.HasValue ? item.VergiTutari.Value.ToString().Replace(',', '.') : "";
                        if (policeDetay.ParaBirimi != "TL")
                        {
                            policeModel.GiderVergisi = item.VergiTutari.HasValue ? (item.VergiTutari.Value / policeDetay.DovizKur).ToString().Replace(',', '.') : "";
                        }
                    }
                    else if (item.VergiKodu == 3)
                    {
                        policeModel.KTGSHesabiTL = item.VergiTutari.HasValue ? item.VergiTutari.Value.ToString().Replace(',', '.') : "";
                        if (policeDetay.ParaBirimi != "TL")
                        {
                            policeModel.KTGS = item.VergiTutari.HasValue ? (item.VergiTutari.Value / policeDetay.DovizKur).ToString().Replace(',', '.') : "";
                        }
                    }
                    else if (item.VergiKodu == 4)
                    {
                        policeModel.YSVTL = item.VergiTutari.HasValue ? item.VergiTutari.Value.ToString().Replace(',', '.') : "";
                        if (policeDetay.ParaBirimi != "TL")
                        {
                            policeModel.YSV = item.VergiTutari.HasValue ? (item.VergiTutari.Value / policeDetay.DovizKur).ToString().Replace(',', '.') : "";
                        }
                    }
                }
            }

            policeModel.VergiTutariTL = policeDetay.ToplamVergi.HasValue ? policeDetay.ToplamVergi.Value.ToString().Replace(',', '.') : "";

            if (policeDetay.BrutPrim.HasValue)
            {
                policeModel.BrutPrimTL = policeDetay.BrutPrim.HasValue ? policeDetay.BrutPrim.Value.ToString().Replace(',', '.') : "";
                if (policeDetay.BrutPrim < 0)
                {
                    policeModel.PoliceTipi = 0;
                }
            }
            policeModel.KomisyonTutariTL = policeDetay.Komisyon.HasValue ? policeDetay.Komisyon.Value.ToString().Replace(',', '.') : "";
            if (policeDetay.ParaBirimi != "TL")
            {
                policeModel.NetPrim = policeDetay.DovizliNetPrim.HasValue ? policeDetay.DovizliNetPrim.ToString().Replace(',', '.') : "";
                policeModel.BrutPrim = policeDetay.DovizliBrutPrim.HasValue ? policeDetay.DovizliBrutPrim.ToString().Replace(',', '.') : "";
                policeModel.KomisyonTutari = policeDetay.DovizliKomisyon.HasValue ? policeDetay.DovizliKomisyon.ToString().Replace(',', '.') : "";
                policeModel.VergiTutari = policeDetay.ToplamVergi.HasValue ? (policeDetay.ToplamVergi.Value / policeDetay.DovizKur).ToString().Replace(',', '.') : "";
            }


            var policeSigortali = policeDetay.PoliceSigortali;
            if (policeSigortali != null)
            {
                policeModel.Sigortali = new Sigortali();
                policeModel.Sigortali.Adi = policeSigortali.AdiUnvan;
                policeModel.Sigortali.Soyadi = policeSigortali.SoyadiUnvan;
                if (policeSigortali.KimlikNo != null && policeSigortali.KimlikNo != "")
                {
                    policeModel.Sigortali.KimlikNo = policeSigortali.KimlikNo;
                }
                else if (policeSigortali.VergiKimlikNo != null && policeSigortali.VergiKimlikNo != "")
                {
                    policeModel.Sigortali.KimlikNo = policeSigortali.VergiKimlikNo;
                }
                policeModel.Sigortali.Telefon = policeSigortali.MobilTelefonNo;
                policeModel.Sigortali.Adres = policeSigortali.Adres;

            }
            var policeSigortaEttiren = policeDetay.PoliceSigortaEttiren;
            if (policeSigortaEttiren != null)
            {
                policeModel.SigortaEttiren = new SigortaEttiren();
                policeModel.SigortaEttiren.Adi = policeSigortaEttiren.AdiUnvan;
                policeModel.SigortaEttiren.Soyadi = policeSigortaEttiren.SoyadiUnvan;
                if (policeSigortaEttiren.KimlikNo != null && policeSigortaEttiren.KimlikNo != "")
                {
                    policeModel.SigortaEttiren.KimlikNo = policeSigortaEttiren.KimlikNo;
                }
                else if (policeSigortaEttiren.VergiKimlikNo != null && policeSigortaEttiren.VergiKimlikNo != "")
                {
                    policeModel.SigortaEttiren.KimlikNo = policeSigortaEttiren.VergiKimlikNo;
                }
                policeModel.SigortaEttiren.Telefon = policeSigortaEttiren.MobilTelefonNo;
                policeModel.SigortaEttiren.Adres = policeSigortaEttiren.Adres;
            }
            if (policeModel.Sigortali.KimlikNo != policeModel.SigortaEttiren.KimlikNo)
            {
                policeModel.SigortaliSigortaEttirenAynimi = false;
            }
            else
            {
                policeModel.SigortaliSigortaEttirenAynimi = true;
            }
            var policeArac = policeDetay.PoliceArac;
            if (policeArac != null)
            {
                policeModel.PlakaKodu = policeArac.PlakaKodu;
                policeModel.PlakaNumarasi = policeArac.PlakaNo;
                policeModel.AsbisNo = policeArac.AsbisNo;
                policeModel.TescilBelgeSeriKodu = policeArac.TescilSeriKod;
                policeModel.TescilBelgeSeriNo = policeArac.TescilSeriNo;
            }
            var odemeSekli = policeDetay.OdemeSekli;
            if (odemeSekli.HasValue)
            {
                if (odemeSekli.Value == 1)
                {
                    policeModel.OdemeSekli = true;
                }
                else
                {
                    policeModel.OdemeSekli = false;
                }
            }

            if (policeDetay.PoliceOdemePlanis.Count > 0)
            {
                foreach (var item in policeDetay.PoliceOdemePlanis)
                {
                    if (item.OdemeTipi.HasValue)
                    {
                        policeModel.OdemeTipi = item.OdemeTipi.Value;
                    }
                }
            }
            if (policeDetay.PoliceOdemePlanis != null)
            {
                policeModel.TaksitSayisi = Convert.ToByte(policeDetay.PoliceOdemePlanis.Count);
            }
            if (policeDetay.PoliceOdemePlanis.Count > 1)
            {
                List<TaksitModel> taksitList = new List<TaksitModel>();
                TaksitModel tModel = new TaksitModel();
                foreach (var item in policeDetay.PoliceOdemePlanis)
                {
                    tModel = new TaksitModel();
                    tModel.TaksitNo = item.TaksitNo;
                    tModel.TaksitTutariTL = item.TaksitTutari.HasValue ? item.TaksitTutari.Value.ToString().Replace(',', '.') : "";
                    tModel.VadeTarihi = item.VadeTarihi.HasValue ? item.VadeTarihi.Value.ToString("dd/MM/yyyy") : "";
                    if (policeDetay.ParaBirimi != "TL")
                    {
                        tModel.TaksitTutari = item.DovizliTaksitTutari.HasValue ? item.DovizliTaksitTutari.ToString().Replace(',', '.') : "";
                    }
                    taksitList.Add(tModel);
                }

                policeModel.TaksitSatirlar = taksitList;
                policeModel.PoliceTipi = (byte)policeDetay.Durum;
            }

            // carihesabı açılmış mı kontrol ediyoruz. Eğer açılmışsa ekranda tc değiştirmesini kapatıyoruz.
            var cariHesap = _Muhasebe_CariHesapService.GetCariHesap("120.01." + policeModel.SigortaEttiren.KimlikNo);
            if (cariHesap != null)
            {
                cariHesapVarMi = true;
            }
            else
            {
                cariHesapVarMi = false;
            }
        }

        private static int[] _lookup = new[] { 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30 };
        private static CultureInfo _ci = CultureInfo.GetCultureInfo("tr-TR");
        public static int SonGun(int yil, int ay)
        {
            return _ci.Calendar.IsLeapYear(yil) ? 29 : 28;
        }

        [AjaxException]
        public ActionResult CreateCariHesap(int Polid, string cariHesapKodu)
        {
            try
            {
                var polGenel = _PoliceService.GetPoliceById(Polid);
                var ulkeKodu = polGenel.GenelBilgiler.PoliceSigortaEttiren.UlkeKodu;
                var TCKN = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;
                var unvan = polGenel.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan + " " + polGenel.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan;
                var adres = polGenel.GenelBilgiler.PoliceSigortaEttiren.Adres;
                var ilKodu = polGenel.GenelBilgiler.PoliceSigortaEttiren.IlKodu;
                var ilceKodu = polGenel.GenelBilgiler.PoliceSigortaEttiren.IlceKodu;
                var telefon = polGenel.GenelBilgiler.PoliceSigortaEttiren.TelefonNo;
                var cepTel = polGenel.GenelBilgiler.PoliceSigortaEttiren.MobilTelefonNo;
                var email = polGenel.GenelBilgiler.PoliceSigortaEttiren.EMail;
                var postaKodu = polGenel.GenelBilgiler.PoliceSigortaEttiren.PostaKodu;
                var MusteriGrupKodu = polGenel.GenelBilgiler.PoliceSigortaEttiren.MusteriGrupKodu;
                var carihesapAdiveKodu = _Muhasebe_CariHesapService.CreateCariHesap(cariHesapKodu, TCKN, unvan, adres, ulkeKodu, ilKodu, ilceKodu, telefon, cepTel, email, postaKodu, MusteriGrupKodu);
                var result = new { success = true, cariAdi = carihesapAdiveKodu.Item1, cariKodu = carihesapAdiveKodu.Item2 };
                return Json(result, JsonRequestBehavior.AllowGet);

            }
            catch (Exception ex)
            {
                return Json(new { success = false, uyari = "Hata var." }, JsonRequestBehavior.AllowGet);
            }
        }
        [AjaxException]
        public ActionResult UpdateCariHesap(string cariHesapKodu, string cariHesapUnvan)
        {
            try
            {
                var carihesap = _Muhasebe_CariHesapService.GetCariHesap(cariHesapKodu);
                if (carihesap != null)
                {
                    carihesap.Unvan = cariHesapUnvan;
                    _Muhasebe_CariHesapService.UpdateCariHesap(carihesap);
                    return Json(new { success = true }, JsonRequestBehavior.AllowGet);
                }
                return Json(new { success = false }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false }, JsonRequestBehavior.AllowGet);
            }
        }
        [AjaxException]
        public ActionResult GetCariHesapByTCKN(int Polid)
        {
            var polGenel = _PoliceService.GetPoliceById(Polid);
            var TCVKN = !String.IsNullOrEmpty(polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo) ? polGenel.GenelBilgiler.PoliceSigortaEttiren.KimlikNo : polGenel.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo;

            try
            {

                var carihesapAdiveKodu = _Muhasebe_CariHesapService.GetCariHesapAdiByTCKN(TCVKN);

                if (carihesapAdiveKodu.Item1 != "" && carihesapAdiveKodu.Item2 != "")
                {
                    var result = new { success = true, cariAdi = carihesapAdiveKodu.Item1, cariKodu = carihesapAdiveKodu.Item2, CariHesapAdiVarMi = true };
                    return Json(result, JsonRequestBehavior.AllowGet);
                }
                else if (carihesapAdiveKodu.Item2 != "")
                {
                    var result = new { success = true, cariAdi = polGenel.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan + " " + polGenel.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan, cariKodu = carihesapAdiveKodu.Item2, CariHesapAdiVarMi = false };
                    return Json(result, JsonRequestBehavior.AllowGet);
                }
                else
                {

                    var result = new { success = false, cariAdi = polGenel.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan + " " + polGenel.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan, cariKodu = "120.01." + TCVKN, CariHesapAdiVarMi = false };
                    return Json(result, JsonRequestBehavior.AllowGet);
                }


            }
            catch (Exception ex)
            {
                var result = new { success = false, cariAdi = polGenel.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan + " " + polGenel.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan, cariKodu = "120.01." + TCVKN };
                return Json(result, JsonRequestBehavior.AllowGet);
            }
        }
        public ActionResult GetBankaHesapByVKN(string VKN, int policeId)
        {
            var cariHesap = _Muhasebe_CariHesapService.GetBankaHesapByVKN(VKN, policeId);

            string cariHesapKodu = cariHesap.Item2;
            return Content(cariHesapKodu);
        }

        public ActionResult GetCariHesapByVKN(string VKN, int policeId)
        {
            var cariHesap = _Muhasebe_CariHesapService.GetCariHesapByVKN(VKN, policeId);

            string cariHesapKodu = cariHesap.Item2;
            return Content(cariHesapKodu);
        }
        [AjaxException]
        public ActionResult CheckIfYurtdisiBrokerByTVMKodu(int tvmKodu)
        {
            var tvmDetay = _TVMService.getAnaAcenteTvmDetay(tvmKodu);
            return Content((tvmDetay.Tipi == 1).ToString());
        }


        [AjaxException]
        public ActionResult GetCariHesapByCariHesapKodu(string cariHesapKodu)
        {
            try
            {
                var carihesapAdiveKodu = _Muhasebe_CariHesapService.GetCariHesapAdi(cariHesapKodu);
                var result = new { success = true, cariAdi = carihesapAdiveKodu.Item1, cariKodu = carihesapAdiveKodu.Item2 };
                if (carihesapAdiveKodu.Item1 == null && carihesapAdiveKodu.Item2 == null)
                {
                    return Json(new { success = false }, JsonRequestBehavior.AllowGet);
                }
                return Json(result, JsonRequestBehavior.AllowGet);

            }
            catch (Exception ex)
            {
                return Json(new { success = false }, JsonRequestBehavior.AllowGet);
            }
        }
        [AjaxException]
        public ActionResult GetTCKNBilgileriByTCKN(string kimlikNo)
        {
            try
            {
                var kimlikBilgileri = _PoliceService.GetTCKNBilgileriByTCKN(kimlikNo);
                if (String.IsNullOrEmpty(kimlikBilgileri.Item5))
                {
                    return Json(new { success = false }, JsonRequestBehavior.AllowGet);
                }
                var result = new { success = true, adi = kimlikBilgileri.Item1, soyadi = kimlikBilgileri.Item2, telefon = kimlikBilgileri.Item3, adres = kimlikBilgileri.Item4, TCKNVKN = kimlikBilgileri.Item5 };
                return Json(result, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false }, JsonRequestBehavior.AllowGet);
            }
        }
        [AjaxException]
        public ActionResult GetSigortaSirketleriBilgileri()
        {
            try
            {
                var SirketCarihesaplar = _PoliceService.getSirketler();
                if (SirketCarihesaplar.Count > 0)
                {
                    var Carihesaplar = new SelectList(SirketCarihesaplar, "CariHesapKodu", "Unvan");
                    return Json(new { success = true, list = Carihesaplar }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    List<SelectListItem> list = new List<SelectListItem>();
                    list.Insert(0, new SelectListItem() { Value = "", Text = babonline.PleaseSelect, Selected = true }); // Lütfen seçiniz

                    return Json(new { success = false, list = list }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {

                ILogService log = DependencyResolver.Current.GetService<ILogService>();
                log.Error(ex);
                throw;
            }
        }
        [AjaxException]
        public ActionResult GetIsimdenMusteriSorgu(string ad, string soyad)
        {
            try
            {
                var kimlikBilgileri = _PoliceService.getMusteriDetay(ad, soyad);

                //var result = new { kimlikBilgileri };
                return Json(kimlikBilgileri, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false }, JsonRequestBehavior.AllowGet);
            }
        }
        private void OdemeTipiText(ref string OdemeTipKodu)
        {
            switch (OdemeTipKodu)
            {
                case "1":
                    OdemeTipKodu = "Nakit";
                    break;
                case "2":
                    OdemeTipKodu = "Müşteri Kredi Kartı";
                    break;
                case "3":
                    OdemeTipKodu = "Havale";
                    break;
                case "4":
                    OdemeTipKodu = "Çek";
                    break;
                case "5":
                    OdemeTipKodu = "Acente Kredi Kartı";
                    break;
                case "6":
                    OdemeTipKodu = "Acente Pos Hesabı";
                    break;
                case "7":
                    OdemeTipKodu = "Senet";
                    break;
                case "9":
                    OdemeTipKodu = "Acente Bireysel K. Kartı";
                    break;
                default:
                    OdemeTipKodu = " ";
                    break;
            }
        }

        public ActionResult PoliceDokuman(int? id)
        {
            PoliceDokumanModel model = new PoliceDokumanModel();
            if (id != null)
            {
                Neosinerji.BABOnlineTP.Business.Police police = _PoliceService.GetPoliceById(id.Value);

                if (police.GenelBilgiler.TVMKodu == _AktifKullaniciService.TVMKodu)
                {
                    model.BaslangicTarihi = police.GenelBilgiler.BaslangicTarihi;
                    model.BitisTarihi = police.GenelBilgiler.BitisTarihi;
                    model.TanzimTarihi = police.GenelBilgiler.TanzimTarihi;
                    model.EkNo = police.GenelBilgiler.EkNo;
                    model.PoliceId = police.GenelBilgiler.PoliceId;
                    model.PoliceNo = police.GenelBilgiler.PoliceNumarasi;
                    model.YenilemeNo = police.GenelBilgiler.YenilemeNo;
                    model.SigortaSirketi = _PoliceService.getSigortaSirketi(police.GenelBilgiler.TUMBirlikKodu).SirketAdi;
                    model.SigortaEttirenAdi = police.GenelBilgiler.PoliceSigortaEttiren.AdiUnvan + " " + police.GenelBilgiler.PoliceSigortaEttiren.SoyadiUnvan;
                    model.SigortaEttirenTcknVkn = police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo == null ? police.GenelBilgiler.PoliceSigortaEttiren.VergiKimlikNo : police.GenelBilgiler.PoliceSigortaEttiren.KimlikNo;

                    model.SigortaliAdi = police.GenelBilgiler.PoliceSigortali.AdiUnvan + " " + police.GenelBilgiler.PoliceSigortali.SoyadiUnvan;
                    model.SigortaliTcknVkn = police.GenelBilgiler.PoliceSigortali.KimlikNo == null ? police.GenelBilgiler.PoliceSigortali.VergiKimlikNo : police.GenelBilgiler.PoliceSigortali.KimlikNo;

                    if (_AktifKullaniciService.Gorevi == 4)
                    {
                        model.PoliceDokumanlar = _PoliceService.getPoliceDokumanlar(police.GenelBilgiler.PoliceId);
                    }
                    else
                    {
                        model.PoliceDokumanlar = _TeklifService.getReasurorGenelDokumanlar(police.GenelBilgiler.PoliceId);
                        model.PoliceDokumanlar.AddRange(_PoliceService.getPoliceDokumanlar(police.GenelBilgiler.PoliceId));
                    }
                }
                else
                {
                    return new RedirectResult("~/Error/ErrorPage/500");
                }
            }

            return View(model);
        }

        [HttpPost]
        public ActionResult PoliceDosyaKayitEt(PoliceDokumanModel model)
        {
            model.IslemMesaji = "Dosya Kayıt İşlemi Başarılı.";

            if (model.DokumanAdi != null && model.DokumanAdi != "" && model.Dokuman != null)
            {
                try
                {

                    #region storage kayıt
                    Guid g;
                    string urlDokuman = null;
                    if (model.Dokuman != null)
                    {
                        //credit döküman
                        g = Guid.NewGuid();
                        //string fileCreditName = System.IO.Path.GetFileName(model.fileCreditNote.FileName);
                        string fileName = g + "__" + System.IO.Path.GetFileName(model.Dokuman.FileName);
                        urlDokuman = _Storage.UploadFile("police", fileName, model.Dokuman.InputStream);
                    }
                    #endregion
                    if (urlDokuman != null)
                    {
                        PoliceDokuman PD = new PoliceDokuman();
                        PD.DokumanAdi = model.DokumanAdi;
                        PD.DokumanURL = urlDokuman;
                        PD.KayitTarihi = TurkeyDateTime.Now;
                        PD.Police_ID = model.PoliceId;
                        PD.TVMKodu = _AktifKullaniciService.TVMKodu;
                        PD.TVMKullaniciKodu = _AktifKullaniciService.AdiSoyadi;
                        var result = _PoliceService.createPoliceDokuman(PD);
                        if (!result)
                        {
                            model.IslemMesaji = "Dosya Kayıt aşamadında bir hata oluştu.";
                            return Json(new { HataMesaji = model.IslemMesaji });
                        }
                    }
                    else
                    {
                        model.IslemMesaji = "Dosya Kayıt aşamadında bir hata oluştu.";
                        return Json(new { HataMesaji = model.IslemMesaji });
                    }
                }

                catch (Exception ex)
                {
                    model.IslemMesaji = "Dosya Kayıt aşamadında bir hata oluştu." + ex.ToString();
                    return Json(new { HataMesaji = model.IslemMesaji });
                }
            }
            else
            {
                model.IslemMesaji = "Lütfen zorunlu alanları doldurunuz.";
            }

            return Json(new { HataMesaji = model.IslemMesaji });
        }
        [HttpPost]
        public ActionResult PoliceDosyaKayit(int? id)
        {
            PoliceDokumanModel model = new PoliceDokumanModel();
            model.PoliceId = Convert.ToInt32(id);
            return PartialView("_DokumanEkle", model);
        }
    }
}
