@using Neosinerji.BABOnlineTP.Web.Content.Lang
@model Neosinerji.BABOnlineTP.Web.Areas.Teklif.Models.FerdiKazaPlusIsDetayModel

@section HorizontalMenu
{
    <ul class="nav">
        <li class="active">
            <a href="#">@babonline.Detail<span class="selected"></span></a>
        </li>
    </ul>
}

@section PageHeader
{

}

@Html.HiddenFor(m => m.TeklifId)
@Html.HiddenFor(m => m.IsNo)
<div class="portlet box light-grey" style="margin-top: 24px;">
    <div class="portlet-title">
        <div class="caption"><i class="icon-reorder"></i>@babonline.BusinessDetails</div>
    </div>
    <div class="portlet-body form">
        <div class="form-horizontal">
            <div class="row-fluid">
                <div class="box-body">
                    <div class="form-section-header">
                        <h3 class="form-section">@babonline.General_Information</h3>
                    </div>

                    <div class="row-fluid">
                        <div class="span6">
                            <div class="control-group">
                                <label class="control-label">@babonline.Date</label>
                                <div class="controls">
                                    <label class="control">@Model.Tarih</label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">@babonline.JobNo</label>
                                <div class="controls">
                                    <label class="control">@Model.IsNo</label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">@babonline.Customer</label>
                                <div class="controls">
                                    <label class="control">@Model.AdiSoyadi</label>
                                </div>
                            </div>


                            <div class="control-group">
                                <label class="control-label">@babonline.RelatedDocument</label>
                                <div class="controls">
                                    <label class="control"><a href="/Teklif/FerdiKazaPlus/Detay/@Model.TeklifId">@Model.IliskiliBelge</a></label>
                                </div>
                            </div>
                        </div>

                        <div class="span6">

                            <div class="control-group">
                                <label class="control-label">@babonline.UserNameSurname</label>
                                <div class="controls">
                                    <label class="control">@Model.TVMKullaniciAdiSoyadi</label>
                                </div>
                            </div>


                            <div class="control-group">
                                <label class="control-label">@babonline.UserGroup</label>
                                <div class="controls">
                                    <label class="control">@Model.KullaniciGrubu</label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">@babonline.BusinessType</label>
                                <div class="controls">
                                    <label class="control">@Model.IsTipi</label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">@babonline.JobTypeDetail</label>
                                <div class="controls">
                                    <label class="control">@Model.IsTipiDetay</label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">@babonline.Stage</label>
                                <div class="controls">
                                    <label class="control">

                                        @if (Model.Adim == 2)
                                        {
                                            <span class="label label-warning">2. @babonline.Stage</span>
                                        }
                                        else if (Model.Adim == 3)
                                        {
                                            <span class="label label-info">3. @babonline.Stage</span>
                                        }
                                        else if (Model.Adim == 4)
                                        {
                                            <span id="adim4-label" class="label label-success">4. @babonline.Stage</span>
                                        }
                                        else if (Model.Adim == 5)
                                        {
                                            <span id="" class="label label-success">@babonline.Completed</span>
                                        }
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section-header">
                        <h3 class="form-section">@babonline.TransactionInformation</h3>
                    </div>

                    <div class="row-fluid">
                        <div class="span6">

                            @if (Model.Adim == 2)
                            {
                                <div class="control-group">
                                    <label class="control-label">@babonline.MissingDocument</label>
                                    <div class="controls">
                                        <input type="checkbox" id="eksik-belge" />
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">@babonline.MissingSignature</label>
                                    <div class="controls">
                                        <input type="checkbox" id="eksik-imza" />
                                    </div>
                                </div>
                                <div class="control-group" style="display: none" id="eksik-belge-div">
                                    <label class="control-label">@babonline.MissingDocumentDescription</label>
                                    <div class="controls">
                                        <input type="text" id="eksik-belge-aciklama" />
                                    </div>
                                </div>
                                
                                <div class="control-group" style="display: none" id="eksik-imza-div">
                                    <label class="control-label">@babonline.MissingSignatureDescription</label>
                                    <div class="controls">
                                        <input type="text" id="eksik-imza-aciklama" />

                                    </div>
                                </div>
                              
                            }
                            else if (Model.Adim == 3)
                            {
                                <div class="control-group">
                                    <label class="control-label">@babonline.CourierWasDelivered</label>
                                    <div class="controls">
                                        <input type="checkbox" id="kuryeye-teslim-edildi" />
                                    </div>
                                </div>
                            }
                            else if (Model.Adim == 4)
                            {
                                <div class="control-group">
                                    <label class="control-label">@babonline.FormsOriginallyCame</label>
                                    <div class="controls">
                                        <input type="checkbox" id="form-asli-geldi" />
                                    </div>
                                </div>
                                <div class="control-group" id="div-form-numarasi" style="display: none">
                                    <label class="control-label">@babonline.BoxNumber</label>
                                    <div class="controls">
                                        <input type="text" id="txt-form-numarasi" />
                                    </div>
                                </div>
                            }


                        </div>
                    </div>

                    <div id="teklif-button-container" class="row-fluid" style="padding-top: 20px; padding-bottom: 20px;">
                        <div class="span4"></div>
                        <div class="span4">
                            @if (Model.Adim == 2)
                            {
                                <a href="#" id="iade" class="btn yellow"><i class="icon-circle-arrow-left icon-white" data-loading-text="@babonline.Message_Loading">&nbsp;</i>@babonline.GivingBack </a>
                            }

                            @if (Model.Adim < 4)
                            {
                                <button id="beklet" class="btn btn-primary" type="button" style="margin-left: 10px;"><i class="icon-pause icon-white" data-loading-text="@babonline.Message_Loading">&nbsp;</i>@babonline.Waiting</button>
                            }

                            @if (Model.Adim == 2)
                            {
                                <button id="ilerlet-adim2" style="margin-left: 10px;" class="btn btn-primary" type="button" data-loading-text="@babonline.Message_Loading">@babonline.Advance<i class="icon-circle-arrow-right icon-white">&nbsp;</i></button>
                            }
                            else if (Model.Adim == 3)
                            {
                                <button id="ilerlet-adim3" style="margin-left: 10px;" class="btn btn-primary" type="button" data-loading-text="@babonline.Message_Loading">@babonline.Advance<i class="icon-circle-arrow-right icon-white">&nbsp;</i></button>
                            }
                            else if (Model.Adim == 4)
                            {
                                <button id="ilerlet-adim4" style="margin-left: 10px;" class="btn btn-primary" type="button" data-loading-text="@babonline.Message_Loading">@babonline.Advance<i class="icon-circle-arrow-right icon-white">&nbsp;</i></button>
                            }
                            else if (Model.Adim == 5)
                            {
                                <button id="tamamlandi" style="margin-left: 10px;" class="btn green" type="button"><i class="icon-circle-arrow-right icon-white">&nbsp;</i>@babonline.Completed</button>
                            }

                        </div>
                    </div>

                    <div class="row-fluid">
                        <div style="margin-top: 15px;" class="tabbable tabbable-custom">
                            <ul class="nav nav-tabs">
                                <li class="active"><a data-toggle="tab" href="#tab_1_1">@babonline.Document</a></li>
                                <li class=""><a data-toggle="tab" href="#tab_1_2">@babonline.History</a></li>
                            </ul>
                            <div class="tab-content">
                                <div id="tab_1_1" class="tab-pane active">
                                    <div class="row-fluid">
                                        <label><a id="dokuman-ekle" href="javascript:void(0)" class="btn btn-success">@babonline.Document_Add</a></label>

                                        @*Dokumanlar Burada Ekleniyor*@
                                        <div class="row-fluid">
                                            <div class="span12" id="dokuman-container">
                                                @Html.Partial("_Dokumanlar", Model.IsDetayDokuman)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="tab_1_2" class="tab-pane">
                                    @*<label><a class="btn btn-success" href="javascript:void(0)" id="not-ekle">Not Ekle</a></label>*@

                                    <div class="row-fluid">
                                        <div id="notlar-container" class="span12">
                                            <table class="table table-striped table-bordered table-hover dataTable data-table" id="notlar-table">
                                                <thead>
                                                    <tr>
                                                        <th>@babonline.BusinessType</th>
                                                        <th>@babonline.UserNameSurname</th>
                                                        <th>@babonline.MovementType</th>
                                                        <th>@babonline.Add_Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model.IsTakipTarihce)
                                                    {
                                                        <tr>

                                                            @if (@item.IsTipi == 1)
                                                            {
                                                                <td>@babonline.JobCreated</td>
                                                            }
                                                            else if (@item.IsTipi == 2)
                                                            {
                                                                <td>@babonline.Step2ApplicationProcess</td>
                                                            }
                                                            else if (@item.IsTipi == 3)
                                                            {
                                                                <td>@babonline.Step3ApplicationProcess</td>
                                                            }
                                                            else if (@item.IsTipi == 4)
                                                            {
                                                                <td>@babonline.Step4ApplicationProcess</td>
                                                            }
                                                            else if (@item.IsTipi == 5)
                                                            {
                                                                <td>@babonline.ProcessCompleted</td>
                                                            }

                                                            <td>@item.TVMKullaniciAdiSoyadi</td>

                                                            @if (@item.HareketTipi == "0")
                                                            {
                                                                <td>@babonline.Started</td> 
                                                            }
                                                            else if (@item.HareketTipi == "1")
                                                            {
                                                                <td>@babonline.WasAdvanced </td> 
                                                            }
                                                            else if (@item.HareketTipi == "2")
                                                            {
                                                                <td>@babonline.OnHold </td> 
                                                            }
                                                            else if (@item.HareketTipi == "3")
                                                            {
                                                                <td>@babonline.ReturnsWere </td> 
                                                            }
                                                            else if (@item.HareketTipi == "4")
                                                            { 
                                                                <td>@babonline.Completed</td> 
                                                            }
                                                            <td>@item.KayitTarihi</td>
                                                        </tr>
                                                    }

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@*Döküman Ekle Div*@
<div id="dokuman-modal-div"></div>
<script>

    $("#iade").click(function () {
        if (!$("#eksik-belge").is(":checked") && !$("#eksik-imza").is(":checked")) {
            alert("Uyarı! Eksik belge veya eksik imza olmadan işi iade edemezsiniz");
        }
        else {
            $(this).button("loading");
            var TeklifId = $("#TeklifId").val();
            var IsNo = $("#IsNo").val();
            var eksikBelgeAciklama = "";
            var eksikImzaAciklama = "";
            var eksikBelge = "";
            var eksikimza = "";

            if ($("#eksik-belge").is(":checked"))
                eksikBelge = "1";
            else eksikBelge = "0";
            if ($("#eksik-imza").is(":checked"))
                eksikimza = "1";
            else eksikimza = "0";

            if ($("#eksik-belge-aciklama").val() == "")
                eksikBelgeAciklama = "0";
            else eksikBelgeAciklama = $("#eksik-belge-aciklama").val();
            if ($("#eksik-imza-aciklama").val() == "")
                eksikImzaAciklama = "0";
            eksikImzaAciklama = $("#eksik-imza-aciklama").val();

            $.ajax({
                url: "/Teklif/FerdiKazaPlus/Iade",
                data: { isTakipId: IsNo, eksikBelge: eksikBelge, eksikImza: eksikimza, eksikBelgeAciklama: eksikBelgeAciklama, eksikImzaAciklama: eksikImzaAciklama },
                dataType: "json",
                async: false,
                method: "post",
                success: function (data) {
                    if (data.Success == "false") { confirm("Hata Mesajı! İade sırasında hata oluştu!"); $("#beklet").button("reset"); }
                    else {
                        if (confirm("Bilgi! İade işleminiz başarıyla gerçekleştirildi.")) {
                            window.location.href = "/Teklif/FerdiKazaPlus/Islerim";
                            $("#iade").button("reset");
                        }
                    }
                    $("#iade").button("reset");
                },
                error: function () { confirm("Hata Mesajı! İade sırasında hata oluştu!"); $("#iade").button("reset"); }
            });
        }
    });

    $("#beklet").click(function () {
        var TeklifId = $("#TeklifId").val();
        $(this).button("loading");
        $.ajax(
            {
                url: "/Teklif/FerdiKazaPlus/Beklet",
                data: { id: TeklifId },
                dataType: "json",
                async: false,
                method: "post",
                success: function (data) {
                    if (data.Success == "false") { confirm("Hata Mesajı! İş bekletme talebinde hata var!"); $("#beklet").button("reset"); }
                    else
                    {
                        if (confirm("Bekletme talebiniz başarıyla gerçekleşmiştir.")) {
                            window.location.href = "/Teklif/FerdiKazaPlus/Islerim";
                            $("#beklet").button("reset");
                        }
                    }
                    $("#beklet").button("reset");
                },
                error: function () { $("#beklet").button("reset"); $.gritter.add({ title: 'Hata Mesajı!', text: "Soru eklenirken bir hata oluştu!" }); $("#beklet").button("reset"); }
            });
    });

    $("#ilerlet-adim2").click(function () {
        var TeklifId = $("#TeklifId").val();
        if ($("#eksik-belge").is(":checked")) {
            alert("Eksik belge var ilerletemezsiniz.");
        }
        else if ($("#eksik-imza").is(":checked")) {
            alert("Eksik imza var ilerletemezsiniz.");
        }
        else if (confirm("Kontrol sonucu herhangi bir eksiklik yoktur, onaylıyor musunuz?")) {
            $(this).button("loading");
            $.ajax(
             {
                 url: "/Teklif/FerdiKazaPlus/Ilerlet",
                 data: { id: TeklifId },
                 dataType: "json",
                 async: true,
                 method: "post",
                 success: function (data) {
                     if (data.Success == "false") { confirm("Hata Mesajı! İş İlerletilmedi"); $("#ilerlet-adim2").button("reset"); }
                     else
                     {
                         window.location.href = "/Teklif/FerdiKazaPlus/Islerim";
                         $("#ilerlet-adim2").button("reset");
                     }
                     $("#ilerlet-adim2").button("reset");
                 },
                 error: function () { confirm("Hata Mesajı! İş İlerletilirken hata oluştu!"); $("#ilerlet-adim2").button("reset"); }
             });
        }
    });

    $("#ilerlet-adim3").click(function () {
        var TeklifId = $("#TeklifId").val();
        if (!$("#kuryeye-teslim-edildi").is(":checked"))
        { alert("Kuryeye teslim edilmeden ilerlenemez") }
        else if (confirm("Kuryeye teslim ettiğinizi belirtiyorsunuz, onaylıyor musunuz?")) {
            $(this).button("loading");
            $.ajax(
               {
                   url: "/Teklif/FerdiKazaPlus/Ilerlet",
                   data: { id: TeklifId },
                   dataType: "json",
                   async: true,
                   method: "post",
                   success: function (data) {
                       if (data.Success == "false") { confirm("Hata Mesajı! İş İlerletilirken hata oluştu!"); $("#ilerlet-adim3").button("reset"); }
                       else
                       {
                           window.location.href = "/Teklif/FerdiKazaPlus/Islerim";
                           $("#ilerlet-adim3").button("reset");

                       }
                       $("#ilerlet-adim3").button("reset");
                   },
                   error: function () { confirm("Hata Mesajı! İş İlerletilirken hata oluştu!"); $("#ilerlet-adim3").button("reset"); }
               });
        }
    });

    $("#ilerlet-adim4").click(function () {
        var TeklifId = $("#TeklifId").val();
        if (!$("#form-asli-geldi").is(":checked")) {
            alert("Form aslı gelmeden ilerlenemez");
        }
        else if ($("#txt-form-numarasi").val() == "") {
            alert("Kutu numarasını girmeden işi ilerletemezsiniz");
        }
        else if (confirm("Form aslının geldiğini belirtiyorsunuz, onaylıyor musunuz?")) {
            $(this).button("loading");
            var aciklama = $("#txt-form-numarasi").val();

            $.ajax(
             {
                 url: "/Teklif/FerdiKazaPlus/Ilerlet",
                 data: { id: TeklifId, aciklama: aciklama },
                 dataType: "json",
                 async: true,
                 method: "post",
                 success: function (data) {
                     if (data.Success == "false") {
                         confirm("Hata Mesajı! İş İlerletilirken hata oluştu!");
                         $("#ilerlet-adim4").button("reset");
                     }
                     else {
                         window.location.href = "/Teklif/FerdiKazaPlus/Islerim"; $("#ilerlet-adim4").button("reset");
                     }
                     $("#ilerlet-adim4").button("reset");
                 },
                 error: function () { confirm("Hata Mesajı! İş İlerletilirken hata oluştu!"); $("#ilerlet-adim4").button("reset"); }

             });

        }
    });

    $("#form-asli-geldi").change(function () {
        if ($(this).is(':checked')) {
            $("#div-form-numarasi").show();
        }
        else {
            $("#div-form-numarasi").hide();
            $("#txt-form-numarasi").val("");
        }

    });

    $("#eksik-belge").change(function () {
        if ($("#eksik-belge").is(":checked")) {
            $("#eksik-belge-div").show();
        }
        else $("#eksik-belge-div").hide();

    });

    $("#eksik-imza").change(function () {
        if ($("#eksik-imza").is(":checked")) {
            $("#eksik-imza-div").show();
        }
        else $("#eksik-imza-div").hide();
    });

    //Doküman Ekleme - Silme İşlemleri
    $("#dokuman-ekle").click(function () {
        var teklifid = $("#TeklifId").val();
        $.get("/Teklif/FerdiKazaPlus/Dokuman",
              { teklifId: teklifid },
              function (data) {
                  $("#dokuman-modal-div").html(data);
                  $.validator.unobtrusive.parse("#dokuman-modal-div");
                  $("#dokuman-modal").modal('show');
              },
              "html");
    });

    $("#dokuman-ekle-btn").live("click", function () {
        $("#dokuman-ekle-form").validate().form();
        if ($("#dokuman-ekle-form").valid()) {
            var formData = new FormData(document.forms.namedItem('dokuman-ekle-form'));
            var oReq = new XMLHttpRequest();
            oReq.open("POST", "/Teklif/FerdiKazaPlus/Dokuman", true);
            oReq.send(formData);
            oReq.onload = function (oEvent) {
                $("#dokuman-modal").modal('hide');
                $("#dokuman-modal-div").html("");
                if (oReq.status == 200) {
                    if (oReq.response != "" || oReq.response != null) {
                        $("#dokuman-modal-div").html(oReq.response);
                        $.validator.unobtrusive.parse("#dokuman-modal-div");
                        $("#dokuman-modal").modal('show');                       
                    }

                } else if (oReq.status == 500) {
                    $("#dokuman-modal").modal('hide');
                    alert("Bir hata oluştu.");
                }
                //Liste Yenileniyor
                viewDokuman();
            };

        }
       
    });

    $(".delete-dokuman").live("click", (function () {
        var IsTakipId = $(this).attr("istakip-id");
        var IsTakipDokumanId = $(this).attr("istakipdokuman-id");

        $.post("/Teklif/FerdiKazaPlus/DokumanSil/",
               { IsTakipId: IsTakipId, IsTakipDokumanId: IsTakipDokumanId },
              function (data) {                   
                   $("#dokuman-container").html(data);                  
               });
        
        $("#delete-confirmation").modal('show');
    }));

    function viewDokuman() {
        var IsNo = $("#IsNo").val();
        $.get("/Teklif/FerdiKazaPlus/DokumanView",
            { IsTakipId: IsNo },
            function (data) {
                $("#dokuman-container").html(data);
            },
            "html");
    }
    //-----Doküman Ekleme - Silme İşlemleri

</script>
